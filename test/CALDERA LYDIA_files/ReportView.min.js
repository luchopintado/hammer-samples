var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var r=e.Frontend.WebClient.DOMUtils;class ReportViewYaml{Create(e,t,o){var n=new Array;var a=document.createElement("div");r.AddClass(a,"section");var s=document.createElement("div");r.AddClass(s,"block");a["reportViewContent"]=s;var l=new i.Form(s,t[0],o);l.AddField(new i.Field(i.EFieldType.Container,"reportBodyContainer",{id:"reportBody"},{},[]));l.AddField(new i.Field(i.EFieldType.Button,"SaveAndCloseButton",{text:"Save and close"},{"margin-right":"10px","margin-bottom":"10px"},["green","inline"],t[0].actionSaveAndClose));l.AddField(new i.Field(i.EFieldType.Button,"ExportAndClose",{text:"Export and download"},{"margin-right":"10px","margin-bottom":"10px"},["green","inline"],t[0].actionExportAndClose));l.AddField(new i.Field(i.EFieldType.Button,"Cancel",{text:"Cancel"},{"margin-right":"10px","margin-bottom":"10px"},["red","inline"],t[0].actionCancelReport));l.Render();a.appendChild(s);e.appendChild(a);n.push(a);return n}}t.ReportViewYaml=ReportViewYaml})(i=t.ReportView||(t.ReportView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(Efferent){var ClientViews;(function(ClientViews){var ReportView;(function(ReportView_1){var DOMUtils=Efferent.Frontend.WebClient.DOMUtils;var WebClient=Efferent.Frontend.WebClient;var FhirClient=Efferent.Frontend.FhirClient;var Utils=Efferent.Frontend.WebClient.Utils;var CalendarUtils=Efferent.Frontend.WebClient.CalendarUtils;const{h2:h2,h3:h3,p:p,br:br,div:div,img:img,input:input,label:label,option:option,select:select,textarea:textarea,textNode:textNode}=DOMUtils;class ReportView{constructor(e,t,i,r){this.fieldTypes={text:["string","SampledData"],time:["time"],date:["dateTime"],period:["Period"],range:["Range"],integer:["integer"],shortText:["Quantity","Ratio","CodeableConcept"]};this.reportHeaderTemplate={subject:["Patient","subject","subject.name[0].text"],issued:["Report Date"],performer:["Author"],imagingStudy:["Study"]};this.reportImagesTemplate={imageQuality:["Image Quality","imageQuality","radio"],imagesPerRow:["Images per row","imagesPerRow","select"],images:["Select key images","images","imageSelector"]};this.inputs=[];this.ViewName="ReportView";this.Platform=t;this.Parent=e;this.SpecView=i;this.ResourceBag=ReportView_1.ResourceBag;this.reportMode=r["ReportMode"];this.resourceId=decodeURIComponent(r["ResourceId"]);this.dateFormat=this.Platform.GetSetting("dateFormat")||"YYYY-MM-DD";this.isReportInfoLoaded=false;this.areImagesLoaded=false;this.isStudyInfoLoaded=false;this.reportFound=false;let o={};o["actionSaveAndClose"]=()=>{this.createDiagnosticReport()};o["actionCancelReport"]=()=>{if(window.history.state===null&&location.href.includes("reportView"))window.close();else t.SwitchView(t.BrowsingHistory[t.BrowsingHistory.length-1],"back")};o["actionExportAndClose"]=()=>{this.generateAndExportPDF();this.createDiagnosticReport()};this.reportViewYaml=(new ReportView_1.ReportViewYaml).Create(this.Parent,[o]);const n=this.reportViewYaml[0]["children"];this.containerDiv=n[0];this.containerDiv.classList.add("reportViewContent");this.containerDiv.parentElement.style.width="100%";const a=h2({});this.reportBody=this.containerDiv.querySelector("#reportBody");this.reportBody.appendChild(a);const continueLoad=()=>{const e=WebClient.PlatformContext.PlatformUri+"/fhir/"+decodeURIComponent(r["ReportTemplate"]);let i=new FhirClient.FhirCall(e,"GET");i.FuncOk=e=>{WebClient.Loader.Hide();const i=JSON.parse(e);a.innerText=i["title"];const r=this.resourceId.split("/");const o=WebClient.PlatformContext.PlatformUri+"/fhir/"+r[0]+"?_id="+r[1]+"&_include=ImagingStudy:subject&_include=ImagingStudy:referrer";let n=new FhirClient.FhirCall(o,"GET");WebClient.Loader.Show();n.FuncOk=e=>{const t=JSON.parse(e);this.processedBundleResource=Efferent.Frontend.FhirClient.FhirParser.ProcessBundle(t,"ImagingStudy")[0];this.createHeaders();this.createViewModel(i);this.createImageSection();this.createInputs();WebClient.Loader.Hide();this.isReportInfoLoaded=true;this.AddKeyImagesToSelector()};n.FuncError=()=>{t.SwitchView(t.BrowsingHistory[t.BrowsingHistory.length-1],"back");WebClient.Toaster.ShowToast("Could not load resource.",WebClient.Colors.Alizarin,3);WebClient.Loader.Hide()};n.Send();WebClient.Loader.Hide()};i.FuncError=()=>{t.SwitchView(t.BrowsingHistory[t.BrowsingHistory.length-1],"back");WebClient.Toaster.ShowToast("Could not load report template.",WebClient.Colors.Alizarin,3);WebClient.Loader.Hide()};i.Send()};const s=WebClient.PlatformContext.PlatformUri+"/fhir/DiagnosticReport?imagingStudy="+this.resourceId.split("/")[1];let l=new FhirClient.FhirCall(s,"GET");WebClient.Loader.Show();l.FuncOk=e=>{const t=JSON.parse(e);if(t["total"]===0){this.reportFound=false;WebClient.Toaster.ShowToast("Existing report not found.",WebClient.Colors.PeterRiver,3)}else{this.reportFound=true;this.existingReport=t["entry"][0].resource;this.reportMode="edit"}continueLoad()};l.FuncError=()=>{WebClient.Toaster.ShowToast("Error aquiring existing reports for this resource.",WebClient.Colors.Alizarin,3);continueLoad()};l.Send();this.LoadStudyImages();this.getFhirResource();t.SwitchTheme(this);this.Platform.ResizeListeners.push(new WebClient.ResizeStructure(this.constructor.name.toLowerCase(),this,this.ViewName))}LoadStudyImages(){const e=this.resourceId.split("/")[1];FhirClient.KeyImageClient.GetKeyImages(e,(e=>{this.areImagesLoaded=true;this.keyImages=e;if(this.isReportInfoLoaded&&this.isStudyInfoLoaded)this.AddKeyImagesToSelector()}))}OnWindowResize(e,t){if(DOMUtils.IsDisplay(this.containerDiv)){const e=document.documentElement.clientHeight-this.Platform.ToolbarSectionHeight()-this.Platform.GetActiveMessageHeight();const t=e-40;this.containerDiv.style.height=t+"px"}}Dispose(){}OnPopState(e){}OnBeforeUnload(e){}OnUnload(e){}OnFullScreenChange(e){}CloseActionsConfig(){}OpenActionsConfig(){}GetFhirEntities(){return[]}SetInitialStatus(){}SwitchTheme(){this.Platform.SwitchTheme(this)}ShowPanes(e){}LoadData(e,t){}GetLanguageDictionary(){return""}OnTagChanged(e){}Refresh(){}UpdateUI(){}createViewModel(e){var t;const i=this.processedBundleResource;const r=this.dateFormat;this.viewModel={title:e["title"],header:{Author:sessionStorage["practitionerName"],"Report Date":CalendarUtils.GetFormattedDate(new Date,r),Patient:""},groups:[]};this.viewModel["groups"].push({name:"Images",cellsPerRow:1,fields:[]});try{this.viewModel["header"].Patient=i["subject"].name[0].text}catch(e){this.viewModel["header"].Patient=i["subject"].display}let o=[];for(let t=0;t<e["contained"].length;t++){const i=e["contained"][t]["category"][0].text;if(o.indexOf(i)===-1){let e={name:i,fields:[]};this.viewModel["groups"].push(e);o.push(i)}}for(let i=0;i<e["contained"].length;i++){const r=e["contained"][i];const n=r["category"][0].text;const a=o.indexOf(n)+1;let s={label:r["preferredReportName"],type:"text",fieldType:r["permittedDataType"][0],value:"",code:{}};if(this.reportMode==="edit"){const e=((t=this.existingReport["contained"][i])===null||t===void 0?void 0:t.valueString)||"";s["value"]=e?e:""}this.viewModel["groups"][a].fields.push(s)}}generateAndExportPDF(){let e=true;if(this.keyImages.length){const t=this.viewModel["groups"][0];const i=Array.from(this.reportBody.querySelectorAll(".imageSelectorItem.selected"));const r=this.reportBody.querySelector("[name=imageQuality]:checked").value;if(i.length){t["cellsPerRow"]=+this.reportBody.querySelector("[name=imagesPerRow]").value;t["fields"]=i.map((e=>({type:"image",value:e.dataset.imageuri,resolution:r})))}else{this.viewModel["groups"].shift();e=false}}else{this.viewModel["groups"].shift();e=false}for(let t=0;t<this.inputs.length;t++){if(this.inputs[t].hasAttribute("data-range")){const i=this.inputs[t].getAttribute("data-range").split(",")[0];const r=CalendarUtils.GetFormattedDate(new Date(i.split("T")[0]+" 00:00"),this.dateFormat);const o=parseInt(this.inputs[t].getAttribute("groupIndex"))-(e?0:1);const n=parseInt(this.inputs[t].getAttribute("fieldIndex"));this.viewModel["groups"][o]["fields"][n]["value"]=r}}const t=JSON.stringify(this.viewModel);const i=WebClient.PlatformContext.PlatformUri+"/reporting";var r=new XMLHttpRequest;r.open("POST",i,true);r.setRequestHeader("Authorization","Bearer "+sessionStorage["token"]);r.responseType="blob";r.onload=function(e){if(this.status===200)DOMUtils.CreateDownloaderAnchor(this.response,"report.pdf")};r.send(t);WebClient.Toaster.ShowToast("Download started.",WebClient.Colors.Emerald,3)}createHeaders(){const dateFormat=this.dateFormat;const resource=this.processedBundleResource;const getInputValue=property=>{switch(property){case"performer":return sessionStorage["userEmail"];case"imagingStudy":return WebClient.ResourceDataSynthesizer.Synthesize(resource);case"issued":return CalendarUtils.GetFormattedDate(new Date,dateFormat);default:try{const value=eval("resource."+this.reportHeaderTemplate[property][2])||"";return value}catch(e){return""}}};Object.keys(this.reportHeaderTemplate).forEach((e=>{const t=div({className:"reportViewField",children:[div({className:"fieldLabel",innerText:this.reportHeaderTemplate[e][0]}),input({value:getInputValue(e),type:"text",readOnly:true})]});this.reportBody.appendChild(t)}))}createKeyImageSelectorItems(e){const imageSelectorItem=e=>{const t=div({className:"imageSelectorItem",dataset:{imageuri:e["ImageUri"]||""},children:[img({src:e.Thumbnail,width:100,height:100,alt:""}),div({className:"imageSelectorCheck"})],onclick:()=>{if(t.classList.contains("selected"))t.classList.remove("selected");else t.classList.add("selected")}});return t};return e.map((e=>div({children:[imageSelectorItem(e)]})))}createImageSection(){const createRadioControl=(e,t)=>{const i=e.map(((e,i)=>label({className:"radioLabel",children:[input({type:"radio",name:t,value:e.value,checked:i===0}),textNode(e.label)]})));return div({style:{display:"inline-block"},children:i})};const createSelectControl=(e,t)=>{const i=e.map((e=>option({value:e.value,innerText:e.label})));return select({name:t,children:i})};const createImageSelectorControl=e=>{const t=this.createKeyImageSelectorItems(e);return div({className:"imageSelector",children:[div({className:"imageSelectorViewPort",children:t})]})};const createControl=e=>{switch(e){case"radio":const e=["low","high"].map((e=>({value:e,label:Utils.Capitalize(e)})));return createRadioControl(e,"imageQuality");case"select":const t=[1,2,3,4].map((e=>({value:e,label:e})));return createSelectControl(t,"imagesPerRow");case"imageSelector":if(this.areImagesLoaded)return createImageSelectorControl(this.keyImages);else return createImageSelectorControl([]);default:return div({innerText:"Unknown control type"})}};const e=Object.keys(this.reportImagesTemplate).map((e=>div({className:"reportViewField",children:[div({className:"fieldLabel",innerText:this.reportImagesTemplate[e][0]}),createControl(this.reportImagesTemplate[e][2])]})));const t=div({children:[h3({innerText:"Images"}),...e]});this.imageSectionContainer=t;this.reportBody.appendChild(t)}AddKeyImagesToSelector(){if(this.isReportInfoLoaded&&this.areImagesLoaded&&this.isStudyInfoLoaded){if(this.keyImages.length){const e=this.reportBody.querySelector(".imageSelector");e.innerHTML="";this.keyImages.forEach((e=>{const t=e.Images[0].ImageGUID;Object.keys(this.studyInfo.Series.StructureData).forEach((i=>{const r=this.studyInfo.Series.StructureData[i];if(r.Images.StructureData[t])e["ImageUri"]=r.Images.StructureData[t]["ImageUri"]}))}));this.createKeyImageSelectorItems(this.keyImages).forEach((t=>{e.appendChild(t)}))}else{this.imageSectionContainer.innerHTML="";if(this.reportFound){this.imageSectionContainer.appendChild(div({children:[h3({innerHTML:"Images"}),p({innerHTML:"There are not key images in the current study."}),br({})]}))}else{this.imageSectionContainer.style.display="none"}}}}getFhirResource(){const e=this;const t=this.resourceId.split("/")[1];const i=`ImagingStudy?_id=${t}&_include=ImagingStudy:endpoint&_include=ImagingStudy:subject&_include=ImagingStudy:location`;this.getImagingStudyFhirResource(i,(t=>{if(t){var i=JSON.parse(t);var r=Efferent.Frontend.FhirClient.FhirParser.ProcessBundle(i,"ImagingStudy");var o=r.map((e=>e["resourceType"]==="ImagingStudy"?e:null));if(o.length!==0)o=o.pop();let n=new WebClient.StudyEntityBase;n=Efferent.Frontend.FhirClient.FhirParser.GetStudyWithSeriesAndImagesReference(n,o,["Efferent.Frontend.WebClient.StudyEntityBase","Efferent.Frontend.WebClient.SeriesEntityBase","Efferent.Frontend.WebClient.ImageEntityBase"]);this.studyInfo=n;e.isStudyInfoLoaded=true;e.AddKeyImagesToSelector()}}),(e=>{}))}getImagingStudyFhirResource(e,t,i){var r=WebClient.PlatformContext.PlatformUri+"/fhir/"+e;var o=new Efferent.Frontend.FhirClient.FhirCall(r,"GET");o.FuncOk=e=>{t(e)};o.FuncError=e=>{i(e)};o.Send()}resolveFieldType(e){for(let t in this.fieldTypes){if(this.fieldTypes[t].indexOf(e)>-1)return t}}createInputs(){const createInputElement=e=>{if(e==="text")return textarea({className:"textArea"});else if(ReportView.dateTypes.includes(e))return div({});else if(ReportView.inputTypes.includes(e))return input({type:"text"});else return div({})};this.viewModel["groups"].forEach(((e,t)=>{if(t===0){return}const i=div({className:"groupContainer",children:[h3({innerText:e.name,className:"groupNameLabel"})]});Object.keys(e["fields"]).forEach(((r,o)=>{const n=e["fields"][r];const a=this.resolveFieldType(n.fieldType);let s=createInputElement(a);const l=div({className:"fieldContainer",children:[div({className:"fieldLabel",innerText:n.label}),s]});if(ReportView.dateTypes.includes(a)){let e;let i=false;try{e=new Date(n["value"].split("T")[0]+" 00:00");i=true}catch(t){e=new Date}const r=new WebClient.DateRangePicker(s,{date:e,from:e,to:e,type:WebClient.EDateRangeType.Single},{onlySingle:true,allowEmpty:true},i);s.setAttribute("groupIndex",t.toString());s.setAttribute("fieldIndex",o.toString())}else{s.setAttribute("code",JSON.stringify(n["code"]));s.value=n["value"];this.reportBody.appendChild(i);s.oninput=()=>{n["value"]=s.value}}this.inputs.push(s);i.appendChild(l)}));this.reportBody.appendChild(i)}));this.OnWindowResize(0,0)}createDiagnosticReport(){const e={resourceType:"DiagnosticReport",status:"final",code:{text:"TEST"},contained:[],result:[]};for(let t in this.reportHeaderTemplate){if(this.reportHeaderTemplate.hasOwnProperty(t)){if(t==="performer"){e["performer"]={reference:sessionStorage["practitionerId"]}}else if(t==="imagingStudy"){e["imagingStudy"]={reference:"ImagingStudy/"+this.processedBundleResource["id"]}}else{try{const i=this.processedBundleResource[this.reportHeaderTemplate[t][1]];if(i){if(i.hasOwnProperty("resourceType"))e[t]={reference:i["resourceType"]+"/"+i["id"]};else e[t]=i}}catch(e){}}}}if(this.reportMode==="edit")e["id"]=this.existingReport["id"];for(let t=0;t<this.inputs.length;t++){e["contained"].push(this.createObservation(this.inputs[t],t+1));e["result"].push({reference:"#embedded"+(t+1)})}const t=WebClient.PlatformContext.PlatformUri+"/fhir/DiagnosticReport"+(this.reportMode==="edit"?"/"+this.existingReport["id"]:"");let i=new Efferent.Frontend.FhirClient.FhirCall(t,this.reportMode==="edit"?"PUT":"POST");i.BodyData=JSON.stringify(e);i.FuncOk=()=>{if(window.history.state===null&&location.href.includes("reportView")){WebClient.Toaster.ShowToast("Diagnostic report created.",WebClient.Colors.Emerald,3);const e=setTimeout((()=>{WebClient.Toaster.ShowToast("Closing tab...",WebClient.Colors.PeterRiver,3);clearTimeout(e)}),2500);const t=setTimeout((()=>{WebClient.Loader.Hide();window.close();clearTimeout(t)}),3500)}else{WebClient.Loader.Hide();this.Platform.SwitchView(this.Platform.BrowsingHistory[this.Platform.BrowsingHistory.length-1],"back");WebClient.Toaster.ShowToast("Diagnostic report created.",WebClient.Colors.Emerald,3)}};i.FuncError=()=>{WebClient.Loader.Hide();WebClient.Toaster.ShowToast("Could not create diagnostic report.",WebClient.Colors.Alizarin,3)};WebClient.Loader.Show();i.Send()}createObservation(e,t){let i;if(e.hasAttribute("data-range"))i=e.getAttribute("data-range").split(",")[0];else i=e.value;const r=JSON.parse(e.getAttribute("code"));let o={resourceType:"Observation",id:"embedded"+t,valueString:i,status:"registered",code:r};return o}}ReportView.dateTypes=["date","period","range"];ReportView.inputTypes=["time","integer","shortText"];ReportView_1.ReportView=ReportView})(ReportView=ClientViews.ReportView||(ClientViews.ReportView={}))})(ClientViews=Efferent.ClientViews||(Efferent.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class ResourceBag{}ResourceBag.ReportViewCss=`.reportViewContent{overflow-y:auto}#reportBody{margin-bottom:15px}.groupNameLabel{font-weight:bold;margin-bottom:10px}.fieldContainer{display:flex;margin-bottom:15px}.textArea{padding:0 3px 0 3px;font-size:15px;outline:none;border-radius:3px}.groupContainer textarea{width:318px;height:50px;resize:none}.fieldLabel{font-size:14px;margin-right:10px;width:140px;text-overflow:ellipsis;display:inline-block;overflow:hidden}.fieldLabel:after{content:":"}.reportViewField{display:flex;margin-bottom:10px}.reportViewField input{width:200px}label>input[type=radio]{display:inline-block;width:auto}label.radioLabel{margin-right:10px}.imageSelector{width:min(100%,490px);display:flex;gap:8px;flex-wrap:wrap}.imageSelector .imageSelectorItem{width:100px;height:100px;border:2px solid #95a5a6;padding:5px;position:relative}.imageSelector .imageSelectorItem:hover .imageSelectorCheck{opacity:1}.imageSelector .imageSelectorCheck{opacity:0;background:url('data:image/svg+xml;utf8,<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14 28C21.732 28 28 21.732 28 14C28 6.26801 21.732 0 14 0C6.26801 0 0 6.26801 0 14C0 21.732 6.26801 28 14 28ZM7.33082 13.2492L11.48 17.3984L21.9292 6.94918L23.7108 8.73082L11.48 20.9616L5.54918 15.0308L7.33082 13.2492Z" fill="white" fill-opacity="0.75"/></svg>') no-repeat;position:absolute;right:8px;top:8px;width:24px;height:24px;background-size:contain}.imageSelector .imageSelectorItem.selected{border-color:#2ecc71}.imageSelector .imageSelectorItem.selected .imageSelectorCheck{opacity:1;background:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIHZpZXdCb3g9IjAgMCAyOCAyOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTI4IDE0QzI4IDIxLjczMiAyMS43MzIgMjggMTQgMjhDNi4yNjgwMSAyOCAwIDIxLjczMiAwIDE0QzAgNi4yNjgwMSA2LjI2ODAxIDAgMTQgMEMyMS43MzIgMCAyOCA2LjI2ODAxIDI4IDE0WiIgZmlsbD0iIzJFQ0M3MSIvPgo8cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTYuODIxNjggMTMuM0wxMC45NzA5IDE3LjQ0OTJMMjEuNDIgN0wyMy4yMDE3IDguNzgxNjRMMTAuOTcwOSAyMS4wMTI1TDUuMDQwMDQgMTUuMDgxNkw2LjgyMTY4IDEzLjNaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K") no-repeat;background-size:contain}.imageSelectorViewPort{flex-wrap:wrap;width:485px;display:flex;gap:6px}`;e.ResourceBag=ResourceBag})(t=e.ReportView||(e.ReportView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));