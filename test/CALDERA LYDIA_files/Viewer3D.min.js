var Efferent;(function(t){var r;(function(t){var r;(function(t){class Bounds{constructor(){this.Clear()}Clear(){this.MinX=1e6;this.MaxX=-1e6;this.MinY=1e6;this.MaxY=-1e6;this.MinZ=1e6;this.MaxZ=-1e6}GetCentroid(){return[(this.MinX+this.MaxX)/2,(this.MinY+this.MaxY)/2,(this.MinZ+this.MaxZ)/2]}Update(t,r,i){this.MinX=Math.min(this.MinX,t);this.MaxX=Math.max(this.MaxX,t);this.MinY=Math.min(this.MinY,r);this.MaxY=Math.max(this.MaxY,r);this.MinZ=Math.min(this.MinZ,i);this.MaxZ=Math.max(this.MaxZ,i)}GetExtent(){return Math.max(Math.abs(this.MinX),Math.abs(this.MinY),Math.abs(this.MinZ),Math.abs(this.MaxX),Math.abs(this.MaxY),Math.abs(this.MaxZ))}Transform(t){var r=new Bounds;var i=[this.MinX,this.MinY,this.MinZ,1];var e=t.MultiplyFromVector(i);r.Update(e[0],e[1],e[2]);i=[this.MaxX,this.MaxY,this.MaxZ,1];e=t.MultiplyFromVector(i);r.Update(e[0],e[1],e[2]);return r}AsArray(){return[this.MinX,this.MinY,this.MinZ,this.MaxX,this.MaxY,this.MaxZ]}toString(){return this.AsArray().toString()}}t.Bounds=Bounds})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(t){var r;(function(t){class Color{constructor(t,r,i,e){if(t===undefined){this.R=this.G=this.B=this.A=0}else if(Array.isArray(t)){var a=t;this.R=a[0];this.G=a[1];this.B=a[2];this.A=a[3]}else{this.R=t;this.G=r;this.B=i;this.A=e}}AsVec3(){return[this.R,this.G,this.B]}AsVec3AmbientLight(){return[this.R-.1,this.G-.1,this.B-.1]}}t.Color=Color})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(r){var i;(function(r){const i={capture:true};var e=t.Frontend.WebClient.Utils;let a;(function(t){t[t["ML"]=0]="ML";t[t["AP"]=1]="AP";t[t["CoronalView"]=2]="CoronalView";t[t["Rotate3D"]=3]="Rotate3D"})(a=r.EViewRotators||(r.EViewRotators={}));class Controller{constructor(t,e,s){this.fixFactorZoom=.5;this.startX=0;this.startY=0;this.extent=1;this.frustumSize=1;this.autoZoomFactor=1;this.PrevX=0;this.PrevY=0;this.MovX=0;this.MovY=0;this.View=t;this.onClickCallback=s;this.ViewMatrix=r.Matrix4.IdentityMatrix();this.canvas=e;this.MouseDownFixed=false;this.rotator=new r.Rotator(t.GetCanvas2D().width/2,t.GetCanvas2D().height/2,this);var n=this;this.VectorsA={};this.VectorsA[a.AP]={vector:[0,0,1],isFliped:false};this.VectorsA[a.CoronalView]={vector:[0,-1,0],isFliped:false};this.VectorsA[a.ML]={vector:[-1,0,0],isFliped:false};this.VectorsA[a.Rotate3D]={vector:[1,-1,4],isFliped:false};if(s!==undefined){t.GetCanvas2D().addEventListener("mousedown",(t=>{n.startMouseCapture(t)}),i);t.GetCanvas2D().addEventListener("wheel",(t=>{n.mousewheelListener(t,n)}),i)}}MakeOrthographic(){var t=this.View.GetAspectRatio();var i=this.extent*this.frustumSize*this.autoZoomFactor;var e=-.5*t*i;var a=.5*t*i;var s=.5*i;var n=-.5*i;var o=-this.extent*1.5;var h=this.extent*1.5;var l=1/(a-e);var v=1/(s-n);var c=1/(h-o);var u=(a+e)*l;var f=(s+n)*v;var d=(h+o)*c;return new r.Matrix4([2*l,0,0,0,0,2*v,0,0,0,0,-2*c,0,-u,-f,-d,1])}GetBox(){var t=this.View.GetAspectRatio();var r=this.extent*this.frustumSize;var i=t*r;var e=r;var a=this.extent*1.5;return[i,e,a]}SetAutoZoomFactor(t){this.autoZoomFactor=t}CalculatedAutoZoom(){var t=this.View.GetModelsBounds();var r=this.GetBox();var i=Math.abs(t.MaxX-t.MinX)/r[0];var e=Math.abs(t.MaxY-t.MinY)/r[1];var a=Math.abs(t.MaxZ-t.MinZ)/r[2];var s=Math.max(i,e,a);var n=s/this.fixFactorZoom;this.SetAutoZoomFactor(n)}Convert(t,r){var i=this.autoZoomFactor*r[0]*t[0]/this.View.GetCanvas2D().width;var e=this.autoZoomFactor*r[1]*t[1]/this.View.GetCanvas2D().height;return[i,e]}GetCanvas2D(){return this.View.GetCanvas2D()}GetContext3D(){return this.View.GetContext3D()}GetProject2D(t,r,i,e){var a=this.View.Project(t,r,i,e);return{x:a.x,y:a.y}}Update(){var t=this.MakeOrthographic();this.View.Render(this.ViewMatrix,t)}SetView3D(t,r=false){var i=r?-1:1;if(t!==a.Rotate3D){this.VectorsA[t].vector=this.VectorsA[t].vector.map((t=>t*i));this.VectorsA[t].isFliped=r?!this.VectorsA[t].isFliped:this.VectorsA[t].isFliped}switch(t){case a.AP:this.rotator.SetView(this.VectorsA[t].vector,[0,1,0],10);break;case a.CoronalView:this.rotator.SetView(this.VectorsA[t].vector,[0,0,1],10);break;case a.ML:this.rotator.SetView(this.VectorsA[t].vector,[0,0,1],10);break;case a.Rotate3D:this.rotator.SetView(this.VectorsA[t].vector,[0,1,0],20)}this.ViewMatrix=this.rotator.GetViewMatrixArray();this.CalculatedAutoZoom();this.Update()}AdjustViewport(){this.extent=this.View.GetBounds().GetExtent()}RotateView3D(t,r,i,e){this.MovX=i;this.MovY=e;if(this.MouseDownFixed){this.MouseDownFixed=false;this.PrevX=t;this.PrevY=r}this.rotator.CreateCam();this.ViewMatrix=this.rotator.GetViewMatrixArray();this.PrevX=this.MovX;this.PrevY=this.MovY;this.Update()}SetRelocateRotator(t){this.rotator.SetRelocateCam(t)}AnyRotate(t,i,s,n,o,h){try{var l=t[s];var v=this.View.GetBounds(i);var c=v.GetCentroid();var u=[l["2d"].X-this.View.GetCanvas2D().width/2,this.View.GetCanvas2D().height/2-l["2d"].Y];var f=this.Convert(u,this.GetBox());var d=[0,0,0];var x=[0,0,0];switch(h){case 0:this.VectorsA[a.AP].isFliped?d[2]=-o:d[2]=o;this.VectorsA[a.AP].isFliped?f[0]=-f[0]:f[0]=f[0];x=[f[0]+c[0],f[1]+c[1],0];break;case 1:this.VectorsA[a.CoronalView].isFliped?d[1]=o:d[1]=-o;this.VectorsA[a.CoronalView].isFliped?f[0]=-f[0]:f[0]=f[0];x=[f[0]+c[0],0,f[1]+c[2]];break;case 2:this.VectorsA[a.ML].isFliped?d[0]=o:d[0]=-o;this.VectorsA[a.ML].isFliped?f[0]=-f[0]:f[0]=f[0];x=[0,-f[0]+c[1],f[1]+c[2]];break}n.TransformMatrixLastStack=r.Matrix4.IdentityMatrix();n.TransformMatrixLastStack=n.TransformMatrixLastStack.AddTranslation(x[0],x[1],x[2]);n.TransformMatrixLastStack=n.TransformMatrixLastStack.AddRotation(d[0],d[1],d[2]);n.TransformMatrixLastStack=n.TransformMatrixLastStack.AddTranslation(-x[0],-x[1],-x[2]);n.TransformMatrix=n.TransformMatrixLastStack.MultiplyByMatrix(n.TransformMatrix)}catch(t){e.DebugConsoleLog(t)}}PickPoint3D(t,r,i=true){var e=i?this.View.GetCoordinates(t,r):{x:t,y:r};var a=this.MakeOrthographic();var s=this.View.EvaluatePickPoint(this.ViewMatrix,a,e.x,e.y);this.View.SetPickPoint(s);this.Update();return s}Zoom3D(t){this.frustumSize=t<0?this.frustumSize*.95:this.frustumSize/.95;this.Update()}startMouseCapture(t){Controller.Captured=this;Controller.mouseDown=true;Controller.isDrag=false;this.startX=this.PrevX=t.clientX;this.startY=this.PrevY=t.clientY;document.body.style["pointer-events"]="none";document.addEventListener("mouseup",this.mouseupListener,i);document.addEventListener("mousemove",this.mousemoveListener,i);t.preventDefault();t.stopPropagation()}mousemoveListener(t){if(Controller.mouseDown){var r=Controller.Captured;var i=t.clientX-r.PrevX;var e=t.clientY-r.PrevY;r.MovX=t.clientX;r.MovY=t.clientY;if(!Controller.isDrag){var a=Math.abs((t.clientX-r.startX)*(t.clientY-r.startY));if(a>9)Controller.isDrag=true}r.rotator.CreateCam();this.ViewMatrix=r.rotator.GetViewMatrixArray();r.ViewMatrix=this.ViewMatrix;r.PrevX=r.MovX;r.PrevY=r.MovY;r.Update();t.preventDefault()}}mouseupListener(t){Controller.mouseDown=false;var r=Controller.Captured;document.body.style["pointer-events"]="auto";document.removeEventListener("mouseup",r.mouseupListener,i);document.removeEventListener("mousemove",r.mousemoveListener,i);t.stopPropagation();if(!Controller.isDrag&&r.onClickCallback){var e=r.View.GetCoordinates(t.clientX,t.clientY);var a=r.MakeOrthographic();var s=r.View.EvaluatePickPoint(r.ViewMatrix,a,e.x,e.y);r.View.SetPickPoint(s);r.Update();r.onClickCallback(s)}}mousewheelListener(t,r){this.frustumSize=t.deltaY<0?this.frustumSize*.95:this.frustumSize/.95;r.Update();t.preventDefault()}}Controller.mouseDown=false;Controller.isDrag=false;r.Controller=Controller})(i=r.Viewer3D||(r.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(t){var r;(function(t){class Matrix4 extends Array{constructor(t){super(...t);Object.setPrototypeOf(this,Object.create(Matrix4.prototype))}AddTranslation(t,r,i){return this.MultiplyByMatrix(new Matrix4([1,0,0,0,0,1,0,0,0,0,1,0,t,r,i,1]))}AddRotation(t,r,i){var e=t?Math.cos(t):1;var a=t?Math.sin(t):0;var s=r?Math.cos(r):1;var n=r?Math.sin(r):0;var o=i?Math.cos(i):1;var h=i?Math.sin(i):0;return this.MultiplyByMatrix(new Matrix4([s*o,s*h,-n,0,a*n*o-e*h,a*n*h+e*o,a*s,0,e*n*o+a*h,e*n*h-a*o,e*s,0,0,0,0,1]))}AddScale(t){return this.MultiplyByMatrix(new Matrix4([t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1]))}NormalMatrix(){var t=this[0];var r=this[1];var i=this[2];var e=this[3];var a=this[4];var s=this[5];var n=this[6];var o=this[7];var h=this[8];var l=this[9];var v=this[10];var c=this[11];var u=this[12];var f=this[13];var d=this[14];var x=this[15];var m=t*s-r*a;var M=t*n-i*a;var g=t*o-e*a;var y=r*n-i*s;var w=r*o-e*s;var p=i*o-e*n;var V=h*f-l*u;var A=h*d-v*u;var D=h*x-c*u;var R=l*d-v*f;var C=l*x-c*f;var P=v*x-c*d;var F=m*P-M*C+g*R+y*D-w*A+p*V;if(!F)return null;F=1/F;return new Matrix4([(s*P-n*C+o*R)*F,(n*D-a*P-o*A)*F,(a*C-s*D+o*V)*F,0,(i*C-r*P-e*R)*F,(t*P-i*D+e*A)*F,(r*D-t*C-e*V)*F,0,(f*p-d*w+x*y)*F,(d*g-u*p-x*M)*F,(u*w-f*g+x*m)*F,0,0,0,0,1])}InvertMatrix(){var t=this[0];var r=this[4];var i=this[8];var e=this[12];var a=this[1];var s=this[5];var n=this[9];var o=this[13];var h=this[2];var l=this[6];var v=this[10];var c=this[14];var u=this[3];var f=this[7];var d=this[11];var x=this[15];var m=[n*c*f-o*v*f+o*l*d-s*c*d-n*l*x+s*v*x,o*v*u-n*c*u-o*h*d+a*c*d+n*h*x-a*v*x,s*c*u-o*l*u+o*h*f-a*c*f-s*h*x+a*l*x,n*l*u-s*v*u-n*h*f+a*v*f+s*h*d-a*l*d,e*v*f-i*c*f-e*l*d+r*c*d+i*l*x-r*v*x,i*c*u-e*v*u+e*h*d-t*c*d-i*h*x+t*v*x,e*l*u-r*c*u-e*h*f+t*c*f+r*h*x-t*l*x,r*v*u-i*l*u+i*h*f-t*v*f-r*h*d+t*l*d,i*o*f-e*n*f+e*s*d-r*o*d-i*s*x+r*n*x,e*n*u-i*o*u-e*a*d+t*o*d+i*a*x-t*n*x,r*o*u-e*s*u+e*a*f-t*o*f-r*a*x+t*s*x,i*s*u-r*n*u-i*a*f+t*n*f+r*a*d-t*s*d,e*n*l-i*o*l-e*s*v+r*o*v+i*s*c-r*n*c,i*o*h-e*n*h+e*a*v-t*o*v-i*a*c+t*n*c,e*s*h-r*o*h-e*a*l+t*o*l+r*a*c-t*s*c,r*n*h-i*s*h+i*a*l-t*n*l-r*a*v+t*s*v];var M=t*m[0]+a*m[4]+h*m[8]+u*m[12];if(M===0)throw new Error("Can't invert matrix, determinant is 0");for(var g=0;g<m.length;g++)m[g]/=M;return new Matrix4(m)}MultiplyFromVector(t){return[t[0]*this[0]+t[1]*this[4]+t[2]*this[8]+t[3]*this[12],t[0]*this[1]+t[1]*this[5]+t[2]*this[9]+t[3]*this[13],t[0]*this[2]+t[1]*this[6]+t[2]*this[10]+t[3]*this[14],t[0]*this[3]+t[1]*this[7]+t[2]*this[11]+t[3]*this[15]]}MultiplyByMatrix(t){var r=this[0];var i=this[1];var e=this[2];var a=this[3];var s=this[4];var n=this[5];var o=this[6];var h=this[7];var l=this[8];var v=this[9];var c=this[10];var u=this[11];var f=this[12];var d=this[13];var x=this[14];var m=this[15];var M=t[0];var g=t[1];var y=t[2];var w=t[3];var p=t[4];var V=t[5];var A=t[6];var D=t[7];var R=t[8];var C=t[9];var P=t[10];var F=t[11];var T=t[12];var E=t[13];var b=t[14];var B=t[15];return new Matrix4([M*r+g*s+y*l+w*f,M*i+g*n+y*v+w*d,M*e+g*o+y*c+w*x,M*a+g*h+y*u+w*m,p*r+V*s+A*l+D*f,p*i+V*n+A*v+D*d,p*e+V*o+A*c+D*x,p*a+V*h+A*u+D*m,R*r+C*s+P*l+F*f,R*i+C*n+P*v+F*d,R*e+C*o+P*c+F*x,R*a+C*h+P*u+F*m,T*r+E*s+b*l+B*f,T*i+E*n+b*v+B*d,T*e+E*o+b*c+B*x,T*a+E*h+b*u+B*m])}ExtractRotation(){return new Matrix4([this[0],this[1],this[2],0,this[4],this[5],this[6],0,this[8],this[9],this[10],0,0,0,0,1])}ExtractTranslation(){return new Matrix4([1,0,0,0,0,1,0,0,0,0,1,0,this[12],this[13],this[14],1])}SetTranslation(t){this[12]=t[0];this[13]=t[1];this[14]=t[2]}ExtractTranslationV(){return[this[12],this[13],this[14]]}static IdentityMatrix(){return new Matrix4([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static TranslationMatrix(t,r,i){return new Matrix4([1,0,0,0,0,1,0,0,0,0,1,0,t,r,i,1])}}t.Matrix4=Matrix4})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(t){var r;(function(t){class Model{constructor(r,i,e,a,s){this.Name=r;this.Normals=e;this.Vertices=i;this.Color=s;this.TrianglesCount=this.Vertices.length/9;this.TransformMatrix=t.Matrix4.IdentityMatrix();this.TransformMatrixLastStack=this.TransformMatrix;this.TempoRorMatrix=t.Matrix4.IdentityMatrix();this.TempoTrMatrix=t.Matrix4.IdentityMatrix();this.BoundingCube=a}GetBoundingCube(t){this.BoundingCube=t}RelocateModel(){var t=this.BoundingCube.GetCentroid();this.TransformMatrix=this.TransformMatrix.AddTranslation(-t[0],-t[1],-t[2]);this.Offset=t}GetOffset(){return this.Offset}GetHorizontalProjection(t){var r=[];var i=[];for(var e=0;e<this.Vertices.length;e+=9){r=[];var a=this.Vertices[e+2]-t;var s=this.Vertices[e+5]-t;var n=this.Vertices[e+8]-t;var o=(a===0?1:0)+(s===0?1:0)+(n===0?1:0);if(o===3){r.push(this.point2D(this.Vertices[e],this.Vertices[e+1]));r.push(this.point2D(this.Vertices[e+3],this.Vertices[e+4]));r.push(this.point2D(this.Vertices[e+6],this.Vertices[e+7]))}if(o===2){if(a===0)r.push(this.point2D(this.Vertices[e],this.Vertices[e+1]));if(s===0)r.push(this.point2D(this.Vertices[e+3],this.Vertices[e+4]));if(n===0)r.push(this.point2D(this.Vertices[e+6],this.Vertices[e+7]))}if(o>0)continue;if(a/s>0&&s/n>0)continue;if(a/s<0)r.push(this.calculateCrossingPoint(t,e,e+3));if(a/n<0)r.push(this.calculateCrossingPoint(t,e,e+6));if(s/n<0)r.push(this.calculateCrossingPoint(t,e+3,e+6));i.push(r)}return i}point2D(t,r){return{x:t,y:r}}calculateCrossingPoint(t,r,i){var e=this.Vertices[r];var a=this.Vertices[r+1];var s=this.Vertices[r+2];var n=this.Vertices[i];var o=this.Vertices[i+1];var h=this.Vertices[i+2];var l=(n-e)*(t-s)/(h-s)+e;var v=(o-a)*(t-s)/(h-s)+a;return{x:l,y:v}}}t.Model=Model})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(t){var r;(function(t){class PickPoint{constructor(t,r,i){this.model=t;this.facet=r;this.facetIndex=i}}t.PickPoint=PickPoint})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(t){var r;(function(t){class Rotator{constructor(t,r,i){this.controller=i;this.unitx=[0,0,0];this.unity=[0,0,0];this.unitz=[0,0,0];this.centerX=t;this.centerY=r;this.radius2=Math.pow(Math.min(this.centerX,this.centerY),2);this.vectorRelocate=[0,0,0]}CreateCam(){var t=this.ToRay(this.controller.PrevX,this.controller.PrevY);var r=this.ToRay(this.controller.MovX,this.controller.MovY);this.ApplyTransvection(t,r)}Copy(t){var r=new Array;r=[t[0],t[1],t[2]];return r}Cross(t,r){return[t[1]*r[2]-t[2]*r[1],t[2]*r[0]-t[0]*r[2],t[0]*r[1]-t[1]*r[0]]}Add(t,r){return[t[0]+r[0],t[1]+r[1],t[2]+r[2]]}Subtract(t,r){return[t[0]-r[0],t[1]-r[1],t[2]-r[2]]}Scale(t,r){return[t[0]*r,t[1]*r,t[2]*r]}Normalize(t){var r=this.Module(t);if(r!==0)return[t[0]/r,t[1]/r,t[2]/r];else return[t[0],t[1],t[2]]}Dot(t,r){return t[0]*r[0]+t[1]*r[1]+t[2]*r[2]}Module(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}GetViewMatrix(){return this.GetViewMatrixArray()}SetRelocateCam(t){this.vectorRelocate=t}GetRelocateCam(){return this.vectorRelocate}GetViewMatrixArray(){return new t.Matrix4([this.unitx[0],this.unity[0],this.unitz[0],0,this.unitx[1],this.unity[1],this.unitz[1],0,this.unitx[2],this.unity[2],this.unitz[2],0,0,0,-this.viewZ,1]).AddTranslation(-this.vectorRelocate[0],-this.vectorRelocate[1],-this.vectorRelocate[2])}GetViewDistance(){return this.viewZ}SetViewDistance(t){this.viewZ=t}ReflectInAxis(t,r){var i=2*(t[0]*r[0]+t[1]*r[1]+t[2]*r[2]);return[i*t[0]-r[0],i*t[1]-r[1],i*t[2]-r[2]]}ApplyTransvection(t,r){t=this.Normalize(t);r=this.Normalize(r);var i=[0,0,0];i=this.Add(t,r);i=this.Normalize(i);var e=[0,0,0];e=this.ReflectInAxis(i,this.unitz);this.unitz=this.ReflectInAxis(t,e);e=this.ReflectInAxis(i,this.unitx);this.unitx=this.ReflectInAxis(t,e);e=this.ReflectInAxis(i,this.unity);this.unity=this.ReflectInAxis(t,e)}SetView(t,r,i){this.viewpoint=t;this.viewup=r;this.viewZ=i;this.unitz=this.Copy(this.viewpoint);this.unitz=this.Normalize(this.unitz);this.unity=this.Copy(this.unitz);this.unity=this.Scale(this.unity,this.Dot(this.unitz,this.viewup));this.unity=this.Subtract(this.viewup,this.unity);this.unity=this.Normalize(this.unity);this.unitx=this.Cross(this.unity,this.unitz)}ToRay(t,r){var i=t-this.centerX;var e=this.centerY-r;var a=i*this.unitx[0]+e*this.unity[0];var s=i*this.unitx[1]+e*this.unity[1];var n=i*this.unitx[2]+e*this.unity[2];var o=a*a+s*s+n*n;if(o>this.radius2){return[a,s,n]}else{var h=Math.sqrt(this.radius2-o);return[a+h*this.unitz[0],s+h*this.unitz[1],n+h*this.unitz[2]]}}}t.Rotator=Rotator})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(t){var r;(function(t){t.fragmentShader=`precision mediump float;\nvarying mediump vec4 lighting;\n\nvoid main(void)\n{\n    gl_FragColor = lighting;\n}\n`;t.vertexShader=`precision mediump float;\n\nconst vec3 ambientLight = vec3(0.1, 0.1, 0.1);\nconst vec3 directionalVector = normalize(vec3(0.0, 0.0, 1.0));\n\nuniform mat4 pview;\nuniform mat4 model;\nuniform mat4 normalTransform;\nuniform vec3 color;\n\nattribute vec3 vertexCoord;\nattribute vec3 vertexNormal;\n\nvarying mediump vec4 lighting;\n\nvoid main()\n{\n    gl_Position = pview * model * vec4(vertexCoord, 1.0);\n\n    highp vec4 transformedNormal = normalTransform * vec4(vertexNormal, 1.0);\n    highp float directional = max(dot(transformedNormal.xyz, directionalVector), 0.0);\n    \n    lighting = vec4(color * directional, 1.0);\n}\n`})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(t){var r;(function(t){class StlLoader{constructor(r){this.name=r;this.bounds=new t.Bounds}loadStl(t){var r;var i=new DataView(t);var e="";for(var a=0;a<80;a++)e+=String.fromCharCode(i.getUint8(a));var s=!e.match(/^\s*solid/i);try{if(s){r=this.parseBinaryStl(i)}else{var n=new TextDecoder("utf-8");var o=n.decode(i);r=this.parseAsciiStl(o)}}catch(t){return null}return r}parseBinaryStl(r){var i=r.getUint32(80,true);var e=new Float32Array(i*9);var a=new Float32Array(i*9);var s=84;var n=0;var o=0;for(var h=0;h<i;h++){for(var l=0;l<3;l++){for(var v=0,c=s;v<3;v++,c+=4)a[o++]=r.getFloat32(c,true)}s+=12;for(var l=0,c=s;l<3;l++){for(var v=0,u=n;v<3;v++,c+=4)e[n++]=r.getFloat32(c,true);this.bounds.Update(e[u],e[u+1],e[u+2])}s+=38}return new t.Model(this.name,e,a,this.bounds,null)}parseAsciiStl(r){var i=r.split("\n");var e=new Array(i.length);for(var a=0;a<i.length;a++)e[a]=i[a].trim().split(/\s+/);var s=[];var n=[];var a=0;while(a<e.length){if(e[a][0]==="facet"){var o=3;while(o--)s.push(e[a][2],e[a][3],e[a][4]);a+=2;o=3;while(o--){n.push(e[a][1],e[a][2],e[a][3]);a++}}else{a++}}var h;var l;var v;for(var a=0;a<n.length;){h=parseFloat(n[a].trim());n[a++]=h;l=parseFloat(n[a].trim());n[a++]=l;v=parseFloat(n[a].trim());n[a++]=v;this.bounds.Update(h,l,v)}for(var a=0;a<s.length;a++)s[a]=parseFloat(s[a].trim());var c=Float32Array.from(n);var u=Float32Array.from(s);return new t.Model(this.name,c,u,this.bounds,null)}static LoadStl(t,r){var i=new StlLoader(r);return i.loadStl(t)}}t.StlLoader=StlLoader})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(r){var i;(function(r){class View{constructor(t){this.canvas=t;var r=this.canvas.parentElement;this.canvas2D=document.createElement("canvas");this.canvas2D.setAttribute("width",this.canvas.getAttribute("width"));this.canvas2D.setAttribute("height",this.canvas.getAttribute("height"));this.canvas2D.style.background="transparent";this.canvas2D.style.pointerEvents="none";this.canvas2D.style.position="absolute";this.canvas2D.style.left="0";this.canvas2D.style.top="0";this.canvas2D.tabIndex=1;r.appendChild(this.canvas2D);this.gl=t.getContext("webgl")||t.getContext("experimental-webgl");this.models=[];this.init();this.zLevelProjection=10}GetAspectRatio(){return this.canvas.width/this.canvas.height}GetCoordLocation(){return this.coordLocation}GetNormalLocation(){return this.normalLocation}GetModelsBounds(){return this.GetBounds(this.models)}GetBounds(t){var i=new r.Bounds;var e=new Array;if(t!==undefined)e=t;else e=this.models;for(var a=0;a<e.length;a++){var s=e[a];var n=s.BoundingCube.Transform(r.Matrix4.IdentityMatrix());i.Update(n.MinX,n.MinY,n.MinZ);i.Update(n.MaxX,n.MaxY,n.MaxZ)}return i}GetNormalTransformRef(){return this.normalTransformRef}GetModelRef(){return this.modelRef}GetColorRef(){return this.colorRef}GetCoordinates(t,r){var i=this.canvas.getBoundingClientRect();return{x:t-i.left,y:r-i.top}}SetPickPoint(t){this.pickedPoint=t}SetZLevelProjection(t){this.zLevelProjection=t}AddModel(t){this.models.push(t);t.VertexBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t.VertexBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,t.Vertices,this.gl.STATIC_DRAW);t.NormalsBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t.NormalsBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,t.Normals,this.gl.STATIC_DRAW)}GetModels(){return this.models}GetModelByName(t){return this.models.filter((r=>r.Name===t)).pop()}Render(t,r,i,e){var a=r.MultiplyByMatrix(t);this.gl.uniformMatrix4fv(this.pviewRef,false,a);this.gl.clearColor(0,0,0,0);this.gl.viewport(0,0,this.canvas.width,this.canvas.height);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.RenderModels(t);if(this.pickedPoint!==undefined)this.renderPoint(this.pickedPoint.model,a,this.pickedPoint.point.x,this.pickedPoint.point.y,this.pickedPoint.point.z);else this.clearPoints()}RenderLine3D(r,i){try{var e=new Float32Array(r);var a=[1,1,1,1,1,1];var s=new Float32Array(a);var n=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n);this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);var o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o);this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW);this.gl.uniformMatrix4fv(this.normalTransformRef,false,t.Frontend.Viewer3D.Matrix4.IdentityMatrix());const h=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,h);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1]),this.gl.STATIC_DRAW);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n);this.gl.vertexAttribPointer(this.coordLocation,3,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(this.coordLocation);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o);this.gl.vertexAttribPointer(this.normalLocation,3,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(this.normalLocation);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,h);this.gl.uniformMatrix4fv(this.modelRef,false,t.Frontend.Viewer3D.Matrix4.IdentityMatrix());this.gl.uniform3fv(this.colorRef,i?i:[1-.1,1-1,1-.1]);this.gl.drawArrays(this.gl.LINES,0,2)}catch(t){}}EvaluatePickPoint(t,r,i,e){var a=r.MultiplyByMatrix(t);return this.getPickTriangle(a,i,e)}Project(t,r,i,e){var a=e.MultiplyFromVector([t,r,i,1]);var t=(1+a[0])*this.canvas.width/2;var r=(1-a[1])*this.canvas.height/2;return{x:t,y:r,z:a[2]}}GetCanvas2D(){return this.canvas2D}GetContext3D(){return this.gl}clearPoints(){var t=this.canvas2D;var r=t.getContext("2d");r.clearRect(0,0,this.canvas2D.width,this.canvas2D.height)}RenderModels(t){for(var r=0;r<this.models.length;r++){var i=this.models[r];this.gl.uniformMatrix4fv(this.normalTransformRef,false,t.NormalMatrix().MultiplyByMatrix(i.TransformMatrix.ExtractRotation()));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.VertexBuffer);this.gl.vertexAttribPointer(this.coordLocation,3,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(this.coordLocation);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.NormalsBuffer);this.gl.vertexAttribPointer(this.normalLocation,3,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(this.normalLocation);i.GetBoundingCube(this.GetBounds());this.gl.uniformMatrix4fv(this.modelRef,false,i.TransformMatrix);this.gl.uniform3fv(this.colorRef,i.Color.AsVec3());this.gl.drawArrays(this.gl.TRIANGLES,0,i.TrianglesCount*3)}}renderPoint(t,r,i,e,a){var s=this.canvas2D;var n=s.getContext("2d");n.strokeStyle="#ff0000";n.clearRect(0,0,1e3,600);n.lineWidth=1;var o=r.MultiplyByMatrix(t.TransformMatrix);var h=this.Project(i,e,a,o);n.beginPath();n.moveTo(h.x-5,h.y);n.lineTo(h.x+5,h.y);n.moveTo(h.x,h.y-5);n.lineTo(h.x,h.y+5);n.stroke();n.closePath()}renderPolygon(t){var r=this.canvas2D;var i=r.getContext("2d");i.strokeStyle="#ff0000";i.lineWidth=1;i.beginPath();var e=this.convert2D(t[0],t[2]);i.moveTo(e.x,e.y);for(var a=0;a<t.length-3;a=a+3){var s=this.convert2D(t[a],t[a+1]);i.lineTo(s.x,s.y)}i.stroke();i.closePath()}convert2D(t,r){var i=t+this.canvas.width/2;var e=this.canvas.height/2-r;return{x:i,y:e}}renderRect(){var t=this.canvas2D;var r=t.getContext("2d");r.strokeStyle="#ff0000";r.clearRect(0,0,1e3,600);r.lineWidth=1;var i=300;var e=150;var a=this.convert2D(i,e);var s=this.convert2D(i,-e);var n=this.convert2D(-i,-e);var o=this.convert2D(-i,e);r.beginPath();r.moveTo(a.x,a.y);r.lineTo(s.x,s.y);r.lineTo(n.x,n.y);r.lineTo(o.x,o.y);r.lineTo(a.x,a.y);r.stroke();r.closePath()}render3DAxis(t,r){var i=this.canvas2D.getContext("2d");i.strokeStyle="#0000ff";i.lineWidth=1;var e=r.MultiplyByMatrix(t.TransformMatrix);var a=this.Project(0,0,0,e);var s=this.Project(15,0,0,e);var n=this.Project(0,30,0,e);var o=this.Project(0,0,45,e);i.beginPath();i.moveTo(s.x,s.y);i.lineTo(a.x,a.y);i.lineTo(n.x,n.y);i.moveTo(a.x,a.y);i.lineTo(o.x,o.y);i.stroke();i.closePath()}renderTriangle(t,r,i,e,a,s,n,o,h,l,v){var c=this.canvas2D.getContext("2d");c.strokeStyle="#ff0000";c.lineWidth=1;var u=r.MultiplyByMatrix(t.TransformMatrix);var f=this.Project(i,e,a,u);var d=this.Project(s,n,o,u);var x=this.Project(h,l,v,u);c.beginPath();c.moveTo(f.x,f.y);c.lineTo(d.x,d.y);c.lineTo(x.x,x.y);c.lineTo(f.x,f.y);c.stroke();c.closePath()}evalCandidates(t,r,i){var e=[];var a=this.canvas.width/2;var s=this.canvas.height/2;for(var n=0;n<this.models.length;n++){var o=this.models[n];var h=o.Vertices;var l=t.MultiplyByMatrix(o.TransformMatrix);for(var v=0;v<o.TrianglesCount;v++){var c=v*9;var u=l.MultiplyFromVector([h[c],h[c+1],h[c+2],1]);var f=(1+u[0])*a;var d=(1-u[1])*s;var x=u[2];u=l.MultiplyFromVector([h[c+3],h[c+4],h[c+5],1]);var m=(1+u[0])*a;var M=(1-u[1])*s;var g=u[2];u=l.MultiplyFromVector([h[c+6],h[c+7],h[c+8],1]);var y=(1+u[0])*a;var w=(1-u[1])*s;var p=u[2];var V=(r-m)*(d-M)-(f-m)*(i-M);var A=(r-y)*(M-w)-(m-y)*(i-w);var D=(r-f)*(w-d)-(y-f)*(i-d);var R=V<0||A<0||D<0;var C=V>0||A>0||D>0;if(!(R&&C)){var P=(x+g+p)/3;e.push([o,v,P,{x:f,y:d,z:x},{x:m,y:M,z:g},{x:y,y:w,z:p}])}}}return e}getPickTriangle(t,i,e){var a;var s;var n;var o=this.evalCandidates(t,i,e);for(var h=0;h<o.length;h++){if(n===undefined||o[h][2]<n){var l=o[h][0];var v=o[h][1];a=new r.PickPoint(l,l.Vertices.slice(v*9,v*9+9),v);n=o[h][2];s=h}}if(s!==undefined)a.point=this.calculateClickCoord(a,o[s],i,e);return a}calculatePoint3DProjected(t,r,i){var e=t.x+i*(r.x-t.x);var a=t.y+i*(r.y-t.y);var s=t.z+i*(r.z-t.z);return{x:e,y:a,z:s}}calculatePointProjected(t,r,i,e){var a=i.x-r.x;var s=i.y-r.y;var n=e.x-t.x;var o=e.y-t.y;var h=o*a-s*n;var l=0;if(Math.abs(h)>1e-6)l=((t.x-r.x)*s-(t.y-r.y)*a)/h;var v=t.x+l*n;var c=t.y+l*o;return{x:v,y:c}}moduleVector2D(t,r){return Math.sqrt((r.x-t.x)*(r.x-t.x)+(r.y-t.y)*(r.y-t.y))}moduleVector3D(t,r){return Math.sqrt((r.x-t.x)*(r.x-t.x)+(r.y-t.y)*(r.y-t.y)+(r.z-t.z)*(r.z-t.z))}normalize2dCanvas(t,r,i){var e=t-this.canvas.width/2;var a=this.canvas.height/2-r;var s=i;return{x:e,y:a,z:s}}calculateClickCoord(t,r,i,e){var a=t.facet;var s=this.normalize2dCanvas(r[3].x,r[3].y,r[3].z);var n=this.normalize2dCanvas(r[4].x,r[4].y,r[4].z);var o=this.normalize2dCanvas(r[5].x,r[5].y,r[5].z);var h=this.normalize2dCanvas(i,e,0);var l=this.calculatePointProjected(s,n,o,h);var v=0;var c=0;if(this.moduleVector2D(s,l)!==0)v=this.moduleVector2D(s,h)/this.moduleVector2D(s,l);if(this.moduleVector2D(n,o)!==0)c=this.moduleVector2D(n,l)/this.moduleVector2D(n,o);var u={x:a[0],y:a[1],z:a[2]};var f={x:a[3],y:a[4],z:a[5]};var d={x:a[6],y:a[7],z:a[8]};var x;var m;x=this.calculatePoint3DProjected(f,d,c);m=this.calculatePoint3DProjected(u,x,v);return{x:m.x,y:m.y,z:m.z}}init(){this.gl.enable(this.gl.DEPTH_TEST);var t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,r.vertexShader);this.gl.compileShader(t);var i=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(i,r.fragmentShader);this.gl.compileShader(i);this.shaderProgram=this.gl.createProgram();this.gl.attachShader(this.shaderProgram,t);this.gl.attachShader(this.shaderProgram,i);this.gl.linkProgram(this.shaderProgram);this.gl.useProgram(this.shaderProgram);this.pviewRef=this.gl.getUniformLocation(this.shaderProgram,"pview");this.modelRef=this.gl.getUniformLocation(this.shaderProgram,"model");this.normalTransformRef=this.gl.getUniformLocation(this.shaderProgram,"normalTransform");this.colorRef=this.gl.getUniformLocation(this.shaderProgram,"color");this.coordLocation=this.gl.getAttribLocation(this.shaderProgram,"vertexCoord");this.normalLocation=this.gl.getAttribLocation(this.shaderProgram,"vertexNormal")}}r.View=View})(i=r.Viewer3D||(r.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));var Efferent;(function(t){var r;(function(t){var r;(function(t){class Viewer3D{constructor(r,i){this.models=[];this.View=new t.View(r);this.Controller=new t.Controller(this.View,r,i)}AddStlModel(t,r){t.Color=r;this.models.push(t);this.View.AddModel(t)}}t.Viewer3D=Viewer3D})(r=t.Viewer3D||(t.Viewer3D={}))})(r=t.Frontend||(t.Frontend={}))})(Efferent||(Efferent={}));