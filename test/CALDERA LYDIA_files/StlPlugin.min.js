var Vue;(function(e){var t;(function(e){var t;(function(e){class Annotation3D{constructor(){this.Is3D=true}Render(){}HitTest(e,t){return null}EvaluateAnnotationTextInCanvas(e){return null}MeasureAnnotation(e,t,o){}DrawGrips(){}DrawSnaps(){}Serialize(){return null}Deserialize(e){}ConvertPointsWithFactororResolution(e){}GetTemplate(){return null}DrawIsValid(){return null}EvaluatePointDragMoveAndEnd(e,t,o){return null}DonePointDragMoveAndEnd(e,t,o){}}e.Annotation3D=Annotation3D})(t=e.StlPlugin||(e.StlPlugin={}))})(t=e.Products||(e.Products={}))})(Vue||(Vue={}));var Vue;(function(e){var t;(function(e){var t;(function(e){var t=Efferent.Frontend.WebClient;var o=Efferent.ClientViews.ImagingStudyView;class Arrow3DAnnotation extends e.Annotation3D{constructor(){super();this.TextboxLabel=new Array;this.Visible=true;this.Name=this.constructor.name;this.Namespace="Vue.Products.StlPlugin";this.Points={};this.Points["EndPoints"]=new Array;this.Points["Label"]=new Array;this.SnapPoints=new Array;this.UnSelectToExecuteClickOnViewport=true;this.IsReferenced=false;this.ShowSnaps=false;this.IsReferable=true;this.FactorScale=1}Render(){var e=this.Context.Canvas2DProjected.getContext("2d");var n=1;var r=Math.round(11/n*10)/10;var a=8;var s;var l;e.lineWidth=this.Status!==o.EAnnotationStatus.Complete||this.Selected!==true?2/n:1/n;e.strokeStyle=this.Status===o.EAnnotationStatus.Complete?t.Colors.SunFlower:t.Colors.SunFlower;e.strokeStyle=this.Selected===true?t.Colors.Emerald:e.strokeStyle;e.font=r+"pt Segoe UI, Arial, Tahoma, Verdana, sans-serif";e.fillStyle=t.Colors.SunFlower;e.textAlign="center";e.textBaseline="bottom";this.renderIncomplete();this.TemporalCurrentGroupName=null;this.TemporalPoint=null;var h=this.Context.Viewport.GetPointsGroupConvert(this.Points["EndPoints"]);var u=this.Context.Viewport.GetPointsGroupConvert(this.Points["Label"]);var A=10/n;if(h.length===2)e.drawArrow(e,h[1].X,h[1].Y,h[0].X,h[0].Y,A);if(this.TextLabel!==undefined&&u.length>0){s=(h[0].X+h[1].X)/2;l=(h[0].Y+h[1].Y)/2;if(h[1].X!==u[0].X||h[1].Y!==u[0].Y){e.dashedLine(e,s,l,u[0].X,u[0].Y,3/n)}var d=this.Context.Viewport.AnnotationManager.DrawAnnotationText(e,s,l,u[0].X,u[0].Y,this.TextLabel,a);this.TextboxLabel[0]={X0:d.X0,X1:d.X1,Y0:d.Y0,Y1:d.Y1,Text:this.TextLabel}}if(this.Selected){this.DrawGrips()}}HitTest(e,t){var n=this.Context.Viewport.GetPointsGroupConvert(this.Points["EndPoints"]);if(e!==undefined&&n.length>0){if(o.Geometry.PointToLine(e.X,e.Y,n[0].X,n[0].Y,n[1].X,n[1].Y)<t)return{isFound:true,groupName:"EndPoints",endRangePoints:"0,0-1,1"}}return{isFound:false,groupName:null,endRangePoints:""}}EvaluateAnnotationTextInCanvas(e){if(this.TextboxLabel!==undefined&&this.TextboxLabel.length>0)return Efferent.ClientViews.ImagingStudyView.AnnotationManager.EvaluateAnnotationTextInCanvas(this.TextboxLabel[0],e);return false}MeasureAnnotation(){return""}DrawGrips(){}DrawSnaps(){}Serialize(){var e="";var t={Author:this.Author,Date:this.Date,Id:this.Id,Name:this.Name,Plugin:this.Plugin,Points:this.Points,TextLabel:this.TextLabel,TextboxLabel:this.TextboxLabel,Type:this.Type,Visible:this.Visible,SeriesGuid:this.Context.SeriesGuid,Namespace:this.Namespace};e=JSON.stringify(t);return e}Deserialize(e){var t=JSON.parse(e);this.Id=t["Id"]||t["id"];this.Author=t["Author"]||t["author"];this.Date=t["Date"]||t["date"];this.Type=t["Type"]||t["type"];this.Plugin=t["Plugin"]||t["plugin"];this.Selected=t["Selected"]||t["selected"];this.Status=t["Status"]||t["status"];this.TextLabel=t["TextLabel"]||t["TextLabel"];this.TextboxLabel=t["TextboxLabel"]||t["textboxLabel"];var n=t["Points"]||t["points"];this.Points=o.AnnotationController.ConvertSamplePoints(n);this.Visible=t["Visible"]||t["visible"];this.Name=t["Name"]||t["name"]}GetTemplate(){var t=e.ResourceBag.Arrow3DTemplateJson;return t}DrawIsValid(){var e=false;var t=3;var n=this.Context.Viewport.GetPointsGroupConvert(this.Context.CurrentAnnotation.Points["EndPoints"]);if(n.length===2){var r=o.Geometry.GetRealDistance(n[0],n[1],this.Context);e=r>t}else e=true;return e}EvaluatePointDragMoveAndEnd(e,t,o){return true}DonePointDragMoveAndEnd(e,t,o){}renderIncomplete(){if(this.TemporalPoint===undefined||this.TemporalPoint===null||this.TemporalCurrentGroupName===undefined||this.TemporalCurrentGroupName===null)return;if(this.Status===o.EAnnotationStatus.Complete)return;try{var e=this.Context.Canvas2DProjected.getContext("2d");var n=1;var r=Math.round(11/n*10)/10;var a=10/n;e.lineWidth=1;e.strokeStyle=this.Selected===true?t.Colors.Emerald:t.Colors.SunFlower;e.font=10+"pt Segoe UI, Arial, Tahoma, Verdana, sans-serif";e.fillStyle=t.Colors.SunFlower;e.textAlign="center";e.textBaseline="bottom";var s=this.Context.Viewport.GetPointsGroupConvert(this.Points["EndPoints"]);if(this.Points[this.TemporalCurrentGroupName].length===1){e.drawArrow(e,this.TemporalPoint.X,this.TemporalPoint.Y,s[0].X,s[0].Y,a)}}catch(e){}}}e.Arrow3DAnnotation=Arrow3DAnnotation})(t=e.StlPlugin||(e.StlPlugin={}))})(t=e.Products||(e.Products={}))})(Vue||(Vue={}));var Vue;(function(e){var t;(function(e){var t;(function(e){var t=Efferent.Frontend.WebClient;var o=Efferent.ClientViews.ImagingStudyView;class Line3DAnnotation extends e.Annotation3D{constructor(){super();this.TextboxLabel=new Array;this.Visible=true;this.Name=this.constructor.name;this.Namespace="Vue.Products.StlPlugin";this.Points={};this.Points["EndPoints"]=new Array;this.Points["Label"]=new Array;this.ExportedPoints=[];this.Vectors={};this.UnSelectToExecuteClickOnViewport=true;this.IsReferenced=false;this.ShowSnaps=false;this.IsReferable=true;this.FactorScale=1}Render(){var e=this.Context.Canvas2DProjected.getContext("2d");var n=this.Context.ContextGl3D;var r=1;var a=Math.round(11/r*10)/10;var s=8;var l;var h;e.lineWidth=this.Status!==o.EAnnotationStatus.Complete||this.Selected!==true?1:1;e.strokeStyle=this.Status===o.EAnnotationStatus.Complete?t.Colors.SunFlower:t.Colors.Emerald;e.strokeStyle=this.Selected===true?t.Colors.Emerald:e.strokeStyle;e.font=a+"pt Segoe UI, Arial, Tahoma, Verdana, sans-serif";e.fillStyle=t.Colors.SunFlower;e.textAlign="center";e.textBaseline="bottom";e.shadowOffsetX=0;e.shadowOffsetY=0;e.shadowColor=t.Colors.FullBlack;e.shadowBlur=8;this.renderIncomplete();this.TemporalCurrentGroupName=null;this.TemporalPoint=null;var u=this.Context.Viewport.GetPointsGroupConvert(this.Points["EndPoints"]);if(u.length===2){this.Points["Label"]=[];this.DrawTextLabel(e,u[0],u[1],true)}var A=this.Points["Label"];if(this.Status===o.EAnnotationStatus.Complete){l=(u[0].X+u[1].X)/2;h=(u[0].Y+u[1].Y)/2;if(u[1].X!==A[0].X||u[1].Y!==A[0].Y){e.dashedLine(e,l,h,A[0].X,A[0].Y,1)}var d=this.MeasureAnnotation(this.Points["EndPoints"][0],this.Points["EndPoints"][1],null,true);var C=this.Context.Viewport.AnnotationManager.DrawAnnotationText(e,l,h,A[0].X,A[0].Y,d,s);this.TextboxLabel[0]={X0:C.X0,X1:C.X1,Y0:C.Y0,Y1:C.Y1,Text:d}}if(this.Selected){this.DrawGrips()}}HitTest(e,t){var n=this.Context.Viewport.GetPointsGroupConvert(this.Points["EndPoints"]);if(e!==undefined&&n.length>0){if(o.Geometry.PointToLine(e.X,e.Y,n[0].X,n[0].Y,n[1].X,n[1].Y)<t)return{isFound:true,groupName:"EndPoints",endRangePoints:"0,0-1,1"}}return{isFound:false,groupName:null,endRangePoints:""}}EvaluateAnnotationTextInCanvas(e){if(this.TextboxLabel!==undefined&&this.TextboxLabel.length>0)return Efferent.ClientViews.ImagingStudyView.AnnotationManager.EvaluateAnnotationTextInCanvas(this.TextboxLabel[0],e);return false}MeasureAnnotation(e,t,o,n=true){var r="";var a="mm";var s=!n?this.Context.Viewport.GetPointsGroupConvert(this.Points["EndPoints"]):this.Points["EndPoints"];var l;if(e===undefined||e===null)e=s[0];if(t===undefined||t===null)t=s[1];var h=e.X;var u=e.Y;var A=t.X;var d=t.Y;if(!n){l=Math.sqrt((A-h)*(A-h)+(d-u)*(d-u));r=parseFloat(l.toFixed(1))+" "+a}else{var C=e["Z"];var c=t["Z"];l=Math.sqrt((A-h)*(A-h)+(d-u)*(d-u)+(c-C)*(c-C));r=parseFloat(l.toFixed(1))+" "+a}return r}DrawGrips(){}DrawSnaps(){}Serialize(){var e="";var t={Author:this.Author,Date:this.Date,Id:this.Id,Name:this.Name,Plugin:this.Plugin,Points:this.Points,TextboxLabel:this.TextboxLabel,Type:this.Type,Visible:this.Visible,SeriesGuid:this.Context.SeriesGuid,Namespace:this.Namespace};e=JSON.stringify(t);return e}Deserialize(e){var t=JSON.parse(e);this.Id=t["Id"]||t["id"];this.Author=t["Author"]||t["author"];this.Date=t["Date"]||t["date"];this.Type=t["Type"]||t["type"];this.Plugin=t["Plugin"]||t["plugin"];this.Selected=t["Selected"]||t["selected"];this.Status=t["Status"]||t["status"];this.Step=t["Step"]||t["step"];this.TextboxLabel=t["TextboxLabel"]||t["textboxLabel"];var n=t["Points"]||t["points"];this.Points=o.AnnotationController.ConvertSamplePoints(n);this.Visible=t["Visible"]||t["visible"];this.Name=t["Name"]||t["name"]}GetTemplate(){var t=e.ResourceBag.Line3DTemplateJson;return t}DrawIsValid(){var e=false;var t=3;var n=this.Context.Viewport.GetPointsGroupConvert(this.Context.CurrentAnnotation.Points["EndPoints"]);if(n.length===2){var r=o.Geometry.GetRealDistance(n[0],n[1],this.Context);e=r>t}else e=true;return e}EvaluatePointDragMoveAndEnd(e,t,o){return true}DonePointDragMoveAndEnd(e,t,o){}renderIncomplete(){if(this.TemporalPoint===undefined||this.TemporalPoint===null||(this.TemporalCurrentGroupName===undefined||this.TemporalCurrentGroupName===null))return;if(this.Status===o.EAnnotationStatus.Complete)return;try{var e=this.Context.Canvas2DProjected.getContext("2d");e.lineWidth=1;e.strokeStyle=t.Colors.BelizeHole;e.font=10+"pt Segoe UI, Arial, Tahoma, Verdana, sans-serif";e.fillStyle=t.Colors.SunFlower;e.textAlign="center";e.textBaseline="bottom";var n=this.Context.Viewport.GetPointsGroupConvert(this.Points["EndPoints"]);if(this.Points[this.TemporalCurrentGroupName].length===1){this.Points["Label"]=[];this.DrawTextLabel(e,n[0],this.TemporalPoint,false);var r=this.Points["Label"];var a=(n[0].X+this.TemporalPoint.X)/2;var s=(n[0].Y+this.TemporalPoint.Y)/2;if(this.TemporalPoint.X!==r[0].X||this.TemporalPoint.Y!==r[0].Y){e.dashedLine(e,a,s,r[0].X,r[0].Y,1)}var l=this.MeasureAnnotation(n[0],this.TemporalPoint,null,false);this.Context.Viewport.AnnotationManager.DrawAnnotationText(e,a,s,r[0].X,r[0].Y,l,1)}}catch(e){}}DrawTextLabel(e,n,r,a){var s=this.Points["Label"];var l=1;if(!a){e.dashedLine(e,n.X,n.Y,r.X,r.Y,0)}else{var h=[];for(var u=0;u<this.Points["EndPoints"].length;u++){var A=this.Points["EndPoints"][u];h=h.concat([A.X,A.Y,A.Z])}if(this.Selected){var d=t.Utils.HexToRgb(t.Colors.Emerald);var C=new Efferent.Frontend.Viewer3D.Color(d.R/255,d.G/255,d.B/255,1);this.Context.Viewport.Viewer3D.View.RenderLine3D(h,C.AsVec3AmbientLight())}else{var d=t.Utils.HexToRgb(t.Colors.SunFlower);var C=new Efferent.Frontend.Viewer3D.Color(d.R/255,d.G/255,d.B/255,1);this.Context.Viewport.Viewer3D.View.RenderLine3D(h,C.AsVec3AmbientLight())}}var c=(n.X+r.X)/2;var w=(n.Y+r.Y)/2;var f=.2*Math.sqrt(Math.pow(n.X-r.X,2)+Math.pow(n.Y-r.Y,2));var p=Math.atan2(r.Y-n.Y,r.X-n.X);if(s===undefined||s===null||s!==undefined&&s!==null&&s.length===0){this.Points["Label"][0]=new o.AnnotationPoint;var P=new t.Point(0,0);P.Y=w+f*Math.cos(p);P.X=c-f*Math.sin(p);this.Points["Label"][0].Y=P.Y;this.Points["Label"][0].X=P.X}}}e.Line3DAnnotation=Line3DAnnotation})(t=e.StlPlugin||(e.StlPlugin={}))})(t=e.Products||(e.Products={}))})(Vue||(Vue={}));var Vue;(function(e){var t;(function(e){var t;(function(e){class ResourceBag{}ResourceBag.Arrow3DTemplateJson={ClassName:"Vue.Products.StlPlugin.Arrow3DAnnotation",Name:"ArrowAnnotation",Groups:{EndPoints:{GroupName:"EndPoints",IsDesign:true,IsVisible:true,IsDraggable:true,MaxPoints:2,MinPoints:2,PromptMessage:"Click on the arrow's endpoints",NextGroup:"Label"},Label:{GroupName:"Label",IsDesign:false,IsVisible:true,IsDraggable:true,MaxPoints:1,MinPoints:1,PromptMessage:"Click on the label position"}}};ResourceBag.Line3DTemplateJson={ClassName:"Vue.Products.StlPlugin.Line3DAnnotation",Name:"Line3DAnnotation",Groups:{EndPoints:{GroupName:"EndPoints",IsDesign:true,IsVisible:true,IsDraggable:true,MaxPoints:2,MinPoints:2,PromptMessage:"Click on the line's endpoints"},Label:{GroupName:"Label",IsDesign:false,IsVisible:true,IsDraggable:true,MaxPoints:1,MinPoints:1,PromptMessage:"Click on the label position"}}};ResourceBag.StlPluginCss=`.StlPane{width:100%;height:100%;position:absolute;background:#2c3e50}.StlPane .ControlStlViewport{position:absolute}.StlPane .ControlStlViewport.controlTop{top:10px;left:10px;width:301px;height:31px}.StlPane .ControlStlViewport.controlBottom{bottom:10px;left:10px;width:301px;height:31px}`;ResourceBag.Icons83dObject32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAABEVBMVEVHcEz///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+dgCZfAAAAWnRSTlMAZq0C3T0KzHd7nhSd4wXLJdEDuQQJpeT2fJBQfmSSZ+7l8+h/COAB7CiDK/5NtGEdwsQS2E/tGM8jE9zmx2kH7zARqxo+98OX1Yy9xR7wvDuvLjJ1VJFd8vyDGmTYAAAA6UlEQVQ4y+3TyVLCQBAG4DaJCTEJ++YGiuy4ILiBsiogi7IICP3+D+KFVHWnpnLk5H+arvpmDlP9A+wlI82ZkzADGk49LMcXtyoDVnzG3yxZjToFuvm94OIj8FqjIDiPfXHRHbx1CIDIZFjlovXe7hEAxkPlgKcZ6z8SAH68VBx58lGg4qHzf3TtH8CpTMCZAEimnLRB4qosAGgGz3dn7/2LKgB4JNvDsxUVASJ+4ksRIOJ3uxIBItYbAUgpim7P4TF+0s33SphFRSY3jBCrTkYKGD68calb2oA7DLmAHEAkf11wL20x6oc/IuwjjmcwpRMAAAAASUVORK5CYII=";ResourceBag.Icons8Delete32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAOdJREFUWAntldEJwzAMRO3SMTpioWt0gK5bXKskIBtZ9ukK/XEgJJbu3tn6SFLa155AN4FSyrPe965ML4Up7CnoEL5/uQmYCRucY4VZYaPaDM1gAIxXnSGlCCjiaUL7BQJEtH2Ou14Br2jckFnTC/B6My7Ut4KsGgRFxTpQv6McSq+Cqa/mhdrFv8zq9PKDkZuaAnQOK9CqQdBVsRfk9Vb5rm4lYEXjhoyaCBjRjvKaegQY8TSh54IBMd5vPg2olDAjbDxHp54wCzaosNGrx7waplutPXLOL6MXKgmrbkK8wt7XnkAzgQ+2xtFqX+VZZgAAAABJRU5ErkJggg==";ResourceBag.Icons8DownLeft32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAADBSURBVFhH7ZI9CgIxEIUjC7aCnb3Vgp33sPIC3sZzeADP4xG2EU+Q+A1MYFGjos40zgfDJC9k3tufFPwNpZRJznmhW18w7zA/UCeV/Kjm9At9rbIPYR7mKvsQ5mGu8ncwbMqwnW6bmD05w1YMFWYq3cGZ3Wt/FQDd9ps/C4Bm/8O1ArC3NxceBWDtYy7cBqD7mQvjAJSvuVAD0Ofu5sIowNHdXKgBBNZ72rZVnG/onV79DQztqfObNVBLvRoEH5LSFeVD5w2yvog+AAAAAElFTkSuQmCC";ResourceBag.Icons8Drag32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGwSURBVFhHvZW9SgQxFIXHQu1FKxtt1/fwAbTYfRdlW61cC9/FQrCxEMR3EFwErawUBZnxu8O9o/NnknGSA4f83c35mE1INlRFUazkeX6OpzqVThp+QVvQfuGZLsWXheN3/IIfcRqIRvg+vsEneI7jQjTDZY62BNB+XAg2roWL6FcAIvoGMe7BZMMNvMRVuIhxDUDE+Ahf6zCuugCSKioAG29pt1e+ABzgTe269eu0P+tUr3wAWJ9gv9vRddX+EjVeX4Aa9xUNDRdR530GqOuHGBIuojboEFLbhhgaLqI+CEBEfR2CzgIIedWe8FWgX/FDY87Hb1ggDgVgqoMlHKchlt/g2661PlO/wJ9YXtKJfYUZFoh5OeEp6kPPwDq+xD/hJiaCIagNuQX94SYWgiCo8wKgxh1uosAgjnWqV9Q4AfjfV6nxCzdRKAfT+aRS4wRgfReIe1q/8BD5AERVUgCC9rRbqQuAz72Gd3Q4jgjZxq3b0QSgb6f9TqfGE5u2rij9CoDW/6oNFRvXIGhLABw/3ERABYEF4AynCTcRZBAfuP6wpBKBBpE+3ETwwf/Cs+wbb1Wj/Vz1yqoAAAAASUVORK5CYII=";ResourceBag.Icons8Erase32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAMcSURBVFhH7ZZbaM5hHMenOS4zO9kYcspysSTtwoWNkjmMxFwNRZYhp6iVSArFjRJSLrhT48alQ2JOS4ZF5nwaSS5IjZbZ6/N9+77/Iu+7/7u9c8O3Pj3/3+H5PYf/8z7/N+2/UqnOzs4CqIXpdv09MWgxvIePINU51PtisInwDs7DAjgMHbDVKb0nBpkAb+FSJBLJoF0B82El/IAtTk29KD4eWhn4Mu1CqHJIsVVwFKTNdqdOFB0Lb+CKV14OlQ4rXg1ToAa0Exsc6rkYcAwFX8FVqITgXfO8GhbblL0XtBOaxHq7uy8GH02hl3ANMkFnYI7DGrAMJtuUXQUjYB1oEmsdSl50HgXP4TpUwDGHFFsOwbvmeR/Ms6mJ12MfAk2ixu7wotNIeAY3KZZFm0s7w2HFtRMlNmVPgyKbsivI11nZBJpEqUNdS4XgCQUitHehwSHFtMVHbMreDbU2Yysv83M6z/doP9OGO5Qk6v09hiYoBb1/vYZ8x3OgOJqMKK4DWmBT8RJ8GXqm7YOts/OF53HRhEQiqZDkFrgDOfLRakIPQFfuxWgi4nkb7Lcp+xQssym7mXq6L9qg628FSfqwPARtWZ7dUeHTqhuhFSbBIBgC8g8gP12Th4GQAVr5WdDg5S4TXyTlg1bZrGe7fxFFBxO7ALrzT9utvvoObLcpuwFUR4PPtDu+SNLg980fB4+JSfQn5wx8Ap3ybNCq+2FrB7UzJ6AN3yx3iy+S8kjWbLX6hIPHRB+d7OO00km7tRCdgdfwFWbbHV8k5YJ+Ynrvw+wOJQbWOz4A32Gj+sNB+AYVTkssiuiEttAW2pW06F8H0gdoh7kOJRaJmdq/0B0SiBrnPHhwDYcSHfSzCn7v3RF9df9r8OCzHFp0Gg6PoInNyLY7tOi3B9rpu8iu5EWB6LVLkdsw1O4uRR/d/1p58D+g26KIPjxP4RaTyLI7rsjbBTr9S+zquSgW+/Q2JpoE8Z3QQc5Su1InCsf+fNyAIgbRLReAbwdIa36PxaGvS4cXnfT36wVtKlTvssmJjlkwtaewkKRu139FaWk/AXYPZV8WWQg1AAAAAElFTkSuQmCC";ResourceBag.Icons8Length32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAALlSURBVFhHvZZNSBVhFIY1S8NAKVBBC4qMhIQyg5A0gggKhKBVqwha1cagRYG7kqBokS2yFhZFEC0qFy5cSbmohUhFQUYQZL/2T/ZLqT3vx2uIOvcycx1feJiZ95w558zMnTtfXpoaHx9fPjY2NgjHbc2daLoKhhgiiP0TDqUv+tXQ8BX0QDv8NukPQZNaeAt9UGSvAnZCukNQvA7ew3MY4U40OhSEl94QFN0An+AqFMFFGIFNTgniePaHoFgDV/uF7SjbenlsCzg+B50haZLwwhDkHLGVXBRqgq9wHrpg0KFIkbMDdBdabCUTBbbCd7jA1eTDfPZXOjyjiG+Dn3DMVjJRYDv8gNfwAqodihQDbiFPA5+ylUwUaIZfKgSL4DZkHILmjcS/wWlbyUSBXaDn9xkq5VG8mP1eaA9JU4S/kRz9SDvY5tuOLwrshj/QBgMUu+WQhtBvYJ4P/wuvHtS8Uzm244sCe+AvHNUxxUrZrwvBCBFfCx/gMvkFtuOLAvtAzYdhAJY4FCly1sA7uJZr8/0wCi1QCU8g4xDEVsMbuE7zBbbjiwIHQRqkULG9iSFmfI/xq0FvRDfnFNqOLwocBt32Vhe84pCe/8KZiuNpATIE+gyHL2EicXIrxaS9Pl4KDSEYIec8g17OC3crkSigV0zv+UfooljW20ieHstT6Mu1+UlQ82YKrWOrb/vNTEMQL4fHcBdKbMcTDfI5+Qxbrd162ITXhu3EEAdC4hThl8FD6Ce31HY8caKanwX9Tx8CLSLaHA5XSM6024q3mNg9uA9Z/xcixckdoO95k4/Xw+YQjJCulpx+0NWX2U4mF9LavdxWRpFXAnd8ToXt5KKInuMDeAQZh9CjIEerXf3iq2znLoplHcLN9cnVu77M9uyJopFDcKxVrv7d9I+4wvbsi+LThuDKC9nvhpeQddmVs2gyeYgquAHDDFLjlPRFw4khtOjUN73WobmTh7jEla+zlYLy8v4BTaW9lbYInL8AAAAASUVORK5CYII=";ResourceBag.Icons8Polyline32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIGSURBVFhHxZc9SJtRFIaTocWUFIODIIUMDkUlXVSwSkEdnBza2UlQDB26NCpqpVBEcJCCS/APwVFCoVsHMdJOCoI4CC0taAaHVnRRMARNfW54UxAV/PKlxxceDue9955z702+/ATuQ/l8PgGnEJdlKxqv/UXElCw70TQGWZhjD1HZNqLhQxpvw2dZ3kSBCIvfQbMsT2LdJPyGalnexML3eu3+QL+XQsxtg3N4Kcu7WNwKR3AIx+AKfoME+6rVtGtiLMycn7Akq3RRZAgyFH1A7IIkHOhmduADNGp6QeSzsAePZZUuijxTs5gsd8Ig+XPiFPGHxvdhBj6Bu6l2TfcvimUgofSaGGuAMfiuzWQ1VB5RcB7SSm8Vc57AFxiWVR5xqFcUzRLDsmzlGrOBnNuILHuxgTQkldqL5oOQUWovmhcfx3pZ9nI3ALc+jv9dNJ+DdS4iKMu/KFgFExTtgEqIkrvrfkHshh54TT5C/Ep0L8O0lvsXxcZd0ZvEWA7cF9Ev0i1i8ZNuWcv9i2J9cAHuC6SF+nXEGuIjTfknvArGOiEky78otgorSm1F46eQ52QdsmxF74+wywbK966+q2gcAvcr540sW3HqXpqfECOybEXzTVhQaitO3QTueb7yW85MNF6EDaW2ovFbOOMCBmTZiubujeeuf1SWrWgchxR7sP2jWFAgcAlSNzwn3/uqrgAAAABJRU5ErkJggg==";ResourceBag.Icons8Rotate18032Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAADd0lEQVRYhcWXT4iVVRjGf8cZx5woKnIaxaTErLEWThNURIyzsEUzwxgG7lqYFBUtIiLCghaS2KZFpFLQEIFGBIFGiwIFZ3CEnE3lSFGiFow59sdUqkn7tfjei5/X786991OYFy7cc87zPu9zvnPOe94Ds2wp31BfAsZSSqNFYLUd6APuBZYD18XQGeB7YBQYSSmdb1TAnKr2OqC3IHCP+iFwCvgUeAxoASaj70ZgLfAlcEIdVu9qVEQ+0EF1Y67doe5Q/1P3quvU62fwX6CuV/ep/6rb1Y5SAtRedVL9Vu0rMZl+9ZB6XO1uSoC6Rv1bfU+d32zwHN98dad6Vh1oVMDn6l/qprKBqziTujlEXPYlqk/BQaAHmABer8IeSSmNlxUB7AQeBO5LKU3VAu5Vf6vx+6JM8Bx3uzqhbrsSnisydVA9r66YTREj6vtlHJ9WW+J/qzqkvhizmpPDLVKfUZ9Xby/geVI9pbY2E7w/klFbtHepY+ob6jfqcPQvU39VP1E/UE+rPVVct6gX1FWNBF6l/uhFa1OXqucq+UHtinVtU99U3835b4wUXs37tfoqXH4XVNtXwGqgK9c3BfwDLIn2UuBYSmkauB/YncPuBh4o4P0JWAbQGoqeAH5OKe3Jo1JK54Aj6rxc3xn1WWBcPQysAB6P4RuAkzmKk8DNBQImK/2VjbA2wHsKwJeYugR4B3gNOAAMATvUe8i+aP6rXlOPryLgD2BhPXBYP7A/pfRWtMfU1cAjwZO//TrJlqzaFgG/kFP7A7C4QQG/A52RXlHnAjcBfwLjIaRijwJjBRyLI2Zmal/s5MK7W52XOwVt6gH1M/WVSCz7A3OHOqW+rW6KI7myiqtyDHvzna2RHNbXENCiPlVJOOrcSEAvqAOVBBVjnYF9Tr2tgGtDiGypHhhW9xUJuJqmjhamYnW5Om0jhUP54GvMSrWuWoDtZmVU6SpohuDXqofVrTOBOtRjZmVUqglsPnhSP1aPqkWJ6RJwt1n5tPlqiIjgW4JzZX2PzGkgHD4ye4yUDd4eMz+r9jfr3B3LMaEOlgg+FGt+tOGZF5AsULfFzh0xKyZqPjQiyWyIozatbq235g2tsdkz62VgkOwZdgg4DpwIyELgVuBuslS9C9iSUvquHndTmyyy18PAQ8CdQOWZdpqLj9PRlNKFZnhn1f4H3Y9LqwOKmcgAAAAASUVORK5CYII=";ResourceBag.Model3DRotateZoomPng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KTMInWQAAA/BJREFUWAm1lm1oVmUYx3u25ZDGli9oak0hWMucrx9E05WhQpRuCCtSIWVDRCZ9KQwKnGYEKhbsS5CfWiIiamD0Binih0CEKb343iq01E0ytHRz7fj7PT5nPIfO03mex3XBj/vluu7/fZ373Pd9TuqBIi0IgicYKim4kEqlvi9SqrBhTLwIOkG7DbfStSD4kbKhMLUCo5ngNeiHnTA1HE69FtpBX1vYP6Qlwj65E6zKJYyvMRPTlCum6H6EXfadSQLEbIUuKEmKzduPWA1odUmDiJkAAzAnKVZ/vlk+SWwvJO50TsMl4n6HyZBo+SbgURtAPEhUvBcwQFGaT2y+CZxDbDjLWpskSsxYYsbDmaTYgvwIe87bkwYR0waXYFhSbEF+BBvAY9iYayC+BdALzbli7qsfYZ/OJDxqE0Ix6mNhEzi5tj70DXmJeBN0gUfNpb4I/2TqzZTrQV/rkE8eCiJeCXNhNayBengwy99K+/9LAvFtsAE8nrGGL0xiXWzA/XQivgO0T6Eqlxa+dfBcLn/R/YiawGn4GTye3pRFWb4XUVqciUbBFBqPQRfMgl/hGP0vUQ6dIVgBL4JPewSuQWh9VPY6G2UJbAZPgrFlYRbUP4AXoDzsSywJngEfw03wj8fJt8DLMA1Gx4nQ/y5o74d+6n+le4LgOmUHuGLxhrMyE+STHIIV8BD4hHWwEt4Dhb6G9LVMmYI3wQvqQxh8Wuom0AJr4VvQPoGRkSzo8Cb7Ds7DQnDS58HgHtBc9rPwORj7BVSBJ+FveDUiSoM+EzgA88BEl8A5cOOOGYynsQ9OwmjwUnGCO+BKvA5PQfa79V3/ACZk0tMHxbIq9K+CL8HVOQ7zYQR0wmfpUCpTQJsNbjqD3QMTs7QiVXwmoB2EERFnTIOYSbAL/FYshZmg1bpMTXALXHbfbUeMRqSLmO3wNuS8CSMDMg3id8Nhm5S+tmVWXBatGtrgBiyPEwj78D8c1vMt1QRP1kZwLm2eCZTBT7AH3CjvQB+4J7xKBz+7+U4Wxjk2o6GWmpvBOZzrApSll5BKPYO+goPQAv5W+Tl9BTz3Z+E4nAJvvsvwB/SD5gZ1LzwC1eAPqWe+BnpgN3hsu+EjWAKL+cc8SnnPSGJWJqurlG+BJ6IUnoY3wKxPQPaNSDNi+owx1jFzQQ211OwGn9zk/m04KsBj9xt4Gr7JtJ+hrAxHUC8Hj5NLLNazLyAvtWfBJDzKaqmpdkWoYxm7iwnyh3IBLAM/p4+DsVfAV+C//x34EzQ/yf6QPAp+qHyFAZwHd/1+S5a8jzJisQlEImiQkLt+BkwC3/E4MMnwaW5S7wX3xi8ZOpnwOvX/tLuOVYyWPK5tNAAAAABJRU5ErkJggg==";ResourceBag.Project3DPng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAImSURBVFiF7ZZdaM5hGMZ/dzZHM+sV2U5ptpKlsNRY2jC0fJxJHIk0jig5VY6o7dCZEnLiTGlqFNPa8nnkK+RzwmTMgaz9HOwp8+7dy/siB96rnno+7vu6rue+n3/9oYQSSijhf0fkO1R3AkeAkb+gXQMM5BPfpF5Xq/60sromcWdyVkBtATqB1cAQ0Ao0AbXAAmAmUAlUpJQR4CMwDNxPoxfoiYjRLO7lwHGgLSIGJxlQG4ETwDpgFXAU+AL0AHeBB8B74FMaADPSyCSDdcn0dGB/RJxM3IuAM0B7RDzJdfOF6j21Lq1fqp1qWc5a5oFapnapL9J6fuJumBgXExLmAeeBbRFxM+3tAI4BozkqMMz3x1nBeFsyjLepHmgBpgEHgMtAN7ArIq5NMqDWABeBPRFxNfsmjLeiifHS1iaxKn58Ax+Y/AYuAbPTvCMiunOVqkodUNdPWc8ioVaqt9XhqWJCvQIsAQazzqqAz8DX3/EAnAU2RMTiwjL1tNpRlKrOnTA/rHYVQ7JV7Ssib6X6Sq1IX8JDtbkYA+XqM3VtATnN6mu1Pa13q70Fi08g3Kg+VWflialRW9VT6lu1Le3Xq+/UZUUbSESd6o2pTKhDar96SM2kvVr1UbFvKFsgkomftiPFblffqHt/WzyLfLP6WO1T96kN6hy1Wl2qHlTvqLfUFb/Km/d/IIeJcmAL0A40AtXAGPAc6AfOARciYqwQ3hJK+Kf4Blexh2oSat6MAAAAAElFTkSuQmCC";ResourceBag.StlPluginLanguageJson={en:{"3dTool":"3D",zoomRotate3DTool:"Zoom / Rotate",pan3DTool:"Move","3DAnnotationTool":"Measure",line3DTool:"Line",downLeft3DTool:"Arrow",rotate1803DTool:"Flip",delete3DAnnotTool:"Delete",show3DTemplate:"Show 3D templates",project3DTool:"Project 3D templates",project3DToolImplant:"Implant",project3DToolBone:"Bone",project3DToolBoth:"Both",close3DTool:"Close"},es:{"3dTool":"3D",zoomRotate3DTool:"Zoom / Rotate",pan3DTool:"Move","3DAnnotationTool":"Medida",line3DTool:"Línea",downLeft3DTool:"Flecha",rotate1803DTool:"Girar",delete3DAnnotTool:"Borrar",show3DTemplates:"Mostrar 3D templates",Project3DTool:"Projectar 3D templates",Project3DToolImplant:"Implante",Project3DToolBone:"Hueso",Project3DToolBoth:"Ambos",close3DTool:"cerrar"}};e.ResourceBag=ResourceBag})(t=e.StlPlugin||(e.StlPlugin={}))})(t=e.Products||(e.Products={}))})(Vue||(Vue={}));var Vue;(function(Vue){var Products;(function(Products){var StlPlugin;(function(StlPlugin_1){var WebClient=Efferent.Frontend.WebClient;var DOMUtils=Efferent.Frontend.WebClient.DOMUtils;var ImagingStudyView=Efferent.ClientViews.ImagingStudyView;let EControlPositions;(function(e){e[e["Top"]=0]="Top";e[e["Bottom"]=1]="Bottom"})(EControlPositions=StlPlugin_1.EControlPositions||(StlPlugin_1.EControlPositions={}));class Scene{}StlPlugin_1.Scene=Scene;class GroupScene{}StlPlugin_1.GroupScene=GroupScene;let EProject3D;(function(e){e[e["Implant"]=0]="Implant";e[e["Bone"]=1]="Bone";e[e["Both"]=2]="Both"})(EProject3D=StlPlugin_1.EProject3D||(StlPlugin_1.EProject3D={}));class StlPlugin{constructor(){this.PluginName="StlPlugin";this.SupportedViewportType=["StlViewport"]}Initialize(e,t,o,n,r){Efferent.Frontend.WebClient.DOMUtils.InjectCSS(Vue.Products.StlPlugin.ResourceBag.StlPluginCss,"styleStlPlugin");this.Controller=e;var a=WebClient.Loader.Show();this.showToaster=false;this.Controller.View.Platform.LanguageManager.AddDictionary("{Vue.Products.StlPlugin.ResourceBag.StlPluginLanguageJson}","StlPluginLanguage",Vue.Products.StlPlugin.ResourceBag.StlPluginLanguageJson[this.Controller.View.Platform.LanguageManager.CurrentLanguage]);this.LoadPlugin();if(o===t.length-1){if(n!==undefined)n.call(this.Controller.View,r)}else{t[o+1].Initialize(this.Controller,t,o+1,n,r)}WebClient.Loader.Hide(a.getAttribute("id"))}LoadPlugin(){this.IsProject3DActivated=false;var e=Efferent.Frontend.WebClient.Utils.IsDebugActive()==="active"?"":".min";var t=["out/Viewer3D"+e+".js"];WebClient.DOMUtils.LoadJsToHead(t);var o=[["3dTool",StlPlugin_1.ResourceBag.Icons83dObject32Png,e=>{}],["show3DTemplate",StlPlugin_1.ResourceBag.Icons83dObject32Png,e=>{var t=e.target;if(!DOMUtils.HasClass(t,"toolbarButton"))t=t.parentElement;var o=this.Controller.GetSelectViewport(this.Controller.ViewportPane);if(o!==null){this.Evaluate3DAnnotation(o,(e=>{if(e){this.OpenPaneStlLayout(t)}else{WebClient.Toolbar.HideAllMenus();WebClient.Toaster.ShowToast("3D models not found.",WebClient.Colors.BelizeHole,3)}}))}else{WebClient.Toaster.ShowToast("Select a viewport.",WebClient.Colors.BelizeHole,3)}}],"project3DTool",["project3DToolImplant",StlPlugin_1.ResourceBag.Project3DPng,e=>{this.IsProject3DActivated=false;this.Project3DTool(e,EProject3D.Implant)}],["project3DToolBone",StlPlugin_1.ResourceBag.Project3DPng,e=>{this.IsProject3DActivated=false;this.Project3DTool(e,EProject3D.Bone)}],["project3DToolBoth",StlPlugin_1.ResourceBag.Project3DPng,e=>{this.IsProject3DActivated=false;this.Project3DTool(e,EProject3D.Both)}]];var n=[["rotate1803DTool",StlPlugin_1.ResourceBag.Icons8Rotate18032Png,e=>{var t=e.target;if(!DOMUtils.HasClass(t,"toolbarButton"))t=t.parentElement;var o=this.Controller.GetSelectViewport(this.StlPane);if(o!==null){o.Viewer3D.Controller.SetView3D(o.TypeViewRotator,true);o.Render3D()}}]];var r=[["zoomRotate3DTool",StlPlugin_1.ResourceBag.Model3DRotateZoomPng,e=>{var t=e.target;if(!DOMUtils.HasClass(t,"toolbarButton"))t=t.parentElement}]];var a=[["pan3DTool",StlPlugin_1.ResourceBag.Icons8Drag32Png,e=>{var t=e.target;if(!DOMUtils.HasClass(t,"toolbarButton"))t=t.parentElement;if(!DOMUtils.HasClass(t,"selected")){var o=this.Controller.GetSelectViewport(this.StlPane);if(o!==null){}DOMUtils.AddClass(t,"selected");this.Controller.View.Platform.Toolbar.DeselectAllButtons();this.Controller.SelectTool("StlPan","Pan3DTool");return}this.Controller.SelectTool("Pointer","pointerTool")}]];var s=[["3DAnnotationTool",StlPlugin_1.ResourceBag.Icons8Length32Png],["line3DTool",StlPlugin_1.ResourceBag.Icons8Polyline32Png,e=>{this.Controller.SelectTool("Pointer","pointerTool");this.Controller.SelectTool("StlLine3DAnnotation","3DlineTool");this.Controller.View.Platform.Toolbar.SelectButton("toolbarviewer.2","3DAnnotationTool","optionInMenuPressed");var t=this.Controller.GetSelectViewport(this.StlPane);this.ControlButtonsOnViewport(t);var o=this.GetViewportPerIndex(3);if(o===t)o.ToolsFree=false;t.ViewportFrameElement.style.cursor="crosshair"}],["downLeft3DTool",StlPlugin_1.ResourceBag.Icons8DownLeft32Png,e=>{this.Controller.SelectTool("Pointer","pointerTool");this.Controller.SelectTool("StlArrow3DAnnotation","3DdownLeftTool");this.Controller.View.Platform.Toolbar.SelectButton("toolbarviewer.2","3DAnnotationTool","optionInMenuPressed");var t=this.Controller.GetSelectViewport(this.StlPane);this.ControlButtonsOnViewport(t);var o=this.GetViewportPerIndex(3);if(o===t)o.ToolsFree=false;t.ViewportFrameElement.style.cursor="crosshair"}]];var l=[["delete3DAnnotTool",StlPlugin_1.ResourceBag.Icons8Erase32Png,e=>{var t=this.Controller.GetSelectViewport(this.StlPane);if(t!==null){if(t.GetSelectedAnnotationsCount()>0){this.DeleteSelectedAnnotations(t);this.Controller.SelectTool("Pointer","pointerTool");this.CloneAnnotations(t,undefined,(e=>{e.Render3D()}));this.RefreshAnnotationsOnAllViewports()}else{WebClient.Toaster.ShowToast("Select one or more annotations to delete.",WebClient.Colors.BelizeHole,3)}}}]];this.Controller.View.Platform.Toolbar.AppendControlsToGroup([n,a,s,l],"StlPluginLanguage","toolbarviewer.2",this);this.Controller.View.ShowButtonsByPlugins(this.Controller.View.Platform.Toolbar,this,false)}Project3DTool(e,t){var o=e.target||e;var n={Implant:["implant.stl"],Bone:["bone.stl"],Both:["implant.stl","bone.stl"]};var r=n[EProject3D[t]];if(!DOMUtils.HasClass(o,"toolbarButton"))o=o.parentElement;if(!this.IsProject3DActivated){DOMUtils.AddClass(o,"selected");this.Controller.SelectTool("Pointer","pointerTool");this.Controller.SelectTool("OrthoProject3D"+EProject3D[t],"project3DTool");this.Controller.View.Platform.Toolbar.SelectButton("toolbarviewer.2","3dTool","optionInMenuPressed");this.IsProject3DActivated=true;var a=this.Controller.GetSelectViewport(this.Controller.ViewportPane);if(a!==null){var s=a.Models3D.filter((e=>r.some((t=>t===e.Name))));if(s.length>0){s.forEach((e=>{var t=r.findIndex((t=>t===e.Name));r.splice(t,1)}))}if(r.length>0){a.DivLoad.style.display="block";this.RefreshAnotationsOnViewport(a,(()=>{if(this.models!==undefined){var e=this.sort3DPerName(r);a.LoadStlModels((e=>{a.RemoveViewportLoader();this.Render3DProjection()}),e,r,0,r.length)}else{Efferent.Frontend.WebClient.Toaster.ShowToast("The 3D image could not be downloaded",Efferent.Frontend.WebClient.Colors.Orange,3.5);this.IsProject3DActivated=false;DOMUtils.RemoveClass(o,"selected");this.Controller.SelectTool("Pointer","pointerTool");a.DivLoad.style.display="none"}}))}else{this.Render3DProjection()}}else{WebClient.Toaster.ShowToast("Please select a viewport",WebClient.Colors.BelizeHole,3);this.IsProject3DActivated=false;DOMUtils.RemoveClass(o,"selected");this.Controller.SelectTool("Pointer","pointerTool")}}else{this.IsProject3DActivated=false;DOMUtils.RemoveClass(o,"selected");this.Controller.SelectTool("Pointer","pointerTool")}}Render3DProjection(){try{if(this.IsProject3DActivated){var e=this.Controller.GetSelectViewport(this.Controller.ViewportPane);if(e!==null&&e.Models3D.length>0){var t=parseInt(e.Context.ImageEntity["dicomTags"]["0028_0011"]);var o=parseInt(e.Context.ImageEntity["dicomTags"]["0028_0010"]);var n=ImagingStudyView.Geometry.Calculate3DPosition(e.Context.ImageEntity,t,o);var r={Implant:"#00ABA0",Bone:WebClient.Colors.Alizarin,Other:WebClient.Colors.BelizeHole};if(n){e.Context.Renderer.Render((t=>{e.Models3D.forEach(((t,o)=>{try{var a=[];switch(this.Controller.ToolSelect){case"OrthoProject3DBoth":a=["implant.stl","bone.stl"];break;case"OrthoProject3DImplant":a=["implant.stl"];break;case"OrthoProject3DBone":a=["bone.stl"];break}if(a.some((e=>e===t.Name))){var s=t.Model;var l=s.GetHorizontalProjection(n.Z);var h=e.ViewportElement.getContext("2d");h.strokeStyle=r[t.TransformData.Type];h.lineWidth=1.25;h.beginPath();for(var u=0;u<l.length;u=u+1){for(var A=0;A<l[u].length;A=A+1){if(A===0){var d=this.Convert2D(l[u][A].x,l[u][A].y);h.moveTo(d.X,d.Y)}else{var d=this.Convert2D(l[u][A].x,l[u][A].y);h.lineTo(d.X,d.Y)}}}h.stroke();h.closePath()}}catch(e){WebClient.Utils.DebugConsoleLog(e)}}))}));e.Context.OverlayRenderer.Render()}else{WebClient.Toaster.ShowToast("3D information not avilable on image.",WebClient.Colors.BelizeHole,3)}}}}catch(e){WebClient.Utils.DebugConsoleLog(e)}}Convert2D(e,t){var o=this.Controller.GetSelectViewport(this.Controller.ViewportPane);var n=parseInt(o.Context.ImageEntity["dicomTags"]["0028_0011"]);var r=parseInt(o.Context.ImageEntity["dicomTags"]["0028_0010"]);var a=ImagingStudyView.Geometry.Calculate3DPosition(o.Context.ImageEntity,0,0);var s=ImagingStudyView.Geometry.Calculate3DPosition(o.Context.ImageEntity,n,r);var l=Math.abs(a.X-s.X);var h=Math.abs(a.Y-s.Y);var u=(e-a.X)*l/(s.X-a.X);var A=(t-a.Y)*h/(s.Y-a.Y);u=u-l/2;A=A-h/2;u=u/o.Context.ImageEntity["pixelSpacing"][0];A=A/o.Context.ImageEntity["pixelSpacing"][1];return new WebClient.Point(u,A)}CloneAnnotations(e,t,o){[0,1,2,3].forEach(((n,r)=>{var a=this.GetViewportPerIndex(n);if(e!==a){if(t!==undefined&&a===t||t===undefined){var s=new Array;var l=new Array;if(Array.isArray(e.Context.Annotations)){e.Context.Annotations.forEach((e=>{if(e["recentCreatedOnMemory"]===true){var t=WebClient.Utils.CloneAnnotation(e,[e.Context]);delete t["recentCreatedOnMemory"];l.push(t)}}))}e.Annotations[this.PluginName].forEach((e=>{var t=WebClient.Utils.CloneAnnotation(e,[e.Context]);s.push(t)}));s.push(...l);a.Annotations[this.PluginName]=s}}if(o!==undefined)o(a)}))}OpenPaneStlLayout(e){if(this.ContainerStlPane===undefined){this.Controller.View.Plugins.forEach((e=>{e.EscapeAction()}));WebClient.Toolbar.HideAllMenus();this.Controller.View.Platform.Toolbar.ShowOrHideButtonsPerGroupName(["main.1","common.1","toolbarviewer.1","specButtons.1"],false,true);var t=this.Controller.View.Platform.Toolbar.GetButton("pointerTool");t.ShowPermanent=true;t.HidePermanent=false;this.Controller.View.Platform.Toolbar.ShowButton(null,"pointerTool");this.ContainerStlPane=document.createElement("div");this.ContainerStlPane.className="StlPane";this.Controller.SpaceViewer.appendChild(this.ContainerStlPane);this.Controller.ThumbnailPane.Hide();this.StlPane=new ImagingStudyView.ViewportPane(this.ContainerStlPane,this.Controller);this.StlPane.Create();this.Controller.View.Platform.ResizeListeners.push(new WebClient.ResizeStructure(this.StlPane.constructor.name.toLowerCase(),this.StlPane,this.Controller.View.ViewName));this.StlPane.HorizontalViewports=2;this.StlPane.VerticalViewports=2;this.StlPane.MaxViewports=16;this.StlPane.RenderViewportPane();this.StlPane.Show();var o=new Array;this.StlPane.ViewportsCollection=new Array;for(var n=0;n<this.StlPane.MaxViewports;n++){this.StlPane.ViewportsCollection.push(new ImagingStudyView.ViewportCollection);var r=new StlPlugin_1.StlViewport(this.StlPane.ViewportPaneSection,"viewportSection_"+(n+1),(e=>{}),this.Controller,this.StlPane,this);r.Create(n);o.push(r)}this.StlPane.ViewportsArray=o;this.StlPane.ViewportsArray[0].SelectViewport=true;this.StlPane.ViewportsArray[0].ViewportFrameElement.style.borderColor=WebClient.Colors.Emerald;DOMUtils.AddClass(this.StlPane.ViewportsArray[0].ViewportFrameElement,"SelectedViewport");this.StlPane.ChangeViewportsNumber();this.Controller.View.ShowToolbarButtonsBySupportViewport(this.Controller.View.Platform.Toolbar,this.StlPane.ViewportsArray[0]);var a=this.GetViewportPerIndex(3);a.ToolsFree=true;[0,1,2,3].forEach((e=>{var t=this.GetViewportPerIndex(e);t.IndexViewport3D=e;switch(e){case 0:t.TypeViewRotator=Efferent.Frontend.Viewer3D.EViewRotators.AP;break;case 1:t.TypeViewRotator=Efferent.Frontend.Viewer3D.EViewRotators.CoronalView;break;case 2:t.TypeViewRotator=Efferent.Frontend.Viewer3D.EViewRotators.ML;break;case 3:t.TypeViewRotator=Efferent.Frontend.Viewer3D.EViewRotators.Rotate3D;break}}));var s=[["close3DTool",StlPlugin_1.ResourceBag.Icons8Delete32Png,e=>{this.OpenPaneStlLayout()}]];this.Controller.View.Platform.Toolbar.AppendControlsToGroup([s],"StlPluginLanguage","toolbarviewer.2",this);this.load3DAlone(this.StlPane.ViewportsArray[0])}else{this.StlPane.ViewportsArray[0].StopDownloadOfElements=true;DOMUtils.RemoveItem(this.ContainerStlPane);this.ContainerStlPane=undefined;this.Controller.ThumbnailPane.Show();this.Controller.View.Platform.Toolbar.ShowOrHideButtonsPerGroupName(["main.1","common.1","toolbarviewer.1","specButtons.1"],true,true);var t=this.Controller.View.Platform.Toolbar.GetButton("pointerTool");t.ShowPermanent=false;this.Controller.ResizeViewports();this.Controller.View.Platform.Toolbar.SetValueToButtonBar(null,"hviewport",this.Controller.ViewportPane.HorizontalViewports);this.Controller.View.Platform.Toolbar.SetValueToButtonBar(null,"vviewport",this.Controller.ViewportPane.VerticalViewports);this.Controller.View.ShowToolbarButtonsBySupportViewport(this.Controller.View.Platform.Toolbar,this.Controller.GetSelectViewport(this.Controller.ViewportPane));this.Controller.View.Platform.CurrentView.SetInitialStatus();this.StlPane=undefined;this.models=undefined}}Terminate(){const e=document.querySelector("style#styleStlPlugin");Efferent.Frontend.WebClient.DOMUtils.RemoveItem(e)}CloseActionsConfig(){}GetRememberToolsPerName(){var e=[];return e}GetContextMenuOptions(){var e=new Array;return e}OnWindowResize(e,t,o=false,n=false){if(this.StlPane!==undefined){this.StlPane.RenderViewportPane();this.StlPane.ChangeViewportsNumber();for(var r=0;r<this.StlPane.ViewportsArray.length;r++){var a=this.StlPane.ViewportsArray[r];if(a&&a.Viewer3D){let e=a.Viewer3D.Controller.GetCanvas2D();e.width=a.ViewportElement.width;e.height=a.ViewportElement.height;if(DOMUtils.IsDisplay(a.ViewportFrameElement)){a.RefreshAnnotations();a.Render3D()}}}}}ReCreateViewport(e,t,o,n){var r=this.Controller.GetSelectViewport(this.StlPane);var a=r.NumberInPanel;var s=r.Context.ImageEntity;var l=new StlPlugin_1.StlViewport(this.StlPane.ViewportPaneSection,"viewportSection_"+(e+1),(e=>{}),this.Controller,this.StlPane,this);l.Create(e,t,o,n);l.Context.ImageEntity=s;l.Context.StudyGuid=r.Context.StudyGuid;l.Context.SeriesGuid=r.Context.SeriesGuid;l.Context.Annotations=new Array;this.StlPane.ViewportsArray[e]=l;this.StlPane.ViewportsArray[e].NumberInPanel=a;var h=this.Controller.GetSelectViewport(this.StlPane);this.Controller.View.ShowToolbarButtonsBySupportViewport(this.Controller.View.Platform.Toolbar,h);return l}EscapeAction(){}SetSeriesToViewport(e,t,o,n,r,a=false){}GetImageEntityForStudyAndSeries(e,t,o,n){return null}AssignViewportDrag(e,t,o,n,r){}OnEvent(e,t,o,n){var r=DOMUtils.GetOffset(n,"x");var a=DOMUtils.GetOffset(n,"y");var s=o;if(!(o instanceof StlPlugin_1.StlViewport)){switch(e){case"keydown":case"wheel":case"mousemove":this.Render3DProjection();break}return}switch(e){case"singletap":case"doubletap":var l=this.Controller.View.Platform.Toolbar.GetButton("3dTool");if(l){DOMUtils.AddClass(l.Element,"selected");DOMUtils.AddClass(l.Element,"fixedSelected")}this.ControlButtonsOnViewport(o);if(e==="singletap")o.ProcessSingleTap(t,n);else o.ProcessDoubleTap(t,n);break;case"wheel":this.ControlButtonsOnViewport(o);o.ProcessWheel(t,n);case"keydown":o.ProcessKeyDown(t,n);break;case"mousemove":o.ProcessMouseMove(t,n);break;case"panleft":case"panright":case"panup":case"pandown":case"panstart":case"panmove":case"panend":case"press":case"pressup":case"swipeleft":case"swiperight":case"swipeup":case"swipedown":this.ControlButtonsOnViewport(o);o.ProcessPanAndSwipe(t,n);break;case"pinch":case"pinchstart":case"pinchmove":case"pinchend":case"rotate":case"rotatestart":case"rotatemove":case"rotateend":break}}SelectAnyTool(){var e=this.GetViewportPerIndex(3);this.IsProject3DActivated=false;if(e!==null)e.ToolsFree=true;if(this.Controller===undefined)return}HoldSaveSpecialAnnotationsOnCourse(){}InitAnnotations(e,t){t.Context.Annotations=new Array;t.Annotations[this.PluginName]=new Array}SetAnnotations(e,t){}RenderAnnotations(e){}SetDefaultTool(e){}DeleteSelectedAnnotations(e){if(e instanceof StlPlugin_1.StlViewport){var t=new Array;for(var o=0;o<e.Context.Annotations.length;o++){if(e.Context.Annotations[o].Selected===true)e.AnnotationManager.DeleteAnnotation(e.Context.Annotations[o]);else t.push(e.Context.Annotations[o])}e.Context.Annotations=t;e.Annotations[this.PluginName]=e.Context.Annotations}}SetSeriesAutomaticInViewports(e,t=false){if(this.Controller.StudyViewerModel.Documents.IndexData.length===0)return}GetMouseBehaviors(){var e=new Array;return e}GetMarkers(){return null}GetPointsGrips(e,t){return null}ControlButtonsOnViewport(e){this.Controller.View.ShowToolbarButtonsBySupportViewport(this.Controller.View.Platform.Toolbar,e);WebClient.Toolbar.UnBlockAndBlockOneButton(this.Controller.View.Platform.Toolbar.Groups,false,"3DAnnotationTool");WebClient.Toolbar.UnBlockAndBlockOneButton(this.Controller.View.Platform.Toolbar.Groups,false,"rotate1803DTool");WebClient.Toolbar.UnBlockAndBlockOneButton(this.Controller.View.Platform.Toolbar.Groups,false,"pointerTool");WebClient.Toolbar.UnBlockAndBlockOneButton(this.Controller.View.Platform.Toolbar.Groups,false,"delete3DAnnotTool");if(e.ToolsFree){WebClient.Toolbar.UnBlockAndBlockOneButton(this.Controller.View.Platform.Toolbar.Groups,false,"zoomRotate3DTool");WebClient.Toolbar.UnBlockAndBlockOneButton(this.Controller.View.Platform.Toolbar.Groups,false,"pan3DTool")}else{WebClient.Toolbar.UnBlockAndBlockOneButton(this.Controller.View.Platform.Toolbar.Groups,true,"zoomRotate3DTool");WebClient.Toolbar.UnBlockAndBlockOneButton(this.Controller.View.Platform.Toolbar.Groups,true,"pan3DTool");if(!this.Controller.ToolSelect.match("3DAnnotation"))this.Controller.SelectTool("Pointer","pointerTool")}}RefreshAnnotationsOnAllViewports(e=0){var t=this.GetViewportPerIndex(e);if(t!==null&&t!==undefined){t.RefreshAnnotations();t.Render3D();this.RefreshAnnotationsOnAllViewports(e+1)}}GetScene(){return this.scene}GetViewportPerIndex(e){if(this.StlPane!==undefined){var t=this.StlPane.ViewportsArray;var o=0;for(var n=0;n<t.length;n++){var r=t[n];if(DOMUtils.IsDisplay(r.ViewportFrameElement)){if(e===o)return r;else o++}}}return null}Evaluate3DAnnotation(e,t,o=true){var n=e;var r=this.Controller.ImagingStudyFhirEntities[n.Context.StudyGuid]["id"];if(o)WebClient.Loader.Show();if(this.Controller.LoadAllAnnotationsForStudy[e.Context.StudyGuid]===undefined){this.Controller.AnnotationClient.GetAllAnnotationsForStudy(r,(e=>{this.evaluatePartData3D(o,e,n,t)}))}else{this.evaluatePartData3D(o,this.Controller.LoadAllAnnotationsForStudy[n.Context.StudyGuid],n,t)}}RefreshAnotationsOnViewport(e,t){var o=this.Controller.ImagingStudyFhirEntities[e.Context.StudyGuid]["id"];this.Controller.AnnotationClient.GetAllAnnotationsForStudy(o,(o=>{this.Controller.LoadAllAnnotationsForStudy[e.Context.StudyGuid]=o;this.retrieveAnnotations(e,o,t)}))}GetSettingsPaneNames(){return[]}GetSettings(e){}UpdateSettings(e,t){return true}CreateSettingsPane(e,t){}GetButtonsToMenu(e,t){var o=[];o.push(" ");for(var n=0;n<e.length;n++){switch(e[n]){case"3dTool":o.push("3dTool");break;case"show3DTemplate":o.push(["show3DTemplate",StlPlugin_1.ResourceBag.Icons83dObject32Png,e=>{var t=e.target;if(!DOMUtils.HasClass(t,"toolbarButton"))t=t.parentElement;var o=this.Controller.GetSelectViewport(this.Controller.ViewportPane);if(o!==null){this.Evaluate3DAnnotation(o,(e=>{if(e){this.OpenPaneStlLayout(t)}else{WebClient.Toolbar.HideAllMenus();WebClient.Toaster.ShowToast("3D models not found.",WebClient.Colors.BelizeHole,3)}}))}else{WebClient.Toaster.ShowToast("Select a viewport.",WebClient.Colors.BelizeHole,3)}}]);break;case"project3DTool":o.push("project3DTool");break;case"project3DToolImplant":o.push(["project3DToolImplant",StlPlugin_1.ResourceBag.Project3DPng,e=>{this.IsProject3DActivated=false;this.Project3DTool(e,EProject3D.Implant)}]);break;case"project3DToolBone":o.push(["project3DToolBone",StlPlugin_1.ResourceBag.Project3DPng,e=>{this.IsProject3DActivated=false;this.Project3DTool(e,EProject3D.Bone)}]);break;case"project3DToolBoth":o.push(["project3DToolBoth",StlPlugin_1.ResourceBag.Project3DPng,e=>{this.IsProject3DActivated=false;this.Project3DTool(e,EProject3D.Both)}]);break}}return{dictionary:"StlPluginLanguage",buttons:o}}ClearViewports(){var e=this.Controller.ViewportPane.ViewportsArray;for(var t=0;t<e.length;t++){var o=e[t];if(o instanceof StlPlugin_1.StlViewport){o.Clear(o)}}}evaluatePartData3D(e,t,o,n){if(e)WebClient.Loader.Hide();try{var r=false;for(var a=0;a<t.length;a++){var s=t[a];if(s["SeriesGuid"]!==undefined&&s["SeriesGuid"]===o.Context.SeriesGuid){if(this.models===undefined&&s["Name"]==="OrthoScene"){r=true;n(true);break}}}if(!r)n(false)}catch(e){n(false)}}retrieveAnnotations(viewport,data,callback){var annotations=new Array;try{for(var i=0;i<data.length;i++){var item=data[i];if(item["SeriesGuid"]!==undefined&&item["SeriesGuid"]===viewport.Context.SeriesGuid){if(this.models===undefined&&item["Name"]==="OrthoScene"){this.scene=item["Scene"];this.readSceneAnnotation(this.scene)}else{var annotationSample=eval("new "+item.Namespace+"."+item.Name+"()");annotationSample.Deserialize(JSON.stringify(item));annotationSample.Selected=false;annotationSample.Status=ImagingStudyView.EAnnotationStatus.Complete;annotations.push(annotationSample)}}}viewport.Annotations[this.PluginName]=annotations}catch(e){}finally{if(callback!==undefined){callback(viewport)}}}readSceneAnnotation(e){var t=new Array;var o=0;e["Groups"].forEach((e=>{var n=e["Elements"];n.forEach((n=>{if(n["Filename"]!==undefined&&n["Filename"]!==null){o++;var r=new ImagingStudyView.PercentModelSTL(n["Filename"],0,0);r.TransformData=new ImagingStudyView.TransformDataSTL;r.TransformData.Filename=n["Filename"];r.TransformData.AdjustTransform=n["AdjustTransform"];r.TransformData.InitialTransform=n["InitialTransform"];r.TransformData.Color=n["Color"];r.TransformData.Type=n["Type"];r.TransformData.GroupName=e["Name"];r.TransformData.GroupIndex=e["Index"];t.push(r)}}))}));t.map((e=>e.Weight=1/o));this.models=t}sort3DPerName(e){if(this.models!==undefined){var t=new Array;e.forEach((e=>{var o=this.models.findIndex((t=>t.Item===e));t.push(this.models[o])}));this.models.forEach((e=>{if(!t.some((t=>t&&t.Item===e.Item))){t.push(e)}}));return t}return[]}load3DAlone(e){var t=this.Controller.GetSelectViewport(this.Controller.ViewportPane);e.Context.StudyGuid=t.Context.StudyGuid;e.Context.SeriesGuid=t.Context.SeriesGuid;WebClient.Loader.Show();this.RefreshAnotationsOnViewport(e,(()=>{WebClient.Loader.Hide();this.ControlButtonsOnViewport(e);if(this.models!==undefined){e.Call3D(this.models,false,(()=>{var o=this.cloneModels(e.Models3D);var loadItemOnViewport=n=>{if(this.StlPane!==undefined){var r=this.StlPane.ViewportsArray[n];if(n<this.StlPane.MaxViewports){if(DOMUtils.IsDisplay(r.ViewportFrameElement)&&!r.ModelsLoaded){r.Context.StudyGuid=t.Context.StudyGuid;r.Context.SeriesGuid=t.Context.SeriesGuid;this.CloneAnnotations(e,r);r.Models3D=this.cloneModels(o);r.Models3D.map((e=>e.Model=Efferent.Frontend.Viewer3D.StlLoader.LoadStl(e.Buffer,e.Name)));r.ModelsLoaded=true;r.Call3D(undefined,false,(()=>{r.Models3D.forEach(((e,t)=>{var o=WebClient.Utils.HexToRgb(e.TransformData.Color);var n=new Efferent.Frontend.Viewer3D.Color(o.R/256,o.G/256,o.B/256,1);r.Viewer3D.AddStlModel(e.Model,n);r.Viewer3D.Controller.AdjustViewport()}));r.Render3D();loadItemOnViewport(n+1)}))}else{loadItemOnViewport(n+1)}}else{this.relocateRotator();this.transformViews3DOnViewports();this.controlEventsForViewports();this.RefreshAnnotationsOnAllViewports()}}};loadItemOnViewport(1)}))}else{WebClient.Toaster.ShowToast("The 3d models could not be obtained from the annotation",WebClient.Colors.BelizeHole,3)}}))}controlEventsForViewports(){[0,1,2].forEach(((e,t)=>{var o=this.GetViewportPerIndex(e);this.loadControlsForViewport(o,t,EControlPositions.Top);if(this.scene.Groups.length>1)this.loadControlsForViewport(o,t,EControlPositions.Bottom)}))}executeActionsStl(e,t,o,n,r){var a=1;var s=Math.PI/180;let l=Object.keys(e.ReferenceRotationPoints).length;switch(r){case"rotate-ccw":if(l>0){e.Viewer3D.Controller.AnyRotate(e.ReferenceRotationPoints,e.GetModelsPerGroup(n),n,t,s,o)}else{if(!this.showToaster){this.showToaster=true;WebClient.Toaster.ShowToast("Please select a rotation origin first",WebClient.Colors.BelizeHole,3)}}break;case"rotate-cw":if(l>0){e.Viewer3D.Controller.AnyRotate(e.ReferenceRotationPoints,e.GetModelsPerGroup(n),n,t,-s,o)}else{if(!this.showToaster){this.showToaster=true;WebClient.Toaster.ShowToast("Please select a rotation origin first",WebClient.Colors.BelizeHole,3)}}break;case"up":switch(o){case 0:t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(0,a,0).MultiplyByMatrix(t.TransformMatrix);break;case 1:t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(0,0,a).MultiplyByMatrix(t.TransformMatrix);break;case 2:t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(0,0,a).MultiplyByMatrix(t.TransformMatrix);break}break;case"right":switch(o){case 0:e.Viewer3D.Controller.VectorsA[Efferent.Frontend.Viewer3D.EViewRotators.AP].isFliped?a=-a:a=a;t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(a,0,0).MultiplyByMatrix(t.TransformMatrix);break;case 1:e.Viewer3D.Controller.VectorsA[Efferent.Frontend.Viewer3D.EViewRotators.CoronalView].isFliped?a=-a:a=a;t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(a,0,0).MultiplyByMatrix(t.TransformMatrix);break;case 2:e.Viewer3D.Controller.VectorsA[Efferent.Frontend.Viewer3D.EViewRotators.ML].isFliped?a=-a:a=a;t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(0,-a,0).MultiplyByMatrix(t.TransformMatrix);break}break;case"down":switch(o){case 0:t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(0,-a,0).MultiplyByMatrix(t.TransformMatrix);break;case 1:t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(0,0,-a).MultiplyByMatrix(t.TransformMatrix);break;case 2:t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(0,0,-a).MultiplyByMatrix(t.TransformMatrix);break}break;case"left":switch(o){case 0:e.Viewer3D.Controller.VectorsA[Efferent.Frontend.Viewer3D.EViewRotators.AP].isFliped?a=-a:a=a;t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(-a,0,0).MultiplyByMatrix(t.TransformMatrix);break;case 1:e.Viewer3D.Controller.VectorsA[Efferent.Frontend.Viewer3D.EViewRotators.CoronalView].isFliped?a=-a:a=a;t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(-a,0,0).MultiplyByMatrix(t.TransformMatrix);break;case 2:e.Viewer3D.Controller.VectorsA[Efferent.Frontend.Viewer3D.EViewRotators.ML].isFliped?a=-a:a=a;t.TransformMatrix=Efferent.Frontend.Viewer3D.Matrix4.TranslationMatrix(0,a,0).MultiplyByMatrix(t.TransformMatrix);break}break}}loadControlsForViewport(e,t,o){var n=e.ViewportFrameElement;var r=document.createElement("div");var a="";var s;if(o===EControlPositions.Top){a="controlTop";s=1}else if(o===EControlPositions.Bottom){a="controlBottom";s=2}r.className="ControlStlViewport "+a;var l=new WebClient.AdjustControl2(r,{width:301,height:31},(o=>{this.showToaster=false;var n=o.getAttribute("data-control");this.scene.Groups[s-1].Elements.forEach((o=>{if(o.Type==="Implant"){var r=e.Viewer3D.View.GetModelByName(o.Filename);if(n==="center"){e.ReadyForSetReferencePoint=true;e.IndexReferenceRotationGroup=s;e.ViewportFrameElement.style.cursor="crosshair";e.Render3D()}else{this.executeActionsStl(e,r,t,s,n);this.syncOtherViewports(o.Filename,t,((o,r)=>{this.executeActionsStl(e,o,t,s,n);r.Render3D()}));e.Render3D()}}}))}));n.appendChild(r)}cloneModels(e){var t=new Array;e.forEach((e=>{var o=new Efferent.Frontend.Viewer3D.Model(e.Name,e.Model.Vertices,e.Model.Normals,e.Model.BoundingCube,e.Model.Color);var n=new ImagingStudyView.ModelsData3d;n.Buffer=e.Buffer;n.Name=e.Name;n.Model=o;n.TransformData=new ImagingStudyView.TransformDataSTL;n.TransformData.AdjustTransform=e.TransformData.AdjustTransform;n.TransformData.Color=e.TransformData.Color;n.TransformData.Filename=e.TransformData.Filename;n.TransformData.InitialTransform=e.TransformData.InitialTransform;n.TransformData.Type=e.TransformData.Type;t.push(n)}));return t}syncOtherViewports(e,t,o){[0,1,2,3].forEach(((n,r)=>{var a=this.GetViewportPerIndex(n);if(r!==t){var s=a.Viewer3D.View.GetModelByName(e);o(s,a)}}))}transformViews3DOnViewports(){for(var e=0;e<4;e++){var t=this.GetViewportPerIndex(e);t.Viewer3D.Controller.SetView3D(t.TypeViewRotator);t.Render3D()}}relocateRotator(){for(var e=0;e<4;e++){var t=this.GetViewportPerIndex(e);var o=t.Viewer3D.View.GetBounds(t.Viewer3D.View.GetModels());var n=o.GetCentroid();t.Viewer3D.Controller.SetRelocateRotator(n);t.Render3D()}}}StlPlugin_1.StlPlugin=StlPlugin})(StlPlugin=Products.StlPlugin||(Products.StlPlugin={}))})(Products=Vue.Products||(Vue.Products={}))})(Vue||(Vue={}));var Vue;(function(Vue){var Products;(function(Products){var StlPlugin;(function(StlPlugin){var WebClient=Efferent.Frontend.WebClient;var DOMUtils=Efferent.Frontend.WebClient.DOMUtils;var ImagingStudyView=Efferent.ClientViews.ImagingStudyView;class ModelData{constructor(e,t,o,n){this.Id=e;this.PositionX=t;this.PositionY=o;this.PositionZ=n}}StlPlugin.ModelData=ModelData;class StlViewport extends ImagingStudyView.Viewport{constructor(e,t,o,n,r,a){super(e,t,o,n,r);this.Plugin=a;this.PluginNameAction="StlViewport";this.Context=new StlPlugin.StlViewportContext(this);this.Context.ImageEntity=null;this.models={};this.ReferenceRotationPoints={};this.ReadyForSetReferencePoint=false;this.ModelsLoaded=false;this.AnnotationManager=new ImagingStudyView.AnnotationManager(this);this.ItemsModel=new Array;this.ToolsFree=false;this.IndexReferenceRotationGroup=-1}Create(e,t,o,n){this.ViewportElement=document.createElement("canvas");this.ContentElement=n;super.Create(e,t);this.WheelFactorSpeed=1;this.ViewportElement.setAttribute("width",this.ContentElement.clientWidth.toString());this.ViewportElement.setAttribute("height",this.ContentElement.clientHeight.toString());this.SelectViewport=true;this.ContentElement.appendChild(this.ViewportElement);this.Context.Annotations=new Array;this.Plugin.Controller.ViewportPane.ViewportsCollection[e].LoadedViewports[this.constructor.name]=this}ClearCanvas2D(){if(this.Viewer3D!==undefined){var e=this.Viewer3D.Controller.GetCanvas2D();var t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)}}Render3D(){if(this.Viewer3D!==undefined){this.Viewer3D.Controller.Update();this.RenderAnnotations();this.DrawCrossReferenceRotation();this.RenderTypeViewRotator()}}RenderTypeViewRotator(){var e=this.Viewer3D.Controller.GetCanvas2D();var t=e.getContext("2d");t.save();t.font="12pt Segoe UI, Arial, Tahoma, Verdana, sans-serif";t.fillStyle=WebClient.Colors.Clouds;t.shadowColor=WebClient.Colors.FullBlack;t.shadowOffsetX=1;t.shadowOffsetY=1;t.textAlign="left";t.textBaseline="top";var o=this.Viewer3D.Controller.VectorsA[this.TypeViewRotator];var n={top:{x:this.ViewportElement.width/2,y:0},right:{x:this.ViewportElement.width-25,y:this.ViewportElement.height/2},bottom:{x:this.ViewportElement.width/2,y:this.ViewportElement.height-15},left:{x:15,y:this.ViewportElement.height/2}};switch(this.TypeViewRotator){case Efferent.Frontend.Viewer3D.EViewRotators.AP:t.fillText("AP",this.ViewportElement.width-25,0);t.fillText("P",n.top.x,n.top.y);t.fillText(o.isFliped?"R":"L",n.right.x,n.right.y);t.fillText("A",n.bottom.x,n.bottom.y);t.fillText(o.isFliped?"L":"R",n.left.x,n.left.y);break;case Efferent.Frontend.Viewer3D.EViewRotators.CoronalView:t.fillText("Coronal",this.ViewportElement.width-55,0);t.fillText("H",n.top.x,n.top.y);t.fillText(o.isFliped?"R":"L",n.right.x,n.right.y);t.fillText("F",n.bottom.x,n.bottom.y);t.fillText(o.isFliped?"L":"R",n.left.x,n.left.y);break;case Efferent.Frontend.Viewer3D.EViewRotators.ML:t.fillText("ML",this.ViewportElement.width-25,0);t.fillText("H",n.top.x,n.top.y);t.fillText(o.isFliped?"P":"A",n.right.x,n.right.y);t.fillText("F",n.bottom.x,n.bottom.y);t.fillText(o.isFliped?"A":"P",n.left.x,n.left.y);break}t.restore()}RenderAnnotations(){this.ClearCanvas2D();for(var e=0;e<this.Context.Annotations.length;e++){try{var t=this.Context.Annotations[e];if(t instanceof StlPlugin.Annotation3D)t.Render()}catch(e){WebClient.Utils.DebugConsoleLog(e)}}if(this.Context.CurrentAnnotation!==null&&this.Context.CurrentAnnotation!==undefined){try{this.Context.CurrentAnnotation.Render();var o=new WebClient.Point(this.Context.MouseMoveX,this.Context.MouseMoveY);this.drawCrossMouse(o)}catch(e){WebClient.Utils.DebugConsoleLog(e)}}}RefreshAnnotations(){if(this.ModelsLoaded&&this.Viewer3D!==undefined){var e=this.Annotations[this.Plugin.PluginName];if(e!==undefined){var t=new Array;if(Array.isArray(this.Context.Annotations)){this.Context.Annotations.forEach((e=>{if(e["recentCreatedOnMemory"]===true){t.push(e)}}))}this.Context.Annotations=new Array;for(var o=0;o<e.length;o++){var n=e[o];n.Context=this.Context;n.Context.Canvas2DProjected=this.Viewer3D.Controller.GetCanvas2D();n.Context.ContextGl3D=this.Viewer3D.Controller.GetContext3D();this.Context.Annotations.push(n)}this.Context.Annotations.push(...t)}}}GetModelsPerGroup(e){var t=new Array;this.Plugin.GetScene().Groups.forEach((o=>{if(o.Index===e){o.Elements.forEach((e=>{for(var o=0;o<this.Models3D.length;o++){var n=this.Models3D[o];if(e.Filename===n.Model.Name){t.push(n.Model);break}}}))}}));return t}Call3D(e,t=false,o){this.Viewer3D=new Efferent.Frontend.Viewer3D.Viewer3D(this.ViewportElement);if(!this.ModelsLoaded){this.DivLoad.style.display="block";this.ItemsModel.push(...e);var n=[];this.ItemsModel.forEach((e=>{n.push(e.Item)}));this.LoadStlModels((e=>{this.RemoveViewportLoader();this.ModelsLoaded=true;this.RefreshAnnotations();if(this.Models3D.length>0){this.Models3D.forEach(((e,t)=>{var o=WebClient.Utils.HexToRgb(e.TransformData.Color);var n=new Efferent.Frontend.Viewer3D.Color(o.R/256,o.G/256,o.B/256,1);this.Viewer3D.AddStlModel(e.Model,n);this.Viewer3D.Controller.AdjustViewport()}));this.Render3D()}else{if(t){this.backToParentViewport()}if(this.Plugin.StlPane!==undefined)WebClient.Toaster.ShowToast("Error downloading 3D models",WebClient.Colors.BelizeHole,3)}if(o!==undefined)o()}),this.ItemsModel,n)}else{if(o!==undefined)o();this.RefreshAnnotations();this.Render3D()}}Actions(e){}ProcessKeyDown(e,t){WebClient.Utils.DebugConsoleLog("key")}ProcessWheel(e,t){if(this.ToolsFree&&this.Viewer3D!==undefined){this.Viewer3D.Controller.Zoom3D(t.deltaY);this.RenderAnnotations()}}ProcessPinchAndRotate(e,t){var o;if(this.Viewer3D===undefined)return;if(t.pointerType==="touch"||t.pointerType==="pen"||((o=t.srcEvent)===null||o===void 0?void 0:o.touches)){if(t.type==="pinchstart"){this.initPinchHammer=t.scale;var n=DOMUtils.GetOffset(t.pointers[0],"x");var r=DOMUtils.GetOffset(t.pointers[0],"y");this.Context.MouseDownX=n;this.Context.MouseDownY=r}if(t.type==="pinchmove"){if(this.ToolsFree){var a=t.scale-this.initPinchHammer;if(Math.abs(a)>=.1){if(t.scale>this.initPinchHammer){this.Viewer3D.Controller.Zoom3D(-1)}else{this.Viewer3D.Controller.Zoom3D(1)}this.RenderAnnotations();this.initPinchHammer=t.scale}}}}}ProcessSingleTap(e,t){if(this.Viewer3D===undefined)return;var o=DOMUtils.GetOffset(t,"x");var n=DOMUtils.GetOffset(t,"y");this.Context.MouseDownX=this.Context.MouseMoveX=o;this.Context.MouseDownY=this.Context.MouseMoveY=n;var r=new WebClient.Point(this.Context.MouseDownX,this.Context.MouseDownY);switch(true){case e.match("Stl[A-za-z]*3DAnnotation")!==null:this.processAnnotations(e,r,ImagingStudyView.EAnnotationEventType.Tap);break;case this.ReadyForSetReferencePoint:this.FillReferencesPoints(r);this.ReadyForSetReferencePoint=false;this.IndexReferenceRotationGroup=-1;this.ViewportFrameElement.style.cursor="default";this.Render3D();break;case!e.match("Annotation"):var a=new ImagingStudyView.AnnotationPoint(r);var s=this.DetectAnnotation(a);if(s!==null){if(s.annotation.Plugin!==this.Plugin.PluginName)return;this.IsAnyAnnotationSelected=true;this.Annotations[this.Plugin.PluginName]=this.Context.Annotations;s.annotation.Selected=!s.annotation.Selected}else{var l=this.Context.Annotations;l.forEach((e=>{e.Selected=false}))}this.Render3D();break}}FillReferencesPoints(e){this.ReferenceRotationPoints[this.IndexReferenceRotationGroup]={"2d":e,"3d":null};this.Render3D()}DrawCrossReferenceRotation(){for(const e in this.ReferenceRotationPoints){if(this.ReferenceRotationPoints.hasOwnProperty(e)){const t=this.ReferenceRotationPoints[e];this.drawCrossMouse(t["2d"],WebClient.Colors.SunFlower);this.drawNumberGroup(t["2d"],e)}}}Get3DPoint(e){if(this.Viewer3D===undefined)return;var t=null;var o=this.Viewer3D.Controller.PickPoint3D(e.X,e.Y,false);if(o!==undefined){var n=o.model.TransformMatrix.MultiplyFromVector([o.point.x,o.point.y,o.point.z,1]);t=new WebClient.Point3D(n,0)}return t}Convert3DPointToProyect2d(e){if(this.Viewer3D===undefined)return;var t=this.Viewer3D.Controller.MakeOrthographic();var o=t.MultiplyByMatrix(this.Viewer3D.Controller.ViewMatrix);var n=this.Viewer3D.Controller.GetProject2D(e.X,e.Y,e.Z,o);return new WebClient.Point(n.x,n.y)}GetPointsGroupConvert(e){try{var t=e.map((e=>{var t=this.Convert3DPointToProyect2d(new WebClient.Point3D(e.X,e.Y,e.Z));return new ImagingStudyView.AnnotationPoint(t)}));return t}catch(e){}return[]}ProcessDoubleTap(e,t){}MoveOnCanvas(e){var t;var o;var n;var r;var a;if(this.Context.CurrentAnnotation&&this.ViewerPage.ToolSelect.match("Stl[A-za-z]*3DAnnotation")){t=this.UpdateDeltaInMove(e);o=t.deltaX;n=t.deltaY;r=new WebClient.Point(this.Context.MouseMoveX,this.Context.MouseMoveY);a=this.Context.CurrentAnnotation;if(a!==undefined&&a!==null&&a.Status!==ImagingStudyView.EAnnotationStatus.Complete){this.Context.CurrentAnnotation.TemporalCurrentGroupName=this.Context.AnnotationController.CurrentGroup?this.Context.AnnotationController.CurrentGroup.GroupName:null;this.Context.CurrentAnnotation.TemporalPoint=new ImagingStudyView.AnnotationPoint(r)}}this.Render3D()}ProcessMouseMove(e,t){if(t.srcEvent!==undefined&&t.pointerType==="mouse"||(t.srcEvent===undefined||t instanceof MouseEvent))this.MoveOnCanvas(t)}ProcessPanAndSwipe(e,t){var o;if(this.Viewer3D===undefined)return;var n=DOMUtils.GetOffset(t,"x");var r=DOMUtils.GetOffset(t,"y");var a;var s;var l=t.srcEvent;var h;switch(true){case t.type==="panstart":this.Viewer3D.Controller.MouseDownFixed=true;this.Context.MouseDownX=this.Context.MouseMoveX=n;this.Context.MouseDownY=this.Context.MouseMoveY=r;break;case t.type==="panmove":if(e.match("Stl[A-za-z]*3DAnnotation")&&(t.pointerType==="touch"||t.pointerType==="pen"||((o=t.srcEvent)===null||o===void 0?void 0:o.touches))){this.MoveOnCanvas(t);return}a=n-this.Context.MouseMoveX;s=r-this.Context.MouseMoveY;this.Context.MouseMoveX=n;this.Context.MouseMoveY=r;if(this.modelSelected!==null&&this.modelSelected!==undefined){this.modelSelected.PositionX+=a===0||Math.abs(a)<=10?0:a<0?-2.5:2.5;this.modelSelected.PositionY+=s===0||Math.abs(s)<=10?0:s<0?2.5:-2.5}else{if(this.ToolsFree){this.Viewer3D.Controller.RotateView3D(this.Context.MouseDownX,this.Context.MouseDownY,this.Context.MouseMoveX,this.Context.MouseMoveY)}}this.Render3D();break;case t.type==="panend":this.Viewer3D.Controller.MouseDownFixed=false;this.Context.MouseDownX=this.Context.MouseMoveX=n;this.Context.MouseDownY=this.Context.MouseMoveY=r;this.modelSelected=null;break}}backToParentViewport(){try{var e=this.Plugin.Controller.ViewportPane.ViewportsCollection[this.IndexNumber];var t=null;for(const o in e["LoadedViewports"]){if(e["LoadedViewports"].hasOwnProperty(o)){const n=e["LoadedViewports"][o];if(o!==this.constructor.name){t=n}}}if(t!==null){this.ViewerPage.View.Plugins.forEach((e=>{if(e.PluginName===t.Plugin.PluginName){this.Plugin.Controller.View.Platform.Toolbar.DeselectButton("toolbarviewer.2","3dTool","fixedSelected");var o=e.ReCreateViewport(this.IndexNumber);o.SelectViewport=true;e.SetSeriesToViewport(t["Context"]["StudyGuid"],t["Context"]["SeriesGuid"],t["Context"]["ImageEntity"]["ImageGUID"],t["Context"]["SeriesIndex"],t["Context"]["ImageIndex"],true)}}))}}catch(e){}}processAnnotations(tool,positionInCanvas,eventName){if(this.Viewer3D===undefined)return;var newPoint=new ImagingStudyView.AnnotationPoint(positionInCanvas,eventName);var new3DPoint=this.Get3DPoint(newPoint);var text;if(this.Context.CurrentAnnotation===null||this.Context.CurrentAnnotation===undefined){var subTypeAnnotationName=tool.substr(3);this.Context.CurrentAnnotation=eval("new Vue.Products.StlPlugin."+subTypeAnnotationName+"()");this.Context.CurrentAnnotation.Context=this.Context;this.Context.CurrentAnnotation.Context.Canvas2DProjected=this.Viewer3D.Controller.GetCanvas2D();this.Context.CurrentAnnotation.Context.ContextGl3D=this.Viewer3D.Controller.GetContext3D();this.Context.CurrentAnnotation.Id=WebClient.Utils.GetGuid();this.Context.CurrentAnnotation.Selected=false;this.Context.CurrentAnnotation.Author=sessionStorage["userEmail"];this.Context.CurrentAnnotation.Date=new Date;this.Context.CurrentAnnotation.Plugin=this.Plugin.PluginName;this.Context.CurrentAnnotation.Status=ImagingStudyView.EAnnotationStatus.New;this.Context.CurrentAnnotation["new"]=true;this.Context.AnnotationController=new ImagingStudyView.AnnotationController(this.Context.CurrentAnnotation);switch(tool){case"StlLine3DAnnotation":case"StlArrow3DAnnotation":this.Context.AnnotationController.SetFirstGroup();if(new3DPoint!==null){this.Context.AnnotationController.RegisterPoint(new3DPoint)}else{this.Context.AnnotationController.ReversePointRegister()}break}}else{switch(tool){case"StlLine3DAnnotation":if(new3DPoint!==null){this.Context.AnnotationController.RegisterPoint(new3DPoint);if(this.Context.CurrentAnnotation.DrawIsValid()){if(this.Context.AnnotationController.IsCompleted){this.Context.CurrentAnnotation.Status=ImagingStudyView.EAnnotationStatus.Complete;this.Context.CurrentAnnotation.MeasureAnnotation();this.Context.Annotations.push(this.Context.CurrentAnnotation);this.annotationDone()}}else{this.Context.AnnotationController.ReversePointRegister()}}else{this.Context.AnnotationController.ReversePointRegister()}break;case"StlArrow3DAnnotation":if(new3DPoint!==null){this.Context.AnnotationController.RegisterPoint(new3DPoint);if(this.Context.CurrentAnnotation.DrawIsValid()){var annotPointArrow=new ImagingStudyView.AnnotationPoint(new3DPoint,eventName);text=prompt("Annotation text:","");if(text!==null){this.Context.AnnotationController.RegisterPoint(annotPointArrow);this.Context.CurrentAnnotation.Status=ImagingStudyView.EAnnotationStatus.Complete;this.Context.CurrentAnnotation.TextLabel=text;this.Context.Annotations.push(this.Context.CurrentAnnotation);this.annotationDone()}else{this.Context.AnnotationController.ReversePointRegister()}}else{this.Context.AnnotationController.ReversePointRegister()}}else{this.Context.AnnotationController.ReversePointRegister()}break}}this.Render3D()}annotationDone(){var e=this.Plugin.GetViewportPerIndex(3);if(this===e)e.ToolsFree=false;if(this.Annotations[this.Plugin.PluginName]===undefined)this.Annotations[this.Plugin.PluginName]=this.Context.Annotations;this.AnnotationManager.SaveAnnotation(this.Context.CurrentAnnotation);this.Context.CurrentAnnotation=null;this.ViewportFrameElement.style.cursor="default";this.Plugin.CloneAnnotations(this,undefined,(e=>{e.Render3D()}));this.Plugin.RefreshAnnotationsOnAllViewports()}drawNumberGroup(e,t){if(this.Viewer3D===undefined)return;var o=this.Viewer3D.Controller.GetCanvas2D();var n=o.getContext("2d");n.save();n.font=10+"pt bold Segoe UI, Arial, Tahoma, Verdana, sans-serif";n.fillStyle=WebClient.Colors.SunFlower;n.fillText(t,e.X+5,e.Y-5);n.restore()}drawCrossMouse(e,t){if(this.Viewer3D===undefined)return;var o=this.Viewer3D.Controller.GetCanvas2D();var n=o.getContext("2d");n.save();n.strokeStyle=t===undefined?WebClient.Colors.Alizarin:t;n.lineWidth=1;n.beginPath();n.moveTo(e.X-10,e.Y);n.lineTo(e.X+10,e.Y);n.moveTo(e.X,e.Y-10);n.lineTo(e.X,e.Y+10);n.stroke();n.closePath();n.restore()}finishLoad3D(){}moveModel(e){this.modelSelected=this.models[""+e+""]}}StlPlugin.StlViewport=StlViewport})(StlPlugin=Products.StlPlugin||(Products.StlPlugin={}))})(Products=Vue.Products||(Vue.Products={}))})(Vue||(Vue={}));var Vue;(function(e){var t;(function(e){var t;(function(e){class StlViewportContext{constructor(e){this.ImageSubIndex=0;this.IsPseudoSeries=false;this.InvertImage=false;this.Window=undefined;this.Level=undefined;this.WindowDelta=0;this.LevelDelta=0;this.ScaleX=1;this.ScaleY=1;this.Rotation=0;this.OffsetX=0;this.OffsetY=0;this.MouseMoveX=0;this.MouseMoveY=0;this.MouseDownX=0;this.MouseDownY=0;this.Viewport=e}}e.StlViewportContext=StlViewportContext})(t=e.StlPlugin||(e.StlPlugin={}))})(t=e.Products||(e.Products={}))})(Vue||(Vue={}));