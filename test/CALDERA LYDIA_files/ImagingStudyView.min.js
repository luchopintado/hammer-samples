var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;var a=e.Frontend.WebClient.DOMUtils;class CaseStudyPaneForm{Create(e,t,r){var o=new Array;var s=document.createElement("div");a.AddClass(s,"section");var l=document.createElement("div");a.AddClass(l,"block");s["AddExist"]=l;var h=new n.Form(l,t[0],r);h.AddField(new n.Field(n.EFieldType.Radio,"radioCaseAddOne",{action:t[0].actionRadioCaseStudy,checked:t[0].checkedAddExist,label:t[0].radioOptionAddExist,name:"radioCase",newline:true},{width:"220px"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectCaseExist",{options:t[0].optionsCaseExist,values:t[0].valuesCaseExist,value:t[0].valueCaseExist,action:t[0].onchangeSelectCaseExist,newline:false,disabled:true},{width:"250px","margin-right":"5px","margin-bottom":"5px"},[]));h.AddField(new n.Field(n.EFieldType.Button,"btnAddExist",{id:"IdButtonAdd",text:t[0].addExistingCaseStudyText,disabled:true},{height:"25px"},["inline"],t[0].actionBtnAddExistingCaseStudy));h.Render();s.appendChild(l);var l=document.createElement("div");a.AddClass(l,"block");s["AddNew"]=l;var h=new n.Form(l,t[0],r);h.AddField(new n.Field(n.EFieldType.Radio,"radioCaseAddNewOne",{action:t[0].actionRadioCaseStudy,checked:t[0].checkedAddNew,label:t[0].radioOptionAddNew,name:"radioCase",newline:true},{width:"220px"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textFieldDescription",{text:t[0].studyDescription,width:110,colon:true},{display:"none"},[]));h.AddField(new n.Field(n.EFieldType.Textbox,"inputDescription",{value:"",newline:false,width:270},{width:"270px",display:"none"},[]));h.AddField(new n.Field(n.EFieldType.NewLine,"",{space:true,text:""},{margin:"0;","line-height":"7px;"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textFieldPatient",{text:t[0].patientText,width:110,colon:true},{display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.Textbox,"inputPatient",{value:"",id:"inputTextPatient",readonly:true,width:270},{width:"270px",display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.NewLine,"",{space:true,text:""},{margin:"0;","line-height":"7px;"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textFieldDate",{text:t[0].dateText,width:110,colon:true},{display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.Textbox,"inputDate",{value:"",id:"inputTextDate",readonly:true,width:270},{display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.NewLine,"",{space:true,text:""},{margin:"0;","line-height":"7px;"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textFieldPhysician",{text:t[0].physician,width:110,colon:true},{display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.Textbox,"inputPhysician",{value:"",id:"inputTextPhysician",readonly:true,width:270},{width:"270px",display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.NewLine,"",{space:true,text:""},{margin:"0;","line-height":"7px;"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textFieldInstitution",{text:t[0].institutionText,width:110,colon:true},{display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.Textbox,"inputInstitution",{value:"",id:"inputTextInstitution",readonly:true,width:270},{width:"270px",display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.NewLine,"",{space:true,text:""},{margin:"0;","line-height":"7px;"},[]));h.AddField(new n.Field(n.EFieldType.Button,"btnAddNew",{id:"IdButtonNew",text:t[0].addNewCaseStudyText,disabled:false},{height:"25px"},["green","inline"],t[0].actionBtnNewCaseStudy));h.Render();s.appendChild(l);e.appendChild(s);o.push(s);return o}}t.CaseStudyPaneForm=CaseStudyPaneForm})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;var a=e.Frontend.WebClient.DOMUtils;class ConfigViewerForm{Create(e,t,r){var o=new Array;var s=document.createElement("div");a.AddClass(s,"section");var l=document.createElement("div");a.AddClass(l,"block");s["viewports"]=l;var h=new n.Form(l,t[0],r);h.AddField(new n.Field(n.EFieldType.Group,"",{text:"VIEWPORTS"},{},[]));h.AddField(new n.Field(n.EFieldType.Radio,"chkAutomaticDistribution",{action:t[0].ActionChkAutDistrib,checked:t[0].checkedAutDistrib,label:"Automatic distribution",name:"radioDistribution",newline:true},{width:"220px"},[]));h.AddField(new n.Field(n.EFieldType.Radio,"chkFixedDistribution",{action:t[0].ActionChkFixedDistrib,checked:t[0].checkedFixedDistrib,label:"Fixed distribution",name:"radioDistribution",newline:true},{width:"220px"},[]));h.AddField(new n.Field(n.EFieldType.Radio,"chkLastUsedDistribution",{action:t[0].ActionChkLastDistrib,checked:t[0].checkedLastDistrib,label:"Last used",name:"radioDistribution",newline:true},{width:"220px"},[]));h.AddField(new n.Field(n.EFieldType.ButtonBar,"buttonBarHorizontal",{options:t[0].optionsCheckHorizontalBb,name:"radiobbhorizontal",id:"bbconfigHor",optionchecked:t[0].optCheckHorizontalBb,onChange:t[0].actionOnchangeBarHorizontal},{display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textBtBarHorizontal",{text:"Horizontal viewports",newline:true,colon:false,width:110},{display:"inline-block",margin:"0 0 0 10px",width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.ButtonBar,"buttonBarVertical",{options:t[0].optionsCheckVerticalBb,name:"radiobbvertical",id:"bbconfigVer",optionchecked:t[0].optCheckVerticalBb,onChange:t[0].actionOnchangeBarVertical},{display:"inline-block"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textBtBarVertical",{text:"Vertical viewports",colon:false,newline:true,width:110},{display:"inline-block",margin:"0 0 0 10px",width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.Checkbox,"chkBoxRecallLastDisplay",{id:"chkBoxRecallLastDisplayStatus",action:t[0].chkBoxRecallLastDisplayAction,label:t[0].chkBoxRecallLastDisplayLabel,checked:t[0].chkBoxRecallLastDisplayValue,newline:true},{},[]));h.Render();s.appendChild(l);var l=document.createElement("div");a.AddClass(l,"block");s["contextMenu"]=l;var h=new n.Form(l,t[0],r);h.AddField(new n.Field(n.EFieldType.Group,"",{text:"CONTEXT MENU"},{},[]));h.AddFields(t[0].fieldsContextMenu);h.Render();s.appendChild(l);e.appendChild(s);o.push(s);var u=document.createElement("div");a.AddClass(u,"section");var l=document.createElement("div");a.AddClass(l,"block");u["behaviorsAct"]=l;var h=new n.Form(l,t[1],r);h.AddField(new n.Field(n.EFieldType.Group,"",{text:t[1].titleGroupBehAct},{},[]));h.AddField(new n.Field(n.EFieldType.Label,"textDefaultLeftBtn",{text:t[1].labelDefaultLeftBtn,colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectMouseDefaultLeft",{options:t[1].optionsMouseDefaultLeft,values:t[1].valuesMouseDefaultLeft,value:t[1].valueMouseDefaultLeft,action:t[1].actionMouseDefaultLeft,newline:true},{width:"250px"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textDragRightBtn",{text:t[1].labelDragRightBtn,colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectMouseBehDragRight",{options:t[1].optionsMouseDragRight,values:t[1].valuesMouseDragRight,isGroups:true,groups:t[1].objGroupMouseDragRight,value:t[1].valueMouseDragRight,action:t[1].actionMouseBehDragRight,newline:true},{width:"250px"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textDragMiddleBtn",{text:t[1].labelDragMiddleBtn,colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectMouseBehDragMiddle",{options:t[1].optionsMouseDragMiddle,values:t[1].valuesMouseDragMiddle,isGroups:true,groups:t[1].objGroupMouseDragMiddle,value:t[1].valueMouseDragMiddle,action:t[1].actionMouseBehDragMiddle,newline:true},{width:"250px"},[]));h.AddField(new n.Field(n.EFieldType.Label,"LabelWheelConfiguration",{text:t[1].labelWheelConfig,colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectWheelConfiguration",{options:t[1].optionsWheelConfiguration,values:t[1].valuesWheelConfiguration,value:t[1].valueWheelConfiguration,action:t[1].actionWheelConfiguration,newline:true},{width:"250px"},[]));h.AddField(new n.Field(n.EFieldType.Label,"LabelScrollSpeed",{text:t[1].labelScrollSpeed,colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.ButtonBar,"buttonBarScrollSpeed",{options:t[1].optionsScrollSpeed,name:"radioScrollSpeed",id:"bbconfigScrollSpeed",optionchecked:t[1].optScrollSpeed,onChange:t[1].actionOnchangeScrollSpeed,newline:true},{display:"block"},[]));h.AddField(new n.Field(n.EFieldType.Label,"SeriesScrollOrientationConfiguration",{text:t[1].labelScrollOrientationConfig,colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectScrollOrientationConfiguration",{options:t[1].optionsScrollOrientationConfiguration,values:t[1].valuesScrollOrientationConfiguration,value:t[1].valueScrollOrientationConfiguration,action:t[1].actionScrollOrientationConfiguration,newline:true},{width:"250px"},[]));h.AddField(new n.Field(n.EFieldType.Label,"LabelZoomWheelConfiguration",{text:t[1].labelZoomWheelConfiguration,colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectZoomWheelConfiguration",{options:t[1].optionsZoomWheelConfiguration,values:t[1].valuesZoomWheelConfiguration,value:t[1].valueZoomWheelConfiguration,action:t[1].actionZoomWheelConfiguration,newline:true},{width:"250px"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textLeftDoubleClick",{text:t[1].labelLeftDblClick,colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectMouseBehLeftDoubleClick",{options:t[1].optionsMouseLeftDblClick,values:t[1].valuesMouseLeftDblClick,isGroups:true,groups:t[1].objGroupMouseLeftDblClick,value:t[1].valueMouseLeftDblClick,action:t[1].actionMouseLeftDblClick,newline:true},{width:"250px"},[]));h.AddField(new n.Field(n.EFieldType.Checkbox,"chkBoxRecallLeftButtonTool",{id:"chkBoxRecallLeftButtonToolId",action:t[1].chkBoxRecallLeftButtonToolAction,label:t[1].chkBoxRecallLeftButtonToolLabel,checked:t[1].chkBoxRecallLeftButtonToolChecked,newline:true},{},[]));h.Render();u.appendChild(l);var l=document.createElement("div");a.AddClass(l,"block");u["general"]=l;var h=new n.Form(l,t[1],r);h.AddField(new n.Field(n.EFieldType.Group,"",{text:"GENERAL"},{},[]));h.AddField(new n.Field(n.EFieldType.Checkbox,"chkBoxThumbnail",{id:"chkBoxThumbnailStatus",action:t[1].chkBoxThumbnailStatusAction,label:t[1].chkBoxThumbnailLabel,checked:t[1].chkBoxThumbnailChecked,newline:true},{},[]));h.AddField(new n.Field(n.EFieldType.Label,"textThumbnailPosition",{text:"Thumbnail position",colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectGeneralThumbnailPosition",{options:t[1].optionsGenerThumbPosition,values:t[1].valuesGenerThumbPosition,value:t[1].valueGenerThumbPosition,action:t[1].actionSelectThumbPosition,newline:true},{width:"250px"},[]));h.AddField(new n.Field(n.EFieldType.Label,"textGlassSize",{text:"Glass size",colon:false,newline:true,width:110},{width:"auto"},[]));h.AddField(new n.Field(n.EFieldType.SelectBox,"selectGlassSize",{options:t[1].optionsGlassSize,values:t[1].valuesGlassSize,value:t[1].valueGlassSize,action:t[1].actionSelectGlassSize},{widtH:"150px"},[]));h.Render();u.appendChild(l);e.appendChild(u);o.push(u);return o}}t.ConfigViewerForm=ConfigViewerForm})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;var a=e.Frontend.FhirClient;class AnnotationClient{constructor(e,t){this.platform=e;this.view=t}GetAllAnnotationsForStudy(e,t){var r=new Array;var callAnnotations=(o,s,l)=>{var h=new a.FhirCall(o,"GET");var u=a.ValueHelper.GetTagFhirFromActiveStudies(this.view.ViewerPage.ImagingStudyFhirEntities,true,e,"modifierExtension[0].url");if(u!==null){var d={};var c=u.split("/")[1];d["X-Organization-PK"]=c;h.Headers=d}h.FuncOk=(e,a)=>{if(e!==""){var o=JSON.parse(e);var h=o["entry"];if(h){for(var u=0;u<h.length;u++){var d=h[u];if(d["resource"]["extension"]!==undefined&&d["resource"]["extension"][0]["url"].toString().match("annotation")){try{var c=decodeURIComponent(n.Utils.DecodeBase64(d["resource"]["extension"][0]["valueString"]));var m=JSON.parse(c);m.Id=d["resource"]["id"];r.push(m)}catch(e){n.Utils.DebugConsoleLog("Annotation with incorrect format in GetAllAnnotationsForStudy")}}if(d["resource"]["valuestring"]!==undefined||d["resource"]["valuestring"]!==""){try{var c=decodeURIComponent(n.Utils.DecodeBase64(d["resource"]["valueString"]));var m=JSON.parse(c);m.Id=d["resource"]["id"];r.push(m)}catch(e){n.Utils.DebugConsoleLog("Annotation with incorrect format in GetAllAnnotationsForStudy")}}}}var g=false;var w;var f=o["link"];for(var p=0;p<f.length;p++){var S=f[p];if(S["relation"]==="next"&&S["url"]!==""&&S["url"]!==undefined){g=true;w=S["url"];break}}if(!g){if(s)t(r,false);else{if(l!==undefined)l()}}else{var v=n.PlatformContext.PlatformUri+"/"+w;callAnnotations(v,s,l)}}else{t(r,false)}};h.FuncError=e=>{try{var a=sessionStorage["applicationTags"];if(a!==undefined)a=JSON.parse(a);if(a===undefined||a["guest"]===undefined||a["guest"]!==undefined&&!a["guest"])n.Toaster.ShowToast("Error getting annotations",n.Colors.Orange,3)}catch(e){}finally{if(s)t(r,true)}};h.Send()};var o=n.PlatformContext.PlatformUri+"/fhir/Basic?subject="+e+"&code=annotation";callAnnotations(o,false,(()=>{var t=n.PlatformContext.PlatformUri+"/fhir/Observation?part-of="+e;callAnnotations(t,true)}))}SaveAnnotation(e,t,r=false,o,s=true){var l=JSON.parse(t);var h=l["Id"];var u=new Date(l["Date"]);var d={resourceType:"Observation",id:h,partOf:[{reference:"ImagingStudy/"+e}],status:"registered",code:{coding:[{system:"http://loinc.org",code:"19005-8"}]},issued:n.Utils.FormatDateTime(u.getFullYear()+"-"+(u.getMonth()+1)+"-"+u.getDate()),performer:[{reference:sessionStorage["practitionerId"]}],valueString:n.Utils.EncodeBase64(encodeURIComponent(t))};var c=r===true?"POST":"PUT";var m=n.PlatformContext.PlatformUri+"/fhir/Observation"+(r===true?"":"/"+h);var g=new a.FhirCall(m,c);g.BodyData=JSON.stringify(d);var w={};w["Content-Type"]="application/json; charset=utf-8";var f=this.view.ViewerPage.GetSelectViewport(this.view.ViewerPage.ViewportPane).Context.StudyGuid;var p=this.view.SendHeaderDistinctOrganization(f,w);if(p!==null)g.Headers=p;else g.Headers=w;g.FuncOk=(e,t,a)=>{if(t===201){if(r){if(s===true)n.Toaster.ShowToast("The annotation has been created.",n.Colors.PeterRiver,3);if(o!==undefined&&o!==null)o(a)}}else if(t===200){if(o)o(a)}};g.FuncError=e=>{n.Toaster.ShowToast("Error saving annotation.",n.Colors.Orange,3);if(o!==undefined&&o!==null)o()};g.Send()}DeleteAnnotation(e,t=true){var r=n.PlatformContext.PlatformUri+"/fhir/Basic/"+e;var o=new a.FhirCall(r,"DELETE");var s=this.view.ViewerPage.GetSelectViewport(this.view.ViewerPage.ViewportPane).Context.StudyGuid;var l=this.view.SendHeaderDistinctOrganization(s);o.Headers=this.addedDeleteHeaders(l);o.FuncOk=(e,a)=>{if(a===204||a===200){if(t)n.Toaster.ShowToast("The annotation was deleted.",n.Colors.PeterRiver,3)}};o.FuncError=e=>{n.Toaster.ShowToast("Error deleting annotation.",n.Colors.Orange,3)};o.Send();var r=n.PlatformContext.PlatformUri+"/fhir/Observation/"+e;o=new a.FhirCall(r,"DELETE");o.Headers=this.addedDeleteHeaders(l);o.FuncOk=(e,t)=>{};o.FuncError=e=>{};o.Send()}addedDeleteHeaders(e){if(e!==null)e["X-HardDelete"]=true;else e={"X-HardDelete":true};return e}}t.AnnotationClient=AnnotationClient})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;class AnnotationController{constructor(e){this.Template=e.GetTemplate();this.IsCompleted=false;this.CurrentGroup=null;this.Instance=e;this.analyzeTemplate()}SetFirstGroup(){var e=Object.keys(this.Template.Groups)[0];this.CurrentGroup=this.Template.Groups[e]}SetCurrentGroup(e){if(!this.Template.Groups.hasOwnProperty(e))throw new Error("Group not found in SetCurrentGroup");this.CurrentGroup=this.Template.Groups[e]}JumpToNextGroup(){if(this.CurrentGroup==null)return;this.CurrentGroup=this.CurrentGroup.NextGroup}RegisterPoint(e){if(this.CurrentGroup==null){this.evaluateIsCompleted();return}var n=this.Instance.Points[this.CurrentGroup.GroupName];if(n===undefined)return;n.push(new t.AnnotationPoint(e));this.evaluateIsCompleted();this.jumpToNextStepOrGroup()}ReversePointRegister(){if(this.CurrentGroup===null||this.CurrentGroup===undefined){var e=Object.keys(this.Template.Groups);var t=e.length;do{t--;this.CurrentGroup=this.Template.Groups[e[t]]}while(!this.Template.Groups[e[t]].IsDesign)}var n=this.Instance.Points[this.CurrentGroup.GroupName].length-1;if(n>0){this.Instance.Points[this.CurrentGroup.GroupName].splice(n-1,1)}else if(this.CurrentGroup.PrevGroup!==undefined&&this.CurrentGroup.PrevGroup!==null&&n===0){this.Instance.Points[this.CurrentGroup.GroupName].splice(0,1);this.CurrentGroup=this.CurrentGroup.PrevGroup}}GetGroupPointCount(e){if(e==null)throw new Error("Null group GetGroupPointCount");if(!this.Instance.Points.hasOwnProperty(e.GroupName))throw new Error("Invalid group name in GetGroupPointCount");return this.Instance.Points[e.GroupName].length}GroupIsSatisfied(e){try{return this.GetGroupPointCount(e)>=e.MinPoints&&e.IsDesign||!e.IsDesign}catch(e){return false}}GroupIsComplete(e){try{return this.GetGroupPointCount(e)===e.MaxPoints}catch(e){return false}}ResetCurrentGroup(){if(this.CurrentGroup==null)return;var e=this.CurrentGroup;do{this.resetPointsInInstance(e.GroupName);this.CurrentGroup=e;e=e?e.PrevGroup:null}while(e!=null)}ResetOnlyCurrentGroup(){if(this.CurrentGroup==null)return;var e=this.CurrentGroup;this.resetPointsInInstance(e.GroupName)}EvaluateIsCompleted(){this.evaluateIsCompleted()}analyzeTemplate(){for(var e in this.Template.Groups){if(!this.Template.Groups.hasOwnProperty(e))continue;var t=this.Template.Groups[e];var n=t.NextGroup;if(n===undefined){t.NextGroup=null}else if(typeof n==="string"){if(!this.Template.Groups.hasOwnProperty(n))throw new Error("Invalid group name in JumpToNextGroup");t.NextGroup=this.Template.Groups[n];t.NextGroup.PrevGroup=t}if(t.PrevGroup===undefined)t.PrevGroup=null}}jumpToNextStepOrGroup(){if(!this.GroupIsSatisfied(this.CurrentGroup))return;if(this.currentGroupIsComplete())this.JumpToNextGroup()}currentGroupIsComplete(){var e=this.Instance.Points[this.CurrentGroup.GroupName].length;return e>=this.CurrentGroup.MaxPoints}resetPointsInInstance(e){if(!this.Instance.Points.hasOwnProperty(e))throw new Error("Invalid group name in ResetCurrentGroup");this.Instance.Points[e]=[]}evaluateIsCompleted(){for(var e in this.Template.Groups){if(!this.Template.Groups.hasOwnProperty(e))continue;var t=this.Template.Groups[e];if(t.IsOptional===true)continue;if(!this.GroupIsSatisfied(t)){this.IsCompleted=false;return}}this.IsCompleted=true}static ConvertSamplePoints(e){var a={};var r=Object.keys(e);r.forEach((r=>{for(var o=0;o<e[r].length;o++){var s=e[r][o];if(s){if(a[r]===undefined)a[r]=new Array;if(s["Z"]!==undefined&&s["Z"]!==null)a[r].push(new t.AnnotationPoint(new n.Point3D(s["X"],s["Y"],s["Z"])));else a[r].push(new t.AnnotationPoint(new n.Point(s["X"],s["Y"])))}}}));return a}}t.AnnotationController=AnnotationController})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(Efferent){var ClientViews;(function(ClientViews){var ImagingStudyView;(function(ImagingStudyView){var WebClient=Efferent.Frontend.WebClient;class AnnotationManager{constructor(e){this.viewport=e;this.viewerPage=e.ViewerPage;this.AnnotationsStack=new Array}SaveToSpecialAnnotation(e,t,n,a,r,o){let s={Id:o!==null&&o!==void 0?o:e.Id,DialogIsOpened:true,PlugiName:n,Type:e.constructor.name,Viewport:t,ContextReplaceNames:a,Annotation:new WebClient.Cloner({proto:true,excludeProperties:r}).Clone(e),IsActive:true,ImageGuid:e.Context.ImageEntity.ImageGUID};this.viewerPage.SpecialAnnotations[o!==null&&o!==void 0?o:e.Id]=s}RestoreSpecialAnnotationToCurrentDrawObject(e,t){let n=this.viewerPage.SpecialAnnotations[t];if(n){e=n.Annotation;e.Context=n.Viewport.Context}}DrawAnnotations(e){if(this.viewport.Context.ImageEntity!==null){try{this.viewport.Context.Renderer.Render(undefined,e);this.viewport.Context.OverlayRenderer.Render()}catch(e){}}}PropagateAnnotations(e,t,n){n.Annotations={};n.SetAnnotationsInViewport=true;for(var a=0;a<this.viewerPage.View.Plugins.length;a++){this.viewerPage.View.Plugins[a].InitAnnotations(n.Context,n)}for(a=0;a<e.length;a++){var r=e[a];if(typeof r==="string")r=JSON.parse(r);r.Context=t;if(n.Annotations[r.Plugin]===undefined){n.Annotations[r.Plugin]=new Array;n.Annotations[r.Plugin].push(r)}else{n.Annotations[r.Plugin].push(r)}}for(a=0;a<this.viewerPage.View.Plugins.length;a++){this.viewerPage.View.Plugins[a].SetAnnotations(n.Context,n)}}GetAnnotationsToViewport(image){try{var annotations;if(this.viewport.Context.IsPseudoSeries){this.viewport.SetAnnotationsInViewport=true;var annotationsString=this.viewport.Context.KeyImageEntity.Annotations;var annotationsItems=JSON.parse(annotationsString);annotations=new Array;for(var i=0;i<annotationsItems.length;i++){var item=JSON.parse(annotationsItems[i]);try{var annotationSample=eval("new "+item.Namespace+"."+item.Name+"()");annotationSample.Deserialize(JSON.stringify(item));annotationSample.Selected=false;annotationSample.Status=ImagingStudyView.EAnnotationStatus.Complete;annotations.push(annotationSample)}catch(e){WebClient.Utils.DebugConsoleLog("No Annotation.")}}this.PropagateAnnotations(annotations,this.viewport.Context,this.viewport)}else{annotations=image.Annotations;this.PropagateAnnotations(annotations,this.viewport.Context,this.viewport)}}catch(e){WebClient.Utils.DebugConsoleLog("Getting annotation error: "+e)}}UnselectAllAnnotations(){for(var e=0;e<this.viewerPage.View.Plugins.length;e++){var t=this.viewerPage.View.Plugins[e].PluginName;var n=this.viewport.Context.Viewport.Annotations[t];if(n!==undefined&&n!==null){for(var a=0;a<n.length;a++){if(n[a].UnSelectToExecuteClickOnViewport)n[a].Selected=false}}}}SetSaveOrRetrieveStatusAnnotations(e){if(e)this.viewport.TemporalAnnotations=new Array;for(let t=0;t<this.viewerPage.View.Plugins.length;t++){let n=this.viewerPage.View.Plugins[t].PluginName;let a=this.viewport.Context.Viewport.Annotations[n];if(a!==undefined&&a!==null){for(let t=0;t<a.length;t++){if(e){this.viewport.TemporalAnnotations.push({AnnotationId:a[t].Id,Selected:a[t].Selected})}else{let e=this.viewport.TemporalAnnotations.find((e=>e.AnnotationId===a[t].Id));if(e)a[t].Selected=e.Selected}}}}if(!e)this.viewport.TemporalAnnotations=new Array}SaveAnnotation(e,t,n=true){if(this.viewport.Context===null&&this.viewport.Context.ImageEntity===null&&this.viewport.Context.ImageEntity===undefined)return;try{var a=e.Serialize();if(this.viewport.Context.ImageEntity){e.ColsOrigin=parseInt(this.viewport.Context.ImageEntity["dicomTags"]["0028_0011"]);e.RowsOrigin=parseInt(this.viewport.Context.ImageEntity["dicomTags"]["0028_0010"])}if(e["new"]===true){e["recentCreated"]=true;e["recentCreatedOnMemory"]=true;this.viewerPage.AnnotationClient.SaveAnnotation(this.viewerPage.ImagingStudyFhirEntities[this.viewport.Context.StudyGuid]["id"],a,true,(t=>{var n=t.getResponseHeader("Location");var a=n.split("Observation/")[1].split("/")[0];e.Id=a;for(var r=0;r<this.viewerPage.View.Plugins.length;r++){var o=this.viewerPage.View.Plugins[r].PluginName;var s=this.viewport.Context.Viewport.Annotations[o];if(s!==undefined&&s!==null){for(var l=0;l<s.length;l++){if(s[l].Id===e.Id){s[l].Id=a;delete s[l]["new"]}}}}this.UpdateAnnotationsToImage()}),n)}else{this.viewerPage.AnnotationClient.SaveAnnotation(this.viewerPage.ImagingStudyFhirEntities[this.viewport.Context.StudyGuid]["id"],a,false,t);this.UpdateAnnotationsToImage()}}catch(e){WebClient.Toaster.ShowToast("Error while saving annotation: "+e,WebClient.Colors.Orange,3)}}DrawGrips(e,t,n){if(t===undefined)return;var a=5/n;e.save();e.fillStyle=WebClient.Colors.Emerald;e.strokeStyle=WebClient.Colors.Nephritis;e.lineWidth=1/n;for(var r=0;r<t.length;r++){e.beginPath();e.arc(t[r].X,t[r].Y,a,0,2*Math.PI,false);e.closePath();e.fill();e.stroke()}e.restore()}DrawSnapsPoints(e,t,n){if(t===undefined)return;var a=5/n;e.save();e.fillStyle=WebClient.Colors.Carrot;e.strokeStyle=WebClient.Colors.Amethyst;e.lineWidth=1/n;for(var r=0;r<t.length;r++){e.beginPath();e.dashedLine(e,t[r].X-a,t[r].Y+a,t[r].X+a,t[r].Y+a,0);e.dashedLine(e,t[r].X+a,t[r].Y+a,t[r].X+a,t[r].Y-a,0);e.dashedLine(e,t[r].X+a,t[r].Y-a,t[r].X-a,t[r].Y-a,0);e.dashedLine(e,t[r].X-a,t[r].Y-a,t[r].X-a,t[r].Y+a,0);e.fill();e.stroke();e.closePath()}e.restore()}GetPointInDetectAnnotation(e,t){var n=this.detectAnnotationGrips(e);if(n!==null){var a=this.getIndexCoordInAnnotation(n,e.X,e.Y,undefined,t);return{annotation:n,coordIndex:a.index,group:a.group}}return null}DrawAnnotationText(e,t,n,a,r,o,s,l){if(o===null||!o)return null;e.textBaseline="middle";var h=o.split("\n");const u=this.viewport.Context.PrintFactor?this.viewport.Context.PrintFactor/2:1;const d=l?l/u||1:1;var c=this.measureAnnotationText(e,h,s,d);var m=r-c.height/2+s/2;let g=this.viewport.Context.PrintFactor?Math.abs(this.viewport.Context.ScaleX)*2.85*u:.85*u;if(!l)g=1;var w={X0:a-c.width/2*g,Y0:m-c.height/2*g,X1:a+c.width/2*g,Y1:m+c.height*g};for(var f=0;f<h.length;f++){this.DrawTextUntransformed(e,h[f],a,m,l?(this.viewport.Context.PrintFactor?Math.abs(this.viewport.Context.ScaleX)*2:.55)*d:null);a-=s*Math.cos(Math.PI/2+this.viewport.Context.Rotation*Math.PI/180);m+=s*Math.sin(Math.PI/2+this.viewport.Context.Rotation*Math.PI/180)}return w}DrawReferenceLine(e){var t=this.viewerPage.View.ReferencedAnnotationLayout;e.save();e.strokeStyle=WebClient.Colors.Pumpkin;e.lineWidth=3/this.viewport.Context.ScaleX;if(t!==undefined&&t!==null){if(t.endRangePoints!==""){var n=t.endRangePoints.split("-");var a=n[0].split(",");var r=n[1].split(",");e.dashedLine(e,t.annotation.Points[t.groupName][a[0]].X,t.annotation.Points[t.groupName][a[0]].Y,t.annotation.Points[t.groupName][r[1]].X,t.annotation.Points[t.groupName][r[1]].Y,0);this.DrawTextUntransformed(e,"+R+",t.annotation.Points[t.groupName][a[0]].X,t.annotation.Points[t.groupName][a[0]].Y);this.DrawTextUntransformed(e,"+R+",t.annotation.Points[t.groupName][r[1]].X,t.annotation.Points[t.groupName][r[1]].Y)}}e.restore()}DrawTextUntransformed(e,t,n,a,r){e.save();var o=false;var s=false;var l=this.viewport.Context.Rotation;if(this.viewport.Context.Rotation>=360)l=ImagingStudyView.Geometry.CalculateRotate360(this.viewport.Context.Rotation);else if(this.viewport.Context.Rotation<=-360)l=-ImagingStudyView.Geometry.CalculateRotate360(Math.abs(this.viewport.Context.Rotation));var h;var u;if(this.viewport.Context.ScaleX<0&&this.viewport.Context.ScaleY<0){h=Math.abs(this.viewport.Context.ScaleX);u=Math.round(11/h*10)/10;e.font=u+"pt Segoe UI, Arial, Tahoma, Verdana, sans-serif";e.scale(-1,-1);o=true;s=true}else{if(this.viewport.Context.ScaleX<0){h=Math.abs(this.viewport.Context.ScaleX);u=Math.round(11/h*10)/10;e.font=u+"pt Segoe UI, Arial, Tahoma, Verdana, sans-serif";e.scale(-1,1);o=true}else if(this.viewport.Context.ScaleY<0){h=Math.abs(this.viewport.Context.ScaleX);u=Math.round(11/h*10)/10;e.font=u+"pt Segoe UI, Arial, Tahoma, Verdana, sans-serif";e.scale(1,-1);s=true}}if(this.viewport.Context.Rotation<=0)e.rotate(-(this.viewport.Context.Rotation/(180/Math.PI)));else e.rotate(-(this.viewport.Context.Rotation/(180/Math.PI)));var d;var c;var m;if(l===0){d=n;c=a}else{m=-(l/180*Math.PI);d=n*Math.cos(-m)-a*Math.sin(-m);c=n*Math.sin(-m)+a*Math.cos(-m)}if(o){m=-(l/180*Math.PI);d=n*Math.cos(m)-a*Math.sin(m);c=n*Math.sin(m)+a*Math.cos(m);d=-d}else if(s){m=-(l/180*Math.PI);d=n*Math.cos(m)-a*Math.sin(m);c=n*Math.sin(m)+a*Math.cos(m);c=-c}if(o&&s){m=-(l/180*Math.PI);d=n*Math.cos(-m)-a*Math.sin(-m);c=n*Math.sin(-m)+a*Math.cos(-m);d=-d;c=-c}if(r){const t=this.viewport.Context.PrintFactor?this.viewport.Context.PrintFactor/2:1;const n=parseFloat(e.font)*r*t;e.font=`${n}pt Segoe UI, Arial, Tahoma, Verdana, sans-serif`;c+=Math.round(n/3)}e.shadowColor=WebClient.Colors.FullBlack;e.shadowBlur=1;e.lineWidth=1;let g=e.strokeStyle;e.shadowOffsetX=2;e.strokeStyle=WebClient.Colors.FullBlack;e.strokeText(t,d,c);e.shadowBlur=0;e.fillStyle=g;e.fillText(t,d,c);e.restore()}UpdateAnnotationsToImage(){var e=new Array;for(var t=0;t<this.viewerPage.View.Plugins.length;t++){var n=this.viewerPage.View.Plugins[t].PluginName;var a=this.viewport.Context.Viewport.Annotations[n];if(a!==undefined&&a!==null){for(var r=0;r<a.length;r++){e.push(a[r])}}}if(this.viewport.Context.ImageEntity)this.viewport.Context.ImageEntity.Annotations=e}UpdatePointsMoveOnFactorScale(e,t){var n=1;var a=t.Points;if(e.Context.ImageEntity){if(t["SetRowsAndColsForSpecialAnnotationWithDifferentContexts"])t["SetRowsAndColsForSpecialAnnotationWithDifferentContexts"]();n=e.GetFactorScaleImageLowOnHigh(t,e.Context.ImageEntity["dicomTags"]["0028_0011"],e.Context.ImageEntity["dicomTags"]["0028_0010"])}for(const r in a){if(a.hasOwnProperty(r)){const o=a[r];if(r!=="SnapPoints"&&r!=="ReferencePoints"){o.forEach(((a,o)=>{var s=e.Context===t["APContext"]&&r.match(/^AP/)!==null;var l=e.Context===t["MLContext"]&&r.match(/^ML/)!==null;var h=!t["APContext"]&&!t["MLContext"];if(s||l||h){t.Points[r][o].X*=n;t.Points[r][o].Y*=n}}))}}}t.ConvertPointsWithFactororResolution(n);if(!t["XCentroid"]&&!t["YCentroid"]){if(e.Context.ImageEntity){t.FactorScale=n;t.ColsOrigin=parseInt(e.Context.ImageEntity["dicomTags"]["0028_0011"]);t.RowsOrigin=parseInt(e.Context.ImageEntity["dicomTags"]["0028_0010"])}}}UpdateAnnotationsPerPlugin(e,t){e.forEach((e=>{this.UpdatePointsMoveOnFactorScale(t,e)}))}GetAllAnnotationsNearToPoint(e,t){var n=this.viewport.PointInElement(e,t);return this.detectAnnotationGrips(n,10)}DeleteAnnotation(e,t=true){if(this.viewport.Context.IsPseudoSeries)return;try{if(this.viewerPage.LoadAllAnnotationsForStudy&&this.viewerPage.LoadAllAnnotationsForStudy[e.Context.StudyGuid]){var n=this.viewerPage.LoadAllAnnotationsForStudy[e.Context.StudyGuid].findIndex((t=>t.Id===e.Id));if(n!==-1)this.viewerPage.LoadAllAnnotationsForStudy[e.Context.StudyGuid].splice(n,1)}this.viewerPage.AnnotationClient.DeleteAnnotation(e.Id,t)}catch(e){WebClient.Toaster.ShowToast("Error while deleting annotation: "+e,WebClient.Colors.Orange,3)}}GetAnnotationPerId(e){if(this.viewport.Context.ImageEntity===null)return null;try{var t=this.viewport.Context.Annotations;var n=this.viewport.Context.Viewport["RendererPlugins"];var a=Object.keys(n);for(var r=0;r<a.length;r++){var o=n[a[r]].Annotations;t=t.concat(o);if(n[a[r]].CurrentAnnotation!==null&&n[a[r]].CurrentAnnotation!==undefined)t=t.concat(n[a[r]].CurrentAnnotation)}if(t.length>0){for(var s=0;s<t.length;s++){if(t[s].Id===e){return t[s]}}}}catch(e){return null}return null}getIndexCoordInAnnotation(e,t,n,a,r){var o=0;var s=0;var l;var h;var u=1;var d={index:-1,group:null};if(e!==null){this.viewerPage.View.Plugins.forEach((t=>{var n=t.GetPointsGrips(t.PluginName,e);if(n!==null)s=n}));var c=e.Points;var m=Object.keys(c);m.forEach((s=>{var c=e.GetTemplate();o=0;if(c.Groups[s]!==undefined&&c.Groups[s].IsDraggable){while(o<e.Points[s].length){if(this.viewport.Context.ImageEntity){if(e["SetRowsAndColsForSpecialAnnotationWithDifferentContexts"])e["SetRowsAndColsForSpecialAnnotationWithDifferentContexts"]();u=this.viewport.GetFactorScaleImageLowOnHigh(e,this.viewport.Context.ImageEntity["dicomTags"]["0028_0011"],this.viewport.Context.ImageEntity["dicomTags"]["0028_0010"])}l=e.Points[s][o].X*u;h=e.Points[s][o].Y*u;if(r){if(l===t&&h===n){d={index:o,group:s};break}}else if(this.getDiffWithThreshold(l,h,t,n,a!==null&&a!==void 0?a:e["ThresholdImportant"])){if(e["AcumulatorShowGripsNumber"]&&(o===0||o%+e["AcumulatorShowGripsNumber"]===0)){d={index:o,group:s};break}else if(!e["AcumulatorShowGripsNumber"]){d={index:o,group:s};break}}o++}}}))}return d}measureAnnotationText(e,t,n,a=1){var r=0;for(var o=0;o<t.length;o++){r=Math.max(r,e.measureText(t[o]).width)}return{width:r*a,height:n*t.length*a}}detectAnnotationGrips(e,t){if(this.viewport.Context.ImageEntity===null)return null;try{var n=this.viewport.Context.Annotations;var a=this.viewport.Context.Viewport["RendererPlugins"];var r=Object.keys(a);for(var o=0;o<r.length;o++){var s=a[r[o]].Annotations;n=n.concat(s);if(a[r[o]].CurrentAnnotation!==null&&a[r[o]].CurrentAnnotation!==undefined)n=n.concat(a[r[o]].CurrentAnnotation)}if(n.length>0){for(var l=0;l<n.length;l++){var h=this.getIndexCoordInAnnotation(n[l],e.X,e.Y,t);if(h.index>=0){this.UpdatePointsMoveOnFactorScale(this.viewport,n[l]);return n[l]}}}}catch(e){return null}return null}getDiffWithThreshold(e,t,n,a,r){var o=(r!==undefined?r:ImagingStudyView.Viewport.AnnotationThreshold)/Math.abs(this.viewport.Context.ScaleX);var s=(r!==undefined?r:5)/Math.abs(this.viewport.Context.ScaleX);var l=Math.abs(this.viewport.Context.ScaleX*this.viewport.Context.ScaleX);var h=Math.round(11/l*10)/10;var u=e-s;var d=e+s;var c=t-h;var m=t;if(n>=u&&n<=d&&a>=c&&a<=m)return true;var g=s;var w=g;var f=Math.atan2((a-t)*Math.abs(g/w),n-e);var p=e+Math.cos(f)*Math.abs(g);var S=t+Math.sin(f)*Math.abs(w);var v=n-p;var P=a-S;var V=Math.sqrt(v*v+P*P);if(V<o)return true;return false}static EvaluateAnnotationTextInCanvas(e,t,n=1){var a=t.X>=e.X0*n;var r=t.X<=e.X1*n;var o=t.Y>=e.Y0*n;var s=t.Y<=e.Y1*n;return a&&r&&o&&s}}ImagingStudyView.AnnotationManager=AnnotationManager})(ImagingStudyView=ClientViews.ImagingStudyView||(ClientViews.ImagingStudyView={}))})(ClientViews=Efferent.ClientViews||(Efferent.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;class CaseStudyController extends n.SubView{constructor(e,a,r){super(e,a,"ViewerLanguage");this.ViewerPage=r;this.Pane=new t.CaseStudyPane(this.BodySection,this);this.ResizeListeners.push(new n.ResizeStructure(this.Pane.constructor.name.toLowerCase(),this.Pane,this.ViewerPage.View.ViewName))}SetButtons(){super.SetButtons([],(()=>{this.DisposeView()}))}DisposeView(){}OnWindowResize(e,t,n){super.OnWindowResize(e,t,n)}}t.CaseStudyController=CaseStudyController})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient.Utils;var a=e.Frontend.WebClient.DOMUtils;var r=e.Frontend.WebClient;var o=e.Frontend.FhirClient.FhirCall;class CaseStudyPane{constructor(e,t){this.Parent=e;this.Controller=t;this.studiesExistFhir=[];this.caseStudySectionA={};var n=document.createElement("div");a.AddClass(n,"caseStudyPane");this.CaseStudySection=n;this.Parent.appendChild(this.CaseStudySection);this.caseStudyNew=true;this.caseStudyExistOptionIndex=0}Toggle(){var o=a.IsDisplay(this.CaseStudySection);if(!o){var s=this.Controller.ViewerPage.GetSelectViewport(this.Controller.ViewerPage.ViewportPane);if(s!==null){if(s.Context.IsPseudoSeries&&s.Context.KeyImageEntity.Images.length>=2){this.CaseStudySection.style.display="none";this.Controller.CloseSubView();r.Toaster.ShowToast("Please select a non stitch image.",r.Colors.Orange,3);return}}this.Controller.ViewerPage.ShowCaseStudy=true;this.studiesExistFhir=[];var l=document.documentElement.clientWidth;var h=document.documentElement.clientHeight-this.Controller.ViewerPage.View.Platform.ToolbarSectionHeight();this.caseStudySectionA={};this.CaseStudySection.innerHTML="";this.caseStudySectionA["actionRadioCaseStudy"]=(e,t)=>{if(e.target["field"]["property"]==="radioCaseAddOne")this.StatusControls(false);else if(e.target["field"]["property"]==="radioCaseAddNewOne")this.StatusControls(true)};this.caseStudySectionA["checkedAddExist"]=!this.caseStudyNew;this.caseStudySectionA["radioOptionAddExist"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","radioOptionAddExist");this.caseStudySectionA["optionsCaseExist"]=["--Select--"];this.caseStudySectionA["valuesCaseExist"]=[0];this.caseStudySectionA["valueCaseExist"]=0;this.caseStudySectionA["addExistingCaseStudyText"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","addText");this.caseStudySectionA["actionBtnAddExistingCaseStudy"]=e=>{try{var t=r.Form.GetFieldFromForms(this.caseStudySectionA,"selectCaseExist");if(t.htmlElement.value==="0"||t.htmlElement.value===""){r.Toaster.ShowToast("Please select a case study.",r.Colors.Orange,3)}else{var n=this.GetFhirImagingStudyForCaseStudy(null,false);if(n!==null)this.Controller.SaveNewCaseStudy(n,false);else r.Toaster.ShowToast("This image has already been added before please select another.",r.Colors.Orange,3);this.Toggle();this.Controller.ViewerPage.SelectTool("Pointer","pointerTool")}}catch(e){r.Toaster.ShowToast("Error in save case study operation",r.Colors.Orange,3.5)}};this.caseStudySectionA["onchangeSelectCaseExist"]=e=>{this.caseStudyExistOptionIndex=e.currentTarget.selectedIndex};this.caseStudySectionA["checkedAddNew"]=this.caseStudyNew;this.caseStudySectionA["radioOptionAddNew"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","radioOptionAddNew");this.caseStudySectionA["studyDescription"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("WorklistLanguage","studyDescription");this.caseStudySectionA["addNewCaseStudyText"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","addText");this.caseStudySectionA["actionBtnNewCaseStudy"]=e=>{try{var t=this.caseStudySectionA["forms"][1];var n=t.GetField("inputDescription").htmlElement;var a=t.GetField("inputDate").htmlElement;var o=this.GetFhirImagingStudyForCaseStudy(a,true);if(o!==null)this.Controller.SaveNewCaseStudy(o,true);else r.Toaster.ShowToast("The study is invalid",r.Colors.Orange,3);this.Toggle();this.Controller.ViewerPage.SelectTool("Pointer","pointerTool")}catch(e){r.Toaster.ShowToast("Error in save case study operation",r.Colors.Orange,3.5)}};this.caseStudySectionA["patientText"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("WorklistLanguage","patientText");this.caseStudySectionA["dateText"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("WorklistLanguage","dateText");this.caseStudySectionA["physician"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("WorklistLanguage","physician");this.caseStudySectionA["institutionText"]=this.Controller.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("WorklistLanguage","institutionText");(new t.CaseStudyPaneForm).Create(this.CaseStudySection,[this.caseStudySectionA]);this.StatusControls(this.caseStudyNew);var u=this.Controller.GetDataStudySelect();if(u!==null){var d=this.caseStudySectionA["forms"][1];var c=d.GetField("inputPatient").htmlElement;var m=d.GetField("inputDate").htmlElement;var g=d.GetField("inputPhysician").htmlElement;var w=d.GetField("inputInstitution").htmlElement;c.value=u.PatientName||this.Controller.ViewerPage.GetInformationStudy("0010_0010",true)[0];m.value=n.GetCurrentDate();g.value=u.ReferringPhysician||this.Controller.ViewerPage.GetInformationStudy("0008_0090",true)[0];w.value=u.InstitutionName||this.Controller.ViewerPage.GetInformationStudy("0008_0080",true)[0]}this.CaseStudySection.style.width=l+"px";this.CaseStudySection.style.height=h+"px";this.CaseStudySection.style.display="block";this.getCaseStudiesForPractitioner((t=>{var n=e.Frontend.FhirClient.FhirParser.ProcessBundle(t,"ImagingStudy");var a=n.map((e=>e["resourceType"]==="ImagingStudy"?e:null));a=a.map((e=>{let t=null;if(e["subject"]["identifier"])t=e["subject"]["identifier"][0]["value"]===this.Controller.ViewerPage.ImagingStudyFhirEntities[u.StudyGUID]["subject"]["identifier"][0]["value"]?e:null;return t}));a=a.filter((e=>e!==null));this.studiesExistFhir=a;var r=this.caseStudySectionA["forms"][0];var o=[];var s=[];o.push("--Select--");s.push(0);this.studiesExistFhir.forEach((e=>{var t;try{t=e["subject"]["name"][0]["text"];if(t===undefined)t=""}catch(e){t=""}var n;try{n=e["subject"].identifier[0].value;if(n===undefined)n=""}catch(e){n=""}var a;try{a="("+e["started"]+")";if(a===undefined)a=""}catch(e){a=""}var r;if(t.length>0||n.length>0||a.length>0)r=t.length>0?t:n+a;else r="UNIDENTIFIED";o.push(r);s.push(e["id"])}));var l=r.GetField("selectCaseExist");var h=l.params;h.options=o;h.values=s;h.value=0;l.htmlElement.UpdateData(l);this.StatusControls(this.caseStudyNew)}));this.Controller.SetButtons();this.OnWindowResize(0,0)}else{this.Controller.ViewerPage.ShowCaseStudy=false;this.CaseStudySection.style.display="none";this.Controller.CloseSubView()}if(a.IsDisplay(this.Controller.Pane.CaseStudySection)){for(var f=0;f<this.Controller.ViewerPage.View.Plugins.length;f++){this.Controller.ViewerPage.View.Plugins[f].SelectAnyTool()}}else{this.Controller.ViewerPage.SelectDefaultTool()}}OnWindowResize(e,t){if(this.Controller.ViewerPage.ShowCaseStudy){this.CaseStudySection.style.width=this.Controller.BodySection.clientWidth+"px";this.CaseStudySection.style.height=document.documentElement.clientHeight-this.Controller.Toolbar.Element.clientHeight-30+"px"}}StatusControls(e){var t=r.Form.GetFieldFromForms(this.caseStudySectionA,"btnAddExist");var n=r.Form.GetFieldFromForms(this.caseStudySectionA,"btnAddNew");var a=r.Form.GetFieldFromForms(this.caseStudySectionA,"selectCaseExist");a.htmlElement.selectedIndex=this.caseStudyExistOptionIndex;if(!e){this.caseStudyNew=false;r.DOMUtils.RemoveClass(n.htmlElement,"green");r.DOMUtils.AddClass(t.htmlElement,"green");n.htmlElement.disabled=true;t.htmlElement.disabled=false;a.htmlElement.disabled=false}else{this.caseStudyNew=true;r.DOMUtils.RemoveClass(t.htmlElement,"green");r.DOMUtils.AddClass(n.htmlElement,"green");t.htmlElement.disabled=true;n.htmlElement.disabled=false;a.htmlElement.disabled=true}}GetFhirImagingStudyForCaseStudy(e,a){var o=this.Controller.GetDataStudySelect();var s=this.Controller.ViewerPage.GetSelectViewport(this.Controller.ViewerPage.ViewportPane);var l=this.Controller.ViewerPage.ImagingStudyFhirEntities[o.StudyGUID];var h=this.searchInstanceOnImagingStudyViewEntity(l,s.Context.ImageEntity.ImageGUID);var u=l["endpoint"].filter((e=>e["resourceType"]==="Endpoint")).pop();if(h.seriesIndexOnEntity===-1&&h.instance===null)return null;var d=l["series"][h.seriesIndexOnEntity]["identifier"];var c=l["series"][h.seriesIndexOnEntity]["uid"];var m="";if(d!==null&&d!==undefined)m=d;else m=c;var g=m.lastIndexOf(":");var w=m.substring(g+1,m.length);var f;var p;var S=new t.StudyEntity;S.StudyGUID=o.StudyGUID;var v=this.Controller.ViewerPage.GetStudyWithSeriesAndImages(S);p=v.Series.StructureData[c].Images.StructureData[s.Context.ImageEntity.ImageGUID].ImageUri;var P=p.split("dicomweb");if(a){f={resourceType:"ImagingStudy",id:n.GetGuid(),meta:{versionId:l["meta"]["versionId"],tag:[{code:"CASE",system:"http://efferenthealth.com/schemas/tagValue"}]},modifierExtension:l["modifierExtension"],extension:l["extension"],description:l["description"],modality:l["modality"],referrer:{reference:sessionStorage["practitionerId"]},identifier:[{system:l["identifier"][0]["system"],value:"urn:oid:"+n.GetGuid()}],status:"available",started:e.value,endpoint:[{reference:"Endpoint/"+u["id"]}],numberOfSeries:0,numberOfInstances:0,series:[{endpoint:[{reference:"/dicomweb"+P[1]}],modality:l["series"][h.seriesIndexOnEntity]["modality"],number:1,numberOfInstances:1,instance:[h.instance]}]};if(l["subject"]){if(l["subject"]["display"]){f["subject"]={display:l["subject"]["display"]}}else{f["subject"]={reference:l["subject"]["resourceType"]+"/"+l["subject"]["id"]}}}if(l["location"]){if(l["location"]["display"]){f["location"]={display:l["location"]["display"]}}else{f["location"]={reference:l["location"]["resourceType"]+"/"+l["location"]["id"]}}}if(d!==null&&d!==undefined)f["series"][0]["identifier"]=w;else f["series"][0]["uid"]=w}else{var V=r.Form.GetFieldFromForms(this.caseStudySectionA,"selectCaseExist");var b=this.studiesExistFhir.filter((e=>e["id"]===V.htmlElement.value)).pop();var y=b["series"].length;f={resourceType:"ImagingStudy",id:b["id"],meta:{versionId:b["meta"]["versionId"],tag:[{code:"CASE",system:"http://efferenthealth.com/schemas/tagValue"}]},modifierExtension:b["modifierExtension"],extension:b["extension"],description:b["description"],modality:b["modality"],identifier:b["identifier"],status:b["status"],started:b["started"],endpoint:{reference:b["endpoint"][0]["resourceType"]+"/"+b["endpoint"][0]["id"]},numberOfSeries:parseInt(b["numberOfSeries"])+1,numberOfInstances:parseInt(b["numberOfInstances"]+1),series:b["series"]};var C=this.searchInstanceOnImagingStudyViewEntity(f,h.instance["uid"]);if(C.instance!==null)return null;if(b["subject"]){if(b["subject"]["display"]){f["subject"]={display:b["subject"]["display"]}}else{f["subject"]={reference:b["subject"]["resourceType"]+"/"+b["subject"]["id"]}}}if(b["location"]){if(b["location"]["display"]){f["location"]={display:b["location"]["display"]}}else{f["location"]={reference:b["location"]["resourceType"]+"/"+b["location"]["id"]}}}if(b["referrer"]){if(b["referrer"]["display"]){f["referrer"]={display:b["referrer"]["display"]}}else{f["referrer"]={reference:b["referrer"]["resourceType"]+"/"+b["referrer"]["id"]}}}f["series"].push({endpoint:[{reference:"/dicomweb"+P[1]}],modality:l["series"][h.seriesIndexOnEntity]["modality"],number:1+y,numberOfInstances:1,instance:[h.instance]});if(d!==null&&d!==undefined)f["series"][b["series"].length-1]["identifier"]=n.GetGuid();else f["series"][b["series"].length-1]["uid"]=n.GetGuid()}f["OriginalResourceId"]=l["id"];return f}getCaseStudiesForPractitioner(e){var t=new Array;var n=new o("ImagingStudy?Resource._tag=CASE&_include=ImagingStudy:subject","GET");n.FuncOk=n=>{t=JSON.parse(n);e(t)};n.FuncError=()=>{e(t)};n.Send()}searchInstanceOnImagingStudyViewEntity(e,t){var n=-1;var a=e["series"];try{for(var r=0;r<a.length;r++){var o=a[r]["instance"];for(var s=0;s<o.length;s++){var l=o[s];var h=l["uid"];var u=h.lastIndexOf(":");var d=h.substring(u+1,h.length);if(d===t){n=r;return{seriesIndexOnEntity:n,instance:l}}}}return{seriesIndexOnEntity:n,instance:null}}catch(e){return{seriesIndexOnEntity:n,instance:null}}}}t.CaseStudyPane=CaseStudyPane})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class DicomElement{constructor(e,t,n,a){this.tag=e;this.value=a;this.VR=t;this.VL=n}ToString(e){if(Array.isArray(this.value)){var t="  ".repeat(e)+this.tag+" "+(this.VR||"??")+" "+this.VL+" Array:\r\n";for(var n=0;n<this.value.length;n++)t+=this.value[n].ToString(e+1)+"\r\n";return t}else{var a;if(typeof this.value==="undefined")a="[undefined]";if(typeof this.value==="string")a=this.value.substring(0,100);else if(typeof this.value==="number")a=this.value.toString();else a="[binary]";return"  ".repeat(e)+this.tag+" "+(this.VR||"??")+" "+this.VL+" "+a}}}e.DicomElement=DicomElement;class DicomParser{constructor(e,t=false){this.position=0;this.pidCounter=1;this.headerSize=128;this.isUnsigned=true;this.DicomTags={};this.reachedPixelData=false;this.implicitVR=false;this.dicomBuffer=e;this.isDebug=t;this.fileSize=e.length;if(this.fileSize<140)return;var n="";for(var a=128;a<132;a++)n+=String.fromCharCode(e[a]);if(n!=="DICM")return;this.position=132;var r;while(r=this.getNextElement()){this.fixVRValue(r);this.readElementValue(r);this.addValueToMainDataset(r);this.evaluateElementTag(r,false);if(this.isDebug)console.log(r.ToString(0));if(Number.isNaN(this.position)||this.position+8>=this.fileSize)break}}getNextElement(){if(this.image&&this.ismainImage)return null;try{var e;var t;var n=this.fetchTag();if(this.implicitVR&&this.position>=this.headerSize){t=this.dicomBuffer[this.position+4]+this.dicomBuffer[this.position+5]*256+this.dicomBuffer[this.position+6]*65536+this.dicomBuffer[this.position+7]*16777216;this.position+=8}else{switch(n){case"FFFE_E000":case"FFFE_E00D":case"FFFE_E0DD":t=this.dicomBuffer[this.position+4]+this.dicomBuffer[this.position+5]*256+this.dicomBuffer[this.position+6]*65536+this.dicomBuffer[this.position+7]*16777216;this.position+=8;break;default:e=String.fromCharCode(this.dicomBuffer[this.position+4])+String.fromCharCode(this.dicomBuffer[this.position+5]);switch(e){case"OB":case"OF":case"OW":case"SQ":case"UN":case"UT":t=this.dicomBuffer[this.position+8]+this.dicomBuffer[this.position+9]*256+this.dicomBuffer[this.position+10]*65536+this.dicomBuffer[this.position+11]*16777216;this.position+=12;break;default:t=this.dicomBuffer[this.position+6]+this.dicomBuffer[this.position+7]*256;this.position+=8;break}break}}if(e&&e!=="SQ"&&n!=="7FE0_0010"&&t===4294967295)return null;return new DicomElement(n,e,t,"")}catch(e){return null}}fixVRValue(e){if(this.transferSyntax==="1.2.840.10008.1.2.1"&&e.tag==="7FE0_0010"){if(e.VR==="OW"&&this.photometric==="RGB")e.VR="OB";else if(e.VR==="OW"&&this.bitsAllocated===8&&(this.modality==="XA"||this.modality==="RF"||this.modality==="US"))e.VR="OB";else if((this.modality==="MG"||this.modality==="DX")&&this.bitsAllocated===16)e.VR="OW"}}readElementValue(e){var t=this.position;if(this.implicitVR&&t>=this.headerSize){var n=this.fetchTag();if(e.VL===4294967295||n==="FFFE_E000"){e.value=[];this.processSequence(e)}else if(e.VL>1024){e.value="[LONG CONTENT]";this.position+=e.VL}else{e.value="";for(var a=0;a<e.VL;a++)e.value+=String.fromCharCode(this.dicomBuffer[t++]);this.position+=e.VL}return}if(e.tag==="7FE0_0010"&&e.VL===4294967295&&(e.VR==="OB"||e.VR==="OW")){e.value=[];this.processPixelDataSequence(e);if(!this.numberFrames||this.numberFrames&&this.numberFrames===1){this.image=e.value&&Array.isArray(e.value)?e.value[e.value.length-1]:e.value}else if(this.numberFrames>1){this.image=e.value}return}switch(e.VR){case"AE":case"AS":case"AT":case"CS":case"DA":case"DS":case"DT":case"IS":case"LO":case"LT":case"PN":case"SH":case"ST":case"TM":case"UI":case"UT":var r="";for(var a=0;a<e.VL;a++)r+=String.fromCharCode(this.dicomBuffer[t++]);e.value=r.toString().replace("\0","").trim();break;case"FL":e.value=new Float32Array(this.getBytes(4))[0];break;case"FD":e.value=new Float64Array(this.getBytes(8))[0];break;case"OB":e.value=new Uint8Array(this.bufferSlice(t,t+e.VL));break;case"OW":try{if(this.isUnsigned)e.value=new Uint16Array(this.bufferSlice(t,t+e.VL));else e.value=new Int16Array(this.bufferSlice(t,t+e.VL))}catch(t){e.value=""}break;case"OF":e.value=new Float32Array(this.bufferSlice(t,t+e.VL));break;case"SL":e.value=new Int32Array(this.getBytes(4))[0];break;case"SS":e.value=e.VL===2?new Int16Array(this.getBytes(2))[0]:new Int16Array(this.getBytes(e.VL)).join("/");break;case"UL":e.value=new Uint32Array(this.getBytes(4))[0];break;case"US":e.value=e.VL===2?new Uint16Array(this.getBytes(e.VL))[0]:e.VL<=20?new Uint16Array(this.getBytes(e.VL)).join("/"):new Uint16Array(this.getBytes(e.VL));break;case"UN":break;case"SQ":e.value=[];this.processSequence(e);return;default:if(e.tag==="FFFE_E000"){e.value=[];this.processSequence(e);return}break}if(e.VL!==4294967295)this.position+=e.VL}evaluateElementTag(e,t){if(e.tag==="7FE0_0010"&&e.VL!==4294967295){this.reachedPixelData=true;if(this.implicitVR)return;if(this.transferSyntax==="1.2.840.10008.1.2.4.50"&&e.VR==="OB"){try{let t=this.validateIsJpeg(this.position+20,this.dicomBuffer.length-8);e.value=t}catch(e){if(this.isDebug)console.log(e)}}this.image=e.value;if(!t&&this.image)this.ismainImage=true;return}if(t)return;var n=e.value;switch(e.tag){case"0002_0000":this.headerSize=this.position+n;break;case"0002_0010":this.transferSyntax=n;if(n==="1.2.840.10008.1.2"){this.implicitVR=true}else if(n==="1.2.840.10008.1.2.1.99"){var a=new Inflator;this.dicomBuffer=a.Inflate(this.dicomBuffer,this.headerSize,this.fileSize-this.headerSize);this.fileSize=this.dicomBuffer.length;this.headerSize=0;this.position=0}break;case"0028_0004":this.photometric=n.toUpperCase();this.isUnsigned=this.photometric!=="MONOCHROME2";break;case"0028_0008":this.numberFrames=n?parseInt(n):n;break;case"0028_0100":try{this.bitsAllocated=parseInt(n)}catch(e){}break;case"0028_0102":this.isUnsigned=n==="15"&&this.photometric==="MONOCHROME1";if(this.modality==="XA"||this.modality==="RF")this.isUnsigned=n==="15"&&(this.photometric==="MONOCHROME1"||this.photometric==="MONOCHROME2");break;case"0028_0103":if(n==="0"||n===0)this.isUnsigned=true;break;case"0008_0060":this.modality=n;break}}fetchTag(){if(this.position+4>this.fileSize)return"";var e=this.dicomBuffer[this.position]+this.dicomBuffer[this.position+1]*256;var t=this.dicomBuffer[this.position+2]+this.dicomBuffer[this.position+3]*256;var n=((e+65536).toString(16).substr(-4)+"_"+(t+65536).toString(16).substr(-4)).toUpperCase();return n}addValueToMainDataset(e){if(e.tag!=="7FE0_0010"){if(!e.value.hasOwnProperty("buffer")){var t=e.value;if(e.tag==="0010_0020"){if(!this.DicomTags[e.tag])this.DicomTags[e.tag]=t;else this.DicomTags[e.tag+"_"+this.pidCounter++]=t}else{this.DicomTags[e.tag]=t}}}}processPixelDataSequence(e){while(true){var t=this.fetchTag();var n=this.dicomBuffer[this.position+4]+this.dicomBuffer[this.position+5]*256+this.dicomBuffer[this.position+6]*65536+this.dicomBuffer[this.position+7]*16777216;this.position+=8;if(t==="FFFE_E000"&&n>4){var a;var r=this.position;try{if(e.VR==="OB"){a=new Uint8Array(this.bufferSlice(r,r+n))}else if(e.VR==="OW"){if(this.isUnsigned)a=new Uint16Array(this.bufferSlice(r,r+n));else a=new Int16Array(this.bufferSlice(r,r+n))}else{break}e.value.push(a)}catch(t){e.value=a;break}}else if(t==="FFFE_E00D"||t==="FFFE_E0DD"){break}else if(this.position+8>=this.fileSize){break}this.position+=n}}processSequence(e){if(e.VL===0)return;var t=e.VL===4294967295;var n;if(!t)n=this.position+e.VL;var a;while(a=this.getNextElement()){if(!t&&a.VL===4294967295)a.VL=n-this.position;this.fixVRValue(a);this.readElementValue(a);this.evaluateElementTag(a,true);if(isNaN(this.position)){break}if(this.position+8>=this.fileSize){break}if(!t&&this.position>=n){break}if(t&&a.tag==="FFFE_E00D"){break}if(t&&a.tag==="FFFE_E0DD"){break}e.value.push(a)}}validateIsJpeg(e,t){var n=new Uint8Array(this.bufferSlice(e,t));var a=[[255,216,255,224],[255,216,255,219],[255,216,255,238],[255,216,255,225]];let r=false;let o=0;e:for(let e=0;e+4<n.length;e++){for(let t=0;t<a.length;t++){if(n[e]===a[t][0]&&n[e+1]===a[t][1]&&n[e+2]===a[t][2]&&n[e+3]===a[t][3]){r=true;o=e;break e}}}n=r?n.slice(o):null;return n}getBytes(e){var t=new Uint8Array(e);for(var n=0;n<e;n++)t[n]=this.dicomBuffer[this.position+n];return t.buffer}bufferSlice(e,t){if(ArrayBuffer.prototype.slice!==undefined)return this.dicomBuffer.buffer.slice(e,t);var n=new Uint8Array(this.dicomBuffer.buffer);if(t===undefined)t=n.length;var a=new ArrayBuffer(t-e);var r=new Uint8Array(a);for(var o=0;o<r.length;o++)r[o]=n[e++];return a}}e.DicomParser=DicomParser;class BitReader{constructor(e,t,n){this.bitsLength=0;this.bits=0;this.buffer=e;this.pos=t;this.limit=t+n-1}ReadByte(){if(this.pos>this.limit)return-1;return this.buffer[this.pos++]}ReadBit(){if(this.bitsLength===0){var e=this.ReadByte();if(e<0)throw new Error("Unexpected end of stream");this.bits=e;this.bitsLength=8}var t=(this.bits&1)!==0;this.bits>>=1;--this.bitsLength;return t}Align(){this.bitsLength=0}ReadLSB(e){var t=0;for(var n=0;n<e;++n){if(this.ReadBit())t|=1<<n}return t}ReadMSB(e){var t=0;for(var n=0;n<e;++n){if(this.ReadBit())t=t<<1|1;else t<<=1}return t}}class Inflator{constructor(){this.encodedLengthStart=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];this.encodedLengthAdditionalBits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0];this.encodedDistanceStart=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];this.encodedDistanceAdditionalBits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];this.clenMap=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];this.initializeStaticTrees()}Inflate(e,t,n){this.bitReader=new BitReader(e,t,n);this.buffer=new Array(0);this.bufferPosition=0;this.state=0;this.blockFinal=false;var a=[];var r;while((r=this.readByte())>=0){a.push(r)}return new Uint8Array(a)}buildCodes(e){var t=new Array(e.length);var n=e[0];for(var a=1;a<e.length;a++){if(n<e[a])n=e[a]}var r=new Array(n+1);for(var a=0;a<=n;a++)r[a]=0;for(var a=0;a<e.length;a++){++r[e[a]]}var o=new Array(n+1);var s=0;r[0]=0;for(var l=1;l<=n;l++){s=s+r[l-1]<<1;o[l]=s}for(var h=0;h<t.length;h++){var u=e[h];if(u!==0){t[h]=o[u];o[u]++}}return t}initializeStaticTrees(){var e=new Array(288);var t=new Array(288);for(var n=0;n<=143;n++){e[n]=48+n;t[n]=8}for(var n=144;n<=255;n++){e[n]=400+n-144;t[n]=9}for(var n=256;n<=279;n++){e[n]=0+n-256;t[n]=7}for(var n=280;n<=287;n++){e[n]=192+n-280;t[n]=8}this.staticCodes=this.buildTree(e,t);var a=new Array(32);var r=new Array(32);for(var n=0;n<=31;n++){a[n]=n;r[n]=5}this.staticDistances=this.buildTree(a,r)}buildTree(e,t){var n=[];for(var a=0;a<e.length;++a){if(t[a]>0){var r={bits:e[a],length:t[a],index:a};n.push(r)}}return this.buildTreeBranch(n,0,0)}buildTreeBranch(e,t,n){if(e.length===0)return null;var a=[];var r=[];var o={};o.isLeaf=false;for(var s=0;s<e.length;++s){if(e[s].length===n&&e[s].bits===t){o.isLeaf=true;o.index=e[s].index;break}else{var l=(e[s].bits>>e[s].length-n-1&1)>0;if(l)r.push(e[s]);else a.push(e[s])}}if(!o.isLeaf){o.zero=this.buildTreeBranch(a,t<<1,n+1);o.one=this.buildTreeBranch(r,t<<1|1,n+1)}return o}readDynamicTrees(e){var t=e.ReadLSB(5)+257;var n=e.ReadLSB(5)+1;var a=e.ReadLSB(4)+4;var r=new Array(19);for(var o=0;o<r.length;++o)r[o]=0;for(var o=0;o<a;++o)r[this.clenMap[o]]=e.ReadLSB(3);var s=this.buildCodes(r);var l=this.buildTree(s,r);var h=new Array(0);while(h.length<t+n){var u=l;while(!u.isLeaf){u=e.ReadBit()?u.one:u.zero}var d=u.index;switch(true){case d<=15:h.push(d);break;case d===16:var c=e.ReadLSB(2)+3;for(var m=0;m<c;++m)h.push(h[h.length-1]);break;case d===17:var c=e.ReadLSB(3)+3;for(var m=0;m<c;++m)h.push(0);break;case d===18:var c=e.ReadLSB(7)+11;for(var m=0;m<c;++m)h.push(0);break;default:break}}var g=h.slice(0,t);var w=this.buildCodes(g);var f=h.slice(t,t+n);var p=this.buildCodes(f);var S={codesTree:this.buildTree(w,g),distancesTree:this.buildTree(p,f)};return S}readByte(){while(this.bufferPosition>=this.buffer.length){var e=this.decodeItem();if(e==null)return-1;switch(e.itemType){case 0:this.buffer=this.buffer.concat(e.array);break;case 2:this.buffer.push(e.symbol);break;case 3:var t=this.buffer.length-e.distance;for(var n=0;n<e.length;n++)this.buffer.push(this.buffer[t++]);break}}var a=this.buffer[this.bufferPosition++];if(this.bufferPosition>49152){var r=this.buffer.length-32768;if(r>this.bufferPosition)r=this.bufferPosition;this.buffer.splice(0,r);this.bufferPosition-=r}return a}decodeItem(){if(this.state===2)return null;if(this.state===0){this.blockFinal=this.bitReader.ReadBit();var e=this.bitReader.ReadLSB(2);switch(e){case 0:this.bitReader.Align();var t=this.bitReader.ReadLSB(16);var n=this.bitReader.ReadLSB(16);if((t&~n)!==t)throw new Error("Invalid block type 0 length");s={itemType:0,array:new Array(t)};for(var a=0;a<t;++a){var r=this.bitReader.ReadByte();if(r<0)throw new Error("Uncomplete block");s.array[a]=r}if(this.blockFinal)this.state=2;return s;case 1:this.codesTree=this.staticCodes;this.distancesTree=this.staticDistances;this.state=1;break;case 2:var o=this.readDynamicTrees(this.bitReader);this.codesTree=o.codesTree;this.distancesTree=o.distancesTree;this.state=1;break;default:throw new Error("Invalid block type (3)")}}var s={};var l=this.codesTree;while(!l.isLeaf){l=this.bitReader.ReadBit()?l.one:l.zero}if(l.index<256){s.itemType=2;s.symbol=l.index}else if(l.index>256){var h=l.index;if(h>285)throw new Error("Invalid length code");var u=this.encodedLengthStart[h-257];if(this.encodedLengthAdditionalBits[h-257]>0)u+=this.bitReader.ReadLSB(this.encodedLengthAdditionalBits[h-257]);l=this.distancesTree;while(!l.isLeaf){l=this.bitReader.ReadBit()?l.one:l.zero}var d=l.index;var c=this.encodedDistanceStart[d];if(this.encodedDistanceAdditionalBits[d]>0)c+=this.bitReader.ReadLSB(this.encodedDistanceAdditionalBits[d]);s.itemType=3;s.distance=c;s.length=u}else{s.itemType=1;this.state=this.blockFinal?2:0}return s}}})(t=e.ImagingStudyView||(e.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class GetResponse{constructor(e,t,n,a){this.data=e;this.contentType=t;this.StatusResponse=n;this.keyImage=a}}e.GetResponse=GetResponse;class WadoClient{constructor(e){this.Url=e}GetImageFile(e,t,n,a,r,o=null,s=null,l=null,h=null){var u;if(s!==null)u=s();var d=new XMLHttpRequest;if(o!==null)d.addEventListener("progress",o,false);if(h!==null){d.addEventListener("load",h,false);d.addEventListener("loadend",h,false)}if(l!==null){d.addEventListener("error",l,false);d.addEventListener("abort",l,false)}if(t!==null&&t!==undefined&&t.toLowerCase()==="mixed"){if(n===1)t="Low";else t="High"}d.open("GET",this.Url,true);d.setRequestHeader("Authorization","Bearer "+e);if(t!==null&&t.toLowerCase()==="low")d.setRequestHeader("Accept","type=application/dicom;transfer-syntax=1.2.840.10008.1.2.4.50");else if(t!==null&&t.toLowerCase()==="high")d.setRequestHeader("Accept","type=application/dicom");else if(t===null&&a==="MP4")d.setRequestHeader("Accept","type=video/mp4");d.setRequestHeader("Cache-Control","no-cache");d.setRequestHeader("Pragma","no-cache");d.responseType="arraybuffer";d.onreadystatechange=()=>{if(d.readyState===4){var e;var t;var n;try{var c=d.getResponseHeader("Content-Type");if(d.status===200){var m=new Uint8Array(d.response);if(c==="video/mp4"||a==="MP4"){t=d.getResponseHeader("X-Frame-Rate");this.Data=new GetResponse(m,c,"200");this.Data.fps=t===null?0:parseFloat(t);n=d.getResponseHeader("Location");if(n)this.Data.urlFileShared=n}else{e=false;this.Data=new GetResponse(m,c,"200",e)}}}catch(e){this.Data=null}finally{var g=d.status.toString();if(g[0]==="5")g="5xx";switch(g){case"0":r(null);break;case"200":r(this.Data);break;case"206":if(c==="video/mp4"||a==="MP4"){t=d.getResponseHeader("X-Frame-Rate");n=d.getResponseHeader("Location");this.Data=new GetResponse(m,c,g);this.Data.fps=t===null?0:parseFloat(t);this.Data.urlFileShared=n;r(this.Data)}else{e=false;this.Data=new GetResponse(m,c,g,e);n=d.getResponseHeader("Location");try{clearInterval(u)}catch(e){}this.getFileExtern(n,this.Data,r,o,s,l,h)}break;case"401":r(new GetResponse("Request_token","",g));break;case"404":r(new GetResponse(null,"",g));break;case"5xx":r(new GetResponse(null,"",g));break}}}};if(this.isURL(this.Url))d.send();else r(null)}isURL(e){try{var t="^(?!mailto:)(?:(?:http|https|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$";var n=new RegExp(t,"i");return e.length<2083&&n.test(e)}catch(e){return false}}getFileExtern(e,t,n,a=null,r=null,o=null,s=null){if(r!==null)r();var l=new XMLHttpRequest;if(a!==null)l.addEventListener("progress",a,false);if(s!==null){l.addEventListener("load",s,false);l.addEventListener("loadend",s,false)}if(o!==null){l.addEventListener("error",o,false);l.addEventListener("abort",o,false)}l.open("GET",e,true);l.responseType="arraybuffer";l.onreadystatechange=()=>{if(l.readyState===4){if(l.status===200){var e=new Uint8Array(l.response);t.data=e}n(t)}};l.send()}}e.WadoClient=WadoClient})(t=e.ImagingStudyView||(e.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){class SeriesEntity extends e.Frontend.WebClient.SeriesEntityBase{}t.SeriesEntity=SeriesEntity;class ImageEntity extends e.Frontend.WebClient.ImageEntityBase{IsCalibrated(){return this.CalibrationData!==""&&this.CalibrationData!==undefined&&this.CalibrationData!==null}GetCalibration(){return JSON.parse(this.CalibrationData)}}t.ImageEntity=ImageEntity;class StudyEntity extends e.Frontend.WebClient.StudyEntityBase{}t.StudyEntity=StudyEntity})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;class Geometry{Xor(e,t){return(e||t)&&!(e&&t)}static Calculate3DPosition(e,t,a){if(e===undefined||e===null||!e["has3DInformation"])return null;var r=e["dicomTags"]["0020_0037"];var o=e["dicomTags"]["0020_0032"];var s=e["pixelSpacing"];var l=o[0]+r[0]*s[0]*t+r[3]*s[1]*a;var h=o[1]+r[1]*s[0]*t+r[4]*s[1]*a;var u=o[2]+r[2]*s[0]*t+r[5]*s[1]*a;return new n.Point3D(l,h,u)}static GetAngleFromPoints(e,t){let n=0;let a=e.X-t.X;let r=e.Y-t.Y;n=Math.atan2(r,a);if(n<0)n=Math.abs(n);else n=2*Math.PI-n;n=180*n/Math.PI;if(n>-180)n=180+(180-Math.abs(n));return n}static GetAngleFromThreePoints(e,t,n){let a=0;let r=(e.Y-n.Y)/(e.X-n.X);let o=(t.Y-n.Y)/(t.X-n.X);a=Math.atan(Math.abs((r-o)/(1+r*o)));let s=1;if(o>r){s=-1}return s*a*180/Math.PI}static GetAngleFromOnePoint(e,t){let n=(e.Y-t.Y)/(e.X-t.X);return Math.atan(n)*180/Math.PI}static RenderCurve(e,t){var n=[t[0]].concat(t).concat(t.slice(length-1));e.beginPath();e.moveTo(n[0].X,n[0].Y);for(var a=1;a<n.length-2;a++){var r=n[a-1].X;var o=n[a-1].Y;var s=n[a].X;var l=n[a].Y;var h=n[a+1].X;var u=n[a+1].Y;var d=n[a+2].X;var c=n[a+2].Y;var m=Math.sqrt((s-r)*(s-r)+(l-o)*(l-o));var g=Math.sqrt((h-s)*(h-s)+(u-l)*(u-l));var w=Math.sqrt((d-h)*(d-h)+(c-u)*(c-u));var f=1;var p=m/(m+g);var S=g/(g+w);var v=(r+s)/2;var P=(o+l)/2;var V=(s+h)/2;var b=(l+u)/2;var y=(h+d)/2;var C=(u+c)/2;var A=v+(V-v)*p;var T=P+(b-P)*p;var E=V+(y-V)*S;var D=b+(C-b)*S;var I=A+(V-A)*f+s-A;var F=T+(b-T)*f+l-T;var x=E+(V-E)*f+h-E;var M=D+(b-D)*f+u-D;var L=[I,F,x,M];e.bezierCurveTo(L[0],L[1],L[2],L[3],n[a+1].X,n[a+1].Y)}e.stroke()}static MinMaxYArray(e){var t=e[0].Y;var n=e[0].Y;for(var a=1;a<e.length;a++){if(e[a].Y<t)t=e[a].Y;if(e[a].Y>n)n=e[a].Y}return{min:t,max:n}}static LeastMeanSquaresMethod(e){var a=0;var r=0;var o=0;var a=0;var s=0;var l=e.length;var h=.001;var u=0;var d=new Array;var c=0;var m=0;for(var g=0;g<e.length;g++){r=r+e[g].X;o=o+e[g].Y;a=a+e[g].X*e[g].Y;s=s+e[g].X*e[g].X}d[0]=new t.AnnotationPoint(new n.Point(0,0));d[1]=new t.AnnotationPoint(new n.Point(0,0));var w=this.MinMaxYArray(e);if(l!==0){c=r/l;m=o/l;h=(a-r*o/l)/(s-r*r/l);u=m-h*c}if(h!==0){d[1].Y=w.min;d[1].X=(w.min-u)/h;d[0].Y=w.max;d[0].X=(w.max-u)/h}return new t.Vector2D(d[0],d[1])}static LeastMeanSquaresMethodDistal(e){var a=0;var r=0;var o=0;var a=0;var s=0;var l=e.length;var h=.001;var u=0;var d=new Array;var c=0;var m=0;for(var g=0;g<e.length;g++){r=r+e[g].X;o=o+e[g].Y;a=a+e[g].X*e[g].Y;s=s+e[g].X*e[g].X}d[0]=new t.AnnotationPoint(new n.Point(0,0));d[1]=new t.AnnotationPoint(new n.Point(0,0));var w=this.MinMaxYArray(e);if(l!==0){c=r/l;m=o/l;h=(a-r*o/l)/(s-r*r/l);u=m-h*c}if(h!==0){d[1].Y=w.min;d[1].X=(w.min-u)/h;d[0].Y=w.max;d[0].X=(w.max-u)/h}return new t.Vector2D(d[0],d[1])}static CircumCircleThreePoints(e,t,n,a){var r=e.X;var o=e.Y;var s=t.X;var l=t.Y;var h=n.X;var u=n.Y;var d=s-r;var c=l-o;var m=h-r;var g=u-o;var w=d*(r+s)+c*(o+l);var f=m*(r+h)+g*(o+u);var p=2*(d*(u-l)-c*(h-s));var S;var v;var P;var V;var b=20;var y;var C;var A;var T;if(d!==0&&m!==0)y=c/d-g/m;else return null;if(Math.abs(y)<1e-6)return null;if(Math.abs(p)<1e-6){S=Math.min(r,s,h);v=Math.min(o,l,u);P=(Math.max(r,s,h)-S)*.5;V=(Math.max(o,l,u)-v)*.5;C=S+P;A=v+V}else{C=(g*w-c*f)/p;A=(d*f-m*w)/p;P=C-r;V=A-o}T=Math.sqrt(P*P+V*V);if(T<b||T>a)return null;return{Radius:T,X:C,Y:A}}static GetSimpleDistance(e,t){return Math.sqrt((e.X-t.X)*(e.X-t.X)+(e.Y-t.Y)*(e.Y-t.Y))}static GetRealDistance(e,t,n){var a=e.X*n.ScaleX;var r=e.Y*n.ScaleY;var o=t.X*n.ScaleX;var s=t.Y*n.ScaleY;return Math.floor(Math.sqrt((o-a)*(o-a)+(s-r)*(s-r)))}static GetDistanceCalibrate(e,t,n){var a=n!==undefined?n.ImageEntity["pixelSpacing"][0]:1;var r=n!==undefined?n.ImageEntity["pixelSpacing"][1]:1;var o=e.X*a;var s=e.Y*r;var l=t.X*a;var h=t.Y*r;return Math.floor(Math.sqrt((l-o)*(l-o)+(h-s)*(h-s)))}static GetValueCalibrate(e,t){var n=t!==undefined?t.ImageEntity["pixelSpacing"][0]:1;var a=t!==undefined?t.ImageEntity["pixelSpacing"][1]:1;return e*Math.sqrt(n*n+a*a)}static CalculateCoefficientsForNaturalCubicSpline(e){var t=new Array;var n=0;var a=0;var r=new Array;var o;var s;var l=new Array;var h=new Array;var u=0;var d=0;var c=0;var m=0;var g=0;for(var w=0;w<e.length-1;w++){n=e[w+1].X-e[w].X;a=6*(e[w+1].Y-e[w].Y)/n;r.push({H:n,B:a})}o=2*(r[0].H+r[1].H);s=r[1].B-r[0].B;l.push({U:0,V:0});l.push({U:o,V:s});for(var w=2;w<e.length-1;w++){o=2*(r[w].H+r[w-1].H)-r[w-1].H*r[w-1].H/l[w-1].U;s=r[w].B-r[w-1].B-r[w-1].H*l[w-1].V/l[w-1].U;l.push({U:o,V:s})}h[e.length-1]=u;for(var w=e.length-2;w>0;w--){u=(l[w].V-r[w].H*h[w+1])/l[w].U;h[w]=u}h[0]=0;for(var w=0;w<e.length-1;w++){d=e[w].Y;c=-(1/6)*r[w].H*h[w+1]-1/3*r[w].H*h[w]+1/r[w].H*(e[w+1].Y-e[w].Y);m=h[w]/2;g=1/(6*r[w].H)*(h[w+1]-h[w]);t.push({A:d,B:c,C:m,D:g})}return t}static OrderedsForNaturalCubicSpline(e,t){var n=new Array;var a=new Array;var r=new Array;for(var o=0;o<e.length-1;o++){var s={MaxLimit:e[o+1].X,MinLimit:e[o].X};n.push(s)}for(var l=0;l<n.length;l++){var h=new Array;var u=.1;if(n[l].MinLimit>n[l].MaxLimit)u=u*-1;if(u>0){for(var d=n[l].MinLimit;d<=n[l].MaxLimit;d+=u){h.push(d);if(d+u>n[l].MaxLimit)h.push(n[l].MaxLimit)}}else{for(var d=n[l].MinLimit;d>=n[l].MaxLimit;d+=u){h.push(d);if(d+u<n[l].MaxLimit)h.push(n[l].MaxLimit)}}a.push(h)}for(var c=0;c<n.length;c++){var m=new Array;var g=t[c];var h=a[c];for(var o=0;o<h.length;o++){var w=g.A+g.B*(h[o]-n[c].MinLimit)+g.C*Math.pow(h[o]-n[c].MinLimit,2)+g.D*Math.pow(h[o]-n[c].MinLimit,3);m.push(w)}r.push(m)}return{xs:a,ys:r}}static calculateControlPoints(){}static OrderedsForNaturalCubicSplineData(e){var n=new Array;var a=new Array;var r=new Array;var o=e.map((e=>e.Clone()));var s=new Array;var l=new Array;for(var h=0;h<e.length;h++){for(var u=h+1;u<e.length;u++){if(e[u].X<e[h].X){var d=e[h].X;var c=e[h].Y;e[h].X=e[u].X;e[u].X=d;e[h].Y=e[u].Y;e[u].Y=c}else if(e[u].X===e[h].X){e[u].X=e[u].X+.001}}}for(var m=0;m<e.length;m++){s[m]=e[m].X;l[m]=e[m].Y}for(var g=0;g<o.length-1;g++){var w={MaxLimit:o[g+1].X,MinLimit:o[g].X};n.push(w)}for(var f=0;f<n.length;f++){var p=new Array;var S=.1;if(n[f].MinLimit>n[f].MaxLimit)S=S*-1;if(S>0){for(var v=n[f].MinLimit;v<=n[f].MaxLimit;v+=S){p.push(v);if(v+S>n[f].MaxLimit)p.push(n[f].MaxLimit)}}else{for(var v=n[f].MinLimit;v>=n[f].MaxLimit;v+=S){p.push(v);if(v+S<n[f].MaxLimit)p.push(n[f].MaxLimit)}}a.push(p)}var P=t.Interpolator.CreateCubicSplineInterpolator(s,l);for(var V=0;V<n.length;V++){var b=new Array;var p=a[V];for(var g=0;g<p.length;g++){var y=P(p[g]);b.push(y)}r.push(b)}return{xs:a,ys:r}}static CalculateRotate360(e){if(e>=360){var t=e-360;e=Geometry.CalculateRotate360(t)}if(e<360)return e;return e}static Sign(e){return e<0?-1:1}static ReorientedVector(e,n){var a=new t.Vector2D(e,n.P1);var r=new t.Vector2D(e,n.P2);if(a.Norm()<r.Norm())return n.Clone();else return n.Clone().Opposite()}static CalculateProjectionPoint(e,n,a){var r=new t.Vector2D(e,n);return r.CalculateProjectionOrthogonal(a)}static GetAdjustDistance(e,t){var n=Math.abs(t.ScaleX);var a=parseFloat(t.ImageEntity["pixelSpacing"][0]);var r=e*a/n;return r}static PointToLine(e,t,n,a,r,o){var s=r-n;var l=o-a;if(s===0&&l===0){s=e-n;l=e-o}else{var h=((e-n)*s+(t-a)*l)/(s*s+l*l);if(h<0){s=e-n;l=t-a}else if(h>1){s=e-r;l=t-o}else{s=e-n-h*s;l=t-a-h*l}}return Math.sqrt(s*s+l*l)}static distance(e,t){return Math.sqrt(Math.pow(e.X-t.X,2)+Math.pow(e.Y-t.Y,2))}static pointRotated(e,t){let a=new n.Point(0,0);let r=e.X*Math.cos(t)-e.Y*Math.sin(t);let o=e.X*Math.sin(t)+e.Y*Math.cos(t);a.X=r;a.Y=o;return a}static calculateRotationAngle(e,a,r,o,s,l){let h=new t.AnnotationPoint(new n.Point(e,a));let u=new t.AnnotationPoint(new n.Point(r,o));let d=new t.AnnotationPoint(new n.Point(s,l));let c=new t.Vector2D(h,u);let m=new t.Vector2D(h,d);let g=c.Angle2VectorsDeg(m);let w=c.EvaluateSideOfPoint(d);return w*g}static validateCurves(e,t,n){var a;var r;var o;var s;switch(n){case 0:a=this.distance(t[n+1],e);r=this.distance(t[n+2],t[n+1]);o=this.distance(t[n+3],t[n+2]);break;case 1:a=(this.distance(t[n-1],e)+this.distance(t[n+1],e))/2;r=this.distance(t[n+2],t[n+1]);o=this.distance(t[n+2],t[n+1]);break;case 2:a=(this.distance(t[n-1],e)+this.distance(t[n+1],e))/2;r=this.distance(t[n-2],t[n-1]);o=this.distance(t[n-2],t[n-1]);break;case 3:a=this.distance(t[n-1],e);r=this.distance(t[n-2],t[n-1]);o=this.distance(t[n-3],t[n-2]);break;default:break}return!(a>.75*(r+o))}static CalculateTextWithPoints(e,t,n,a,r){var o=0;var s=0;var l=0;if(n==="EndPoints"){this.SetLabelOnLine(e,e["EndPoints"][a===0?1:0],t,a,r)}else if(n==="Label"){o=(e["EndPoints"][1].X+e["EndPoints"][0].X)/2;s=(e["EndPoints"][1].Y+e["EndPoints"][0].X)/2;var h=2*Math.PI+Math.atan2(t.Y-s,t.X-o);var u=2*Math.PI+Math.atan2(e["EndPoints"][1].Y-e["EndPoints"][0].Y,e["EndPoints"][1].X-e["EndPoints"][0].X);e["Polar"][0].X=Math.sqrt(Math.pow(o-t.X,2)+Math.pow(s-t.Y,2));e["Polar"][0].Y=h-u}}static SetLabelOnLine(e,n,a,r,o){if(!e["Label"])e["Label"]=new Array;if(!e["Polar"])e["Polar"]=new Array;var s=(n.X+a.X)/2;var l=(n.Y+a.Y)/2;var h=.2;var u=Math.sqrt(Math.pow(n.X-a.X,2)+Math.pow(n.Y-a.Y,2));var d=Math.atan2(a.Y-n.Y,a.X-n.X);let calculate=(e,n,a)=>{e["Label"][r]=new t.AnnotationPoint;e["Polar"][r]=new t.AnnotationPoint;let o=a*u;e["Polar"][r].X=h*o*n;e["Polar"][r].Y=.5*Math.PI;e["Label"][r].Y=l+h*o*Math.sin(e["Polar"][r].Y+d);e["Label"][r].X=s+h*(o*n)*Math.cos(e["Polar"][r].Y+d)};calculate(e,1,1);let c=e["Label"][r].X*o.ScaleX+o.OffsetX;let m=e["Label"][r].Y*o.ScaleY+o.OffsetY;calculate(e,c<0||c>o.Viewport.GetWidth()?-1:1,m>o.Viewport.GetHeight()?-1:1)}}t.Geometry=Geometry})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;let a;(function(e){e[e["New"]=0]="New";e[e["Complete"]=1]="Complete"})(a=t.EAnnotationStatus||(t.EAnnotationStatus={}));let r;(function(e){e[e["Tap"]=0]="Tap";e[e["Drag"]=1]="Drag";e[e["DontCare"]=2]="DontCare"})(r=t.EAnnotationEventType||(t.EAnnotationEventType={}));class AnnotationVector{constructor(){this.Vector=new n.Point(0,0);this.UnitaryVector=new n.Point(0,0);this.OrthogonalVector=new n.Point(0,0);this.Distance=0}Calculator(e,t){if(this.Point1!==undefined&&this.Point2!==undefined){this.Vector.X=this.Point2.X*(e?e:1)-this.Point1.X*(e?e:1);this.Vector.Y=this.Point2.Y*(t?t:1)-this.Point1.Y*(t?t:1);this.Distance=Math.sqrt(this.Vector.X*this.Vector.X+this.Vector.Y*this.Vector.Y);if(this.Distance!==0){this.UnitaryVector.X=this.Vector.X/this.Distance;this.UnitaryVector.Y=this.Vector.Y/this.Distance}else{this.UnitaryVector.X=0;this.UnitaryVector.Y=0}this.OrthogonalVector.X=-1*this.UnitaryVector.Y;this.OrthogonalVector.Y=this.UnitaryVector.X}}}t.AnnotationVector=AnnotationVector;class AnnotationPoint extends n.Point3D{constructor(e,t,n){super(0,0,0);if(e===undefined){this.X=0;this.Y=0;this.Z=0}else{this.X=e.X;this.Y=e.Y;this.Z=e["Z"]}this.EventName=t;this.ControlPoint=n}Clone(){var e=this.ControlPoint===undefined?undefined:this.ControlPoint.Clone();return new AnnotationPoint(new n.Point(this.X,this.Y),this.EventName,e)}static HitTest(e,t){}}t.AnnotationPoint=AnnotationPoint;class AnnotationPointGroup{}t.AnnotationPointGroup=AnnotationPointGroup;class AnnotationTemplate{Create(){var e=this.GetInstance(window,this.ClassName);return e}GetInstance(e,t,...n){var a=Object.create(e.eval(t).prototype);a.constructor.apply(a,n);return a}}t.AnnotationTemplate=AnnotationTemplate})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class MarkerSet{constructor(e){this.Name=e;this.Groups={}}}e.MarkerSet=MarkerSet;class ContextMenuOption{constructor(e,t,n){this.Name=e;this.Text=t;this.ButtonName=n;this.Default=false}}e.ContextMenuOption=ContextMenuOption})(t=e.ImagingStudyView||(e.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(Efferent){var ClientViews;(function(ClientViews){var ImagingStudyView;(function(ImagingStudyView_2){var WebClient=Efferent.Frontend.WebClient;var FhirClient=Efferent.Frontend.FhirClient;class Context{}ImagingStudyView_2.Context=Context;class ImagingStudyView{constructor(e,t,n,a){this.ViewName="ImagingStudyView";this.LocalTheme="dark";this.SpecView=n;this.Platform=t;this.parameters=a;this.ContainerElement=e;this.Plugins=new Array;this.ResourceBag=ImagingStudyView_2.ResourceBag;this.dateFormat=t.GetSetting("dateFormat");t.LanguageManager.AddDictionary("{Efferent.ClientViews.ImagingStudyView.ResourceBag.ViewerLanguageJson}","ViewerLanguage",Efferent.ClientViews.ImagingStudyView.ResourceBag.ViewerLanguageJson[this.Platform.LanguageManager.CurrentLanguage]);this.SwitchTheme();this.Initialize1()}Initialize1(){var continueLoad=()=>{this.StudyViewer=new ImagingStudyView_2.Viewer;this.ViewerPage=new ImagingStudyView_2.ViewerPage(this.ContainerElement,this.StudyViewer,this);var currentToolbar=new ImagingStudyView_2.ViewerToolbar(this);if(WebClient.LocalStorage.Get("ViewportsLayoutTemporal")!==undefined){this.Platform.SetSetting(40,"ViewportsLayout",WebClient.LocalStorage.Get("ViewportsLayoutTemporal"));WebClient.LocalStorage.Delete("ViewportsLayoutTemporal")}else{if(this.Platform.GetSetting("ViewportsLayout")==="undefined"||this.Platform.GetSetting("ViewportsLayout")==="Temporal")this.Platform.SetSetting(40,"ViewportsLayout","Auto")}if(this.Platform.GetSetting("ViewportsLayout")==="Fixed"||this.Platform.GetSetting("ViewportsLayout")==="Manual"){this.ViewerPage.ViewportPane.HorizontalViewports=+this.Platform.GetSetting("HorizontalViewport");this.ViewerPage.ViewportPane.VerticalViewports=+this.Platform.GetSetting("VerticalViewport")}var itemTabImagingStudy=new WebClient.Tab("imagingStudy",this.Platform.LanguageManager.GetValuesFromDict("Efferent.PlatformClient","imagingStudy").toUpperCase());itemTabImagingStudy.ActionTab=e=>{var t;var n;var a;var r;var o;var s;this.Platform.SettingsSubView.Pane.DataA["ActionChkAutDistrib"]=(e,t)=>{n=e.target.checked;if(n){o=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"buttonBarHorizontal");s=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"buttonBarVertical");for(var l=0;l<4;l++){a=o.htmlElements[l];r=s.htmlElements[l];a.disabled=true;a.checked=false;r.disabled=true;r.checked=false}this.Platform.SetSetting(40,"ViewportsLayout","Auto");this.Platform.SettingsSubView.Pane.DataA["chkFixedDistribution"]=false;this.Platform.SettingsSubView.Pane.DataA["chkLastUsedDistribution"]=false}};this.Platform.SettingsSubView.Pane.DataA["checkedAutDistrib"]=this.Platform.GetSetting("ViewportsLayout")==="Auto";this.Platform.SettingsSubView.Pane.DataA["ActionChkFixedDistrib"]=(e,t)=>{n=e.target.checked;if(n){o=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"buttonBarHorizontal");s=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"buttonBarVertical");for(var l=0;l<4;l++){a=o.htmlElements[l];r=s.htmlElements[l];a.disabled=false;r.disabled=false;if(this.Platform.GetSetting("HorizontalViewport")!==undefined&&parseInt(this.Platform.GetSetting("HorizontalViewport"))===l+1)a.checked=true;if(this.Platform.GetSetting("VerticalViewport")!==undefined&&parseInt(this.Platform.GetSetting("VerticalViewport"))===l+1)r.checked=true}this.Platform.SetSetting(40,"ViewportsLayout","Fixed");this.Platform.SettingsSubView.Pane.DataA["chkAutomaticDistribution"]=false;this.Platform.SettingsSubView.Pane.DataA["chkLastUsedDistribution"]=false}};this.Platform.SettingsSubView.Pane.DataA["checkedFixedDistrib"]=this.Platform.GetSetting("ViewportsLayout")==="Fixed";this.Platform.SettingsSubView.Pane.DataA["ActionChkLastDistrib"]=(e,t)=>{n=e.target.checked;if(n){var l=0;o=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"buttonBarHorizontal");s=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"buttonBarVertical");while(l<4){a=o.htmlElements[l];r=s.htmlElements[l];a.disabled=false;r.disabled=false;if(this.Platform.GetSetting("HorizontalViewport")!==undefined&&parseInt(this.Platform.GetSetting("HorizontalViewport"))===l+1)a.checked=true;if(this.Platform.GetSetting("VerticalViewport")!==undefined&&parseInt(this.Platform.GetSetting("VerticalViewport"))===l+1)r.checked=true;l++}this.Platform.SetSetting(40,"ViewportsLayout","Manual");this.Platform.SettingsSubView.Pane.DataA["chkAutomaticDistribution"]=false;this.Platform.SettingsSubView.Pane.DataA["chkFixedDistribution"]=false}};this.Platform.SettingsSubView.Pane.DataA["checkedLastDistrib"]=this.Platform.GetSetting("ViewportsLayout")==="Manual";this.Platform.SettingsSubView.Pane.DataA["actionOnchangeBarHorizontal"]=e=>{var t=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"chkFixedDistribution");var n=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"chkLastUsedDistribution");if(t.htmlElement.checked||n.htmlElement.checked){this.ViewerPage.ViewportPane.HorizontalViewports=+e.target.bbValue;this.ViewerPage.ViewportPane.VerticalViewports=+this.Platform.GetSetting("VerticalViewport")}this.ViewerPage.View.Platform.SetSetting(40,"HorizontalViewport",e.target.bbValue)};this.Platform.SettingsSubView.Pane.DataA["optionsCheckHorizontalBb"]=["1","2","3","4"];this.Platform.SettingsSubView.Pane.DataA["optCheckHorizontalBb"]=this.Platform.GetSetting("HorizontalViewport");this.Platform.SettingsSubView.Pane.DataA["actionOnchangeBarVertical"]=e=>{var t=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"chkFixedDistribution");var n=WebClient.Form.GetFieldFromForms(this.Platform.SettingsSubView.Pane["GroupData"],"chkLastUsedDistribution");if(t.htmlElement.checked||n.htmlElement.checked){this.ViewerPage.ViewportPane.HorizontalViewports=+this.Platform.GetSetting("HorizontalViewport");this.ViewerPage.ViewportPane.VerticalViewports=+e.target.bbValue}this.ViewerPage.View.Platform.SetSetting(40,"VerticalViewport",e.target.bbValue)};this.Platform.SettingsSubView.Pane.DataA["optionsCheckVerticalBb"]=["1","2","3","4"];this.Platform.SettingsSubView.Pane.DataA["optCheckVerticalBb"]=this.Platform.GetSetting("VerticalViewport");this.Platform.SettingsSubView.Pane.DataA["chkBoxRecallLastDisplayLabel"]="Recall last display mode (tile/stack)";this.Platform.SettingsSubView.Pane.DataA["chkBoxRecallLastDisplayAction"]=(e,t)=>{var n=e.target.checked;this.Platform.SetSetting(40,"chkBoxRecallLastDisplayChecked",n.toString())};this.Platform.SettingsSubView.Pane.DataA["chkBoxRecallLastDisplayValue"]=WebClient.Utils.StrToBool(this.Platform.GetSetting("chkBoxRecallLastDisplayChecked")||false);var l=new Array;var h;try{h=WebClient.Utils.DecodeBase64(this.Platform.GetSetting("contextMenuOptions"))}catch(e){h=""}var u=new Array;var d=h!==undefined&&h!==""?JSON.parse(h):{};var c=Object.keys(d).length;var saveContextMenuOptions=(e,t)=>{var n;try{n=WebClient.Utils.DecodeBase64(this.Platform.GetSetting("contextMenuOptions"))}catch(e){}var a={};if(n!==undefined){a=JSON.parse(n);a[e]=t}else{for(var r=0;r<u.length;r++){a[u[r].property]=u[r].params["checked"]}a[e]=t}this.Platform.SetSetting(40,"contextMenuOptions",WebClient.Utils.EncodeBase64(JSON.stringify(a)))};this.Plugins.forEach((e=>{e.GetContextMenuOptions().forEach((e=>{u.push(new WebClient.Field(WebClient.EFieldType.Checkbox,"uchk_"+e.Name,{label:e.Text,checked:d["uchk_"+e.Name]!==undefined?d["uchk_"+e.Name]:e.Default&&c===0},"",[],((e,t)=>{saveContextMenuOptions(e.target["field"]["property"],e.target.checked)})));u.push(new WebClient.Field(WebClient.EFieldType.NewLine,null,null,{"margin-top":"-10px"}))}))}));var m=this.Platform.LanguageManager;u.push(new WebClient.Field(WebClient.EFieldType.Checkbox,"uchk_stackMode",{label:m.GetValuesFromDict("ViewerLanguage","stackMode"),checked:d["uchk_stackMode"]!==undefined?d["uchk_stackMode"]:false},"",[],((e,t)=>{saveContextMenuOptions(e.target["field"]["property"],e.target.checked)})));u.push(new WebClient.Field(WebClient.EFieldType.NewLine,null,null,{"margin-top":"-10px"}));u.push(new WebClient.Field(WebClient.EFieldType.Checkbox,"uchk_tileMode",{label:m.GetValuesFromDict("ViewerLanguage","tileMode"),checked:d["uchk_tileMode"]!==undefined?d["uchk_tileMode"]:false},"",[],((e,t)=>{saveContextMenuOptions(e.target["field"]["property"],e.target.checked)})));u.push(new WebClient.Field(WebClient.EFieldType.NewLine,null,null,{"margin-top":"-10px"}));u.push(new WebClient.Field(WebClient.EFieldType.Checkbox,"uchk_fullScreen",{label:m.GetValuesFromDict("ViewerLanguage","fullScreen"),checked:d["uchk_fullScreen"]!==undefined?d["uchk_fullScreen"]:false},"",[],((e,t)=>{saveContextMenuOptions(e.target["field"]["property"],e.target.checked)})));u.push(new WebClient.Field(WebClient.EFieldType.NewLine,null,null,{"margin-top":"-10px"}));u.push(new WebClient.Field(WebClient.EFieldType.Checkbox,"uchk_pointerTool",{label:m.GetValuesFromDict("ViewerLanguage","pointerTool"),checked:d["uchk_pointerTool"]!==undefined?d["uchk_pointerTool"]:c===0},"",[],((e,t)=>{saveContextMenuOptions(e.target["field"]["property"],e.target.checked)})));u.push(new WebClient.Field(WebClient.EFieldType.NewLine,null,null,{"margin-top":"-10px"}));u.push(new WebClient.Field(WebClient.EFieldType.Checkbox,"uchk_settings",{label:m.GetValuesFromDict("ViewerLanguage","settings"),checked:d["uchk_settings"]!==undefined?d["uchk_settings"]:false},"",[],((e,t)=>{saveContextMenuOptions(e.target["field"]["property"],e.target.checked)})));this.Platform.SettingsSubView.Pane.DataA["fieldsContextMenu"]=u;var g=new Array;var w=new Array;var f="";var p=0;var S="";var v=0;var P=new Array;var V=new Array;var b=new Array;var y=new Array;var C=JSON.parse(WebClient.LocalStorage.Get("behaviors"));for(var A=0;A<C.length;A++){if(C[A].Type===ImagingStudyView_2.EMouseBehavior.Activate){var T=C[A].PluginName;if(f===""||f!==T){f=T;g[p]={groupName:T,names:new Array,values:new Array};g[p].names.push(C[A].ShowName);g[p].values.push(C[A].Behavior);p++}else{g[p-1].names.push(C[A].ShowName);g[p-1].values.push(C[A].Behavior)}P.push(C[A].ShowName);V.push(C[A].Behavior)}else if(C[A].Type===ImagingStudyView_2.EMouseBehavior.Drag){var E=C[A].PluginName;if(S===""||S!==E){S=E;w[v]={groupName:E,names:new Array,values:new Array};w[v].names.push(C[A].ShowName);w[v].values.push(C[A].Behavior);v++}else{w[v-1].names.push(C[A].ShowName);w[v-1].values.push(C[A].Behavior)}b.push(C[A].ShowName);y.push(C[A].Behavior)}}if(WebClient.LocalStorage.Get("selectMouseRightClick")===undefined)WebClient.LocalStorage.Set("selectMouseRightClick",V[0]);if(this.Platform.GetSetting("selectMouseBehDragRight")===undefined)this.Platform.SetSetting(40,"selectMouseBehDragRight",y[0]);if(this.Platform.GetSetting("selectMouseDefaultLeft")===undefined)this.Platform.SetSetting(40,"selectMouseDefaultLeft","Pointer");if(this.Platform.GetSetting("selectMouseBehLeftDoubleClick")===undefined)this.Platform.SetSetting(40,"selectMouseBehLeftDoubleClick","Dicom1x1Layout");if(this.Platform.GetSetting("chkBoxThumbnailChecked")===undefined)this.Platform.SetSetting(40,"chkBoxThumbnailChecked","false");this.Platform.SettingsSubView.Pane.DataB["titleGroupBehAct"]=m.GetValuesFromDict("ViewerLanguage","mouseBehaviorsTitle").toUpperCase();this.Platform.SettingsSubView.Pane.DataB["labelDragRightBtn"]=m.GetValuesFromDict("ViewerLanguage","dragRightTitle");this.Platform.SettingsSubView.Pane.DataB["optionsMouseDragRight"]=b.join(",");this.Platform.SettingsSubView.Pane.DataB["valuesMouseDragRight"]=y.join(",");this.Platform.SettingsSubView.Pane.DataB["objGroupMouseDragRight"]=w;this.Platform.SettingsSubView.Pane.DataB["actionMouseBehDragRight"]=e=>{this.Platform.SetSetting(40,"selectMouseBehDragRight",e.target.value)};this.Platform.SettingsSubView.Pane.DataB["valueMouseDragRight"]=this.Platform.GetSetting("selectMouseBehDragRight");this.Platform.SettingsSubView.Pane.DataB["labelDragMiddleBtn"]=m.GetValuesFromDict("ViewerLanguage","dragMiddleTitle");this.Platform.SettingsSubView.Pane.DataB["optionsMouseDragMiddle"]=b.join(",");this.Platform.SettingsSubView.Pane.DataB["valuesMouseDragMiddle"]=y.join(",");this.Platform.SettingsSubView.Pane.DataB["objGroupMouseDragMiddle"]=w;this.Platform.SettingsSubView.Pane.DataB["actionMouseBehDragMiddle"]=e=>{this.Platform.SetSetting(40,"selectMouseBehDragMiddle",e.target.value)};this.Platform.SettingsSubView.Pane.DataB["valueMouseDragMiddle"]=this.Platform.GetSetting("selectMouseBehDragMiddle");let D=b.slice(0);D.unshift("Pointer");let I=y.slice(0);I.unshift("Pointer");this.Platform.SettingsSubView.Pane.DataB["labelDefaultLeftBtn"]=m.GetValuesFromDict("ViewerLanguage","defaultLeftTitle");this.Platform.SettingsSubView.Pane.DataB["optionsMouseDefaultLeft"]=D;this.Platform.SettingsSubView.Pane.DataB["valuesMouseDefaultLeft"]=I;this.Platform.SettingsSubView.Pane.DataB["actionMouseDefaultLeft"]=e=>{this.Platform.SetSetting(40,"selectMouseDefaultLeft",e.target.value)};this.Platform.SettingsSubView.Pane.DataB["valueMouseDefaultLeft"]=this.Platform.GetSetting("selectMouseDefaultLeft");this.Platform.SettingsSubView.Pane.DataB["labelWheelConfig"]="Wheel action";this.Platform.SettingsSubView.Pane.DataB["optionsWheelConfiguration"]=["Images scroll","Zoom scroll"];this.Platform.SettingsSubView.Pane.DataB["valuesWheelConfiguration"]=["scrollImages","scrollZoomToCenter"];this.Platform.SettingsSubView.Pane.DataB["valueWheelConfiguration"]=this.Platform.GetSetting("wheelOperation");this.Platform.SettingsSubView.Pane.DataB["actionWheelConfiguration"]=e=>{this.Platform.SetSetting(40,"wheelOperation",e.target.value)};this.Platform.SettingsSubView.Pane.DataB["labelScrollSpeed"]="Scroll speed";this.Platform.SettingsSubView.Pane.DataB["optionsScrollSpeed"]=[ImagingStudyView_2.EScrollSpeed[ImagingStudyView_2.EScrollSpeed.Slow],ImagingStudyView_2.EScrollSpeed[ImagingStudyView_2.EScrollSpeed.Medium],ImagingStudyView_2.EScrollSpeed[ImagingStudyView_2.EScrollSpeed.Fast]];this.Platform.SettingsSubView.Pane.DataB["optScrollSpeed"]=(t=this.Platform.GetSetting("ScrollSpeed"))!==null&&t!==void 0?t:ImagingStudyView_2.EScrollSpeed[ImagingStudyView_2.EScrollSpeed.Medium];this.Platform.SettingsSubView.Pane.DataB["actionOnchangeScrollSpeed"]=e=>{let t=this.ViewerPage.GetScrollSpeedNumber(e.target.bbValue);this.ViewerPage.GeneralWheelFactorSpeed=t;this.Platform.SetSetting(40,"ScrollSpeed",e.target.bbValue);this.ViewerPage.ViewportPane.ViewportsArray.forEach((e=>{e.WheelFactorSpeed=this.ViewerPage.GeneralWheelFactorSpeed}))};this.Platform.SettingsSubView.Pane.DataB["labelScrollOrientationConfig"]="Series scroll orientation";this.Platform.SettingsSubView.Pane.DataB["optionsScrollOrientationConfiguration"]=["Next image upwards","Next image downwards"];this.Platform.SettingsSubView.Pane.DataB["valuesScrollOrientationConfiguration"]=["up","down"];this.Platform.SettingsSubView.Pane.DataB["valueScrollOrientationConfiguration"]=this.Platform.GetSetting("seriesScrollWheelOrientation")||"up";this.Platform.SettingsSubView.Pane.DataB["actionScrollOrientationConfiguration"]=e=>{this.Platform.SetSetting(40,"seriesScrollWheelOrientation",e.target.value)};this.Platform.SettingsSubView.Pane.DataB["labelZoomWheelConfiguration"]="Zoom scroll orientation";this.Platform.SettingsSubView.Pane.DataB["optionsZoomWheelConfiguration"]=["Zoom in upwards","Zoom in downwards"];this.Platform.SettingsSubView.Pane.DataB["valuesZoomWheelConfiguration"]=["up","down"];this.Platform.SettingsSubView.Pane.DataB["valueZoomWheelConfiguration"]=this.Platform.GetSetting("zoomWheelOrientation");this.Platform.SettingsSubView.Pane.DataB["actionZoomWheelConfiguration"]=e=>{this.Platform.SetSetting(40,"zoomWheelOrientation",e.target.value)};this.Platform.SettingsSubView.Pane.DataB["labelLeftDblClick"]=m.GetValuesFromDict("ViewerLanguage","leftDoubleClickTitle");this.Platform.SettingsSubView.Pane.DataB["optionsMouseLeftDblClick"]=P.join(",");this.Platform.SettingsSubView.Pane.DataB["valuesMouseLeftDblClick"]=V.join(",");this.Platform.SettingsSubView.Pane.DataB["objGroupMouseLeftDblClick"]=g;this.Platform.SettingsSubView.Pane.DataB["actionMouseLeftDblClick"]=e=>{this.Platform.SetSetting(40,"selectMouseBehLeftDoubleClick",e.target.value)};this.Platform.SettingsSubView.Pane.DataB["valueMouseLeftDblClick"]=this.Platform.GetSetting("selectMouseBehLeftDoubleClick");this.Platform.SettingsSubView.Pane.DataB["chkBoxRecallLeftButtonToolLabel"]="Recall left-button tool";this.Platform.SettingsSubView.Pane.DataB["chkBoxRecallLeftButtonToolAction"]=(e,t)=>{var n=e.target.checked;this.Platform.SetSetting(40,"LastToolUsedIsActivated",n.toString())};this.Platform.SettingsSubView.Pane.DataB["chkBoxRecallLeftButtonToolChecked"]=WebClient.Utils.StrToBool(this.Platform.GetSetting("LastToolUsedIsActivated"));this.Platform.SettingsSubView.Pane.DataB["chkBoxThumbnailLabel"]="Hide Thumbnails";this.Platform.SettingsSubView.Pane.DataB["chkBoxThumbnailStatusAction"]=(e,t)=>{var n=e.target.checked;this.Platform.SetSetting(40,"chkBoxThumbnailChecked",n.toString());if(n)this.ViewerPage.ThumbnailPane.Hide();else this.ViewerPage.ThumbnailPane.Show()};this.Platform.SettingsSubView.Pane.DataB["chkBoxThumbnailChecked"]=WebClient.Utils.StrToBool(this.Platform.GetSetting("chkBoxThumbnailChecked"));this.Platform.SettingsSubView.Pane.DataB["optionsGenerThumbPosition"]=["Left","Right","Top","Bottom"];this.Platform.SettingsSubView.Pane.DataB["valuesGenerThumbPosition"]=["left","right","top","bottom"];this.Platform.SettingsSubView.Pane.DataB["valueGenerThumbPosition"]=this.Platform.GetSetting("selectGeneralThumbnailPosition")||"left";this.Platform.SettingsSubView.Pane.DataB["actionSelectThumbPosition"]=e=>{this.Platform.SetSetting(40,"selectGeneralThumbnailPosition",e.target.value);this.ViewerPage.ChangeThumbnailPosition()};this.Platform.SettingsSubView.Pane.DataB["optionsGlassSize"]=["Small","Medium","Large"];this.Platform.SettingsSubView.Pane.DataB["valuesGlassSize"]=["1","1.5","2"];this.Platform.SettingsSubView.Pane.DataB["valueGlassSize"]=this.Platform.GetSetting("selectGlassSize")||"1";this.Platform.SettingsSubView.Pane.DataB["actionSelectGlassSize"]=e=>{this.Platform.SetSetting(40,"selectGlassSize",e.target.value)};var F=this.Platform.SettingsSubView.Pane["GroupData"]=[this.Platform.SettingsSubView.Pane.DataA,this.Platform.SettingsSubView.Pane.DataB];var x=(new ImagingStudyView_2.ConfigViewerForm).Create(e,F,this.dateFormat);x.forEach((e=>{this.Platform.SettingsSubView.Pane.SectionsViewer.push(e)}));if(this.Platform.GetSetting("ViewportsLayout")==="Auto"){var o=WebClient.Form.GetFieldFromForms(F,"buttonBarHorizontal");var s=WebClient.Form.GetFieldFromForms(F,"buttonBarVertical");for(var M=0;M<4;M++){var L=o.htmlElements[M];var B=s.htmlElements[M];L.disabled=true;L.checked=false;B.disabled=true;B.checked=false}}var G;var R=localStorage.getItem("unitCalibrationZoom");var k=document.createElement("h2");k.innerHTML=this.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","titleScreenCalibrationConfig");var O=document.createElement("div");O.innerHTML=this.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","legendScreenCalibrationConfig");var N=document.createElement("div");N.style.position="relative";N.style.marginTop="20px";var H=document.createElement("div");H.style.position="relative";H.style.marginTop="20px";H.style.marginBottom="20px";var W=document.createElement("div");W.className="buttonbar";W.style.cssFloat="left";var U=document.createElement("input");U.type="radio";U.id="UnitsBtnInches";U.name="UnitsButtons";U.checked=!R?false:parseInt(R)===1;U.onclick=e=>{if(!G)return;G.Units=ImagingStudyView_2.Units.inch;G.FillRuler()};var Y=document.createElement("label");Y.setAttribute("for",U.id);Y.innerHTML=this.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","inches").toLowerCase();var X=document.createElement("input");X.type="radio";X.id="UnitsBtnCentimeters";X.name="UnitsButtons";X.checked=!R?true:parseInt(R)===0;X.onclick=e=>{if(!G)return;G.Units=ImagingStudyView_2.Units.cm;G.FillRuler()};var z=document.createElement("label");z.setAttribute("for",X.id);z.innerHTML=this.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","centimeters").toLowerCase();W.appendChild(U);W.appendChild(Y);W.appendChild(X);W.appendChild(z);var j=document.createElement("div");var Q=document.createElement("button");Q.className="green autowidth";Q.innerHTML=this.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","acceptCalibration");Q.onclick=e=>{localStorage.setItem("factorCalibrationZoom",G.BarValue.toString());localStorage.setItem("unitCalibrationZoom",G.Units.toString());WebClient.Toaster.ShowToast("The calibration was saved successfully.",WebClient.Colors.Orange,3.5)};j.appendChild(Q);N.appendChild(W);H.appendChild(j);var q=document.createElement("br");q.style.clear="both";N.appendChild(q);var Z=document.createElement("div");Z.style.marginTop="20px";Z.style.width="1100px";Z.style.height="100px";var J=document.createElement("div");J.className="section";J.appendChild(k);J.appendChild(O);J.appendChild(N);J.appendChild(Z);J.appendChild(H);e.appendChild(J);G=new ImagingStudyView_2.ScreenCalibration(Z,ImagingStudyView_2.Units.cm);if(localStorage.getItem("factorCalibrationZoom"))G.BarValue=parseFloat(localStorage.getItem("factorCalibrationZoom"));if(localStorage.getItem("unitCalibrationZoom"))G.Units=parseInt(localStorage.getItem("unitCalibrationZoom"));G.FillRuler()};if(WebClient.Utils.CheckNotAllowTag(["patient","guest"]))this.Platform.TemporalSettingsTabs.push(itemTabImagingStudy);if(this.Platform.PluginsArray.length!==0){this.Platform.PluginsArray.forEach((pl=>{try{var viewerPlugin=eval(pl);var viewerPlug=new viewerPlugin;this.Platform.ResizeListeners.push(new WebClient.ResizeStructure(viewerPlug.constructor.name.toLowerCase(),viewerPlug,this.ViewName));this.Plugins.push(viewerPlug)}catch(e){WebClient.Utils.DebugConsoleLog(e)}}));this.Plugins[0].Initialize(this.ViewerPage,this.Plugins,0,this.Initialize2,undefined,true)}var actions=this.Platform.CurrentSpec.Functions[0].Views[this.SpecView.Id].Actions;this.Platform.Toolbar.CreateButtonGroupFromSpecView(actions,this.Platform,ImagingStudyView_2.ResourceBag)};this.Platform.InjectPlugins(this.SpecView,continueLoad)}Initialize2(){var e=this.Platform.LanguageManager;var t=new Array;this.Plugins.forEach((e=>{t=t.concat(e.GetMouseBehaviors())}));t.push(new ImagingStudyView_2.MouseBehavior(ImagingStudyView_2.EMouseBehavior.Activate,"stackMode","Workstation",e.GetValuesFromDict("ViewerLanguage","stackMode"),"stackMode"));t.push(new ImagingStudyView_2.MouseBehavior(ImagingStudyView_2.EMouseBehavior.Activate,"tileMode","Workstation",e.GetValuesFromDict("ViewerLanguage","tileMode"),"tileMode"));t.push(new ImagingStudyView_2.MouseBehavior(ImagingStudyView_2.EMouseBehavior.Activate,"fullScreen","Workstation",e.GetValuesFromDict("ViewerLanguage","fullScreen"),"fullScreen"));t.push(new ImagingStudyView_2.MouseBehavior(ImagingStudyView_2.EMouseBehavior.Activate,"pointerTool","Workstation",e.GetValuesFromDict("ViewerLanguage","pointerTool"),"pointerTool"));WebClient.LocalStorage.Set("behaviors",JSON.stringify(t));let keyDownImaging=e=>{if(e.which===27){this.Plugins.forEach((e=>{e.EscapeAction()}))}};var n=this.constructor.name+"_";this.ViewerPage.View.Platform.RegisterGlobalEvents(n+"keydown","keydown",{register:true,view:this.ViewerPage.View.Platform.CurrentView.ViewName,event:keyDownImaging,name:"keydown"},keyDownImaging);if(this.Platform.MessageBar){var a=document.getElementsByClassName("toolbarBG");for(var r=0;r<a.length;r++){a[r].style.top=this.Platform.MessageBar.clientHeight+"px"}}var o=decodeURIComponent(this.parameters["Study"]);if(o==="undefined")o=decodeURIComponent(this.parameters["resourceId"]);WebClient.Loader.Hide();this.ViewerPage.Show();if(o!=="undefined"){this.ViewerPage.OpenStudy(o,undefined)}else{o=decodeURIComponent(this.parameters["resourceUid"]);this.ViewerPage.OpenStudy(undefined,o)}this.Platform.RebuildToolbar()}Dispose(){try{this.ViewerPage.StopDownloadStudies();let e=new Array;this.Platform.ResizeListeners.forEach((t=>{if(t.GroupName!==this.ViewName)e.push(t)}));this.Platform.ResizeListeners=e;this.ViewerPage.View.Plugins.forEach((e=>{e.Terminate()}));this.Platform.RemoveGlobalEvents("ImagingStudyView")}catch(e){WebClient.Utils.DebugConsoleLog("Error on Dispose ImagingStudyView method")}}ShowPanes(e){}LoadData(){}OnPopState(e){}OpenActionsConfig(){this.ShowPanes(false)}SendHeaderDistinctOrganization(e,t){var n=true;var a;var r={};try{a=this.ViewerPage.ImagingStudyFhirEntities[e]["modifierExtension"][0]["url"].split("/")[1];if(sessionStorage["organizationId"]!==a)n=false}catch(e){WebClient.Utils.DebugConsoleLog(e)}if(!n){if(t!==undefined)r=t;r["X-Organization-PK"]=a}else{r=null}return r}CloseActionsConfig(){this.ViewerPage.ViewportPane.RenderViewportPane();this.ViewerPage.ViewportPane.ChangeViewportsNumber();for(var e=0;e<this.ViewerPage.View.Plugins.length;e++){this.ViewerPage.View.Plugins[e].CloseActionsConfig()}this.ViewerPage.ThumbnailPane.UpdateAllThumnailsPane()}OnBeforeUnload(e){}OnUnload(e){for(var t in this.Platform.OpenWindows){if(this.Platform.OpenWindows.hasOwnProperty(t))this.Platform.OpenWindows[t].close()}}SwitchTheme(){this.Platform.SwitchTheme(this)}SetSerieResourceToViewport(e,t,n,a,r,o,s=false,l){for(var h=0;h<this.ViewerPage.View.Plugins.length;h++){if(this.ViewerPage.View.Plugins[h].PluginName===e){this.ViewerPage.View.Plugins[h].SetSeriesToViewport(t,n,a,r,o,s,l);break}}}OnFullScreenChange(e){var t=document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;if(t===undefined){var n=this;var a=n["CurrentView"]["ViewerPage"];if(a!==null&&a!==undefined)a.DeactivateFullScreen()}}ExistStudyInOpenerStudies(e){var t=false;for(var n=0;n<this.Platform.OpenWindows.length;n++){var a=this.Platform.OpenWindows[n];if(a.StudyGUID===e.StudyGUID){t=true;break}}return t}ShowButtonsByPlugins(e,t,n=true){var a=e.Groups;for(var r=0;r<a.length;r++){if(a[r].GroupName!=="main.1"&&a[r].GroupName!=="common.1"&&!a[r].GroupName.match("specButtons")&&!a[r].GroupName.match("importantSpecButtons")){var o=a[r].Buttons;for(var s=0;s<o.length;s++){let e=o[s].Plugin;if(e===t){if(n){if(!o[s].HidePermanent){o[s].Hide=false;o[s].Element.style.display="inline-block"}}else{if(!o[s].ShowPermanent){o[s].Hide=true;o[s].Element.style.display="none"}}}}}}}ShowToolbarButtonsBySupportViewport(e,t){if(t!==null){var n=e.Groups;for(var a=0;a<n.length;a++){if(n[a].GroupName!=="main.1"&&n[a].GroupName!=="common.1"&&!n[a].GroupName.match("specButtons")&&!n[a].GroupName.match("importantSpecButtons")){var r=n[a].Buttons;for(var o=0;o<r.length;o++){let e=r[o].Plugin;let s=typeof e==="object"&&e.SupportedViewportType.some((e=>e.toLowerCase()===t.PluginNameAction.toLowerCase()));let l=r[o].ViewportsWorked.some((e=>e.toLowerCase()===t.PluginNameAction.toLowerCase()));if(n[a].GroupName==="toolbarviewer.1"||s||l){if(!r[o].HidePermanent){r[o].Hide=false;r[o].Element.style.display="inline-block"}}else{if(!r[o].ShowPermanent){r[o].Hide=true;r[o].Element.style.display="none"}}}}}}e.OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight)}GetFhirEntities(){var e=this.ViewerPage["ImagingStudyFhirEntities"][this.ViewerPage.MainStudyOpen.StudyGUID];return Object.keys(e).length>0?[e]:[]}OnTagChanged(e){FhirClient.ValueHelper.GetFullResource(e.resourceType,e.id,(e=>{var t=JSON.parse(e);var n=t["identifier"][0]["value"];var a=n.split("urn:oid:");var r=a.length===2?a[1]:a[0];this.ViewerPage["ImagingStudyFhirEntities"][r]=t;const o=WebClient.TagUtils.SelectTagToMenu([t]);const s=WebClient.TagUtils.GetTags(t);const l=s.filter((e=>o.indexOf(e)<0));this.ViewerPage.ThumbnailPane.CreateTagsThumbnail(r);Efferent.ClientViews.CommonView.TagController.CreateExtraTags(this,l,[t])}))}Refresh(){var e=this.ViewerPage.StudyViewerModel.Documents.IndexData;var t=[];e.forEach((e=>{t.push(this.ViewerPage.ImagingStudyFhirEntities[e]["id"]);this.ViewerPage.LoadAllAnnotationsForStudy[e]=undefined;this.ViewerPage.RequestReadyAnnotations[e]=null}));this.ViewerPage.ReopenStudy(t[0],t.length>1?t.slice(1):null,-1)}UpdateUI(){this.ViewerPage.ResizeViewports()}GetLanguageDictionary(){return"ViewerLanguage"}SetInitialStatus(){var e=this.ViewerPage.ToolSelect===undefined||this.ViewerPage.ToolSelect===null;var t=this.ViewerPage.ToolSelectButtonName===undefined||this.ViewerPage.ToolSelectButtonName===null;if(e||t)this.ViewerPage.SelectDefaultTool();else{this.ViewerPage.SelectTool(this.ViewerPage.ToolSelect,this.ViewerPage.ToolSelectButtonName)}}}ImagingStudyView_2.ImagingStudyView=ImagingStudyView})(ImagingStudyView=ClientViews.ImagingStudyView||(ClientViews.ImagingStudyView={}))})(ClientViews=Efferent.ClientViews||(Efferent.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class Interpolator{constructor(){this.EPSILON=Number.EPSILON||2220446049250313e-31}static CreateCubicSplineInterpolator(e,t){if(e.length!==t.length)throw new Error("Dimension mismatch.");if(e.length<3)throw new Error("Number of points is too small.");const n=e.length-1;this.checkOrder(e);const a=Array(n);for(let t=0;t<n;t++){a[t]=e[t+1]-e[t]}const r=Array(n);const o=Array(n+1);r[0]=0;o[0]=0;let s=0;for(let l=1;l<n;l++){s=2*(e[l+1]-e[l-1])-a[l-1]*r[l-1];r[l]=a[l]/s;o[l]=(3*(t[l+1]*a[l-1]-t[l]*(e[l+1]-e[l-1])+t[l-1]*a[l])/(a[l-1]*a[l])-a[l-1]*o[l-1])/s}const l=Array(n);const h=Array(n+1);const u=Array(n);o[n]=0;h[n]=0;for(let e=n-1;e>=0;e--){h[e]=o[e]-r[e]*h[e+1];l[e]=(t[e+1]-t[e])/a[e]-a[e]*(h[e+1]+2*h[e])/3;u[e]=(h[e+1]-h[e])/(3*a[e])}const d=Array(n);const c=Array(4);for(let e=0;e<n;e++){c[0]=t[e];c[1]=l[e];c[2]=h[e];c[3]=u[e];d[e]=this.createPolynomialFunction(c)}return this.createPolynomialSplineFunction(e,d)}static createPolynomialSplineFunction(e,t){e=e.slice();if(e.length<2)throw new Error("Not enough knots.");if(e.length-1!==t.length)throw new Error("Dimension mismatch.");this.checkOrder(e);return n=>{let a=this.binarySearch(e,n);if(a<0)a=-a-2;a=Math.max(0,Math.min(a,t.length-1));return t[a](n-e[a])}}static createPolynomialFunction(e){e=e.slice();let t=e.length;if(t===0)throw new Error("Empty polynomials coefficients array");while(t>1&&e[t-1]===0){t--}return n=>{let a=e[t-1];for(let r=t-2;r>=0;r--){a=n*a+e[r]}return a}}static checkOrder(e){let t=e[0];const n=e.length;for(let a=1;a<n;a++){if(e[a]<=t)throw new Error("Non-monotonic sequence exception.");t=e[a]}}static binarySearch(e,t){let n=0;let a=e.length-1;while(n<=a){const r=n+a>>>1;const o=e[r];if(o<t)n=r+1;else if(o>t)a=r-1;else if(o===t)return r;else throw new Error("Invalid number encountered in binary search.")}return-(n+1)}}e.Interpolator=Interpolator})(t=e.ImagingStudyView||(e.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;class Intersection extends n.Point{constructor(e,t,n,a,r,o,s){super(e.X,e.Y);this.CrossA=t;this.CrossB=n;this.LineA=a;this.LineB=r;this.PointExtA=o;this.PointExtB=s}Clone(){return new Intersection(new n.Point(this.X,this.Y),this.CrossA.Clone(),this.CrossB.Clone(),{A:this.LineA.A,B:this.LineA.B,C:this.LineA.C},{A:this.LineB.A,B:this.LineB.B,C:this.LineB.C},this.PointExtA.Clone(),this.PointExtB.Clone())}}t.Intersection=Intersection;class SlopeInRect{}t.SlopeInRect=SlopeInRect})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;class Line2D extends n.Point{constructor(e,t){super(0,0);if(e!==undefined&&e!==null)this.P1=e;if(t!==undefined&&t!==null)this.V1=t}Clone(){return new Line2D(this.P1.Clone(),this.V1.Clone())}Recalculate(){}Intersection(e){var a=new n.Point(0,0);var r=new t.AnnotationPoint(a);var o=new t.AnnotationPoint(this.P1);var s=new t.Vector2D(this.V1.P1,this.V1.P2);var l=new t.AnnotationPoint(e.P1);var h=new t.Vector2D(e.V1.P1,e.V1.P2);var u=s.Y*h.X-h.Y*s.X;var d=0;if(Math.abs(u)>1e-6)d=((o.X-l.X)*h.Y-(o.Y-l.Y)*h.X)/u;r.X=o.X+d*s.X;r.Y=o.Y+d*s.Y;return r}IntersectionAP(e){return new t.AnnotationPoint(this.Intersection(e))}Bisector(e){var n;var a=this.V1.Clone();var r=new t.Vector2D(e.V1.P1,e.V1.P2);a.Normalize();r.Normalize();n=a.Add(r);n.Normalize();return n}EvalPoint(e){return new n.Point(this.P1.X+e*this.V1.Normalize().X,this.P1.Y+e*this.V1.Normalize().Y)}EvalLine(e,n){var a=0;var r=0;if(this.V1.Y!==0){a=(e-this.P1.Y)/this.V1.Y;r=(n-this.P1.Y)/this.V1.Y}return new t.Vector2D(new t.AnnotationPoint(this.EvalPoint(a)),new t.AnnotationPoint(this.EvalPoint(r)))}GetSlope(){var e=0;if(this.V1.X)e=this.V1.Y/this.V1.X;return e}DistancePointToLine(e){var n=new t.Vector2D(this.P1,e);var a=n.Norm();var r=this.V1.Dot(n)/this.V1.Norm();return Math.sqrt(a*a-r*r)}DistancePointToLineCalibrated(e,n){var a=new t.Vector2D(this.P1,e);a.X=a.X*n.ImageEntity["pixelSpacing"][0];a.Y=a.Y*n.ImageEntity["pixelSpacing"][1];var r=a.Norm();var o=this.V1.Dot(a)/this.V1.Norm();return Math.sqrt(r*r-o*o)}AngleBetween2Lines(e){var t=Math.abs(Math.atan2(e.GetSlope()-this.GetSlope(),1+e.GetSlope()*this.GetSlope()));if(t>Math.PI/2)t-=Math.PI/2;else if(t<-Math.PI/2)t+=Math.PI/2;return t}}t.Line2D=Line2D})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){let t;(function(e){e[e["Activate"]=0]="Activate";e[e["Drag"]=1]="Drag";e[e["Hover"]=2]="Hover";e[e["TapAndHoverOrDrag"]=3]="TapAndHoverOrDrag"})(t=e.EMouseBehavior||(e.EMouseBehavior={}));class MouseBehavior{constructor(e,t,n,a,r){this.Type=e;this.Behavior=t;this.PluginName=n;this.ShowName=a;this.ButtonName=r}}e.MouseBehavior=MouseBehavior})(t=e.ImagingStudyView||(e.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class ResourceBag{}ResourceBag.ImagingStudyViewCss=``;ResourceBag.Icons8Collapse32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG6SURBVFhH7Za9SsRAFIVXREUQxB9EEJZ9AwUtfQDF2lqsfAOxs3VLwTewFrGxtrWw8kV8ARO/M9xZzd9MskkKIR8cJvfO5J4Du5vsaMCTpukkSZITK3sBj0U8LtCKtX6heYq+0ZW1OsXMH1m/WHesnUXmfYTImR9Zu5xYCPr7DHqz0kGtj++DdclaMxqZe2SOSkPQO9MwKx3Ux0isW8tB3dzcI3NUCEFdKwDX85t7ZI4yIbiOBmBtb+6ROZqFYA0GQN2Ze2SOXAhUGYC9TdStucfMFeIpEOC5E3MNYNB5XvRfWUXVR6AQU5bCvWhsx+Mw5J0bQlQGCHBnxwf+AXxeE3QY0IEddVCv5fYL4nu1ZcfjcPiTm0I0/hIy896Ox+H8MtrIaZshL6wiFOAG5e+VFux4c7j57+P1VqttOaj9g+gaFV5grWBu5tmOgu8CmaNuQjCw8GJhjb4NZY7ahWBY6VuN62gAIXM0XwgGVb5SqWsFEDJHzUIwpNJc0KsdQMgc1QvBgKC5YG/M3tRKBz39RB9YS39qMkfhEHXM2xANwcZlX+YeHwKf4n8DNlbZ2LWyN/DZs8sBGI1+AOZ8/u+Xnk07AAAAAElFTkSuQmCC";ResourceBag.Icons8Cursor32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIMSURBVFhH7ZY/aBNhGMaTVNL6LzS6qBQJ6GBThNIpiw6SrWLQzVFQ6NiKk6Nuutk16NShdCjJIghFB2kKhYJis1RxEOugqPTPUDGJv+d4A0n9k7vku8MhD/z4vu9537v3Idz1Guvrv1e9Xk81Go0XrBNmRSuGnwbpOyEumh2dGOwFYPhT2IVJK0WjlgDn4R78gOtWDl+tAXRmnYGfMOU1hK39AST2NyzEXbPC058CSJyvwR48pBw3273+FkDCzuPvQJH9gNlu9a8AEn4OvsICbUmz3alTAEk1+ATP4LDZbuQngET9DLyHZdrTZvcuvwEkek5BFV5xyQmze1OQABJ9x2EV3nJZxuzuFTSARO9ReA4fYczs7uQ3AC1pOEffBbgKt0Gv6BcYtbbg6hRAdWpb6mmKsz5aeiArUMIat/bg4uLfArDXTzwHlyglWT/AE/YZOGRtbsQN2wKwNh8yfQsq5t2BTRjU2alaA8BJeAOvsfLm6y9hCr7BLbvMnZjRDHAF3sEKHFONVU/6vO0fQJXWhM7O1BJAD9YS2yNW0tAC6B8U/TJCX8eCld2IG45YgDLLkNmeOCfwN+C+zqyP4aVXdCWGxLnpZdYDZrWJmt73z3AQsiDlrBy+CDbMwG24qTNrGRa9YlRi4CNYs/001AjW+3fArxh4FqR1qEEJvDclMjFwFoqQNasvH4rFfgFEC72Hg2HoFQAAAABJRU5ErkJggg==";ResourceBag.Icons8Expand32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGpSURBVFhH7Za/SsNQFMaLPoWTIqi7WB9AB8FHcBAXdRb8UxR8Cik4u4ij+BhWsJuTjg4VfAETfyecG9IkN/fepIUM+cHHzTk5J98H2rS9jlYRRdFjHMevNnF/R0etMHNZtpvRQEeLsDxmIOYcoaucztGSjlphZjuzY3SNJvrsoY4W4eYYvaE/dKrtRuC5yLMeOH85P1B1AAYHYo4ah8iZb6EX5A6g141C5M2lx+kfQKCuFaLMXOA6LIBALyiEzVygdgZ4RxdaptDzClFlLtB7RndaFuHmLir9qNGvDOEyF+j30bqW4Yg5khDH2krAdIFepfnMwOQEk5GWCdRr6HPu5h2tQP/hlrVMob+il/MDk+Sjhr60lUB/lV7wGzMIY85pe8nUem1PwfIZ2tQyxWVuEHNkDUH/EO1pWYSbhe8CX3MDM9YQ9MK+jELNDcyWhqD2D1DX3MBOIQTXfgGamhvYnQrB6Q6AblBjcwPPSEMgrwA/szI38CwTYoKcfwL56SznU170+zpqhbmj/J6I3W9O58/yW3Rv0RBt6KgVZvYzO2U60NGONtDr/QNSi2+2n64zVQAAAABJRU5ErkJggg==";ResourceBag.Icons8Layout32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAABZUlEQVRYhe2WvUoDQRSFv2tSBQz+FUrAiNaCYm0fkKRQtPAFFMTC1iews/AFbHwC8QWsBTsLiYKIjaKCxirFscgGJ0uS2QlhDZoDw3Bn7jn37LIHFob47zBJR79tQMA18Jry7ElgGTVQSnk4kkqSNJL24DiybiGpABwH8E+ifT+Ac2BmT80i/gbywCZQB949qwwUo1VO0F+PtPPuwJY34ODQzB66PYakdaesmdmOp78IbMfPB+sbcLAoaSqAm5W04umfCTFw7hGLYwy4CuS0NXALTATwv6L9IoDz0c3ANCnEEPDGMJdAqMJPDCsJ+nMExHAvQQxfnPLTzLY8/UVgLX4+sDGclZTxcN37jKR5T38hxMClRyyOceAukNPWQBVYCOA/R3sI57GjATOrA/cBYk3UeuC0GFiVNNqrSI9YgsYv2VvKgwcL1ulC0i6w0ac5p2Z21u6iUwwBboC5Phmo9klniD+Ib0e2cI2rsvaTAAAAAElFTkSuQmCC";ResourceBag.Icons8Sheets32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAOLSURBVFhH7ZVraM9RGMe3mTY2JsNcRlnMJZbETDPXlNZctsR4IdchFi+IXBt54T7XpIS5TcgLCRPZygtyvyQl5H6/5zb29/ke5/z326w2/7Z3+9anc87zPOec3/88zzn/oFrVKlCVlJREw2wYA2HWXPNis0TYCd/gJXyFF7ACWtuw6pXP5wuH8WxwkdZHWwSZdOvSNoY5cA9+wVEYjC/YTg9cLBLHYqvhDXyGbZBg3WVEbAi+IXAMfsNdmIW9kQ2pmuxCqXDcLnQHsrFH2ZBKRXxbWAmv4QtsZ343665YBKmo5sJ90FEegUFMDPgomR8G4+AC6yh152Gs7DbEBHXHt4tWRfUclkOsdVebWLMH7ABv0baU45X9OhVYGxtfY2Kffp4982WIgQXwCH7AAUix8dUi9tJtyYQiu7F+rG5VPRtigupgSIfTIF2Hqdgjbch/i/mxoJQqtUqx3o9E6/4rDHpMCthohD7C2uIhl/EHQX8jbUczoRIRF0z8QFARF4OKWsUdLT9tQ5gBtyFPhiTIh5+gNCgdMTY4ggWzaK+CdAYysIXK7xW2KHzZoGur66trnIo9RH76XWArfIJ3sAZfac0xaI5xMTyB77APkq1bCyTDfut7DIvsnATQA6WHSg/WKuxxmkOr3I+iPQfK/WWYBKW5Z1AIa6G9xsSF0s8A/VpJv34KRNh4b9EW24VNUUG4jWkFOfAM9MF50Es+ib5ugoo9R4MJcAt0bCdhGAu5WugEmxirDt5DLsTLpxj6adDTjpX7AXAIlM4HMA+aWn8k/elwEyTt1Vs+Iwb6qoNgJjNhPq138jS4AZK/aOl7i8r9iKH4XO47w2b4CPoR68CcthGDLTARTF5oW8BSeAo6vj2QZIIR/b6g49OHqhb8RQXtFMPmyv1IOAvSFZiMvb71m3qjzdKCyr8K6C1UuAh9fwHR9S6i66UUej9+CbhC3gv+Y6afAt6Pz3QOHeNMcMd4AtLYxHuMOin3a/1FK9H3pu8hqEibycca5dOnhy4du6mzMsLoCukw6BExhYS9ifz0G4AKyRVtAbiiOgXD3cL0VcB6wNxjtgE6yFclEayrtAzcVdoN/qvEov0Z64jXg7sZ5a/wNWx6yMwVDkgsoFoYDYX0pUv0/UUrYXOPmPJq/tCw9bHu6hMLdwU9p65odaW8RbUQzDNeo2ITV7S6GaoD/T/8W1S1qlWlCgr6A42iprJDzXUzAAAAAElFTkSuQmCC";ResourceBag.Icons8Thumbnails32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHkSURBVFhH7ZU9KEZhFMdfeUlKvkrkIyIGsYgiZUMZlI8UZaLIKB9lUBbKKoNNBoOJZDEoBikWTN5JBoOBohh4r9+5Du597qOU8ir3X7/Oc8/53cejy72RMGHe4zhOOkzDgkk8Hu9TLcK66QtnDorF4TqV9YTpCPQH3Y3MMBiBe9g1OABJkXqXcAamdwWr6gzAo/a97HEIh1olni/0pxmc6uVH6JfoTTV6fce63x16Qm8ZtnU9CpfuwBPuzZS9SLO2PkPznx+AG8bhGqYM5uUOaqV6N7CuMy+HsKHOMNxq38us++Mdp048XxgWwg7DYxP6S9Qk9cbgyOLsU93fjHUebJmOQH+Fmize3wuna+R0vV7odUOZKuLkQqfFa6dGVROvweL0QIUq/jDoQrKG2QMlW72Tt24wzBbVadVWIMyeoEA8X5iF74GEvwcmIcawzgu9DqocoFo9+f+e8ToCvQ3YVEe+K9cWp4UqezWK5wvNergXwQz9c0qaemtvXX/oP8OQOjVwqyNf6F9AhniBME+BbIMsHX9ENrB47gHfw3XUmLvo2B6ExB2ATX/6CF5gWJ1a+OoRxCD4CGgm9o+QfvgiSviL6Nc+RpR88QJhaP0cU0tVEScHbJ/jNup3PsflqoQJQyKRVwTKY0jI8pryAAAAAElFTkSuQmCC";ResourceBag.Icons8TreeStructure32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHXSURBVFhH7ZY/LANRHMdrkggRZWksYjb4MxCDwSpiwmggNduJSUQiMQjBYGknBtFYMNA0kYhNJJhEImFADIpItT6/y++Sa72r1F3aRPtNPnn37v1+3/v1vXuvF6joXyqdTtdBRyaT6TLBWCdtvYb7K8y7MX+BvCLuFfo1zT9hGoF9ntEEDSYYb4RtiGmaf8J0D1a16ypi5iGhXf9UsgKY2ioMp+Cz6AVgJGsagyTcQfEKwKQHbuES2mAX1nTYVcQsQFwugjAN63lYgj7NtZQz5VH6tXKf6xl4hA0wedncw6IYHXNxQ7vlBuMHkOK6XR/inPIJuWeLfjXM5nrkQswcbY0kpGBI811FzDVMQtaU6/DfRRVyKg1o11XEnEMCsqbcswosQJYhrLf8USEFaKx/v15USAGwCbL+V6RZL6RnYfYGY9o1inF5s+WAGQfZATvwThHelwOjFfiC5zxIkbJvQ5LDg41ngIh+MxyBycfJCXmtdlIvnWE3GB+EoBXsEPd+bEla+UGyXKMmL4GxETiFqGXkRZjISSpLksQ8TFv8f0Me7FySDyjN9wCGsiQPJStAhGmZfhHZwnQZLuC3XXAGEU3zT5iG4BCewLT/beIU06JpFZWtAoFvHkm5NtD4eZYAAAAASUVORK5CYII=";ResourceBag.PlusPng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgEAQAAACJ4248AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAAAGAAAABgAPBrQs8AAAAHdElNRQflCA8TNy6w/8vUAAAC+ElEQVRYw8VXQUsqURS+MwslHCEoE2mTJTmSoMuHUsS0i7ZF/RkRQfQfiPoTtKBFLQU1lyH2A2ZSKJA2gQrV4nxvcZymXlYz06sOuPDce8/3ne/ec+4dSdg0kN8vpL09AU0TUiIhxMqKEPPzPHp/L4RhCPR6Qmo0BM7OJHk0shv7Y2CEQkCpBEwmsG2TCahaBUUiXwCemwNyOdB4bAW+vAQyGWB7G1BVwOfjn6qyL5PhOaY9PQHFIsjrdQZOkQhwdcVBiIBaDYhG7ZOPRoF6ndcCQKcDCgZtLk4mgeGQF+o68OePexVTKcAwONZgAIrHbWRugjeboMVF13v4HDMQAJpNjtnvv6sE77kpe7MJ8ni+Cm6R8HgsEp3OzDMB5HLPsv+HzGcroeuMUSj8Ax4K8WkncrLnQKcDtNv256dSjPH4CKytvRgolZhZreYoq6k5U+L4mIurUpk6/H5uMkROSs01AcRiTGA8BimKAI6OzCbjJJBbApx0t8srDw5kAU1j9+mp00CuTTKxdnZkvliEEKLV+jECJhYSCVkgHOY/t7c/R+DmhpUIhwWXBABSlFlTudTc2uwSBSkKjz88yJZbkmazJXKf6XsHVLZwQXd3rMD6uvPwLqsA0SivHA5lIek6C7C87D5TpzbFgq7LAr0eOzc3f47A1hYn3esJ4PDw1xoR7e//XivGaAT4fFNG1So76/XvJ3BywqvK5ReSRCL8gCQCUin7wdptwH4HBdJps/5hNkBrsFjkQcMABQJOsrIFToEAcH3NGPn8jAler9X1vuNJ1mqZ3fHd2KBgEBgMeOLFhe2n9IeyLywAjcanj1KLRDxukdB1J2fiLXg6bcne7wMbGzYlCwat7SDiZ1QsZh84FrNOuyn70pIz9uT1AoXC820JgBtINgtoGqCqIEXhm01V2ZfNWq8dgNfm8186T8DqKqhSef2N+JmNRkC5/KbUZphkhwQroihC2t0VQtMEkkkhhcOvPs9hGELqdgUaDSGdn0vSZGIn7l8OtM8lHL82nQAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMS0wOC0xNVQxOTo1NTo0NiswMDowMIWUvroAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjEtMDgtMTVUMTk6NTU6NDYrMDA6MDD0yQYGAAAAAElFTkSuQmCC";ResourceBag.ViewerLanguageJson={en:{pointerTool:"Pointer",about:"About",back:"Back",titleHViewportPresets:"Horizontal viewports",titleVViewportPresets:"Vertical viewports",briefCase:"Study Case",cancel:"Cancel",keyTool:"Key Image",marketSquare:"Marketplace",more:"More",mouseLeftClick:"Mouse Left",mouseRightClick:"Mouse Right",mouseScrolling:"Mouse Scrolling",okResponse:"Ok",rotateFlipTool:"Rotate/Flip",rewind:"Rewind Tool",sell:"Sell Tool",settings:"Settings",stackMode:"Stack Mode",tileMode:"Tile Mode",skipToStart:"Skip To Start",thumbnails:"Viewport",trigonometryTool:"Trigonometry",undoTool:"Undo",variationTool:"Variation",visible:"Visible Tool",zipTool:"Zip",zoomInTool:"Zoom In",zoomOutTool:"Zoom Out",assignViewportOption:"Touch a viewport to be assigned to the selected series",assignViewport:"Assign viewport",clearViewport:"Clear viewport",clearText:"Clear",cancelText:"Cancel",systemTab:"System",worklistTab:"Worklist",viewerTab:"Viewer",fullScreen:"Full screen",connectionTitle:"Connection",systemTitle:"System",dicomWebTitle:"Dicom Web",generalTitle:"General",languageTitle:"Language",languages:"English,Spanish",viewportsTitle:"Viewports",autoDistributionLayout:"Automatic distribution",horizontalViewports:"Horizontal viewports",verticalViewports:"Vertical viewports",mouseBehaviorsTitle:"Mouse Behaviors",dragLeftTitle:"Drag left button",dragRightTitle:"Drag right button",dragMiddleTitle:"Drag middle button",rightClickTitle:"Right click button",leftDoubleClickTitle:"Left double-click action",logout:"Logout",addText:"Add",caseStudyTool:"Case",caseTagSpan:"Case",radioOptionAddExist:"Add the selected image to an existing Case Study",radioOptionAddNew:"Add the selected image to a new Case Study",feedbackTool:"Feedback",relatedStudiesTool:"Related",imagingStudy:"Imaging study",titleScreenCalibrationConfig:"SCREEN CALIBRATION",legendScreenCalibrationConfig:"Put a regular ruler (centimeters or inches) over the images shown, and press the left and right button until they match.<article>This calibration will be valid only for the current screen</article>",inches:"Inches",centimeters:"Centimeters",acceptCalibration:"Accept calibration",medicalRecords:"Medical records",deleteActionMessageNoSelectedImage:"Select and image in viewport",deleteActionMessageNoKeyImage:"The selected image cannot be a key image",deleteActionMessageNoLastImage:"Cannot delete the unique image in the study",deleteActionMessageImageDeleted:"Image deleted",deleteActionMessageErrorDeleting:"There was an error deleting the image",defaultLeftTitle:"Default left button tool"},es:{pointerTool:"Puntero",about:"Acerca de",back:"Atras",titleHViewportPresets:"ventanas horizontales",titleVViewportPresets:"Ventanas verticales",briefCase:"Caso de estudio",cancel:"Cancelar",keyTool:"Imagen llave",marketSquare:"Mercado",more:"Ms",mouseLeftClick:"Mouse izquierdo",mouseRightClick:"Mouse derecho",mouseScrolling:"Mouse Scrolling",okResponse:"Ok",rotateFlipTool:"Rotar/Voltear",rewind:"Rebobinar",sell:"Vender",settings:"Opciones",stackMode:"Modo pila",tileMode:"Modo azulejo",skipToStart:"Saltar al inicio",thumbnails:"Viewport",trigonometryTool:"Trigonometra",undoTool:"Deshacer",variationTool:"Variacin",visible:"Visible",zipTool:"Comprimir",zoomInTool:"Acercar",zoomOutTool:"Alejar",assignViewportOption:"Toque una ventana a la que se asignar la serie seleccionada.",assignViewport:"Asignar ventana",clearViewport:"Limpiar ventana",clearText:"Limpiar",cancelText:"Cancelar",systemTab:"Sistema",worklistTab:"Lista de trabajo",viewerTab:"Visor",fullScreen:"Ampliar",connectionTitle:"Conexin",systemTitle:"Sistema",dicomWebTitle:"Web dicom",generalTitle:"General",languageTitle:"Lenguaje",languages:"Ingles,Espaol",viewportsTitle:"Ventanas",autoDistributionLayout:"Distribucin automtica",horizontalViewports:"Ventanas horizontales",verticalViewports:"Ventanas verticales",mouseBehaviorsTitle:"Conducta del ratn",dragLeftTitle:"Arrastrar botn a la izquierda",dragRightTitle:"Arrastrar botn a la derecha",dragMiddleTitle:"Arrastrar botn del medio",logout:"Salir",addText:"Agregar",caseStudyTool:"Casos",caseTagSpan:"Caso",radioOptionAddExist:"Aadir la imagen seleccionada a un estudio de caso existente",radioOptionAddNew:"Aadir la imagen seleccionada a un nuevo estudio de caso",feedbackTool:"Reaccin",relatedStudiesTool:"Relacin",imagingStudy:"Estudio de imagenes",titleScreenCalibrationConfig:"CALIBRACION DE PANTALLA",legendScreenCalibrationConfig:"Ponga una regla normal (centmetros o pulgadas) sobre las imgenes mostradas, y pulse el botn izquierdo y derecho hasta que coincidan. <Article> Esta calibracin ser vlida slo para la pantalla actual </Article>",inches:"Pulgadas",centimeters:"Centimetros",acceptCalibration:"Aceptar calibracin",deleteActionMessageNoSelectedImage:"Seleccione una imagen en un viewport",deleteActionMessageNoKeyImage:"La imagen seleccionada no puede ser una key image",deleteActionMessageNoLastImage:"No se puede eliminar la nica imagen del estudio",deleteActionMessageImageDeleted:"Imagen eliminada",deleteActionMessageErrorDeleting:"Hubo un error al eliminar la imagen",defaultLeftTitle:"Boton izquierdo por defecto"}};e.ResourceBag=ResourceBag})(t=e.ImagingStudyView||(e.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){let n;(function(e){e[e["cm"]=0]="cm";e[e["inch"]=1]="inch"})(n=t.Units||(t.Units={}));class ScreenCalibration{constructor(t,a){this.minValue=10;this.maxValue=200;this.BarValue=100;this.parent=t;this.Units=a;this.canvas=document.createElement("canvas");this.canvas.width=this.parent.clientWidth-200;this.canvas.height=this.parent.clientHeight;this.canvas.style.border="solid 1px "+e.Frontend.WebClient.Colors.Clouds;this.canvas.style.display="inline-block";this.buttonBefore=document.createElement("button");this.buttonBefore.type="button";this.buttonBefore.style.display="inline-block";this.buttonBefore.style.width="35px";this.buttonBefore.style.minWidth="35px";this.buttonBefore.style.marginTop="-90px";this.buttonBefore.style.height="40px";this.buttonBefore.style.marginRight="15px";this.buttonBefore.className="green";this.buttonBefore.innerHTML="<";this.buttonBefore.onclick=e=>{this.BarValue-=this.Units===n.cm?1:2.54;if(this.BarValue<=this.minValue)this.BarValue=this.minValue;this.FillRuler()};this.buttonAfter=document.createElement("button");this.buttonAfter.type="button";this.buttonAfter.style.display="inline-block";this.buttonAfter.style.width="35px";this.buttonAfter.style.minWidth="35px";this.buttonAfter.style.marginTop="-90px";this.buttonAfter.style.height="40px";this.buttonAfter.style.marginLeft="15px";this.buttonAfter.className="green";this.buttonAfter.innerHTML=">";this.buttonAfter.onclick=e=>{this.BarValue+=this.Units===n.cm?1:2.54;if(this.BarValue>=this.maxValue)this.BarValue=this.maxValue;this.FillRuler()};this.parent.appendChild(this.buttonBefore);this.parent.appendChild(this.canvas);this.parent.appendChild(this.buttonAfter)}PaintLines(t){t.beginPath();t.strokeStyle=e.Frontend.WebClient.Colors.Clouds;t.fillStyle=e.Frontend.WebClient.Colors.Clouds;var n=0;for(var a=0;a<this.canvas.width;a+=this.distance){var r=this.canvas.height;t.moveTo(a,this.canvas.height-10);t.lineTo(a,r-30);if(n!==0)t.fillText((n/10).toString(),a-5,r-35);n+=10}t.stroke()}PaintDecimalsLines(e){var t;if(this.Units===n.cm){t=this.distance/10;if(t<5)t=this.distance/5;if(t<5)t=this.distance}else{t=this.distance/16;if(t<5)t=this.distance/8;if(t<5)t=this.distance/4;if(t<5)t=this.distance}e.beginPath();for(var a=0;a<this.canvas.width;a+=t){var r=this.canvas.height;e.moveTo(a,this.canvas.height);e.lineTo(a,r-20)}e.stroke()}FillRuler(){this.distance=this.BarValue;if(this.Units===n.inch)this.distance*=2.54;var t=this.canvas.getContext("2d");t.font="16px Georgia";t.strokeStyle=e.Frontend.WebClient.Colors.Clouds;t.clearRect(0,0,this.canvas.width,this.canvas.height);this.PaintLines(t);this.PaintDecimalsLines(t)}}t.ScreenCalibration=ScreenCalibration})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;var a=e.Frontend.WebClient.DOMUtils;class SubThumbnail{constructor(e,t,n){this.parent=e;this.imageGuid=t;this.Loaded=false;this.subThumbnailPane=n}Create(e,t,r){this.id=r;this.Element=a.div({className:`subThumbnail`,id:`subThumbnail_${t}`});if(e){this.image=e;this.imageIndex=t;this.LoadImage();var o=new Hammer.Manager(this.Element);o.add(new Hammer.Tap({event:"doubletap",taps:2}));o.add(new Hammer.Tap({event:"singletap"}));o.get("doubletap").recognizeWith("singletap");o.get("singletap").requireFailure("doubletap");o.on("singletap doubletap",(e=>{switch(e.type){case"singletap":break;case"doubletap":let e=this.subThumbnailPane.GetController().GetSelectViewport(this.subThumbnailPane.GetController().ViewportPane);for(var t=0;t<this.subThumbnailPane.GetController().View.Plugins.length;t++){this.subThumbnailPane.GetController().View.Plugins[t].AssignViewportDrag(e,this.subThumbnailPane.GetStudyGuid(),this.subThumbnailPane.GetSeriesItem(),this.subThumbnailPane.GetSerieNumber()-1,this.subThumbnailPane.GetTypeResource(),this.imageIndex)}break}}));o=new Hammer(this.Element);o.get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0,pointers:0});o.on("panstart panmove panend pancancel press pressup",(e=>{var t;var r;var o;var s;switch(e.type){case"panstart":this.Element.style.outline="none";if(e.pointerType==="mouse")this.isPressedAction();if(e.deltaTime<1e3){if(this.isPressed){this.isDragThumbnail=true;if(this.thumbnail){t=this.Element.getBoundingClientRect();r=t.top;o=t.left;s=this.subThumbnailPane.GetController().ThumbnailPane.FlyoutThumbnailImage;s.innerHTML="";var l=new Image;l.onload=e=>{};l.src=this.thumbnail;l.style.width="100%";l.style.height="100%";s.style.border="solid 1px "+n.Colors.Alizarin;s.appendChild(l);s.className="subThumbnail flyout";s.style.top=r+"px";s.style.left=o+"px";s.style.display="block"}}}else if(e.deltaTime>=1e3){this.isDragThumbnail=false}break;case"panmove":this.subThumbnailPane.GetController().ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","no");if(this.isDragThumbnail){this.subThumbnailPane.GetController().ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","yes");s=this.subThumbnailPane.GetController().ThumbnailPane.FlyoutThumbnailImage;s.style.top=e.center.y-90+"px";s.style.left=e.center.x-60+"px"}break;case"panend":this.isDragThumbnail=false;this.subThumbnailPane.GetController().ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","no");if(this.isPressed){this.isPressed=false;if(this.image["Load"]){var h=this.subThumbnailPane.GetController().ViewportPane.ViewportsArray;for(var u=0;u<h.length;u++){var d=h[u];t=d.ViewportFrameElement.getBoundingClientRect();if(e.center.x>=t.left&&e.center.x<=t.left+d.ViewportFrameElement.clientWidth&&(e.center.y>=t.top&&e.center.y<=t.top+d.ViewportFrameElement.clientHeight)){if(a.IsDisplay(d.ViewportFrameElement)){for(var c=0;c<this.subThumbnailPane.GetController().View.Plugins.length;c++){this.subThumbnailPane.GetController().View.Plugins[c].AssignViewportDrag(d,this.subThumbnailPane.GetStudyGuid(),this.subThumbnailPane.GetSeriesItem(),this.subThumbnailPane.GetSerieNumber()-1,this.subThumbnailPane.GetTypeResource(),this.imageIndex)}break}}}}}s=this.subThumbnailPane.GetController().ThumbnailPane.FlyoutThumbnailImage;s.innerHTML="";s.style.display="none";break;case"pancancel":this.isDragThumbnail=false;this.isPressed=false;s=this.subThumbnailPane.GetController().ThumbnailPane.FlyoutThumbnailImage;s.innerHTML="";s.style.display="none";this.Element.style.outline="none";break;case"press":this.isPressedAction();break;case"pressup":this.isPressed=false;this.isDragThumbnail=false;this.Element.style.outline="none";this.subThumbnailPane.GetController().ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","no");break}}))}this.parent.appendChild(this.Element)}GetImageGuid(){return this.imageGuid}GetId(){return this.id}LoadImage(){if(this.image["Load"]){n.DicomBufferRenderer.GetThumbnailFromImage(this.image,(e=>{let t=new Image;t.onload=()=>{this.Element.appendChild(t);this.Loaded=true};t.src=e;this.thumbnail=e}))}}isPressedAction(){this.subThumbnailPane.GetController().ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","yes");this.isPressed=true;this.Element.style.outline="solid 1px "+n.Colors.SunFlower}}t.SubThumbnail=SubThumbnail})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;var a=e.Frontend.WebClient.DOMUtils;class SubThumbnailPane{constructor(e,t,n,a,r,o,s,l,h,u){this.controller=t;this.parent=a;this.elementReference=n;this.serieNumber=r;this.imagesNumber=o;this.offsetLoadImages=0;this.countLoadImages=10;this.subThumbnails=new Array;this.studyGuid=s;this.serieGuid=l;this.wasCreated=false;this.typeResource=h;this.seriesItem=u;this.viewportPane=e}Create(e,r){this.panePosition=e;this.elementReferencePointer=r;if(!this.wasCreated){this.Element=a.div({className:`subThumbnailContainer ${a.CheckFlexGap()?"":"gap"}`,id:`subThumbnailContainer_${this.serieNumber}`});this.elementReference.after(this.Element);this.wasCreated=true;this.Load();this.SetOrientationPane(t.PanePostionString[e]);this.setWithContainer()}else if(n.DOMUtils.IsDisplay(this.Element)){this.Hide()}else{this.loadImagesWithoutDownload();this.Show(e);this.setWithContainer()}this.viewportPane.RenderViewportPane();this.viewportPane.ChangeViewportsNumber()}GetSerieNumber(){return this.serieNumber}GetStudyGuid(){return this.studyGuid}GetSerieGuid(){return this.serieGuid}GetTypeResource(){return this.typeResource}GetSeriesItem(){return this.seriesItem}GetController(){return this.controller}SetSerieNumber(e){this.serieNumber=e}SetImagesNumber(e){this.imagesNumber=e}GetImagesNumber(){return this.imagesNumber}SetSubThumbnails(e){this.subThumbnails=e}SetOffsetLoadImages(e){this.offsetLoadImages=e}SetWasCreated(e){this.wasCreated=e}Load(e){let n=e?this.imagesNumber:Math.min(this.offsetLoadImages+this.countLoadImages,this.imagesNumber);for(let e=this.offsetLoadImages;e<n;e++){for(let n=0;n<this.controller.View.Plugins.length;n++){if(e<this.imagesNumber){let a=this.controller.View.Plugins[n].GetImageEntityForStudyAndSeries(this.studyGuid,this.serieGuid,e);if(a){let n;if(!this.subThumbnails.some((e=>e.GetId()===a.id))){let n=new t.SubThumbnail(this.Element,a.image.ImageGUID,this);this.subThumbnails.push(n);n.Create(a.image,e,a.id)}else if(n=this.subThumbnails.find((e=>e.GetId()===a.id&&!e.Loaded))){n.LoadImage()}}}}}this.offsetLoadImages+=this.countLoadImages;this.setWithContainer()}ChangeOrientationPane(e){this.SetOrientationPane(e);this.Show(this.panePosition);this.setWithContainer();this.showMore()}SetOrientationPane(e){this.panePosition=t.PanePostionString[e];let n=this.isHorizontalOrientation();if(n){this.Element.classList.remove("column");this.Element.classList.add("row")}else{this.Element.classList.add("column");this.Element.classList.remove("row")}this.setWithContainer();this.showMore()}Show(e){this.panePosition=e;this.Element.style.display="flex";this.elementReferencePointer.style.backgroundColor=n.Colors.SunFlower;this.elementReferencePointer.style.color=n.Colors.FullWhite}Hide(){this.offsetLoadImages=this.countLoadImages;this.Element.style.display="none";this.elementReferencePointer.style.removeProperty("background-color");this.elementReferencePointer.style.removeProperty("color")}isHorizontalOrientation(){return this.panePosition===t.PanePosition.Top||this.panePosition===t.PanePosition.Bottom}showMore(){let e=t.ResourceBag.PlusPng;let r=this.imagesNumber;let o=this.subThumbnails.length;if(this.buttonShowMore)n.DOMUtils.RemoveItem(this.buttonShowMore);if(this.offsetLoadImages<r){this.buttonShowMore=a.div({className:`showMoreSubThumbnail`});let t=new Image;t.src=e;this.buttonShowMore.appendChild(t);this.buttonShowMore.onclick=e=>{this.loadImagesWithoutDownload();this.Load();this.showMore()};let n=this.isHorizontalOrientation();if(n){this.buttonShowMore.classList.add("showMoreSubThumbnailHorizontal");this.buttonShowMore.classList.remove("showMoreSubThumbnailVertical")}else{this.buttonShowMore.classList.remove("showMoreSubThumbnailHorizontal");this.buttonShowMore.classList.add("showMoreSubThumbnailVertical")}if(o===r){this.setWithContainer();this.subThumbnails[Math.min(this.offsetLoadImages,r)-1].Element.appendChild(this.buttonShowMore)}else{this.subThumbnails[this.subThumbnails.length-1].Element.appendChild(this.buttonShowMore)}this.Element.style.overflow="hidden"}else{this.Element.style.removeProperty("overflow")}}setWithContainer(){let e=0;let t=0;let n=this.isHorizontalOrientation();let a=this.imagesNumber;if(n){e=(this.subThumbnails[0].Element.clientWidth+10)*Math.min(this.offsetLoadImages,a);this.Element.style.width=e+"px";this.Element.style.height="auto"}else{t=(this.subThumbnails[0].Element.clientHeight+10)*Math.min(this.offsetLoadImages,a);this.Element.style.width="auto";this.Element.style.height=t+"px"}}loadImagesWithoutDownload(){let e=this.imagesNumber;let t=0;this.subThumbnails.forEach((e=>t+=e.Loaded?1:0));if(t<this.offsetLoadImages&&e>t){let e=Math.floor(t/this.countLoadImages);this.offsetLoadImages=this.countLoadImages*e;this.Load()}else{let n=e-t;if(n<=5&&n!==0){this.offsetLoadImages=0;this.Load(true);this.offsetLoadImages=e}}}}t.SubThumbnailPane=SubThumbnailPane})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient.DOMUtils;var a=e.Frontend.WebClient;class Thumbnail{constructor(e,t,n,a,r,o=false){this.loadPercent=0;this.PseudoSeries=o;this.StudyGuid=e;this.SeriesItem=t;this.SeriesNumber=n;this.ViewportPane=a;this.ActionClick=r;this.isDragThumbnail=false;this.isMenuShown=false;this.isPressed=false;this.ThumbnailName="normal"}Create(e){this.Parent=e;var r=document.createElement("div");this.Element=r;var o;n.AddClass(r,"ThumbnailItem");if(this.PseudoSeries){n.AddClass(r,"ThumbnailKey");o=document.createElement("div");n.AddClass(o,"KeyImageThumb");this.Element.appendChild(o)}var s=document.createElement("canvas");n.AddClass(s,"progress");this.canvas=s;this.Element.appendChild(s);var l=document.createElement("div");l.className="totalImagesCounter";l.onclick=e=>{this.ToogleSubThumbnails(e)};this.Element.appendChild(l);this.Element.setAttribute("data-seriesNumber",this.SeriesNumber.toString());this.Element.setAttribute("data-studyGuid",this.StudyGuid);this.Element.setAttribute("data-seriesGuid",this.SeriesItem.SeriesGUID);this.Element.setAttribute("tooltip","");var h=new Hammer.Manager(this.Element);h.add(new Hammer.Tap({event:"doubletap",taps:2}));h.add(new Hammer.Tap({event:"singletap"}));h.get("doubletap").recognizeWith("singletap");h.get("singletap").requireFailure("doubletap");h.on("singletap doubletap",(e=>{switch(e.type){case"singletap":this.ActionClick(e);break;case"doubletap":if(this.ViewportPane.ViewerPage.LayoutMode===t.LayoutMode.Stack&&+this.ViewportPane.HorizontalViewports===1&&+this.ViewportPane.VerticalViewports===1){var n=this.ViewportPane.ViewportsArray[0];for(let e=0;e<this.ViewportPane.ViewerPage.View.Plugins.length;e++){this.ViewportPane.ViewerPage.View.Plugins[e].AssignViewportDrag(n,this.StudyGuid,this.SeriesItem,this.SeriesNumber-1,this.Element.getAttribute("data-typeResource"))}}break}}));h=new Hammer(this.Element);h.get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0,pointers:0});h.on("panstart panmove panend pancancel press pressup",(e=>{var r;var s;var l;var h;switch(e.type){case"panstart":this.Element.style.outline="none";if(e.deltaTime<1e3){if(e.pointerType==="mouse")this.isPressedAction();if(this.isPressed){this.isDragThumbnail=true;this.isMenuShown=false;if(this.SeriesImage!==undefined&&this.SeriesImage!==null){r=this.Element.getBoundingClientRect();s=r.top;l=r.left;h=this.ViewportPane.ViewerPage.ThumbnailPane.FlyoutThumbnailImage;h.innerHTML="";var u=new Image;u.onload=e=>{};u.src=this.SeriesImage.src;h.style.border="solid 1px "+a.Colors.Alizarin;h.appendChild(u);h.className="ThumbnailImage flyout";h.style.top=s+"px";h.style.left=l+"px";h.style.display="block"}else{r=this.Element.getBoundingClientRect();s=r.top;l=r.left;h=this.ViewportPane.ViewerPage.ThumbnailPane.FlyoutThumbnailImage;h.innerHTML="";h.style.border="solid 1px "+a.Colors.Alizarin;h.className="ThumbnailImage flyout";h.style.top=s+"px";h.style.left=l+"px";o=document.createElement("div");n.AddClass(o,"KeyImageThumb");h.appendChild(o);h.style.display="block"}}}else if(e.deltaTime>=1e3){this.isDragThumbnail=false;this.isMenuShown=true}break;case"panmove":this.ViewportPane.ViewerPage.ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","no");if(this.isDragThumbnail){this.ViewportPane.ViewerPage.ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","yes");h=this.ViewportPane.ViewerPage.ThumbnailPane.FlyoutThumbnailImage;h.style.top=e.center.y-80+"px";h.style.left=e.center.x-50+"px"}break;case"panend":this.isDragThumbnail=false;if(!this.isMenuShown)this.ViewportPane.ViewerPage.ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","no");else this.ViewportPane.ViewerPage.ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","yes");if(this.isPressed){this.isPressed=false;if(this.Element.getAttribute("data-totalimagesloaded")!==undefined&&parseInt(this.Element.getAttribute("data-totalimagesloaded"))>0){var d=this.ViewportPane.ViewportsArray;for(var c=0;c<d.length;c++){var m=d[c];r=m.ViewportFrameElement.getBoundingClientRect();if(e.center.x>=r.left&&e.center.x<=r.left+m.ViewportFrameElement.clientWidth&&(e.center.y>=r.top&&e.center.y<=r.top+m.ViewportFrameElement.clientHeight)){if(n.IsDisplay(m.ViewportFrameElement)){for(var g=0;g<this.ViewportPane.ViewerPage.View.Plugins.length;g++){this.ViewportPane.ViewerPage.View.Plugins[g].AssignViewportDrag(m,this.StudyGuid,this.SeriesItem,this.SeriesNumber-1,this.Element.getAttribute("data-typeResource"))}break}}}}}h=this.ViewportPane.ViewerPage.ThumbnailPane.FlyoutThumbnailImage;h.innerHTML="";h.style.display="none";this.Element.style.outline="none";break;case"pancancel":this.isDragThumbnail=false;this.isPressed=false;this.isMenuShown=false;h=this.ViewportPane.ViewerPage.ThumbnailPane.FlyoutThumbnailImage;h.innerHTML="";h.style.display="none";this.Element.style.outline="none";break;case"press":this.isPressedAction();break;case"pressup":this.isPressed=false;this.isDragThumbnail=false;this.Element.style.outline="none";if(e.deltaTime<1e3){this.isMenuShown=false;this.ViewportPane.ViewerPage.ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","no")}else if(e.deltaTime>=1e3){this.isMenuShown=true;this.ViewportPane.ViewerPage.ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","yes");if(this.Element.getAttribute("data-totalimagesloaded")!==undefined&&parseInt(this.Element.getAttribute("data-totalimagesloaded"))>0){if(this.ViewportPane.ViewerPage.LayoutMode===t.LayoutMode.Stack)this.ThumbnailMenu.ShowMenu(true)}}break}}));this.Parent.appendChild(this.Element);this.ProgressRing=new a.ProgressRing(this.canvas);this.ProgressRing.ShowWatch();this.ViewportLayoutGrid=new a.ViewportLayoutGrid(this.Element,this.ViewportPane.HorizontalViewports,this.ViewportPane.VerticalViewports,{width:10,height:10});this.ViewportLayoutGrid.Render(0);this.ThumbnailMenu=new t.ThumbnailMenu(this);this.ThumbnailMenu.Create(this.Element)}ToogleSubThumbnails(e){var n=+this.Element.getAttribute("data-totalimages");if(n>1){if(!this.SubThumbnailPane)this.SubThumbnailPane=new t.SubThumbnailPane(this.ViewportPane,this.ViewportPane.ViewerPage,this.Element,this.Parent,this.SeriesNumber,n,this.StudyGuid,this.SeriesItem.SeriesGUID,this.Element.getAttribute("data-typeResource"),this.SeriesItem);if(n!==this.SubThumbnailPane.GetImagesNumber()){this.SubThumbnailPane.SetSerieNumber(this.SeriesNumber);this.SubThumbnailPane.SetImagesNumber(n);this.SubThumbnailPane.SetSubThumbnails(new Array);this.SubThumbnailPane.SetOffsetLoadImages(0);this.SubThumbnailPane.Element.innerHTML="";a.DOMUtils.RemoveItem(this.SubThumbnailPane.Element);this.SubThumbnailPane.SetWasCreated(false)}this.SubThumbnailPane.Create(this.ViewportPane.ViewerPage.ThumbnailPane.Position,e.currentTarget)}}StartProgressRing(){var e=setInterval((()=>{try{this.loadPercent=parseInt(this.Element.getAttribute("data-totalimagesloaded"))/parseInt(this.Element.getAttribute("data-totalimages"))*100;var t=this.PseudoSeries?2:1;n.AddClass(this.Element.childNodes.item(t),"totalimages");while(this.Element.childNodes.item(t).firstChild){this.Element.childNodes.item(t).removeChild(this.Element.childNodes.item(t).firstChild)}this.Element.childNodes.item(t).appendChild(document.createTextNode(this.Element.getAttribute("data-totalimages")));this.ProgressRing.ShowPercentage(this.loadPercent);if(this.loadPercent>=100){clearInterval(e);this.ProgressRing.Clear()}}catch(t){clearInterval(e);this.ProgressRing.Clear()}}),500)}TogglePositionClass(e,t=null){if(t!==null)n.RemoveClass(this.Element,t);n.AddClass(this.Element,e)}IsEqualTo(e){var t,n;return this.StudyGuid===e.StudyGuid&&((t=this.SeriesItem)===null||t===void 0?void 0:t.SeriesGUID)===((n=e.SeriesItem)===null||n===void 0?void 0:n.SeriesGUID)}Delete(e){e.removeChild(this.Element)}ChangeOrientation(e){var t;(t=this.SubThumbnailPane)===null||t===void 0?void 0:t.SetOrientationPane(e)}isPressedAction(){this.ViewportPane.ViewerPage.ThumbnailPane.ThumbnailPaneSection.setAttribute("data-blockScroll","yes");this.isPressed=true;this.Element.style.outline="solid 1px "+a.Colors.SunFlower}}t.Thumbnail=Thumbnail})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient.DOMUtils;var a=e.Frontend.WebClient;class ThumbnailMenu{constructor(e){this.thumbnail=e}Create(e){this.Parent=e;var t=document.createElement("div");var a=this.thumbnail.ViewportPane.ViewerPage.View.Platform.LanguageManager;var r=this.Parent.clientWidth;this.Element=t;n.AddClass(t,"ThumbnailMenu");this.BlAssignViewport=document.createElement("div");this.BlAssignViewport.style.width=r-20+"px";this.BlAssignViewport.innerHTML=a.GetValuesFromDict("ViewerLanguage","assignViewport");n.AddClass(this.BlAssignViewport,"optionLabel");this.BlClearViewport=document.createElement("div");this.BlClearViewport.style.width=r-20+"px";this.BlClearViewport.innerHTML=a.GetValuesFromDict("ViewerLanguage","clearViewport");n.AddClass(this.BlClearViewport,"optionLabel");this.BlClearViewport.style.display="none";this.PanelClearViewport=document.createElement("div");this.PanelClearViewport.style.width=r-20+"px";n.AddClass(this.PanelClearViewport,"optionLabel");n.AddClass(this.PanelClearViewport,"panel");this.PanelClearViewport.style.display="none";this.BlCancel=document.createElement("div");this.BlCancel.style.width=r-20+"px";this.BlCancel.innerHTML=a.GetValuesFromDict("ViewerLanguage","cancelText");n.AddClass(this.BlCancel,"optionLabel");var o=new Hammer(this.BlAssignViewport);o.on("tap",(e=>{var t=this.thumbnail.ViewportPane.ViewerPage;t.ThumbnailPane.ThumbnailSerieSelect=this.thumbnail;t.View.TextBar.innerHTML=t.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","assignViewportOption");t.View.MessageBar.style.display="block";t.View.MessageBar.style.width=t.View.Platform.Toolbar.Element.parentElement.parentElement.clientWidth+"px";t.View.MessageBar.style.height=t.View.Platform.Toolbar.Element.parentElement.parentElement.clientHeight+"px";t.View.ActionClickBar=()=>{t.View.MessageBar.style.display="none"};this.ShowMenu(false)}));var s=new Hammer(this.BlClearViewport);s.on("tap",(e=>{if(this.viewportItems.length===1){this.thumbnail.ViewportPane.ViewerPage.ThumbnailPane.ClearImageOfViewport(this.thumbnail.StudyGuid,this.thumbnail.SeriesItem.SeriesGUID,this.viewportItems[0]);this.BlClearViewport.style.display="none";this.ShowMenu(false)}}));var l=new Hammer(this.BlCancel);l.on("tap",(e=>{this.ShowMenu(false)}));this.Element.appendChild(this.BlAssignViewport);this.Element.appendChild(this.BlClearViewport);this.Element.appendChild(this.PanelClearViewport);this.Element.appendChild(this.BlCancel);this.Parent.appendChild(this.Element)}ShowMenu(e){if(e){var t=document.getElementsByClassName("ThumbnailMenu");for(var a in t){if(t.hasOwnProperty(a)){var r=t[a];n.HideElement(r)}}this.AnalyzeViewports();this.Element.style.display="block"}else{this.Element.style.display="none"}}IsShow(){var e=true;if(this.Element.style.display==="none")e=false;return e}AnalyzeViewports(){this.viewportItems=this.thumbnail.ViewportPane.ViewerPage.ThumbnailPane.SearchViewportInThumbnailSeries(this.thumbnail.StudyGuid,this.thumbnail.SeriesItem.SeriesGUID);if(this.viewportItems.length===1){this.BlClearViewport.style.display="block";this.PanelClearViewport.innerHTML="";this.PanelClearViewport.style.display="none";this.Element.style.height=this.Parent.clientHeight+"px"}else{this.PanelClearViewport.innerHTML="";this.BlClearViewport.style.display="none";this.PanelClearViewport.style.display="block";this.Element.style.height=this.Parent.clientHeight+"px";for(var e=0;e<this.viewportItems.length;e++){var t=document.createElement("div");var r=document.createElement("div");var o=document.createElement("div");n.AddClass(t,"container");n.AddClass(r,"elements");n.AddClass(o,"elements");var s=this.thumbnail.ViewportPane.HorizontalViewports*4+(this.thumbnail.ViewportPane.HorizontalViewports-1)*2;var l=this.thumbnail.ViewportPane.VerticalViewports*4+(this.thumbnail.ViewportPane.VerticalViewports-1)*2;r.style.width=s+"px";r.style.height=l+"px";var h=new a.ViewportLayoutGrid(r,this.thumbnail.ViewportPane.HorizontalViewports,this.thumbnail.ViewportPane.VerticalViewports,{width:4,height:4});h.Render(this.viewportItems[e]);h.Element.style.left="0px";h.Element.style.top="0px";o.innerHTML=this.thumbnail.ViewportPane.ViewerPage.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","clearText");o.style.marginTop="2px";o.style.marginLeft="5px";o.setAttribute("data-index",e.toString());var func=e=>{var t=this.viewportItems[e];this.thumbnail.ViewportPane.ViewerPage.ThumbnailPane.ClearImageOfViewport(this.thumbnail.StudyGuid,this.thumbnail.SeriesItem.SeriesGUID,t);this.AnalyzeViewports()};var u=new Hammer(o);u.on("tap",(e=>{var t=parseInt(e.target.getAttribute("data-index"));func(t)}));if(e<this.viewportItems.length-1)t.style.marginBottom="6px";t.appendChild(r);t.appendChild(o);this.PanelClearViewport.appendChild(t)}}}}t.ThumbnailMenu=ThumbnailMenu})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient.Utils;var a=e.Frontend.WebClient.DOMUtils;var r=e.Frontend.WebClient;const o=a.div;const s=a.span;let l;(function(e){e[e["Top"]=1]="Top";e[e["Right"]=2]="Right";e[e["Bottom"]=3]="Bottom";e[e["Left"]=4]="Left"})(l=t.PanePosition||(t.PanePosition={}));let h;(function(e){e[e["top"]=1]="top";e[e["right"]=2]="right";e[e["bottom"]=3]="bottom";e[e["left"]=4]="left";e[e["undefined"]=4]="undefined"})(h=t.PanePostionString||(t.PanePostionString={}));class ThumbnailPane{constructor(e,t){this.ThumbnailContainerPerStudy={};this.Thumbnails={};this.Parent=e;this.Controller=t;this.ThumbnailContainerPerStudy={}}Create(){const e=this.IsHorizontalOrientation();this.ThumbnailPaneSection=o({className:`thumbnailPane ${e?"row":"column"}`});const t=setTimeout((()=>{const e=this.IsHorizontalOrientation();const n=this.Controller.ViewportPane.GetPaneDimensions();this.ThumbnailPaneSection.style.height=e?"100%":`${n.height}px`;this.ThumbnailPaneSection.style.width=e?`${n.width}px`:"100%";this.ThumbnailPaneSection.style.overflowY=e?"hidden":"auto";this.ThumbnailPaneSection.style.overflowX=e?"auto":"hidden";clearTimeout(t)}),150);var r=new Hammer(this.ThumbnailPaneSection);r.get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0,pointers:0});r.on("panstart panmove panend",(e=>{if(e.type==="panmove")a.ScrollElement(this.ThumbnailPaneSection,e.deltaY<0?-e.distance:e.distance,e.additionalEvent==="panup"||e.additionalEvent==="pandown")}));a.ScrollElement(this.ThumbnailPaneSection);if(this.Controller.View.Platform.GetSetting("chkBoxThumbnailChecked")===undefined)this.Controller.View.Platform.SetSetting(40,"chkBoxThumbnailChecked","false");this.Parent.appendChild(this.ThumbnailPaneSection);if(n.StrToBool(this.Controller.View.Platform.GetSetting("chkBoxThumbnailChecked")))this.Hide();else this.Show()}HideSubThumbanilPaneFromStudyAndSerieGuid(e,t){if(this.Thumbnails[e]){this.Thumbnails[e].forEach((e=>{if(e.SeriesItem.SeriesGUID===t){if(e.SubThumbnailPane&&r.DOMUtils.IsDisplay(e.SubThumbnailPane.Element))e.SubThumbnailPane.Hide()}}))}}ExistsContainerStudyThumbnails(e){var t=null;return t}BuildThumbnailElement(e,n,r=false){const s=this.IsHorizontalOrientation();if(r){const e=o({className:`separatorThumbnailSection ${s?"ThumbnailStudySeparatorH":"ThumbnailStudySeparatorV"}`,innerHTML:"&nbsp;"});this.ThumbnailPaneSection.appendChild(e)}else{this.Thumbnails={};this.ThumbnailPaneSection.innerHTML=""}this.Thumbnails[e]=new Array;if(!this.ThumbnailContainerPerStudy[e]){const t=o({className:`thumbnailContainer ${s?"row":"column"} ${a.CheckFlexGap()?"":"gap"}`,style:{display:s?"inline-flex":"flex"}});t.setAttribute("data-studyGuid",e);this.ThumbnailPaneSection.appendChild(t);this.ThumbnailContainerPerStudy[e]=t}this.CreateTagsThumbnail(e);n.IndexData.forEach(((a,r)=>{const o=n.StructureData[a];const s=new t.Thumbnail(e,o,r+1,this.Controller.ViewportPane,(e=>{}));s.Create(this.ThumbnailContainerPerStudy[e]);this.Thumbnails[e].push(s)}));if(!this.ThumbnailPaneSection.classList.contains("hasScroll")&&this.ThumbnailPaneSection.clientHeight<this.ThumbnailPaneSection.children[0].clientHeight){this.ThumbnailPaneSection.classList.add("hasScroll")}}ChangeOrientationPane(e){this.Position=h[e];const t=this.IsHorizontalOrientation();Object.keys(this.ThumbnailContainerPerStudy).forEach((e=>{if(this.ThumbnailContainerPerStudy.hasOwnProperty(e)){const n=this.ThumbnailContainerPerStudy[e];n.classList.remove("column");n.classList.remove("row");n.classList.add(t?"row":"column")}}));Object.keys(this.Thumbnails).forEach((t=>{this.Thumbnails[t].forEach((t=>t.ChangeOrientation(e)))}));const n=this.Controller.ViewportPane.GetPaneDimensions();if(t){this.Parent.style.justifyContent="flex-start";this.ThumbnailPaneSection.classList.remove("column");this.ThumbnailPaneSection.classList.add("row");this.ThumbnailPaneSection.style.height="100%";this.ThumbnailPaneSection.style.width=`${n.width}px`;this.ThumbnailPaneSection.style.overflowY="hidden";this.ThumbnailPaneSection.style.overflowX="auto";Array.from(this.ThumbnailPaneSection.querySelectorAll(".thumbnailContainer")).forEach((e=>{e.style.display="inline-flex"}));Array.from(this.ThumbnailPaneSection.querySelectorAll(".separatorThumbnailSection")).forEach((e=>{e.classList.remove("ThumbnailStudySeparatorV");e.classList.add("ThumbnailStudySeparatorH")}))}else{this.Parent.style.justifyContent="center";this.ThumbnailPaneSection.classList.remove("row");this.ThumbnailPaneSection.classList.add("column");this.ThumbnailPaneSection.style.height=`${n.height}px`;this.ThumbnailPaneSection.style.width="100%";this.ThumbnailPaneSection.style.overflowY="auto";this.ThumbnailPaneSection.style.overflowX="hidden";Array.from(this.ThumbnailPaneSection.querySelectorAll(".thumbnailContainer")).forEach((e=>{e.style.display="flex"}));Array.from(this.ThumbnailPaneSection.querySelectorAll(".separatorThumbnailSection")).forEach((e=>{e.classList.remove("ThumbnailStudySeparatorH");e.classList.add("ThumbnailStudySeparatorV")}))}}BuildThumbnailPseudoSeries(e,n,a){var r=n.IndexData[n.IndexData.length-1];var o=n.StructureData[r];var s=new t.Thumbnail(e,o,n.IndexData.length,this.Controller.ViewportPane,(e=>{}),true);s.ThumbnailName=a;s.Create(this.ThumbnailContainerPerStudy[e]);s.Element.setAttribute("data-typeResource","dicom");this.Thumbnails[e].push(s)}CloseAllSubThumbnails(e){this.Thumbnails[e].forEach((e=>{var t;(t=e.SubThumbnailPane)===null||t===void 0?void 0:t.Hide()}))}UpdateThumbnailsInLine(e,n){for(var a=0;a<n.Series.IndexData.length;a++){var r=n.Series.IndexData[a];if(!this.Thumbnails[e].some((e=>e.SeriesItem.SeriesGUID===r))){var o=n.Series.StructureData[r];var s=new t.Thumbnail(e,o,a+1,this.Controller.ViewportPane,(e=>{}));s.Create(this.ThumbnailContainerPerStudy[e]);this.Thumbnails[e].push(s)}}let l=this.Thumbnails[e].filter((e=>!n.Series.IndexData.some((t=>t===e.SeriesItem.SeriesGUID))));l.forEach((t=>{t.Delete(this.ThumbnailContainerPerStudy[e]);const n=this.Thumbnails[e].findIndex((e=>e.IsEqualTo(t)));this.Thumbnails[e].splice(n,1)}));let h=1;this.Thumbnails[e].forEach((e=>{e.SeriesNumber=h;e.SeriesItem.SerieNumber=h;h++}))}PseudoSeriesExist(e,t){return this.Thumbnails[e].some((e=>e.PseudoSeries&&e.ThumbnailName===t))}RemoveThumbnailPseudoSeries(e,t){var n=Object.keys(this.Thumbnails);for(var r=0;r<n.length;r++){for(var o=0;o<this.Thumbnails[n[r]].length;o++){if(this.Thumbnails[n[r]][o].StudyGuid===e&&this.Thumbnails[n[r]][o].SeriesItem.SeriesGUID===t){var s=this.Thumbnails[n[r]][o].Parent;var l=this.Thumbnails[n[r]][o].Element;l.style.display="none";this.Thumbnails[n[r]].splice(o,1);a.RemoveItem(l);break}}}}UpdateAllThumnailsPane(){var e,t;var n=Object.keys(this.Thumbnails);for(var r=0;r<n.length;r++){var o=this.Thumbnails[n[r]];for(var s=0;s<o.length;s++){var l=new Array;var h=this.Controller.ViewportPane.ViewportsArray;if(h!==null){for(var u=0;u<h.length;u++){if(h[u].Context.StudyGuid===o[s].StudyGuid&&h[u].Context.SeriesGuid===o[s].SeriesItem.SeriesGUID){if(a.IsDisplay(h[u].ViewportFrameElement))l.push(h[u].NumberInPanel)}}}if(o[s].ThumbnailMenu.IsShow())o[s].ThumbnailMenu.AnalyzeViewports();o[s].ViewportLayoutGrid.VerticalViewports=this.Controller.ViewportPane.VerticalViewports;o[s].ViewportLayoutGrid.HorizontalViewports=this.Controller.ViewportPane.HorizontalViewports;if(s===0){const n=(t=(e=h[s])===null||e===void 0?void 0:e.Context)===null||t===void 0?void 0:t.StudyGuid;if(n&&this.ThumbnailContainerPerStudy[n]){if(!this.ThumbnailContainerPerStudy[n].getAttribute("data-has-tags"))this.CreateTagsThumbnail(n)}}o[s].ViewportLayoutGrid.Render(0,l)}}}CreateTagsThumbnail(e){const t=this.getStudyTags(e);const n=this.ThumbnailContainerPerStudy[e];if(t.length>0){const a=t.some((e=>e.length>12));const r=this.CreateTags(e);const s=o({className:"ThumbnailItem thumbnailTags",children:r});if(r.length<4&&!a){s.style.flex="0 0";s.style.overflow="initial"}if(n.getAttribute("data-has-tags")){const e=n.querySelector(".thumbnailTags");n.removeChild(e);n.prepend(s)}else{n.prepend(s);n.setAttribute("data-has-tags","true")}}else{if(n.getAttribute("data-has-tags")){const e=n.querySelector(".thumbnailTags");n.removeChild(e);n.removeAttribute("data-has-tags")}}}IsHorizontalOrientation(){return this.Position===l.Top||this.Position===l.Bottom}Show(){if(!n.StrToBool(this.Controller.View.Platform.GetSetting("chkBoxThumbnailChecked"))){this.Visible=true;this.ThumbnailPaneSection.parentElement.style.display="flex"}}Hide(){this.Visible=false;this.ThumbnailPaneSection.parentElement.style.display="none"}OnWindowResize(e,t){const n=this.Controller.ViewportPane.GetPaneDimensions();if(this.IsHorizontalOrientation()){this.ThumbnailPaneSection.style.height="100%";this.ThumbnailPaneSection.style.width=`${n.width}px`}else{this.ThumbnailPaneSection.style.height=`${n.height}px`;this.ThumbnailPaneSection.style.width="100%"}}CreateTags(e){const t=this.getStudyTags(e);const getTagClass=e=>{if(e.toUpperCase()==="READ")return"tagblue";if(e.toUpperCase()==="CASE")return"tagorange";else if(e.toUpperCase().includes("!"))return"tagred";else return""};return t.map((e=>s({innerHTML:e,className:`tag ${getTagClass(e)}`})))}getStudyTags(e){const t=this.Controller.ImagingStudyFhirEntities;const n=t[e];if(!n)return[];return r.TagUtils.GetTags(n)}}t.ThumbnailPane=ThumbnailPane})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;class Vector2D extends n.Point{constructor(e,n){super(0,0);if(e===undefined||e===null)this.P1=new t.AnnotationPoint;else this.P1=e;if(n===undefined||n===null)this.P2=new t.AnnotationPoint;else this.P2=n;this.Calculate()}Clone(){return new Vector2D(this.P1.Clone(),this.P2.Clone())}Null(){this.P1.X=0;this.P1.Y=0;this.P2.X=0;this.P2.Y=0;this.X=0;this.Y=0;return this}Calculate(){this.X=this.P2.X-this.P1.X;this.Y=this.P2.Y-this.P1.Y}Recalculate(){this.P2.X=this.P1.X+this.X;this.P2.Y=this.P1.Y+this.Y}Add(e){this.X=this.X+e.X;this.Y=this.Y+e.Y;this.Recalculate();return this}SetXY(e,t){this.X=e;this.Y=t;this.Recalculate()}Copy(){return new Vector2D(this.P1,this.P2)}Orthogonal(){var e=this.X;this.X=-this.Y;this.Y=e;this.Recalculate();return new Vector2D(this.P1,this.P2)}OrthoNorm(){if(this.Norm()===0){return this.Null()}else{var e=this.X/this.Norm();this.X=-this.Y/this.Norm();this.Y=e;this.Recalculate();return new Vector2D(this.P1,this.P2)}}HorizontalComponent(){var e=new t.AnnotationPoint;e.X=this.P2.X;e.Y=this.P1.Y;return new Vector2D(this.P1,e)}VerticalComponent(){var e=new t.AnnotationPoint;e.X=this.P1.X;e.Y=this.P2.Y;return new Vector2D(this.P1,e)}Distance(e){return e.Subtract(this).Norm()}Norm(){return Math.sqrt(this.X*this.X+this.Y*this.Y)}Normalize(){return this.NormalizeV(this)}NormalizeV(e){var t=e.Norm();if(t!==0){e.X=e.X/t;e.Y=e.Y/t;e.Recalculate()}return e}Subtract(e){this.X=this.X-e.X;this.Y=this.Y-e.Y;this.Recalculate();return this}ScalarMult(e){this.X=e*this.X;this.Y=e*this.Y;this.Recalculate();return this}Dot(e){return this.X*e.X+this.Y*e.Y}Cross(e){return this.X*e.Y-this.Y*e.X}Opposite(){var e=this.P1.X;var t=this.P1.Y;this.P1.X=this.P2.X;this.P1.Y=this.P2.Y;this.P2.X=e;this.P2.Y=t;this.X=this.P2.X-this.P1.X;this.Y=this.P2.Y-this.P1.Y;return this}AngleDeg(){var e=Math.atan2(this.Y,this.X)*180/Math.PI;if(e<0)e+=360;return e}AngleRad(){return Math.atan2(this.Y,this.X)}Slope(){if(this.X===0)return 0;else return this.Y/this.X}RotateRad(e){var t=this.X*Math.cos(e)-this.Y*Math.sin(e);var n=this.X*Math.sin(e)+this.Y*Math.cos(e);this.X=t;this.Y=n;this.Recalculate();return this}RotateDeg(e){return this.RotateRad(e*Math.PI/180)}MidPoint(){return this.Clone().ScalarMult(.5).P2}IsXPositive(){return this.P2.X-this.P1.X>=0}IsYPositive(){return this.P2.Y-this.P1.Y>=0}ToString(){return"("+this.X+", "+this.Y+")"}Angle2VectorsDeg(e){return this.Angle2Vectors(e)*180/Math.PI}Angle2VectorsDeg90(e){var t=this.Angle2Vectors(e)*180/Math.PI;if(t>90)t=180-t;return t}Angle2Vectors(e){var t=this.Clone().Dot(e);var n=this.Norm()*e.Norm();if(n!==0)return Math.acos(t/n);else return 0}AddVectorToAnnotationPoint(e){this.Recalculate();var n=new t.AnnotationPoint;n.X=e.X+this.X;n.Y=e.Y+this.Y;return n}AddVectorToPoint(e){this.Recalculate();var t=new n.Point(0,0);t.X=e.X+this.X;t.Y=e.Y+this.Y;return t}SubstractVectorToPoint(e){this.Recalculate();var n=new t.AnnotationPoint;n.X=e.X-this.X;n.Y=e.Y-this.Y;return n}SubstractVectorToPointOnlyX(e){this.Recalculate();var n=new t.AnnotationPoint;n.X=e.X-this.X;n.Y=e.Y+this.Y;return n}CalculateProjectionOrthogonal(e){var t=new Vector2D(this.P1,e);var n=this.Dot(t)/Math.pow(this.Clone().Norm(),2);var a=this.Clone().ScalarMult(n);return a.AddVectorToAnnotationPoint(this.P1)}DistanceToPlane(e,t,n,a){var r=[t[0]-e[0],t[1]-e[1],t[2]-e[2]];var o=[n[0]-e[0],n[1]-e[1],n[2]-e[2]];var s=[e[0]-a[0],e[1]-a[1],e[2]-a[2]];var l=[r[1]*o[2]-r[2]*o[1],-(r[0]*o[2]-r[2]*o[0]),r[0]*o[1]-r[1]*o[0]];var h=s[0]*l[0]+s[1]*l[1]+s[2]*l[2];var u=Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);if(u!==0)return h/u;else return h}EvaluateSideOfPoint(e){var t=new Vector2D(this.P1,e);if(this.Clone().Orthogonal().Dot(t)>=0)return 1;else return-1}EvalXDirection(){return this.P2.X-this.P1.X>=0}DistancePointToVector(e){var t=new Vector2D(this.P1,e);var n=t.Norm();var a=this.Dot(t)/this.Norm();return Math.sqrt(n*n-a*a)}IsPointLieOnLine(e){return this.DistancePointToVector(e)<=.01}VectorBisectorNorm(e){return this.Normalize().Add(e.Normalize())}VectorForLabels(e){var t=this.Clone().Normalize().ScalarMult(e);return new Vector2D(t.Clone().SubstractVectorToPoint(this.P1),t.Clone().AddVectorToAnnotationPoint(this.P2))}AlwaysPointsUpwards(){if(!this.EvalXDirection())this.Opposite();return this}DirectionV(){return this.P2.Y-this.P1.Y>0?-1:1}}t.Vector2D=Vector2D})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;class Viewer{constructor(){this.Documents=new n.MapStructure}}t.Viewer=Viewer})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;var a=n.DOMUtils;var r=e.Frontend.WebClient.Utils;var o=e.Frontend.WebClient.CalendarUtils;var s=e.Frontend.WebClient.LayoutManager.LayoutManager;var l=e.Frontend.WebClient.LayoutManager.LayoutType;var h=e.Frontend.WebClient.LayoutManager.Panel;var u=e.Frontend.WebClient.LayoutManager.MovablePanelDirection;var d=e.Frontend.WebClient.LayoutManager.PanelOrientation;let c;(function(e){e[e["Stack"]=0]="Stack";e[e["Tile"]=1]="Tile"})(c=t.LayoutMode||(t.LayoutMode={}));let m;(function(e){e[e["Slow"]=0]="Slow";e[e["Medium"]=1]="Medium";e[e["Fast"]=2]="Fast"})(m=t.EScrollSpeed||(t.EScrollSpeed={}));class ViewerPage{constructor(e,r,o){this.MultipleSelectViewports=false;this.ExtendViewportPane=false;this.ChangeLayoutFromToolbar=false;this.ExitFullScreen=false;this.ImagingStudyFhirEntities={};this.LoadAllAnnotationsForStudy={};this.RequestReadyAnnotations={};this.ForceHDDownloadForStudyAndSerie={};this.HasBlockedDoubleClick=false;this.HasBlockedRightClick=false;this.isDownloadingReport=false;this.SpecialAnnotations={};var u=n.Utils.StrToBool(o.Platform.GetSetting("chkBoxRecallLastDisplayChecked")||false);var m=o.Platform.GetSetting("chkBoxRecallLastDisplayValue");this.GeneralWheelFactorSpeed=this.GetScrollSpeedNumber(o.Platform.GetSetting("ScrollSpeed"));this.AnnotationsHide=o.Platform.GetSetting("annotationsHideValue")?n.Utils.StrToBool(o.Platform.GetSetting("annotationsHideValue")):false;this.Parent=e;this.LayoutMode=u&&m?m===c[c.Stack]?c.Stack:c.Tile:c.Stack;this.FullScreen=false;this.ActiveContextMenu=true;this.View=o;this.StudyViewerModel=r;this.TopBarElement=new n.TopBar(this.View.Platform.Toolbar.Parent.parentElement);this.TopBarElement.Hide();this.View.Platform.ResizeListeners.push(new n.ResizeStructure(this.TopBarElement.constructor.name.toLowerCase(),this.TopBarElement,this.View.ViewName));var g=document.createElement("div");a.AddClass(g,"SpaceViewer");this.SpaceViewer=g;this.Parent.appendChild(g);this.layoutManager=new s(this.SpaceViewer);this.layoutManager.SetLayout(l.MOVABLE,{orientation:d.HORIZONTAL,width:"100%",height:"100%",isResponsive:true,style:{gap:"5px"}});const w=new h({className:"wrap-thumbnailPane",style:{justifyContent:d.HORIZONTAL?"flex-start":"center"}});const f=new h({});this.layoutManager.Add(w);this.layoutManager.Add(f);this.ThumbnailPane=new t.ThumbnailPane(w.GetDOMElement(),this);this.ThumbnailPane.Create();this.View.Platform.ResizeListeners.push(new n.ResizeStructure(this.ThumbnailPane.constructor.name.toLowerCase(),this.ThumbnailPane,this.View.ViewName));this.ThumbnailPane.FlyoutThumbnailImage=document.createElement("div");a.AddClass(this.ThumbnailPane.FlyoutThumbnailImage,"flyout");g.appendChild(this.ThumbnailPane.FlyoutThumbnailImage);this.ViewportPane=new t.ViewportPane(f.GetDOMElement(),this);this.ViewportPane.Create();this.View.Platform.ResizeListeners.push(new n.ResizeStructure(this.ViewportPane.constructor.name.toLowerCase(),this.ViewportPane,this.View.ViewName));this.ShowCaseStudy=false;this.ShowRelatedStudies=false;this.Downloader=new n.MapStructure;this.AnnotationClient=new t.AnnotationClient(this.View.Platform,this.View);this.Hide();this.ChangeThumbnailPosition()}SelectDefaultTool(){let e=this.View.Platform.GetSetting("selectMouseDefaultLeft");if(e===undefined){this.SelectTool("Pointer","pointerTool")}else{switch(e){case"Pointer":this.SelectTool("Pointer","pointerTool");break;default:for(let t=0;t<this.View.Plugins.length;t++){this.View.Plugins[t].SetDefaultTool(e)}break}}this.SelectLastToolUsed()}GetScrollSpeedNumber(e){let t=3;switch(e){case m[m.Slow]:t-=1.5;break;case m[m.Fast]:t+=1.5;break}return t}GetTypeStudyForSeries(e){try{return e.trim().split("[")[1].substr(0,3).toUpperCase()}catch(e){return""}}ActionOpenStudy(e,r,o){var s=new t.StudyEntity;s.StudyGUID=e;var l=s;this.ViewportPane.OneByOneContext.IsActive=false;this.ChangeLayoutFromToolbar=false;this.RequestReadyAnnotations[e]=null;if(n.LocalStorage.Get("ViewportsLayoutTemporal")!==undefined){this.View.Platform.SetSetting(40,"ViewportsLayout",n.LocalStorage.Get("ViewportsLayoutTemporal"));n.LocalStorage.Delete("ViewportsLayoutTemporal")}if(this.View.Platform.GetSetting("ViewportsLayout")==="Fixed"||this.View.Platform.GetSetting("ViewportsLayout")==="Manual"){this.ViewportPane.HorizontalViewports=+this.View.Platform.GetSetting("HorizontalViewport");this.ViewportPane.VerticalViewports=+this.View.Platform.GetSetting("VerticalViewport")}var h=l.StudyGUID;var u=this.CreateStudyDownloader(h);if(r&&u){n.Toaster.ShowToast("This study is already open",n.Colors.Orange,5);return}var d=document.getElementsByClassName("toolbarDrop");if(d!==null){for(var c=0;c<d.length;c++){var m=d[c];a.RemoveClass(m,"selected")}}if(!r){this.MainStudyOpen=s;sessionStorage["studyView"]=JSON.stringify(l);this.ThumbnailPane.ThumbnailPaneSection.innerHTML="Loading...";this.ViewportPane.Show();this.ViewportPane.RenderViewportPane();this.ViewportPane.ViewportPaneSection.innerHTML="Loading...";this.setTitleForPatient(o);this.Init();this.SelectDefaultTool()}var g=this.GetStudyWithSeriesAndImages(l);if(g.Series.IndexData.length>0){this.ThumbnailPane.BuildThumbnailElement(l.StudyGUID,l.Series,r);this.ViewportPane.ViewportPaneSection.innerHTML="";if(this.Downloader.StructureData[h]!==undefined){var w=this.View.Platform.CacheConnect;if(this.View.Platform.GetSetting("localRepoActive")!==undefined&&this.View.Platform.GetSetting("localRepoActive")==="true"&&n.Utils.IsURL(w.ServiceUrlCache)&&sessionStorage["userEmail"].match("device")===null){if(sessionStorage["tokenCache"]===undefined||sessionStorage["tokenCache"]===null||sessionStorage["tokenCache"]===""){var f=n.Loader.Show("Getting access to local cache");w.GetToken((()=>{n.Loader.Hide(f.getAttribute("id"));this.Downloader.StructureData[h].Download(l)}))}else{this.Downloader.StructureData[h].Download(l)}}else{this.Downloader.StructureData[h].Download(l)}}var p=this.StudyViewerModel.Documents.StructureData[h];var S=p!==undefined?p["Study"]["IsCase"]:null;if(S!==null&&n.Utils.StrToBool(S)){if(this.StudyViewerModel.Documents.IndexData.length===1)this.View.Platform.Toolbar.HideButton(null,"caseStudyTool",true)}if(r){var v=this.StudyViewerModel.Documents.IndexData;for(var P=0;P<v.length;P++){var V=this.StudyViewerModel.Documents.StructureData[v[P]];if(V.Study.StudyGUID!==l.StudyGUID){for(var b=0;b<this.View.Plugins.length;b++){this.View.Plugins[b].SetSeriesAutomaticInViewports(V.Study.StudyGUID,false)}}}}}else{n.Toaster.ShowToast("There are no series for this study",n.Colors.Orange,5)}}OpenStudy(t,a,o=false){if(!t&&!a)return;if(t)t=t.replace(/ImagingStudy\//gi,"");var s=n.HttpUtils.GetUrlParameter("getExternal");var l;var h=this.View.Platform.GetRolName()==="GUEST";var u=n.HttpUtils.GetUrlParameter("openHipaa");var d;if(t!==null&&t!==undefined)d="ImagingStudy?_id="+t+"&_include=ImagingStudy:endpoint&_include=ImagingStudy:subject&_include=ImagingStudy:location";else if(a!==null&&a!==undefined)d="ImagingStudy?study="+a+"&_include=ImagingStudy:endpoint&_include=ImagingStudy:subject&_include=ImagingStudy:location";n.Loader.Show();this.getImagingStudyFhirResource(d,(t=>{n.Loader.Hide();if(t!==""){try{var a;try{a=JSON.parse(t)}catch(a){var u=t.split("|");if(u[1]==="draft"){l=u[0];var d=new n.HipaaWarningBox("shareMessage",(()=>{var t="Consent/"+l+"/$accept-consent";var a=new e.Frontend.FhirClient.FhirCall(t,"POST");a.FuncOk=()=>{n.Loader.Hide();location.replace(location.href+"&openHipaa=yes")};a.FuncError=()=>{n.Loader.Hide();n.Toaster.ShowToast("The Consent to accept the operation was not satisfactory",n.Colors.PeterRiver,3.5)};n.Loader.Show();a.Send()}),(()=>{if(s!==""&&s==="yes")this.View.Platform.Logout();else this.View.Platform.SwitchView(this.View.Platform.BrowsingHistory[this.View.Platform.BrowsingHistory.length-1],"back")}));d.Show()}else{n.Toaster.ShowToast("The application could not find data for this study.",n.Colors.Orange,3)}return}var c=e.Frontend.FhirClient.FhirParser.ProcessBundle(a,"ImagingStudy");var m=c.map((e=>e["resourceType"]==="ImagingStudy"?e:null));if(m.length!==0)m=m.pop();var g=m["identifier"][0]["value"];var w=g.lastIndexOf(":");var f=g.substring(w+1,g.length);var p;if(m["endpoint"]!==null&&m["endpoint"]!=="undefined")p=m["endpoint"][0]["address"];try{var S;if(m["modifierExtension"]!==null&&m["modifierExtension"]!==undefined)S=m["modifierExtension"][0]["url"].split("/")[1];var v;if(sessionStorage["organizationId"]===S)v=sessionStorage["organizationName"];else{if(m["modifierExtension"]!==null&&m["modifierExtension"]!==undefined)v=m["modifierExtension"][0]["valueString"]}if(p!==null)this.RegionId=p.split("/")[2]+"/"+v}catch(e){if(p!==null)this.RegionId=p.split("/")[2]+"/"+"any"}finally{this.ImagingStudyFhirEntities[f]=m;var P=m["modifierExtension"].filter((e=>e["url"]==="Deleted")).pop();if(!o&&(P!==undefined&&parseInt(P["valueString"])===1)){this.ViewportPane.disabledStudyNotice.style.display="block";this.ViewportPane.ViewportPaneSection.style.height="calc(100% - 38px)"}}if(s===""&&!h||(s!==""&&s==="yes"||h)){this.ActionOpenStudy(f,o,this.ImagingStudyFhirEntities[f]);try{this.View.Platform.RebuildTagsMenu(this.View,null);const t=this.View.GetFhirEntities();const a=n.TagUtils.GetTags(t[0]);const r=n.TagUtils.SelectTagToMenu(t);const o=a.filter((e=>r.indexOf(e)<0));e.ClientViews.CommonView.TagController.CreateExtraTags(this.View,o,t)}catch(e){n.Utils.DebugConsoleLog(e)}this.SelectLastToolUsed()}else{n.Toaster.ShowToast("The application failed to open the study.",n.Colors.Orange,3)}}catch(e){if(r.IsDebugActive())console.error(e);n.Toaster.ShowToast("The application failed to open the study.",n.Colors.Orange,3)}}else{n.Toaster.ShowToast("The application could not find data for this study.",n.Colors.Orange,3)}}),(e=>{n.Loader.Hide()}))}ReopenStudy(t,a,r){var o="ImagingStudy?_id="+t+"&_include=ImagingStudy:endpoint&_include=ImagingStudy:subject&_include=ImagingStudy:location";n.Loader.Show("Reloading "+(a?1+a.length:1)+" studies opened...");this.getImagingStudyFhirResource(o,(t=>{n.Loader.Hide();try{var o=JSON.parse(t);var s=e.Frontend.FhirClient.FhirParser.ProcessBundle(o,"ImagingStudy");var l=s.map((e=>e["resourceType"]==="ImagingStudy"?e:null));if(l.length!==0)l=l.pop();var h=l["identifier"][0]["value"];var u=h.lastIndexOf(":");var d=h.substring(u+1,h.length);var c;if(l["endpoint"]!==null&&l["endpoint"]!=="undefined")c=l["endpoint"][0]["address"];try{var m;if(l["modifierExtension"]!==null&&l["modifierExtension"]!==undefined)m=l["modifierExtension"][0]["url"].split("/")[1];var g;if(sessionStorage["organizationId"]===m)g=sessionStorage["organizationName"];else{if(l["modifierExtension"]!==null&&l["modifierExtension"]!==undefined)g=l["modifierExtension"][0]["valueString"]}if(c!==null)this.RegionId=c.split("/")[2]+"/"+g}catch(e){if(c!==null)this.RegionId=c.split("/")[2]+"/"+"any"}finally{this.ImagingStudyFhirEntities[d]=l}var w=this.Downloader.StructureData[d];var f=new e.ClientViews.ImagingStudyView.StudyEntity;f.StudyGUID=d;var p=this.GetStudyWithSeriesAndImages(f);this.ThumbnailPane.CloseAllSubThumbnails(d);this.ThumbnailPane.UpdateThumbnailsInLine(d,f);this.ThumbnailPane.CreateTagsThumbnail(d);w.Download(p,true);let n=this.StudyViewerModel.Documents.StructureData[d].Study;let S=n.Series.IndexData;for(let e=0;e<S.length;e++){let t=this.ThumbnailPane.Thumbnails[d][e];if(!t.PseudoSeries){t.Element.setAttribute("data-totalImagesLoaded",w.GetImagesLoadedBySeries(d,S[e]).toString());t.Element.setAttribute("data-totalImages",n.Series.StructureData[S[e]].Images.IndexData.length.toString());t.StartProgressRing()}}if(a){if(r<a.length-1)this.ReopenStudy(a[r],a,++r)}}catch(e){n.Utils.DebugConsoleLog(e);n.Toaster.ShowToast("The application failed to open the study.",n.Colors.Orange,3)}}),(e=>{n.Loader.Hide()}))}SelectLastToolUsed(){var e=n.Utils.StrToBool(this.View.Platform.GetSetting("LastToolUsedIsActivated"));if(e){var t=new Array;var a=new Array;this.View.Plugins.forEach((e=>{t.push(...e.GetRememberToolsPerName());a.push(...e.GetContextMenuOptions())}));var r=this.View.Platform.GetSetting("LastToolUsed");var o;var s;for(var l=0;l<t.length;l++){var h=t[l].split("-");o=h.length===1?h[0]:h[1];s=h.length===1?h[0]:h[0];if(o===r)break}if(o&&s){var u=a.filter((e=>e.Name===s));if(u.length===1)u.pop().Action()}}}StopDownloadStudies(){var e=this.Downloader;for(var t=0;t<e.IndexData.length;t++){var n=e.IndexData[t];this.Downloader.StructureData[n].StopWorker()}}GetSeriesNumberWithoutPseudoSeries(e){var t=this.StudyViewerModel.Documents.StructureData[e].Study.Series;var n=0;for(var a=0;a<t.IndexData.length;a++){var r=t.IndexData[a];var o=t.StructureData[r];if(o["pseudoserie"]===undefined)n++}return n}ActivateFullScreen(){if(!this.FullScreen){a.ToggleFullScreen(false);this.FullScreen=true;this.View.Platform.Toolbar.Element.style.display="none";this.View.Platform.Toolbar.Element.parentElement.parentElement.style.display="none";this.ThumbnailPane.Hide();const n=this.layoutManager.GetLayoutPanel();n.Children()[0].SetVisible(false);if(this.View.Platform.GetActiveMessageHeight()>0)this.View.Platform.MessageBar.style.display="none";this.ViewportPane.RenderViewportPane();for(var e=0;e<this.View.Plugins.length;e++){this.View.Plugins[e].OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight,true,false)}this.collapseButton=document.createElement("img");this.collapseButton.id="closeCollapse";this.collapseButton.style.width="32px";this.collapseButton.style.height="32px";this.collapseButton.style.position="absolute";this.collapseButton.style.cursor="pointer";if(a.IsPortrait()){this.collapseButton.style.top="2px";this.collapseButton.style.right="0"}else{this.collapseButton.style.top="2px";this.collapseButton.style.right="0"}this.collapseButton.src=t.ResourceBag.Icons8Collapse32Png;this.collapseButton.addEventListener("click",(e=>{this.DeactivateFullScreen()}));this.ViewportPane.ViewportPaneSection.appendChild(this.collapseButton)}}DeactivateFullScreen(){a.ToggleFullScreen(true);this.FullScreen=false;this.View.Platform.Toolbar.Element.style.display="block";this.View.Platform.Toolbar.Element.parentElement.parentElement.style.display="flex";this.ThumbnailPane.Show();const e=this.layoutManager.GetLayoutPanel();e.Children()[0].SetVisible(true);if(this.View.Platform.GetActiveMessageHeight()>0)this.View.Platform.MessageBar.style.display="block";this.ViewportPane.RenderViewportPane();this.View.Plugins.forEach((e=>{e.OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight,true,false)}));if(this.collapseButton!==null){this.collapseButton.style.display="none";a.RemoveItem(this.collapseButton)}this.ExitFullScreen=true}Show(){sessionStorage["pageView"]="viewer";this.View.Platform.Toolbar.Show();this.ViewportPane.Show();this.ThumbnailPane.Show();this.View.Platform.Toolbar.OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight)}Hide(){this.View.Platform.Toolbar.Hide();this.ViewportPane.Hide();this.ThumbnailPane.Hide()}GetSelectViewport(e){if(e.ViewportsArray===undefined)return null;for(var t=0;t<e.ViewportsArray.length;t++){if(e.ViewportsArray[t].SelectViewport)return e.ViewportsArray[t]}for(var t=0;t<e.ViewportsArray.length;t++){if(e.ViewportsArray[t].ViewportFrameElement.className.includes("SelectedViewport")){e.ViewportsArray[t].SelectViewport=true;return e.ViewportsArray[t]}}return null}UnselectViewports(e){var t=e.ViewportsArray;for(var r=0;r<t.length;r++){t[r].SelectViewport=false;var o=t[r].ViewportFrameElement;o.style.borderColor=n.Colors.BgDarker;a.RemoveClass(o,"SelectedViewport")}}SetSelectViewport(e,t){var r=t!==null&&t!==void 0?t:this.ViewportPane;var o=r.ViewportsArray[e.IndexNumber];this.UnselectViewports(r);o.SelectViewport=true;o.ViewportFrameElement.style.borderColor=n.Colors.Emerald;a.AddClass(o.ViewportFrameElement,"SelectedViewport")}SetCursorForViewports(e,t){if(e&&e.ViewportsArray){try{var n=e.ViewportsArray;for(var a=0;a<n.length;a++){var r=n[a];r.ViewportElement.style.cursor=t}}catch(e){}}}ActivateVisualizationMode(e){var t;this.ViewportPane.HorizontalViewports=+this.View.Platform.GetSetting("HorizontalViewport");this.ViewportPane.VerticalViewports=+this.View.Platform.GetSetting("VerticalViewport");if(e===c.Stack){this.View.Platform.SetSetting(40,"chkBoxRecallLastDisplayValue",c[c.Stack]);this.View.SetLayoutMode(c.Stack);this.View.Platform.Toolbar.DeselectAllButtons();this.View.Platform.Toolbar.DeselectButton("toolbarviewer.1","tileMode");this.View.Platform.Toolbar.SelectButton("toolbarviewer.1","stackMode","fixedSelected");this.LayoutMode=c.Stack;this.ViewportPane.ChangeViewportsNumber();for(t=0;t<this.View.Plugins.length;t++){this.View.Plugins[t].OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight,true,true)}}else{this.View.Platform.SetSetting(40,"chkBoxRecallLastDisplayValue",c[c.Tile]);this.View.SetLayoutMode(c.Tile);this.View.Platform.Toolbar.DeselectAllButtons();this.View.Platform.Toolbar.DeselectButton("toolbarviewer.1","stackMode");this.View.Platform.Toolbar.SelectButton("toolbarviewer.1","tileMode","fixedSelected");this.LayoutMode=c.Tile;this.ViewportPane.ChangeViewportsNumber();for(t=0;t<this.View.Plugins.length;t++){this.View.Plugins[t].OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight,true,true)}}let n=this.ViewportPane.ViewportsArray[0];this.SetSelectViewport(n,this.ViewportPane);for(t=0;t<this.View.Plugins.length;t++){try{this.View.Plugins[t].ValidateViewportVoid()}catch(e){}}this.SelectDefaultTool();this.SelectLastToolUsed()}ResizeViewports(){this.ViewportPane.RenderViewportPane();this.ViewportPane.ChangeViewportsNumber();for(var e=0;e<this.View.Plugins.length;e++)this.View.Plugins[e].OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight,true);this.ThumbnailPane.UpdateAllThumnailsPane()}ChangeThumbnailPosition(){const e=this.View.Platform.GetSetting("selectGeneralThumbnailPosition")||"left";const t={top:u.TOP,left:u.LEFT,right:u.RIGHT,bottom:u.BOTTOM};const n=t[e]||t["left"];const a=this.layoutManager.GetLayoutPanel();a.Move(n);this.ThumbnailPane.ChangeOrientationPane(e)}GetLayoutOrientation(){return this.layoutManager.GetLayoutPanel().GetOrientation()}GetTotalViewportsAvailables(){let e=this.ViewportPane.HorizontalViewports;let t=this.ViewportPane.VerticalViewports;return e*t}GetViewportBySerieAndStudy(e,t){var n;var a=this.ViewportPane.ViewportsArray;for(var r=0;r<a.length;r++){if(a[r].Context.StudyGuid===e&&a[r].Context.SeriesGuid===t){n=a[r];break}}return n}SelectTool(e,t){this.ToolSelect=e;this.ToolSelectButtonName=t;this.MultipleSelectViewports=false;this.ActiveContextMenu=true;var r=document.getElementsByClassName("magnifierelement")[0];if(r!==undefined){r.style.visibility="hidden";r.style.display=""}for(var o=0;o<this.View.Plugins.length;o++){this.View.Plugins[o].SelectAnyTool()}this.View.Platform.Toolbar.RemoveClassFromAllButtons("toolbarviewer.2","optionInMenuPressed","toolbarDrop");this.View.Platform.Toolbar.DeselectAllButtons();var s=this.View.Platform.Toolbar.GetButton(t);if(s!==null){n.Toolbar.HideAllMenus();a.AddClass(s.Element,"selected")}var l=this.View.Platform.Toolbar.GetButtonParent(t);if(l!==null)this.View.Platform.Toolbar.SelectButton(null,l.Name,"optionInMenuPressed");if(e.match(/Pointer/))this.SetCursorForViewports(this.ViewportPane,"default");var h=new Array;var u=false;this.View.Plugins.forEach((e=>{h.push(...e.GetRememberToolsPerName())}));h.forEach((t=>{var n=t.split("-");var a=n.length===1?n[0]:n[1];if(a===e)u=true}));if(u)this.View.Platform.SetSetting(40,"LastToolUsed",e)}DownloadReport(e){var t;if(this.isDownloadingReport){n.Toaster.ShowToast("A current download is in progress.",n.Colors.Orange,3);return}const r=this.GetSelectViewport(this.ViewportPane);const o=this.ImagingStudyFhirEntities[r.Context.StudyGuid];const s=r.Context.ImageEntity.ImageGUID;const{formattedDate:l,author:h,seriesDescription:u}=this.getReportData(o,s);const d={hideLogo:true,header:{"Study Date":l,Patient:((t=o.subject)===null||t===void 0?void 0:t.name)?o.subject.name.length&&o.subject.name[0]&&o.subject.name[0].text:""},groups:[{cellsPerRow:1,fields:e}]};if(o.referrer)d.header["Author"]=h;if(u)d.header["Series"]=u;const c=this;const m=JSON.stringify(d);const g=new XMLHttpRequest;g.open("POST",n.PlatformContext.PlatformUri+"/reporting",true);g.setRequestHeader("Authorization","Bearer "+sessionStorage["token"]);g.responseType="blob";g.onload=function(e){c.isDownloadingReport=false;if(this.status===200)a.CreateDownloaderAnchor(this.response,"radiology-image.pdf")};g.send(m);this.isDownloadingReport=true;n.Toolbar.HideAllMenus();n.Toaster.ShowToast("Download started.",n.Colors.Emerald,3)}DownloadReportCurrent(){const e=this.GetSelectViewport(this.ViewportPane);const t=e.Context.ImageEntity.ImageUri;const n=[{type:"image",value:t,resolution:"high"}];this.DownloadReport(n)}DownloadReportSeries(){const e=this.GetSelectViewport(this.ViewportPane);const t=e.Context.StudyGuid;const n=e.Context.ImageEntity.ImageGUID;const a=this.getSerieFromImage(t,n);const r=this.getImagesFromSeries(t,a);const o=r.map((e=>({type:"image",value:e,resolution:"high"})));this.DownloadReport(o)}DownloadReportStudy(){const e=this.GetSelectViewport(this.ViewportPane);const t=e.Context.StudyGuid;const n=this.getImagesFromStudy(t);const a=n.map((e=>({type:"image",value:e,resolution:"high"})));this.DownloadReport(a)}DeleteImage(){n.Toolbar.HideAllMenus();const e=this.GetSelectViewport(this.ViewportPane);if(!e){n.Toaster.ShowToast(this.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","deleteActionMessageNoSelectedImage"),n.Colors.Orange,3);return}const{ImageGUID:t}=e.Context.ImageEntity;if(this.isKeyImage(t)){n.Toaster.ShowToast(this.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","deleteActionMessageNoKeyImage"),n.Colors.Orange,3);return}if(this.isLastImage(t)){n.Toaster.ShowToast(this.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","deleteActionMessageNoLastImage"),n.Colors.Orange,3);return}const a=new n.HipaaWarningBox("deleteRecoverMessage",(()=>{this.ContinueDeleteImage()}),(()=>{}));a.Show()}ContinueDeleteImage(){const t=this.GetSelectViewport(this.ViewportPane);const a="DELETE";const r=this.ImagingStudyFhirEntities[t.Context.StudyGuid];const o=n.PlatformContext.PlatformUri+"/fhir/ImagingStudy/"+r.id+"/$delete-instance";const s=new e.Frontend.FhirClient.FhirCall(o,a);const l={resourceType:"Parameters",id:r.id,parameter:[{id:r.id,name:r.resourceType,resource:{resourceType:r.resourceType,serie:t.Context.SeriesGuid,instance:t.Context.ImageEntity.ImageGUID}}]};s.BodyData=JSON.stringify(l);s.FuncOk=(e,t)=>{n.Loader.Hide();n.Toaster.ShowToast(this.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","deleteActionMessageImageDeleted"),n.Colors.Emerald,1);n.Toolbar.HideAllMenus();this.View.Platform.CurrentView.Refresh()};s.FuncError=e=>{n.Loader.Hide();n.Toaster.ShowToast(this.View.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","deleteActionMessageErrorDeleting"),n.Colors.Orange,3)};n.Loader.Show();n.Toolbar.HideAllMenus();s.Send()}getImagingStudyFhirResource(t,a,r){var o=n.PlatformContext.PlatformUri+"/fhir/"+t;var s=new e.Frontend.FhirClient.FhirCall(o,"GET");s.FuncOk=e=>{a(e)};s.FuncError=(e,t)=>{if(e===403){if(t.AjaxRequest.response&&t.AjaxRequest.response.indexOf("|draft")>-1)a(t.AjaxRequest.response);else r(e)}else{r(e)}};s.Send()}setTitleForPatient(e){try{var t=e["subject"].identifier[0].value;var n=e["subject"]["name"][0]["text"];document.title=n||t||"ImagingStudy"}catch(e){document.title="ImagingStudy"}}isKeyImage(e){var t,n,a;const{Documents:r}=this.StudyViewerModel;let o=false;if(r.StructureData){for(const s of Object.keys(r.StructureData)){const l=r.StructureData[s];if((n=(t=l===null||l===void 0?void 0:l.Study)===null||t===void 0?void 0:t.Series)===null||n===void 0?void 0:n.StructureData){for(const t of Object.keys(l.Study.Series.StructureData)){const n=l.Study.Series.StructureData[t];if((n===null||n===void 0?void 0:n.pseudoserie)&&((a=n===null||n===void 0?void 0:n.KeyImages)===null||a===void 0?void 0:a.StructureData)){for(const t of Object.keys(n.KeyImages.StructureData)){const a=n.KeyImages.StructureData[t];if(a.Images.some((t=>t.ImageGUID===e))){o=true;return o}}}}}}}return o}isLastImage(e){var t,n;const{Documents:a}=this.StudyViewerModel;let r=0;if(a.StructureData){for(const e of Object.keys(a.StructureData)){const o=a.StructureData[e];if((n=(t=o===null||o===void 0?void 0:o.Study)===null||t===void 0?void 0:t.Series)===null||n===void 0?void 0:n.StructureData){for(const e of Object.keys(o.Study.Series.StructureData)){const t=o.Study.Series.StructureData[e];r+=+t.ImageCount}}}}return r===1}getReportData(e,t){const getFormattedDate=e=>{if(r.IsValidDate(e)){const t=o.GetDateFromString(e,"YYYY-MM-DD");const n=this.View.Platform.GetSetting("dateFormat")||"YYYY-MM-DD";return o.GetFormattedDate(t,n)}return""};const getAuthor=e=>{if(e){const{name:t,display:n}=e;if(t)return t.length&&t[0]&&t[0].text||"";else if(n)return n}return""};const getSeriesDescription=()=>{var n;let a="";if((n=e===null||e===void 0?void 0:e.series)===null||n===void 0?void 0:n.length){e.series.forEach((e=>{if(e.instance.some((e=>e.uid===t))){if(e.description)a=e.description}}))}return a};return{formattedDate:getFormattedDate(e.started),author:getAuthor(e.referrer),seriesDescription:getSeriesDescription()}}getSerieFromImage(e,t){let n="";const a=this.StudyViewerModel.Documents.StructureData[e].Study.Series.StructureData;Object.keys(a).forEach((e=>{var r,o,s;if((s=(o=(r=a[e])===null||r===void 0?void 0:r.Images)===null||o===void 0?void 0:o.IndexData)===null||s===void 0?void 0:s.length){a[e].Images.IndexData.forEach((r=>{if(a[e].Images.StructureData[r].ImageGUID===t)n=e}))}}));return n}getImagesFromSeries(e,t){var n,a,r;const o=[];const s=this.StudyViewerModel.Documents.StructureData[e].Study.Series.StructureData;if((r=(a=(n=s[t])===null||n===void 0?void 0:n.Images)===null||a===void 0?void 0:a.IndexData)===null||r===void 0?void 0:r.length){s[t].Images.IndexData.forEach((e=>{var n,a,r;if((r=(a=(n=s[t])===null||n===void 0?void 0:n.Images)===null||a===void 0?void 0:a.StructureData[e])===null||r===void 0?void 0:r.ImageUri)o.push(s[t].Images.StructureData[e].ImageUri)}))}return o}getImagesFromStudy(e){let t=[];const n=this.StudyViewerModel.Documents.StructureData[e].Study.Series.StructureData;Object.keys(n).forEach((n=>{const a=this.getImagesFromSeries(e,n);t=t.concat(a)}));return t}}t.ViewerPage=ViewerPage})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient.DOMUtils;const{div:a,button:r}=n;class ViewerToolbar{constructor(o){let s;const l=[["thumbnails",t.ResourceBag.Icons8Layout32Png,e=>{var t=[];this.View.Plugins.forEach((e=>{var n=e.GetButtonsToMenu(["Cine","Link","3DCursor"],"thumbnails");t.push({dictionary:n.dictionary,buttons:n.buttons})}));if(t.length>0){t.forEach((e=>{if(e.buttons.length>0)this.View.Platform.Toolbar.AppendMenuButtonItems(e.buttons,e.dictionary,"toolsItems",true,"thumbnails",true)}))}}],["fullScreen",t.ResourceBag.Icons8Expand32Png,e=>{this.View.ViewerPage.ActivateFullScreen();this.View.ViewerPage.SelectDefaultTool()}],["stackMode",t.ResourceBag.Icons8Sheets32Png,n=>{for(s=0;s<this.View.ViewerPage.View.Plugins.length;s++){this.View.ViewerPage.View.Plugins[s].HoldSaveSpecialAnnotationsOnCourse(this.View.ViewerPage.GetSelectViewport(this.View.ViewerPage.ViewportPane))}this.View.ViewerPage.ActivateVisualizationMode(t.LayoutMode.Stack);e.Frontend.WebClient.Toolbar.UnBlockAndBlockOneButton(this.View.Platform.Toolbar.Groups,false,"cineTool")}],["tileMode",t.ResourceBag.Icons8Thumbnails32Png,n=>{for(s=0;s<this.View.ViewerPage.View.Plugins.length;s++){this.View.ViewerPage.View.Plugins[s].HoldSaveSpecialAnnotationsOnCourse(this.View.ViewerPage.GetSelectViewport(this.View.ViewerPage.ViewportPane))}this.View.ViewerPage.ActivateVisualizationMode(t.LayoutMode.Tile);e.Frontend.WebClient.Toolbar.UnBlockAndBlockOneButton(this.View.Platform.Toolbar.Groups,true,"cineTool")}],"titleHViewportPresets",["hviewport",[1,2,3,4],(e,t)=>{try{if(this.View.ViewerPage.View.Platform.GetSetting("ViewportsLayout")==="Auto")this.View.ViewerPage.ChangeLayoutFromToolbar=true;if(this.View.ViewerPage.View.Platform.GetSetting("ViewportsLayout")==="Manual")this.View.ViewerPage.View.Platform.SetSetting(40,"HorizontalViewport",t);for(s=0;s<this.View.ViewerPage.View.Plugins.length;s++){this.View.ViewerPage.View.Plugins[s].HoldSaveSpecialAnnotationsOnCourse(this.View.ViewerPage.GetSelectViewport(this.View.ViewerPage.ViewportPane))}this.View.ViewerPage.ViewportPane.HorizontalViewports=parseInt(t,10);this.View.ViewerPage.ViewportPane.ChangeViewportsNumber();for(s=0;s<this.View.ViewerPage.View.Plugins.length;s++){this.View.ViewerPage.View.Plugins[s].OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight,true,true)}let e=this.View.ViewerPage.ViewportPane.ViewportsArray[0];this.View.ViewerPage.SetSelectViewport(e,this.View.ViewerPage.ViewportPane)}catch(e){}}],"titleVViewportPresets",["vviewport",[1,2,3,4],(e,t)=>{try{if(this.View.ViewerPage.View.Platform.GetSetting("ViewportsLayout")==="Auto")this.View.ViewerPage.View.ViewerPage.ChangeLayoutFromToolbar=true;if(this.View.ViewerPage.View.Platform.GetSetting("ViewportsLayout")==="Manual")this.View.ViewerPage.View.Platform.SetSetting(40,"VerticalViewport",t);for(s=0;s<this.View.ViewerPage.View.Plugins.length;s++){this.View.ViewerPage.View.Plugins[s].HoldSaveSpecialAnnotationsOnCourse(this.View.ViewerPage.GetSelectViewport(this.View.ViewerPage.ViewportPane))}this.View.ViewerPage.ViewportPane.VerticalViewports=parseInt(t);this.View.ViewerPage.ViewportPane.ChangeViewportsNumber();for(s=0;s<this.View.ViewerPage.View.Plugins.length;s++){this.View.ViewerPage.View.Plugins[s].OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight,true,true)}let e=this.View.ViewerPage.ViewportPane.ViewportsArray[0];this.View.ViewerPage.SetSelectViewport(e,this.View.ViewerPage.ViewportPane)}catch(e){}}],"toolsItems"];const h=[["relatedStudiesTool",t.ResourceBag.Icons8TreeStructure32Png,e=>{this.View.ViewerPage.RelatedStudiesController=new t.WorklistRelatedController(this.View.Platform.GetMainContainer(),this.View.Platform,this.View.ViewerPage);this.View.ViewerPage.RelatedStudiesController.Pane.Toggle();for(s=0;s<this.View.ViewerPage.View.Plugins.length;s++){this.View.ViewerPage.View.Plugins[s].SelectAnyTool()}this.View.ViewerPage.SelectDefaultTool()}]];const u=[["pointerTool",t.ResourceBag.Icons8Cursor32Png,e=>{this.View.ViewerPage.SetCursorForViewports(this.View.ViewerPage.ViewportPane,"default");this.View.ViewerPage.View.Plugins.forEach((e=>{e.EscapeAction()}));this.View.ViewerPage.SelectTool("Pointer","pointerTool")}]];const d=o.Platform.Toolbar.CreateButtonsAndMenus([l,h,u],"ViewerLanguage","toolbarviewer.1","workstation");o.Platform.Toolbar.Groups.push(d);d.Create(o.Platform.Toolbar.Element);o.MessageBar=a({className:"MessageBar",style:{width:`${o.Platform.Toolbar.Element.parentElement.parentElement.clientWidth}px`,height:`${o.Platform.Toolbar.Element.parentElement.parentElement.clientHeight}px`}});const c=a({className:"InnerMessageBar",style:{height:`${parseInt(o.MessageBar.style.height)-20}px`},children:[o.TextBar=a({className:"floatLeft"}),o.ButtonsContainer=a({className:"floatRight",children:[o.ButtonBar=r({innerHTML:o.Platform.LanguageManager.GetValuesFromDict("ViewerLanguage","cancelText")})]})]});const m=new Hammer(o.ButtonBar);m.on("tap",(e=>{o.ActionClickBar()}));o.MessageBar.appendChild(c);o.Platform.Toolbar.Element.parentElement.parentElement.appendChild(o.MessageBar);let g;if(o.ViewerPage.LayoutMode===t.LayoutMode.Stack){g=o.Platform.Toolbar.GetButton("stackMode");if(g!==null)n.AddClass(g.Element,"selected fixedSelected")}else{g=o.Platform.Toolbar.GetButton("tileMode");if(g!==null)n.AddClass(g.Element,"selected fixedSelected")}const w=o.Platform.Toolbar.GetButton("titleHViewportPresets");if(w!==null)w.Element.style.marginBottom="-8px";const f=o.Platform.Toolbar.GetButton("titleVViewportPresets");if(f!==null)f.Element.style.marginBottom="-8px";this.View=o}}t.ViewerToolbar=ViewerToolbar})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient.DOMUtils;var a=e.Frontend.WebClient;const r=n.div;const o=n.anchor;class TransformDataSTL{}t.TransformDataSTL=TransformDataSTL;class PercentModelSTL{constructor(e,t,n){this.Item=e;this.Percent=t;this.Weight=n}}t.PercentModelSTL=PercentModelSTL;class ModelsData3d{}t.ModelsData3d=ModelsData3d;class Viewport{constructor(e,n,a,r,o){var s,l;this.RendererPlugins={};this.EnableActionsOnViewport=true;this.PauseMoveForClickEvent=false;this.Annotations={};this.MouseRightDragAcum=0;this.MouseRightDragDown=false;this.Id=n;this.WorkspaceElement=e;this.Action=a;this.ViewerPage=r;this.ViewportPane=o;this.SelectViewport=false;this.RendererPlugins={};this.Annotations={};this.SetAnnotationsInViewport=false;this.TemporalAnnotations=new Array;this.wheelDeltaAcum=0;this.wheelDeltaInit=0;this.WheelFactorSpeed=(l=(s=this.ViewerPage)===null||s===void 0?void 0:s.GeneralWheelFactorSpeed)!==null&&l!==void 0?l:3;this.Models3D=new Array;this.StopDownloadOfElements=false;this.CreateWithoutEvents=false;this.AnnotationManager=new t.AnnotationManager(this)}ExecuteActionWheel(e,t,n=0){if(this.wheelDeltaAcum===0){this.wheelDeltaInit=Math.abs(e);this.wheelDeltaAcum=this.wheelDeltaInit}else{this.wheelDeltaAcum+=Math.abs(e)}if(this.wheelDeltaAcum>=this.wheelDeltaInit*(this.WheelFactorSpeed+n)){t();this.wheelDeltaAcum=0}}Create(r,o){var s=o===undefined?document.createElement("div"):o;this.IndexNumber=r;s.setAttribute("id",this.Id);s.setAttribute("data-rowTemp",(r>>2).toString());s.setAttribute("data-columnTemp",(r&3).toString());s.setAttribute("data-indexTemp",r.toString());n.AddClass(s,"viewportElement");this.ViewportFrameElement=s;if(o===undefined)this.WorkspaceElement.appendChild(this.ViewportFrameElement);if(this.ContentElement!==undefined&&this.ContentElement!==null)n.RemoveItem(this.ContentElement);this.ContentElement=document.createElement("div");a.DOMUtils.AddClass(this.ContentElement,"subViewportElement");if(this.ViewportElement===undefined||this.ViewportElement===null)this.ViewportElement=this.ContentElement;this.CreateViewportLoader();this.ViewportFrameElement.appendChild(this.ContentElement);if(!this.CreateWithoutEvents){this.ViewportElement.addEventListener("click",(e=>{this.ViewerPage.View.ShowToolbarButtonsBySupportViewport(this.ViewerPage.View.Platform.Toolbar,this);if(!this.ViewerPage.MultipleSelectViewports&&!this.ViewportPane.OneByOneContext.IsActive){this.ViewerPage.UnselectViewports(this.ViewportPane);this.SelectViewport=true;this.ViewportFrameElement.style.borderColor=a.Colors.Emerald;n.AddClass(this.ViewportFrameElement,"SelectedViewport");if(this.ViewportFrameElement.getAttribute("data-seriesGuid")===""&&this.ViewportFrameElement.getAttribute("data-seriesGuid")==="")a.Toolbar.UnBlockAndBlockButtons(this.ViewerPage.View.Platform.Toolbar.Groups,true,["back","home","refresh","tags","shareTool","thumbnails","relatedStudiesTool","pointerTool"],["main.1","common.1","toolbarviewer.1"])}for(let e=0;e<this.ViewerPage.View.Plugins.length;e++){try{this.ViewerPage.View.Plugins[e].ValidateViewportVoid()}catch(e){}}}));var l=new Hammer.Manager(this.ViewportElement);l.add(new Hammer.Tap({event:"doubletap",taps:2}));l.add(new Hammer.Tap({event:"singletap"}));l.get("doubletap").recognizeWith("singletap");l.get("singletap").requireFailure("doubletap");l.on("singletap doubletap",(r=>{if(document.getElementsByClassName("contextMenuContainer")[0]!==undefined)n.HideElement(document.getElementsByClassName("contextMenuContainer")[0]);this.IsAnyAnnotationSelected=false;if(r.type==="singletap")this.PauseMoveForClickEvent=true;for(var o=0;o<this.ViewerPage.View.Plugins.length;o++){this.ViewerPage.View.Plugins[o].OnEvent(r.type,this.ViewerPage.ToolSelect,this,r)}if(r.type==="singletap")this.PauseMoveForClickEvent=false;if(!this.IsAnyAnnotationSelected){this.AnnotationManager.UnselectAllAnnotations();this.AnnotationManager.DrawAnnotations()}if(r.type==="singletap"){this.Action(r)}else if(r.type==="doubletap"){if(this.ViewerPage.HasBlockedDoubleClick)return;var s=this.ViewerPage.View.Platform.GetSetting("selectMouseBehLeftDoubleClick");switch(s){case"stackMode":this.ViewerPage.ActivateVisualizationMode(t.LayoutMode.Stack);e.Frontend.WebClient.Toolbar.UnBlockAndBlockOneButton(this.ViewerPage.View.Platform.Toolbar.Groups,false,"cineTool");break;case"tileMode":this.ViewerPage.ActivateVisualizationMode(t.LayoutMode.Tile);e.Frontend.WebClient.Toolbar.UnBlockAndBlockOneButton(this.ViewerPage.View.Platform.Toolbar.Groups,true,"cineTool");break;case"fullScreen":this.ViewerPage.ActivateFullScreen();this.ViewerPage.SelectDefaultTool();break;case"pointerTool":this.ViewerPage.SelectTool("Pointer","pointerTool");break}}if(!this.ViewerPage.MultipleSelectViewports&&!this.ViewportPane.OneByOneContext.IsActive){this.ViewerPage.UnselectViewports(this.ViewportPane);this.SelectViewport=true;this.ViewportFrameElement.style.borderColor=a.Colors.Emerald;n.AddClass(this.ViewportFrameElement,"SelectedViewport");if(this.ViewportFrameElement.getAttribute("data-seriesGuid")===""&&this.ViewportFrameElement.getAttribute("data-seriesGuid")==="")a.Toolbar.UnBlockAndBlockButtons(this.ViewerPage.View.Platform.Toolbar.Groups,true,["back","home","refresh","tags","shareTool","thumbnails","relatedStudiesTool","pointerTool"],["main.1","common.1","toolbarviewer.1"])}}));this.ContentElement.addEventListener("wheel",(e=>{this.ExecuteActionWheel(e.wheelDelta,(()=>{this.ViewerPage.View.Plugins.forEach((t=>{t.OnEvent("wheel",this.ViewerPage.ToolSelect,this,e)}));if(!this.ViewerPage.MultipleSelectViewports){this.ViewerPage.UnselectViewports(this.ViewportPane);this.ViewerPage.SetSelectViewport(this,this.ViewportPane);this.ViewportFrameElement.style.borderColor=a.Colors.Emerald;n.AddClass(this.ViewportFrameElement,"SelectedViewport")}}))}));if(r===0&&o===undefined){var keyDownViewport=e=>{try{const r=new URLSearchParams(window.location.search);if(r.get("view")==="Study"){if(e.code==="Tab")e.preventDefault()}var t=this.ViewerPage.View.Platform.CurrentView;var n=t.ViewerPage.GetSelectViewport(t.ViewerPage.ViewportPane);if(n||a.DOMUtils.HasClass(e.target,"viewportElement")||a.DOMUtils.HasClass(e.target,"subViewportElement")){t.Plugins.forEach((a=>{if(n!==null)a.OnEvent("keydown",t.ViewerPage.ToolSelect,n,e)}))}}catch(e){a.Utils.DebugConsoleLog(e)}};var keyUpViewport=e=>{try{const t=new URLSearchParams(window.location.search);if(t.get("view")==="Study"){if(e.code==="Tab")e.preventDefault()}}catch(e){a.Utils.DebugConsoleLog(e)}};var h=this.constructor.name+"_";this.ViewerPage.View.Platform.RegisterGlobalEvents(h+"keydown","keydown",{register:true,view:this.ViewerPage.View.Platform.CurrentView.ViewName,event:keyDownViewport,name:"keydown"},keyDownViewport);this.ViewerPage.View.Platform.RegisterGlobalEvents(h+"keyup","keyup",{register:true,view:this.ViewerPage.View.Platform.CurrentView.ViewName,event:keyUpViewport,name:"keyup"},keyUpViewport)}var u;document.addEventListener("contextmenu",(e=>{e.preventDefault()}));this.ViewportElement.addEventListener("mouseup",(e=>{if(e.button===2||e.buttons===2){this.ViewerPage.View.Plugins.forEach((t=>{u=[];t.GetContextMenuOptions().forEach((e=>{u.push(e)}));t.OnEvent("mouseup",this.ViewerPage.ToolSelect,this,e)}))}}));this.ViewportElement.addEventListener("mousedown",(e=>{this.ViewerPage.View.Plugins.forEach((t=>{t.OnEvent("mousedown",this.ViewerPage.ToolSelect,this,e)}));if(!this.ViewerPage.MultipleSelectViewports){this.ViewerPage.UnselectViewports(this.ViewportPane);this.ViewerPage.SetSelectViewport(this,this.ViewportPane);this.ViewportFrameElement.style.borderColor=a.Colors.Emerald;n.AddClass(this.ViewportFrameElement,"SelectedViewport")}this.MouseRightDragAcum=0}));var d;this.ViewportElement.addEventListener("mousemove",(e=>{var t=n.GetOffset(e,"x");var r=n.GetOffset(e,"y");this.PointMove=new a.Point(t,r);this.ViewerPage.View.Plugins.forEach((t=>{t.OnEvent("mousemove",this.ViewerPage.ToolSelect,this,e)}));var o=this.AnnotationManager.GetAllAnnotationsNearToPoint(t,r);if(o!==null){o.ShowSnaps=true;d=o;this.AnnotationManager.DrawAnnotations()}else{if(d!==undefined){d.ShowSnaps=false;this.AnnotationManager.DrawAnnotations();d=undefined}}if(e.button===2||e.buttons===2)this.MouseRightDragAcum++}));this.ViewportElement.addEventListener("mouseout",(e=>{this.PointMove=null;for(var t=0;t<this.ViewerPage.View.Plugins.length;t++){this.ViewerPage.View.Plugins[t].OnEvent("mouseout",this.ViewerPage.ToolSelect,this,e)}if(e.button===2||e.buttons===2){this.MouseRightDragDown=false;this.MouseRightDragAcum=0}}));l=new Hammer(this.ViewportElement);l.get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0,pointers:0});l.get("swipe").set({direction:Hammer.DIRECTION_ALL});l.on("panleft panright panup pandown panstart panmove panend press pressup swipeleft swiperight swipeup swipedown",(e=>{for(var t=0;t<this.ViewerPage.View.Plugins.length;t++){this.ViewerPage.View.Plugins[t].OnEvent(e.type,this.ViewerPage.ToolSelect,this,e)}if(!this.ViewerPage.MultipleSelectViewports){this.ViewerPage.UnselectViewports(this.ViewportPane);this.ViewerPage.SetSelectViewport(this,this.ViewportPane);this.ViewportFrameElement.style.borderColor=a.Colors.Emerald;n.AddClass(this.ViewportFrameElement,"SelectedViewport")}}));var c=new Hammer.Manager(this.ViewportElement);var m=new Hammer.Pinch({threshold:0});var g=new Hammer.Rotate({threshold:0});m.recognizeWith(g);c.add([m,g]);c.on("pinch pinchstart pinchmove pinchend rotate rotatestart rotatemove rotateend",(e=>{for(var t=0;t<this.ViewerPage.View.Plugins.length;t++){this.ViewerPage.View.Plugins[t].OnEvent(e.type,this.ViewerPage.ToolSelect,this,e)}}))}}ReCreateViewport(e){}CreateViewportLoader(){this.DivLoad=document.createElement("div");this.DivLoad.innerHTML=e.Frontend.WebClient.ResourceBag.RingSvg;this.DivLoad.style.height="98px";this.DivLoad.style.width="98px";this.DivLoad.style.margin="auto";this.DivLoad.style.position="absolute";this.DivLoad.style.top="0";this.DivLoad.style.left="0";this.DivLoad.style.right="0";this.DivLoad.style.bottom="0";this.DivLoad.style.display="none";this.ContentElement.appendChild(this.DivLoad)}AdminLoaderModels(t){if(t){var n=document.createElement("canvas");n.width=80;n.height=60;var r=document.createElement("div");r.style.width="80px";r.style.height="60px";r.appendChild(n);this.progressRing=new a.ProgressRing(n);this.progressRing.ShowWatch();this.DivLoad.innerHTML="";this.DivLoad.appendChild(r)}else{this.DivLoad.innerHTML=e.Frontend.WebClient.ResourceBag.RingSvg}}RemoveViewportLoader(){this.DivLoad.style.display="none"}CreateContextMenu(e,s){if(e.length===0){var l=new Array;s.preventDefault();this.ViewerPage.View.Plugins.forEach((e=>{e.GetContextMenuOptions().forEach((e=>{l.push(e)}))}));var h=this.ViewerPage.View.Platform.LanguageManager;var u=new t.ContextMenuOption("stackMode",h.GetValuesFromDict("ViewerLanguage","stackMode"),"stackMode");u.Action=e=>{this.ViewerPage.ActivateVisualizationMode(t.LayoutMode.Stack)};var d=new t.ContextMenuOption("tileMode",h.GetValuesFromDict("ViewerLanguage","tileMode"),"tileMode");d.Action=e=>{this.ViewerPage.ActivateVisualizationMode(t.LayoutMode.Tile)};var c=new t.ContextMenuOption("fullScreen",h.GetValuesFromDict("ViewerLanguage","fullScreen"),"fullScreen");c.Action=e=>{this.ViewerPage.ActivateFullScreen();this.ViewerPage.SelectDefaultTool()};var m=new t.ContextMenuOption("pointerTool",h.GetValuesFromDict("ViewerLanguage","pointerTool"),"pointerTool");m.Action=e=>{this.ViewerPage.View.Plugins.forEach((e=>{e.EscapeAction()}));this.ViewerPage.SelectTool("Pointer","pointerTool")};m.Default=true;var g=new t.ContextMenuOption("settings","Settings","settings");g.Action=e=>{this.ViewerPage.View.Platform.SettingsSubView=this.ViewerPage.View.Platform.ActivateSubView("SettingsView",{});this.ViewerPage.View.Platform.LoadSettingsFromPlugins();this.ViewerPage.View.Platform.SetTemporalTabsOnSubView();this.ViewerPage.View.Platform.SettingsSubView.Pane.ShowSection()};l.push(u,d,c,m,g);e=l}var w=e.slice();var f;try{f=a.Utils.DecodeBase64(this.ViewerPage.View.Platform.GetSetting("contextMenuOptions"))}catch(e){}if(f!==undefined){var p=JSON.parse(f);for(var S=0;S<w.length;S++){var v=w[S];if(p["uchk_"+v.Name]===undefined||!p["uchk_"+v.Name]){w.forEach(((e,t)=>{if(e.Name===v.Name){w.splice(t,1);S=-1}}))}}if(w.length>0){e=w}else{w=e.slice();f=undefined}}if(f===undefined){for(var P=0;P<w.length;P++){if(!w[P].Default){w.splice(P,1);P=-1}}e=w}var V=document.getElementsByClassName("contextMenuContainer")[0];var b=this.ViewerPage.ViewportPane.ViewportPaneSection.parentElement;var y;if(V!==undefined){V.innerHTML="";V.style.display="";y=V}else{y=document.createElement("div");n.AddClass(y,"contextMenuContainer")}var C=[s.clientX-10,s.clientY-75];y.style.left=C[0]+"px";y.style.top=C[1]+"px";y.style.bottom="";n.AddClass(y,"contextmenu");if(e.length){const t=document.querySelector(".MessageBar");if(!n.IsDisplay(t)){const t=r({className:"contextMenuBox",children:e.map((e=>o({innerHTML:e.Text,className:"contextMenuAction",onclick:t=>{n.HideElement(y);e.Action()}})))});y.appendChild(t)}}b.appendChild(y);var A=y.clientHeight+y.offsetTop;var T=y.parentElement.clientHeight;if(A>T){var E=y;E.style.top="";E.style.bottom="0"}if(C[0]+y.clientWidth>b.clientWidth)y.style.left=s.clientX-y.clientWidth-10+"px";if(C[1]+(y.clientHeight>0?y.clientHeight:y.scrollHeight)>b.clientHeight)y.style.top=s.clientY-(y.clientHeight>0?y.clientHeight:y.scrollHeight)-75+"px";if((y.clientHeight>0?y.clientHeight:y.scrollHeight)>document.documentElement.clientHeight-50){y.style.overflow="auto";y.style.height=document.documentElement.clientHeight-100+"px";y.style.display="block"}else{y.style.overflow="none";y.style.height="auto";y.style.display="table"}}UpdateDeltaInMove(e){var t;var a;var r=e;var o=n.GetOffset(e,"x");var s=n.GetOffset(e,"y");var l=o;var h=s;t=l-this.Context.MouseMoveX;a=h-this.Context.MouseMoveY;this.Context.MouseMoveX=l;this.Context.MouseMoveY=h;return{deltaX:t-50,deltaY:a-20}}GetFactorScaleImageLowOnHigh(e,t,n){var a=1;var r;var o;try{t=parseInt(t.toString());n=parseInt(n.toString());if(!e.ColsOrigin&&!e.RowsOrigin){a=1}else{if(e.ColsOrigin/t===1&&e.RowsOrigin/n===1){a=1}else{r=e.RowsOrigin/n;o=e.ColsOrigin/t;if(r>1||o>1)a=1/Math.max(r,o);if(r<1||o<1)a=1/Math.min(r,o)}}}catch(e){}return a}DetectAnnotation(e){var t=Viewport.AnnotationThreshold/Math.abs(this.Context.ScaleX);var n=this.Context.Annotations||[];if(this.RendererPlugins!==undefined&&this.RendererPlugins!==null){for(var a in this.RendererPlugins){if(this.RendererPlugins.hasOwnProperty(a)){var r=this.RendererPlugins[a].Annotations;if(r!==null&&r!==undefined)n=n.concat(r)}}}if(n.length>0){for(var o=0;o<n.length;o++){var s=n[o].HitTest(e,t);if(s.isFound||n[o].EvaluateAnnotationTextInCanvas(e))return{annotation:n[o],groupName:s.groupName,endRangePoints:s.endRangePoints}}}return null}GetAllAnnotations(){var e=this.Context.Annotations||[];if(this.RendererPlugins!==undefined&&this.RendererPlugins!==null){for(var t in this.RendererPlugins){if(this.RendererPlugins.hasOwnProperty(t)){var n=this.RendererPlugins[t].Annotations;if(n!==null&&n!==undefined)e=e.concat(n)}}}return e}CountingSelectedLinesAnnotations(){var e=this.GetAllAnnotations();var t=[];e.forEach((e=>{if(e.Selected&&e.IsLineType)t.push(e)}));return t}SelectUnSelectAnnotations(e){var t=this.GetAllAnnotations();t.forEach((t=>{t.Selected=e}));this.Context.Renderer.Render();this.Context.OverlayRenderer.Render()}SwitchVisibleAnnotations(e,t,n){try{if(n){n.Visible=e}else{var r=this.GetAllAnnotations();r.forEach((n=>{if(t){if(n.Name===t)n.Visible=e}else{n.Visible=e}}))}this.AnnotationManager.DrawAnnotations()}catch(e){a.Utils.DebugConsoleLog(e)}}LoadStlModels(t,n,a,r=0,o){if(this.StopDownloadOfElements){this.AdminLoaderModels(false);t(true);return}if(o!==undefined&&o===r){this.AdminLoaderModels(false);t(false)}if(a!==undefined&&this.Models3D.some((e=>e.Name===a[r]))){if(a.length===r+1){this.AdminLoaderModels(false);t(false)}else{this.LoadStlModels(t,n,a,r+1,o)}return}let s=e.Frontend.WebClient.PlatformContext.PlatformUri+"/dicomweb/"+this.ViewerPage.RegionId+"/studies/"+this.Context.StudyGuid+"/series/"+this.Context.SeriesGuid+"/instances/"+a[r];var l={};l["Accept"]="model/stl";var h=false;if(a!==undefined&&r===0||a===undefined){if(this.Models3D.length<=0)this.Models3D=new Array;this.AdminLoaderModels(true)}let u={responseType:"arraybuffer",downloadPercentUpdater:e=>{if(this.StopDownloadOfElements)e.target.abort();if(n===undefined){var t=parseFloat((e["loaded"]*100/e["total"]).toFixed(2));this.progressRing.ShowPercentage(t)}else{var a;a=parseFloat((e["loaded"]*100/e["total"]).toFixed(2));n[r].Percent=a;var o=0;for(var s=0;s<n.length;s++){o+=n[s].Weight*n[s].Percent}this.progressRing.ShowPercentage(o)}},downloadStarter:()=>{if(r===0)this.progressRing.ShowWatch()},onDownloadStop:()=>{h=true;this.ViewerPage.View.Platform.ShowSwitchMessageToCacheMode(false)}};let processResult=s=>{try{var l=e.Frontend.Viewer3D.StlLoader.LoadStl(s,a[r]);if(l!=null){var h=new ModelsData3d;h.Model=l;h.Name=a[r];h.Buffer=s;h.TransformData=n[r].TransformData;this.Models3D.push(h)}}catch(e){}finally{if(a!==undefined){if(a.length===r+1){this.AdminLoaderModels(false);t(false)}else{this.LoadStlModels(t,n,a,r+1,o)}}else{this.AdminLoaderModels(false);t(false)}}};e.Frontend.WebClient.HttpUtils.AjaxCall(s,"GET",l,null,((s,l)=>{if(s.status===200){processResult(l)}else if(s.status===206){let l=s.getResponseHeader("Location");e.Frontend.WebClient.HttpUtils.AjaxCall(l,"GET","none",null,((e,t)=>{processResult(t)}),(s=>{if(a!==undefined){if(a.length===r+1){this.AdminLoaderModels(false);t(true)}else{this.LoadStlModels(t,n,a,r+1,o)}}else{this.AdminLoaderModels(false);t(true)}if(!h)e.Frontend.WebClient.Toaster.ShowToast("The 3D image could not be downloaded",e.Frontend.WebClient.Colors.Orange,3.5)}),u.responseType,u.downloadPercentUpdater,u.downloadStarter,u.onDownloadStop)}}),(s=>{e.Frontend.WebClient.Toaster.ShowToast(`The 3D image could not be downloaded`,e.Frontend.WebClient.Colors.Orange,3.5);if(a!==undefined){if(a.length===r+1){this.AdminLoaderModels(false);t(true)}else{this.LoadStlModels(t,n,a,r+1,o)}}else{this.AdminLoaderModels(false);t(true)}}),u.responseType,u.downloadPercentUpdater,u.downloadStarter,u.onDownloadStop)}GetSelectedAnnotationsCount(){var e=0;var t=this.Context.Annotations||[];if(this.RendererPlugins!==undefined&&this.RendererPlugins!==null){for(var n in this.RendererPlugins){if(this.RendererPlugins.hasOwnProperty(n)){var a=this.RendererPlugins[n].Annotations;if(a!==null&&a!==undefined)t=t.concat(a)}}}if(t.length>0){for(var r=0;r<t.length;r++){if(t[r].Selected)e++}}return e}SelectedAllAnnotations(){var e=this.Context.Annotations||[];if(this.RendererPlugins!==undefined&&this.RendererPlugins!==null){for(var t in this.RendererPlugins){if(this.RendererPlugins.hasOwnProperty(t)){var n=this.RendererPlugins[t].Annotations;if(n!==null&&n!==undefined)e=e.concat(n)}}}if(e.length>0){for(var a=0;a<e.length;a++){e[a].Selected=true}}}PointInElement(e,t){var n;var r;if(this.Context.Rotation!==0){var o=-(this.Context.Rotation/180*Math.PI);e-=this.Context.OffsetX;t-=this.Context.OffsetY;n=e*Math.cos(o)-t*Math.sin(o);r=e*Math.sin(o)+t*Math.cos(o)}else{n=e-this.Context.OffsetX;r=t-this.Context.OffsetY}return new a.Point(n/this.Context.ScaleX,r/this.Context.ScaleY)}Clear(t){var n=t.ViewportElement.getContext("2d");n.fillStyle=e.Frontend.WebClient.Colors.BgDarker;n.fillRect(0,0,t.Width,t.Height)}GetWidth(){var e;var t=(e=this.Width)!==null&&e!==void 0?e:this.ViewportElement.getAttribute("width");return parseFloat(t)}GetHeight(){var e;var t=(e=this.Height)!==null&&e!==void 0?e:this.ViewportElement.getAttribute("height");return parseFloat(t)}Dispose(){n.RemoveItem(this.ViewportFrameElement)}}Viewport.AnnotationThreshold=3.5;t.Viewport=Viewport})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class ViewportCollection{constructor(){this.LoadedViewports={}}GetOrCreateViewport(){return null}AttachToUI(e){}}e.ViewportCollection=ViewportCollection})(t=e.ImagingStudyView||(e.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient.DOMUtils;var a=e.Frontend.WebClient.LayoutManager.Panel;var r=e.Frontend.WebClient.LayoutManager.DockPanel;var o=e.Frontend.WebClient.LayoutManager.PanelOrientation;var s=e.Frontend.WebClient.LayoutManager.DockPanelPosition;const{div:l}=n;class OneByOneContext{constructor(){this.IsActive=false}}t.OneByOneContext=OneByOneContext;class ViewportPane{constructor(e,t){this.OneByOneContext=new OneByOneContext;this.Parent=e;this.ViewerPage=t}Create(){this.ViewportPaneSection=l({className:"viewportPane",attr:{id:"ViewportPaneId"}});const e=new a({domElement:this.ViewportPaneSection});const t=new r({});const n=new a({width:0,height:"100%",className:"left-drop-panel"});const o=new a({width:0,height:"100%",className:"right-drop-panel"});t.AddChild(n,s.LEFT);t.AddChild(o,s.RIGHT);t.AddLast(e);this.dropLeftPane=n.GetDOMElement();this.dropRightPane=o.GetDOMElement();this.topContainer=l({style:{width:"100%"},children:[this.disabledStudyNotice=l({className:"disabledStudyNotice",innerText:"This study is invalid.",style:{display:"none"}}),t.GetDOMElement()]});this.Parent.appendChild(this.topContainer);this.mainPage=this.Parent.closest(".mainPage")}Hide(){this.ViewportPaneSection.style.display="none";this.topContainer.style.display="none"}Show(){this.ViewportPaneSection.style.display="block";this.topContainer.style.display="block"}RenderViewportPane(){var e;var t;var a=this.ViewerPage.TopBarElement.IsDisplay()?this.ViewerPage.TopBarElement.Element.clientHeight-9:this.ViewerPage.View.Platform.Toolbar.Element.clientHeight;var r=0;var o=0;var s=this.disabledStudyNotice.style.display==="block"?this.disabledStudyNotice.clientHeight:0;if(this.ViewerPage.ThumbnailPane.ThumbnailPaneSection.style.display!=="none"){r=this.ViewerPage.ThumbnailPane.ThumbnailPaneSection.clientWidth;o=this.ViewerPage.ThumbnailPane.ThumbnailPaneSection.clientHeight}if(this.ViewerPage.ExtendViewportPane){e=document.documentElement.clientHeight-a-this.ViewerPage.View.Platform.GetActiveMessageHeight()-s-30;this.ViewportPaneSection.style.width="100%";this.ViewportPaneSection.style.height=e+"px";this.ViewportPaneSection.style.marginTop="0px";this.ViewportPaneSection.style.marginLeft="0px";this.PaneWidth=this.ViewportPaneSection.clientWidth;this.PaneHeight=e;if(s!==0){this.disabledStudyNotice.style.marginTop="0px";this.disabledStudyNotice.style.marginBottom="0px";this.disabledStudyNotice.style.marginLeft="0px";this.disabledStudyNotice.style.marginRight="0px"}}else if(this.ViewerPage.FullScreen){n.AddClass(this.ViewportPaneSection,"fullscreenview");if(n.IsPortrait()){t=document.documentElement.clientWidth-(30+60);e=document.documentElement.clientHeight-30-s;this.ViewportPaneSection.style.width="";this.ViewportPaneSection.style.top="";this.ViewportPaneSection.style.height="";this.ViewportPaneSection.style.marginTop="";this.ViewportPaneSection.style.marginLeft="";this.PaneWidth=t;this.PaneHeight=e}else{t=document.documentElement.clientWidth-(30+60);e=document.documentElement.clientHeight-30-s;this.ViewportPaneSection.style.top="";this.ViewportPaneSection.style.margin="";this.ViewportPaneSection.style.width="";this.ViewportPaneSection.style.height="";this.PaneWidth=t;this.PaneHeight=e}if(s!==0){this.disabledStudyNotice.style.marginTop="0px";this.disabledStudyNotice.style.marginBottom="0px";this.disabledStudyNotice.style.marginLeft="0px";this.disabledStudyNotice.style.marginRight="0px"}}else{n.AddClass(this.ViewportPaneSection,"normalview");this.ViewerPage.View.Platform.Toolbar.OnWindowResize(document.documentElement.clientWidth,document.documentElement.clientHeight);const e=this.GetPaneDimensions();const t=e.width;const a=e.height;this.PaneWidth=t;this.PaneHeight=a-s}}GetPaneDimensions(){const e=this.ViewerPage.View.Platform.ToolbarSectionHeight();const t=parseInt(getComputedStyle(this.mainPage).margin,10);const n=this.ViewerPage.GetLayoutOrientation()===o.HORIZONTAL?0:this.ViewerPage.ThumbnailPane.ThumbnailPaneSection.parentElement.clientHeight;const a=this.ViewerPage.GetLayoutOrientation()===o.HORIZONTAL?this.ViewerPage.ThumbnailPane.ThumbnailPaneSection.parentElement.clientWidth:0;const r=document.documentElement.clientHeight-(e+this.ViewerPage.View.Platform.GetActiveMessageHeight()+(2*t+10)+n);const s=parseInt(getComputedStyle(this.dropLeftPane).width,10);const l=parseInt(getComputedStyle(this.dropRightPane).width,10);const h=document.documentElement.clientWidth-(2*t+5+a+s+l);return{width:h,height:r}}ChangeViewportsNumber(e=true){this.ViewerPage.View.Platform.Toolbar.SetValueToButtonBar(null,"hviewport",this.HorizontalViewports);this.ViewerPage.View.Platform.Toolbar.SetValueToButtonBar(null,"vviewport",this.VerticalViewports);let t;let a;const r=4;const o=2;const s=2;t=Math.floor((this.PaneWidth-(this.HorizontalViewports-1)*r)/this.HorizontalViewports)-3*o;a=(this.PaneHeight+r)/this.VerticalViewports-r-2*o-s;var l=2;this.ViewportPaneSection.style.height=`${this.PaneHeight}px`;if(this.ViewportsArray===undefined)return;if(this.ShowOnlyViewportId&&this.HorizontalViewports===1&&this.VerticalViewports===1){for(var h=0;h<this.ViewportsArray.length;h++){var u=this.ViewportsArray[h];if(u.Id!==this.ShowOnlyViewportId)u.ViewportFrameElement.style.display="none"}const t=this.ViewportsArray.findIndex((e=>e.Id===this.ShowOnlyViewportId));if(t>-1){var u=this.ViewportsArray[t];var d=u.ViewportFrameElement;var c=parseInt(d.getAttribute("data-rowTemp"),10);var m=parseInt(d.getAttribute("data-columnTemp"),10);d.style.width=`${this.PaneWidth-2*o}px`;d.style.height=this.PaneHeight+"px";d.style.marginRight="0px";d.style.marginBottom="0px";if(u!==null&&n.IsDisplay(u.ViewportFrameElement)&&u.Context.ImageEntity!==null){u.Context.Renderer.Render();u.Context.OverlayRenderer.Render()}if(e){u.ViewportElement.setAttribute("width",d.clientWidth.toString());u.ViewportElement.setAttribute("height",d.clientHeight.toString());u.Width=d.clientWidth;u.Height=d.clientHeight;this.setHistorialSize(u)}}}else{for(var h=0;h<this.ViewportsArray.length;h++){var u=this.ViewportsArray[h];var d=u.ViewportFrameElement;var c=parseInt(d.getAttribute("data-rowTemp"),10);var m=parseInt(d.getAttribute("data-columnTemp"),10);d.style.width=t+"px";d.style.height=a+"px";d.style.marginRight="0px";d.style.marginBottom="0px";if(m<=2&&m+1<this.HorizontalViewports)d.style.marginRight="4px";if(c<=2&&c+1<this.VerticalViewports)d.style.marginBottom="4px";if(c<this.VerticalViewports&&m<this.HorizontalViewports){d.style.display="inline-block";u.ContentElement.setAttribute("tabindex",l.toString());u.NumberInPanel=l-1;this.TabIndexMaxViewport=l;l++}else{d.style.display="none"}if(e){u.ViewportElement.setAttribute("width",d.clientWidth.toString());u.ViewportElement.setAttribute("height",d.clientHeight.toString());u.Width=d.clientWidth;u.Height=d.clientHeight;this.setHistorialSize(u)}}var g=this.ViewportsArray;for(var h=0;h<g.length;h++){try{var w=g[h];if(w!==null&&n.IsDisplay(w.ViewportFrameElement)&&w.Context.ImageEntity!==null){w.Context.Renderer.Render();w.Context.OverlayRenderer.Render()}}catch(e){}}}}OnWindowResize(e,t){}setHistorialSize(e){let t=e.ViewportElement.getAttribute("oldwidth");if(t){t=`${t}, ${e.Width}`;let n=t.split(",");if(n.length>2)t=n.splice(n.length-2,2).join(",");e.ViewportElement.setAttribute("oldwidth",t)}else{t=e.Width;if(t)e.ViewportElement.setAttribute("oldwidth",t)}let n=e.ViewportElement.getAttribute("oldheight");if(n){n=`${n},${e.Height}`;let t=n.split(",");if(t.length>2)n=t.splice(t.length-2,2).join(",");e.ViewportElement.setAttribute("oldheight",n)}else{n=e.Height;if(n)e.ViewportElement.setAttribute("oldheight",n)}}}t.ViewportPane=ViewportPane})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient;class WorklistRelatedController extends n.SubView{constructor(e,a,r){super(e,a,"ViewerLanguage");this.ViewerPage=r;this.Pane=new t.WorklistRelatedPane(this.BodySection,this);this.ResizeListeners.push(new n.ResizeStructure(this.Pane.constructor.name.toLowerCase(),this.Pane,this.ViewerPage.View.ViewName))}SetButtons(){super.SetButtons([],(()=>{this.DisposeView()}))}DisposeView(){}OnWindowResize(e,t,n){super.OnWindowResize(e,t,n)}}t.WorklistRelatedController=WorklistRelatedController})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var n;(function(t){var n=e.Frontend.WebClient.Utils;var a=e.Frontend.WebClient.DOMUtils;var r=e.Frontend.WebClient;class WorklistRelatedPane extends r.WorklistGrid{constructor(e,t){var n=document.createElement("div");a.AddClass(n,"worklistRelatedPane");var o=document.createElement("div");a.AddClass(o,"timeLineRelatedPane");var s="WorklistLanguage";var l=t.ViewerPage.View.Platform.LanguageManager;var h=l.GetValuesFromDict(s,"patientId");var u=l.GetValuesFromDict(s,"patientName");var d=l.GetValuesFromDict(s,"patientAge");var c=l.GetValuesFromDict(s,"seriesCount");var m=l.GetValuesFromDict(s,"imagesCount");var g=l.GetValuesFromDict(s,"physician");var w=l.GetValuesFromDict(s,"studyDateTime");var f=l.GetValuesFromDict(s,"studyDescription");var p=l.GetValuesFromDict(s,"studyModalities");var S=l.GetValuesFromDict(s,"studyFacility");var v=new r.WorklistColumn(h,80,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var P=new r.WorklistColumn(u,180,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var V=new r.WorklistColumn(d,80,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var b=new r.WorklistColumn(c,80,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var y=new r.WorklistColumn(m,80,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var C=new r.WorklistColumn(g,180,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var A=new r.WorklistColumn(w,100,((e,t)=>{}),r.EWorklistSort.Down,r.EWorklistFilter.Up);var T=new r.WorklistColumn(f,180,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var E=new r.WorklistColumn(p,180,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var D=new r.WorklistColumn(S,180,((e,t)=>{}),r.EWorklistSort.None,r.EWorklistFilter.Up);var I=[v,P,V,b,y,C,A,T,E,D];super(I);this.worklistPaneSection=n;this.timeLinePaneSection=o;this.Parent=e;this.Controller=t;var F=document.createElement("div");a.AddClass(F,"worklistPane");a.AddClass(F,"relatedStudiesPane");F.appendChild(this.timeLinePaneSection);F.appendChild(this.worklistPaneSection);var x=document.createElement("table");x.setAttribute("class","workListTable");this.table=x;var M=document.createElement("ul");M.setAttribute("class","workListUl");this.list=M;var L=document.createElement("thead");var B=document.createElement("tbody");this.tHead=L;this.tBody=B;this.table.appendChild(L);this.table.appendChild(B);this.RelatedStudiesSection=F;this.worklistPaneSection.appendChild(this.table);this.worklistPaneSection.appendChild(this.list);var G=document.createElement("div");a.AddClass(G,"buttonsBarRelatedStudies");this.openButton=document.createElement("input");this.openButton.type="button";this.openButton.value="Open";a.AddClass(this.openButton,"green");this.openButton.onclick=e=>{this.openStudy()};this.cancelButton=document.createElement("input");this.cancelButton.type="button";this.cancelButton.value="Cancel";a.AddClass(this.cancelButton,"red");this.cancelButton.onclick=e=>{this.RelatedStudiesSection.style.display="block";this.Toggle();this.Controller.ViewerPage.SelectDefaultTool()};G.appendChild(this.openButton);G.appendChild(this.cancelButton);this.RelatedStudiesSection.appendChild(G);var R=new Hammer(this.worklistPaneSection);R.get("pan").set({direction:Hammer.DIRECTION_ALL,threshold:0,pointers:0});R.on("panstart panmove panend",(e=>{if(e.type==="panmove")a.ScrollElement(this.worklistPaneSection,e.deltaY<0?-e.distance:e.distance,e.additionalEvent==="panup"||e.additionalEvent==="pandown")}));a.ScrollElement(this.worklistPaneSection);this.Parent.appendChild(this.RelatedStudiesSection)}Toggle(){var e=a.IsDisplay(this.RelatedStudiesSection);if(!e){this.Controller.ViewerPage.ShowRelatedStudies=true;this.RelatedStudiesSection.style.display="block";this.Controller.SetButtons();this.OnWindowResize(0,0);this.getRelatedStudies()}else{this.Controller.ViewerPage.ShowRelatedStudies=false;this.RelatedStudiesSection.style.display="none";this.Controller.CloseSubView();this.Controller.ViewerPage.SelectTool("Pointer","pointerTool")}}OnWindowResize(e,t){if(this.Controller.ViewerPage.ShowRelatedStudies){var n=document.documentElement.clientHeight-220;this.worklistPaneSection.style.height=n+"px";if(this.timeline){try{this.timeline.LoadData(this.studiesTimeLine,"date","color");this.timeline.Render()}catch(e){}}}}buildTableHeader(){this.tHead.innerHTML="";super.CreateHead(this.tHead)}existStudyRelatedOpen(e){var t=this.Controller.ViewerPage.StudyViewerModel.Documents;for(var n=0;n<t.IndexData.length;n++){if(t.IndexData[n]===e)return true}return false}buildBodyTable(e){this.tBody.innerHTML="";this.list.innerHTML="";var t=this.Controller.ViewerPage.StudyViewerModel.Documents.IndexData[0];var a=new Array;this.From=1;this.PageSize=10;for(var o in e){if(e.hasOwnProperty(o)){var s=e[o];var l=new Array;l.push(new r.ItemCell(s.PatientID));l.push(new r.ItemCell(n.FormatValue(s.PatientName)));l.push(new r.ItemCell(s.PatientAge));l.push(new r.ItemCell(s.SeriesCount.toString()));l.push(new r.ItemCell(s.ImageCount.toString()));l.push(new r.ItemCell(n.FormatValue(s.ReferringPhysician)));var h=s.StudyDateTime.getFullYear();var u=s.StudyDateTime.getMonth()+1;var d=s.StudyDateTime.getDate();var c=n.FormatDateTime(h+"-"+u+"-"+d);l.push(new r.ItemCell(c));l.push(new r.ItemCell(n.FormatValue(s.StudyDescription)));l.push(new r.ItemCell(s.StudyModalities));l.push(new r.ItemCell(n.FormatValue(s.InstitutionName)));var m=new r.WorklistRow(s,l,(e=>{}),(e=>{var n=e.target.parentElement.parentElement.getAttribute("data-entityuid");if(t!==n&&!this.existStudyRelatedOpen(n))this.openStudy();else r.Toaster.ShowToast("Can not open the same study",r.Colors.BelizeHole,4)}),this);a.push(m)}}this.Rows=a;super.CreateBody(this.tBody,this.list,(()=>{}),(()=>{}))}openStudy(){if(this.SelectedEntities===null||this.SelectedEntities===undefined||this.SelectedEntities.length===0){r.Toaster.ShowToast("Please select a study",r.Colors.BelizeHole,3);return}var e=this.Controller.ViewerPage.StudyViewerModel.Documents.IndexData[0];var t=this.SelectedEntities;if(e===t[0].StudyGUID||this.existStudyRelatedOpen(t[0].StudyGUID)){r.Toaster.ShowToast("Can not open the same study",r.Colors.BelizeHole,4);return}this.Controller.ViewerPage.SelectDefaultTool();var n={Id:"attachRelatedButon",Name:"Attach",ClassNames:["green"],Text:"Attach",Action:e=>{this.Toggle();this.Controller.ViewerPage.OpenStudy(this.SelectedEntities[0]["id"],undefined,true)}};var a={Id:"newWindowRelatedButton",Name:"New window",ClassNames:["red"],Text:"New Window",Action:e=>{this.Toggle();var t=location.href.split("?")[0].split("/")[3];var n=r.PlatformContext.PlatformUri+"/"+t;this.SelectedEntities.forEach((e=>{var t=window.open(n+"?view=viewStudy&Study="+e["id"],"Study Open "+this.Controller.ViewerPage.View.Platform.OpenWindows.length+1);this.Controller.ViewerPage.View.Platform.OpenWindows.push(t)}))}};var o=new r.MessageBox("Please choose how you want to open this next study.",[n,a]);o.Show()}getRelatedStudies(){var n=this.Controller.ViewerPage.StudyViewerModel.Documents.IndexData[0];if(n===undefined)return;try{var a=this.Controller.ViewerPage.MainStudyOpen.StudyGUID||this.Controller.ViewerPage.GetSelectViewport(this.Controller.ViewerPage.ViewportPane).Context.StudyGuid;var o=this.Controller.ViewerPage.ImagingStudyFhirEntities[a]["subject"]["identifier"][0]["value"];if(o!==""){r.Loader.Show();var s=r.PlatformContext.PlatformUri+"/fhir/ImagingStudy?subject:Patient.identifier="+o+"&_include=ImagingStudy:subject&_include=ImagingStudy:referrer&_include=ImagingStudy:location";var l=new e.Frontend.FhirClient.FhirCall(s,"GET");l.FuncOk=a=>{r.Loader.Hide();if(a!==""){try{this.buildTableHeader();this.studiesTimeLine=[];var o=new Array;var s=e.Frontend.FhirClient.FhirParser.ProcessBundle(JSON.parse(a),"ImagingStudy");if(s.length>0){for(var l=0;l<s.length;l++){var h=new t.StudyEntity;if(s[l]["resourceType"].match("ImagingStudy")!==null){var u=s[l]["identifier"][0]["value"];var d=u.lastIndexOf(":");var c=u.substring(d+1,u.length);h["id"]=s[l]["id"];h.StudyGUID=c;try{h.PatientID=s[l]["subject"]["identifier"][0]["value"]}catch(e){h.PatientID=""}try{h.PatientName=s[l]["subject"]["name"][0]["text"]}catch(e){h.PatientName=""}var m;var g;try{var w=s[l]["started"];var f=s[l]["meta"]["lastUpdated"];g=w?w:f;var p=g.substr(0,4)+"-"+g.substr(4,2)+"-"+g.substr(6,2);var S=s[l]["subject"]["birthDate"];var v=S.substr(0,4)+"-"+S.substr(4,2)+"-"+S.substr(6,2);var m=S?r.Utils.GetAgeFromDate(v,p):"";m=S?isNaN(+m)?"0Y":`${m}Y`:""}catch(e){m=""}h.PatientAge=m;h.SeriesCount=s[l]["numberOfSeries"];h.ImageCount=s[l]["numberOfInstances"];try{h.ReferringPhysician=s[l]["referrer"]["name"][0]["text"]}catch(e){h.ReferringPhysician=""}h.StudyDescription=s[l]["description"];try{h.StudyModalities=s[l]["modality"][0]["code"]}catch(e){h.StudyModalities=""}try{h.InstitutionName=s[l]["location"]["name"]||s[l]["location"]["name"][0]["text"]}catch(e){h.InstitutionName=""}if(g){if(g.length===10)h.StudyDateTime=new Date(g.replace(/-/gi,"/")+" 00:00:00");else h.StudyDateTime=new Date(g.substr(0,10).replace(/-/gi,"/"))}o.push(h)}}var P=document.createElement("canvas");this.timeLinePaneSection.innerHTML="";this.timeLinePaneSection.appendChild(P);this.buildBodyTable(o);for(var V=0;V<o.length;V++){var b={color:"",date:o[V].StudyDateTime,studyGuid:o[V].StudyGUID};if(b.studyGuid===n){b.color=r.Colors.SunFlower}else{for(var l=1;l<this.Controller.ViewerPage.StudyViewerModel.Documents.IndexData.length;l++){if(this.Controller.ViewerPage.StudyViewerModel.Documents.IndexData[l]===b.studyGuid)b.color=r.Colors.Nephritis}}this.studiesTimeLine.push(b)}this.timeline=new r.TimelineControl(P);this.timeline.LoadData(this.studiesTimeLine,"date","color");this.timeline.Render()}else{r.Toaster.ShowToast("The application could not find related studies.",r.Colors.Orange,3);this.Toggle()}}catch(e){r.Toaster.ShowToast("Error showing related studies.",r.Colors.Orange,3);this.Toggle()}}else{r.Toaster.ShowToast("The application could not find related studies.",r.Colors.Orange,3);this.Toggle()}};l.FuncError=e=>{r.Loader.Hide();this.Toggle()};l.Send()}else{r.Toaster.ShowToast("The patient id is empty.",r.Colors.Orange,3);this.Toggle()}}catch(e){r.Toaster.ShowToast("Error getting related studies",r.Colors.Orange,3);this.Toggle()}}}t.WorklistRelatedPane=WorklistRelatedPane})(n=t.ImagingStudyView||(t.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));