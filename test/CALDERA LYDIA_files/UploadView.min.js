var Efferent;(function(e){var t;(function(e){var t;(function(e){class DicomElement{constructor(e,t,i,s){this.tag=e;this.value=s;this.VR=t;this.VL=i}ToString(e){if(Array.isArray(this.value)){var t="  ".repeat(e)+this.tag+" "+(this.VR||"??")+" "+this.VL+" Array:\r\n";for(var i=0;i<this.value.length;i++)t+=this.value[i].ToString(e+1)+"\r\n";return t}else{var s;if(typeof this.value==="undefined")s="[undefined]";if(typeof this.value==="string")s=this.value.substring(0,100);else if(typeof this.value==="number")s=this.value.toString();else s="[binary]";return"  ".repeat(e)+this.tag+" "+(this.VR||"??")+" "+this.VL+" "+s}}}e.DicomElement=DicomElement;class DicomParser{constructor(e,t=false){this.position=0;this.pidCounter=1;this.headerSize=128;this.isUnsigned=true;this.DicomTags={};this.reachedPixelData=false;this.implicitVR=false;this.dicomBuffer=e;this.isDebug=t;this.fileSize=e.length;if(this.fileSize<140)return;var i="";for(var s=128;s<132;s++)i+=String.fromCharCode(e[s]);if(i!=="DICM")return;this.position=132;var n;while(n=this.getNextElement()){this.fixVRValue(n);this.readElementValue(n);this.addValueToMainDataset(n);this.evaluateElementTag(n,false);if(this.isDebug)console.log(n.ToString(0));if(Number.isNaN(this.position)||this.position+8>=this.fileSize)break}}getNextElement(){if(this.image&&this.ismainImage)return null;try{var e;var t;var i=this.fetchTag();if(this.implicitVR&&this.position>=this.headerSize){t=this.dicomBuffer[this.position+4]+this.dicomBuffer[this.position+5]*256+this.dicomBuffer[this.position+6]*65536+this.dicomBuffer[this.position+7]*16777216;this.position+=8}else{switch(i){case"FFFE_E000":case"FFFE_E00D":case"FFFE_E0DD":t=this.dicomBuffer[this.position+4]+this.dicomBuffer[this.position+5]*256+this.dicomBuffer[this.position+6]*65536+this.dicomBuffer[this.position+7]*16777216;this.position+=8;break;default:e=String.fromCharCode(this.dicomBuffer[this.position+4])+String.fromCharCode(this.dicomBuffer[this.position+5]);switch(e){case"OB":case"OF":case"OW":case"SQ":case"UN":case"UT":t=this.dicomBuffer[this.position+8]+this.dicomBuffer[this.position+9]*256+this.dicomBuffer[this.position+10]*65536+this.dicomBuffer[this.position+11]*16777216;this.position+=12;break;default:t=this.dicomBuffer[this.position+6]+this.dicomBuffer[this.position+7]*256;this.position+=8;break}break}}if(e&&e!=="SQ"&&i!=="7FE0_0010"&&t===4294967295)return null;return new DicomElement(i,e,t,"")}catch(e){return null}}fixVRValue(e){if(this.transferSyntax==="1.2.840.10008.1.2.1"&&e.tag==="7FE0_0010"){if(e.VR==="OW"&&this.photometric==="RGB")e.VR="OB";else if(e.VR==="OW"&&this.bitsAllocated===8&&(this.modality==="XA"||this.modality==="RF"||this.modality==="US"))e.VR="OB";else if((this.modality==="MG"||this.modality==="DX")&&this.bitsAllocated===16)e.VR="OW"}}readElementValue(e){var t=this.position;if(this.implicitVR&&t>=this.headerSize){var i=this.fetchTag();if(e.VL===4294967295||i==="FFFE_E000"){e.value=[];this.processSequence(e)}else if(e.VL>1024){e.value="[LONG CONTENT]";this.position+=e.VL}else{e.value="";for(var s=0;s<e.VL;s++)e.value+=String.fromCharCode(this.dicomBuffer[t++]);this.position+=e.VL}return}if(e.tag==="7FE0_0010"&&e.VL===4294967295&&(e.VR==="OB"||e.VR==="OW")){e.value=[];this.processPixelDataSequence(e);if(!this.numberFrames||this.numberFrames&&this.numberFrames===1){this.image=e.value&&Array.isArray(e.value)?e.value[e.value.length-1]:e.value}else if(this.numberFrames>1){this.image=e.value}return}switch(e.VR){case"AE":case"AS":case"AT":case"CS":case"DA":case"DS":case"DT":case"IS":case"LO":case"LT":case"PN":case"SH":case"ST":case"TM":case"UI":case"UT":var n="";for(var s=0;s<e.VL;s++)n+=String.fromCharCode(this.dicomBuffer[t++]);e.value=n.toString().replace("\0","").trim();break;case"FL":e.value=new Float32Array(this.getBytes(4))[0];break;case"FD":e.value=new Float64Array(this.getBytes(8))[0];break;case"OB":e.value=new Uint8Array(this.bufferSlice(t,t+e.VL));break;case"OW":try{if(this.isUnsigned)e.value=new Uint16Array(this.bufferSlice(t,t+e.VL));else e.value=new Int16Array(this.bufferSlice(t,t+e.VL))}catch(t){e.value=""}break;case"OF":e.value=new Float32Array(this.bufferSlice(t,t+e.VL));break;case"SL":e.value=new Int32Array(this.getBytes(4))[0];break;case"SS":e.value=e.VL===2?new Int16Array(this.getBytes(2))[0]:new Int16Array(this.getBytes(e.VL)).join("/");break;case"UL":e.value=new Uint32Array(this.getBytes(4))[0];break;case"US":e.value=e.VL===2?new Uint16Array(this.getBytes(e.VL))[0]:e.VL<=20?new Uint16Array(this.getBytes(e.VL)).join("/"):new Uint16Array(this.getBytes(e.VL));break;case"UN":break;case"SQ":e.value=[];this.processSequence(e);return;default:if(e.tag==="FFFE_E000"){e.value=[];this.processSequence(e);return}break}if(e.VL!==4294967295)this.position+=e.VL}evaluateElementTag(e,t){if(e.tag==="7FE0_0010"&&e.VL!==4294967295){this.reachedPixelData=true;if(this.implicitVR)return;if(this.transferSyntax==="1.2.840.10008.1.2.4.50"&&e.VR==="OB"){try{let t=this.validateIsJpeg(this.position+20,this.dicomBuffer.length-8);e.value=t}catch(e){if(this.isDebug)console.log(e)}}this.image=e.value;if(!t&&this.image)this.ismainImage=true;return}if(t)return;var i=e.value;switch(e.tag){case"0002_0000":this.headerSize=this.position+i;break;case"0002_0010":this.transferSyntax=i;if(i==="1.2.840.10008.1.2"){this.implicitVR=true}else if(i==="1.2.840.10008.1.2.1.99"){var s=new Inflator;this.dicomBuffer=s.Inflate(this.dicomBuffer,this.headerSize,this.fileSize-this.headerSize);this.fileSize=this.dicomBuffer.length;this.headerSize=0;this.position=0}break;case"0028_0004":this.photometric=i.toUpperCase();this.isUnsigned=this.photometric!=="MONOCHROME2";break;case"0028_0008":this.numberFrames=i?parseInt(i):i;break;case"0028_0100":try{this.bitsAllocated=parseInt(i)}catch(e){}break;case"0028_0102":this.isUnsigned=i==="15"&&this.photometric==="MONOCHROME1";if(this.modality==="XA"||this.modality==="RF")this.isUnsigned=i==="15"&&(this.photometric==="MONOCHROME1"||this.photometric==="MONOCHROME2");break;case"0028_0103":if(i==="0"||i===0)this.isUnsigned=true;break;case"0008_0060":this.modality=i;break}}fetchTag(){if(this.position+4>this.fileSize)return"";var e=this.dicomBuffer[this.position]+this.dicomBuffer[this.position+1]*256;var t=this.dicomBuffer[this.position+2]+this.dicomBuffer[this.position+3]*256;var i=((e+65536).toString(16).substr(-4)+"_"+(t+65536).toString(16).substr(-4)).toUpperCase();return i}addValueToMainDataset(e){if(e.tag!=="7FE0_0010"){if(!e.value.hasOwnProperty("buffer")){var t=e.value;if(e.tag==="0010_0020"){if(!this.DicomTags[e.tag])this.DicomTags[e.tag]=t;else this.DicomTags[e.tag+"_"+this.pidCounter++]=t}else{this.DicomTags[e.tag]=t}}}}processPixelDataSequence(e){while(true){var t=this.fetchTag();var i=this.dicomBuffer[this.position+4]+this.dicomBuffer[this.position+5]*256+this.dicomBuffer[this.position+6]*65536+this.dicomBuffer[this.position+7]*16777216;this.position+=8;if(t==="FFFE_E000"&&i>4){var s;var n=this.position;try{if(e.VR==="OB"){s=new Uint8Array(this.bufferSlice(n,n+i))}else if(e.VR==="OW"){if(this.isUnsigned)s=new Uint16Array(this.bufferSlice(n,n+i));else s=new Int16Array(this.bufferSlice(n,n+i))}else{break}e.value.push(s)}catch(t){e.value=s;break}}else if(t==="FFFE_E00D"||t==="FFFE_E0DD"){break}else if(this.position+8>=this.fileSize){break}this.position+=i}}processSequence(e){if(e.VL===0)return;var t=e.VL===4294967295;var i;if(!t)i=this.position+e.VL;var s;while(s=this.getNextElement()){if(!t&&s.VL===4294967295)s.VL=i-this.position;this.fixVRValue(s);this.readElementValue(s);this.evaluateElementTag(s,true);if(isNaN(this.position)){break}if(this.position+8>=this.fileSize){break}if(!t&&this.position>=i){break}if(t&&s.tag==="FFFE_E00D"){break}if(t&&s.tag==="FFFE_E0DD"){break}e.value.push(s)}}validateIsJpeg(e,t){var i=new Uint8Array(this.bufferSlice(e,t));var s=[[255,216,255,224],[255,216,255,219],[255,216,255,238],[255,216,255,225]];let n=false;let o=0;e:for(let e=0;e+4<i.length;e++){for(let t=0;t<s.length;t++){if(i[e]===s[t][0]&&i[e+1]===s[t][1]&&i[e+2]===s[t][2]&&i[e+3]===s[t][3]){n=true;o=e;break e}}}i=n?i.slice(o):null;return i}getBytes(e){var t=new Uint8Array(e);for(var i=0;i<e;i++)t[i]=this.dicomBuffer[this.position+i];return t.buffer}bufferSlice(e,t){if(ArrayBuffer.prototype.slice!==undefined)return this.dicomBuffer.buffer.slice(e,t);var i=new Uint8Array(this.dicomBuffer.buffer);if(t===undefined)t=i.length;var s=new ArrayBuffer(t-e);var n=new Uint8Array(s);for(var o=0;o<n.length;o++)n[o]=i[e++];return s}}e.DicomParser=DicomParser;class BitReader{constructor(e,t,i){this.bitsLength=0;this.bits=0;this.buffer=e;this.pos=t;this.limit=t+i-1}ReadByte(){if(this.pos>this.limit)return-1;return this.buffer[this.pos++]}ReadBit(){if(this.bitsLength===0){var e=this.ReadByte();if(e<0)throw new Error("Unexpected end of stream");this.bits=e;this.bitsLength=8}var t=(this.bits&1)!==0;this.bits>>=1;--this.bitsLength;return t}Align(){this.bitsLength=0}ReadLSB(e){var t=0;for(var i=0;i<e;++i){if(this.ReadBit())t|=1<<i}return t}ReadMSB(e){var t=0;for(var i=0;i<e;++i){if(this.ReadBit())t=t<<1|1;else t<<=1}return t}}class Inflator{constructor(){this.encodedLengthStart=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];this.encodedLengthAdditionalBits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0];this.encodedDistanceStart=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];this.encodedDistanceAdditionalBits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];this.clenMap=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];this.initializeStaticTrees()}Inflate(e,t,i){this.bitReader=new BitReader(e,t,i);this.buffer=new Array(0);this.bufferPosition=0;this.state=0;this.blockFinal=false;var s=[];var n;while((n=this.readByte())>=0){s.push(n)}return new Uint8Array(s)}buildCodes(e){var t=new Array(e.length);var i=e[0];for(var s=1;s<e.length;s++){if(i<e[s])i=e[s]}var n=new Array(i+1);for(var s=0;s<=i;s++)n[s]=0;for(var s=0;s<e.length;s++){++n[e[s]]}var o=new Array(i+1);var a=0;n[0]=0;for(var l=1;l<=i;l++){a=a+n[l-1]<<1;o[l]=a}for(var r=0;r<t.length;r++){var d=e[r];if(d!==0){t[r]=o[d];o[d]++}}return t}initializeStaticTrees(){var e=new Array(288);var t=new Array(288);for(var i=0;i<=143;i++){e[i]=48+i;t[i]=8}for(var i=144;i<=255;i++){e[i]=400+i-144;t[i]=9}for(var i=256;i<=279;i++){e[i]=0+i-256;t[i]=7}for(var i=280;i<=287;i++){e[i]=192+i-280;t[i]=8}this.staticCodes=this.buildTree(e,t);var s=new Array(32);var n=new Array(32);for(var i=0;i<=31;i++){s[i]=i;n[i]=5}this.staticDistances=this.buildTree(s,n)}buildTree(e,t){var i=[];for(var s=0;s<e.length;++s){if(t[s]>0){var n={bits:e[s],length:t[s],index:s};i.push(n)}}return this.buildTreeBranch(i,0,0)}buildTreeBranch(e,t,i){if(e.length===0)return null;var s=[];var n=[];var o={};o.isLeaf=false;for(var a=0;a<e.length;++a){if(e[a].length===i&&e[a].bits===t){o.isLeaf=true;o.index=e[a].index;break}else{var l=(e[a].bits>>e[a].length-i-1&1)>0;if(l)n.push(e[a]);else s.push(e[a])}}if(!o.isLeaf){o.zero=this.buildTreeBranch(s,t<<1,i+1);o.one=this.buildTreeBranch(n,t<<1|1,i+1)}return o}readDynamicTrees(e){var t=e.ReadLSB(5)+257;var i=e.ReadLSB(5)+1;var s=e.ReadLSB(4)+4;var n=new Array(19);for(var o=0;o<n.length;++o)n[o]=0;for(var o=0;o<s;++o)n[this.clenMap[o]]=e.ReadLSB(3);var a=this.buildCodes(n);var l=this.buildTree(a,n);var r=new Array(0);while(r.length<t+i){var d=l;while(!d.isLeaf){d=e.ReadBit()?d.one:d.zero}var h=d.index;switch(true){case h<=15:r.push(h);break;case h===16:var c=e.ReadLSB(2)+3;for(var u=0;u<c;++u)r.push(r[r.length-1]);break;case h===17:var c=e.ReadLSB(3)+3;for(var u=0;u<c;++u)r.push(0);break;case h===18:var c=e.ReadLSB(7)+11;for(var u=0;u<c;++u)r.push(0);break;default:break}}var p=r.slice(0,t);var F=this.buildCodes(p);var f=r.slice(t,t+i);var m=this.buildCodes(f);var g={codesTree:this.buildTree(F,p),distancesTree:this.buildTree(m,f)};return g}readByte(){while(this.bufferPosition>=this.buffer.length){var e=this.decodeItem();if(e==null)return-1;switch(e.itemType){case 0:this.buffer=this.buffer.concat(e.array);break;case 2:this.buffer.push(e.symbol);break;case 3:var t=this.buffer.length-e.distance;for(var i=0;i<e.length;i++)this.buffer.push(this.buffer[t++]);break}}var s=this.buffer[this.bufferPosition++];if(this.bufferPosition>49152){var n=this.buffer.length-32768;if(n>this.bufferPosition)n=this.bufferPosition;this.buffer.splice(0,n);this.bufferPosition-=n}return s}decodeItem(){if(this.state===2)return null;if(this.state===0){this.blockFinal=this.bitReader.ReadBit();var e=this.bitReader.ReadLSB(2);switch(e){case 0:this.bitReader.Align();var t=this.bitReader.ReadLSB(16);var i=this.bitReader.ReadLSB(16);if((t&~i)!==t)throw new Error("Invalid block type 0 length");a={itemType:0,array:new Array(t)};for(var s=0;s<t;++s){var n=this.bitReader.ReadByte();if(n<0)throw new Error("Uncomplete block");a.array[s]=n}if(this.blockFinal)this.state=2;return a;case 1:this.codesTree=this.staticCodes;this.distancesTree=this.staticDistances;this.state=1;break;case 2:var o=this.readDynamicTrees(this.bitReader);this.codesTree=o.codesTree;this.distancesTree=o.distancesTree;this.state=1;break;default:throw new Error("Invalid block type (3)")}}var a={};var l=this.codesTree;while(!l.isLeaf){l=this.bitReader.ReadBit()?l.one:l.zero}if(l.index<256){a.itemType=2;a.symbol=l.index}else if(l.index>256){var r=l.index;if(r>285)throw new Error("Invalid length code");var d=this.encodedLengthStart[r-257];if(this.encodedLengthAdditionalBits[r-257]>0)d+=this.bitReader.ReadLSB(this.encodedLengthAdditionalBits[r-257]);l=this.distancesTree;while(!l.isLeaf){l=this.bitReader.ReadBit()?l.one:l.zero}var h=l.index;var c=this.encodedDistanceStart[h];if(this.encodedDistanceAdditionalBits[h]>0)c+=this.bitReader.ReadLSB(this.encodedDistanceAdditionalBits[h]);a.itemType=3;a.distance=c;a.length=d}else{a.itemType=1;this.state=this.blockFinal?2:0}return a}}})(t=e.ImagingStudyView||(e.ImagingStudyView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var s=e.Frontend.WebClient.DOMUtils;class StudyToolsAttachForm{Create(e,t,n){var o=new Array;var a=document.createElement("div");s.AddClass(a,"section");var l=document.createElement("div");s.AddClass(l,"block");a["burningTools"]=l;var r=new i.Form(l,t[0],n);r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Patient name",width:150,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.Textbox,"patientName",{id:"patientName",readonly:true,width:270,newline:true},{},["readOnlyTextbox"]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Study date",width:150,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.Textbox,"",{id:"studyDate",readonly:true,width:270,newline:true},{},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Study description",width:150,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.Textbox,"studyDescription",{id:"studyDescription",readonly:true,width:270,newline:true},{},["readOnlyTextbox"]));r.AddField(new i.Field(i.EFieldType.Container,"",{id:"idProgressbarContainer",newline:true},{display:"inline-block"},["progressbarContainer"]));r.Render();a.appendChild(l);e.appendChild(a);o.push(a);return o}}t.StudyToolsAttachForm=StudyToolsAttachForm})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var s=e.Frontend.WebClient.DOMUtils;class StudyToolsUploadAnyForm{Create(e,t,n){var o=new Array;var a=document.createElement("div");s.AddClass(a,"section");var l=document.createElement("div");s.AddClass(l,"block");a["burningTools"]=l;var r=new i.Form(l,t[0],n);r.AddField(new i.Field(i.EFieldType.Container,"",{id:"idProgressbarContainer",newline:true},{display:"inline-block"},["progressbarContainer"]));r.Render();a.appendChild(l);e.appendChild(a);o.push(a);return o}}t.StudyToolsUploadAnyForm=StudyToolsUploadAnyForm})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var s=e.Frontend.WebClient.DOMUtils;class StudyToolsUploadEditDemographics{Create(e,t,n){var o=new Array;var a=document.createElement("div");s.AddClass(a,"section");var l=document.createElement("div");s.AddClass(l,"block");a["section2"]=l;var r=new i.Form(l,t[0],n);r.AddField(new i.Field(i.EFieldType.Group,"",{text:"Edit data"},{},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Patient ID",width:170,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.SelectBox,"",{id:"selectPatientID",options:t[0].patientIdOptions,values:t[0].patientIdOptions,value:0,action:t[0].onchangeSelect,width:200},{display:"inline-block","margin-right":"10px"},["dicomFieldSelect"]));r.AddField(new i.Field(i.EFieldType.Textbox,"",{id:"PatientIDTextbox",width:150,newline:true},{},["dicomFieldInput"]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Patient name",width:170,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.SelectBox,"",{id:"selectPatientName",options:t[0].patientNameOptions,values:t[0].patientNameOptions,value:0,action:t[0].onchangeSelect,width:200},{display:"inline-block","margin-right":"10px"},["dicomFieldSelect"]));r.AddField(new i.Field(i.EFieldType.Textbox,"",{id:"PatientNameTextbox",width:150,newline:true},{},["dicomFieldInput"]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Patient DOB",width:170,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.SelectBox,"",{id:"selectDOB",options:t[0].patientDobOptions,values:t[0].patientDobOptions,value:0,action:t[0].onchangeSelect,width:200},{display:"inline-block","margin-right":"10px"},["dicomFieldSelect"]));r.AddField(new i.Field(i.EFieldType.Container,"",{id:"patientDobContainer",newline:true},{width:"150px"},["dicomFieldInput"]));r.AddField(new i.Field(i.EFieldType.Button,"BtnPick",{id:"IdBtnPick",text:"Pick Patient...",newline:true},{},["blue","inline","DTButton"],t[0].actionPickPatient));r.AddField(new i.Field(i.EFieldType.Checkbox,"anonymize",{id:"anonymizeCheck",label:"Anonymize",checked:false,newline:true},{},[],t[0].actionCheckboxChange));r.AddField(new i.Field(i.EFieldType.Button,"BtnUpload",{id:"IdBtnUpload",text:"Upload"},{"margin-right":"15px"},["green","inline","DTButton"],t[0].actionBtnUpload));r.Render();a.appendChild(l);e.appendChild(a);o.push(a);return o}}t.StudyToolsUploadEditDemographics=StudyToolsUploadEditDemographics})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var s=e.Frontend.WebClient.DOMUtils;class StudyToolsUploadMp4{Create(e,t,n){var o=new Array;var a=document.createElement("div");s.AddClass(a,"section");var l=document.createElement("div");s.AddClass(l,"block");a["burningTools"]=l;var r=new i.Form(l,t[0],n);r.AddField(new i.Field(i.EFieldType.Group,"",{text:"Upload MP4"},{},[]));r.AddField(new i.Field(i.EFieldType.Container,"",{id:"VideoInfo",newline:true},{display:"inline-flex"},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{id:"instructions",text:"Click the explore button and select a MP4 file.",newline:true,width:150,colon:true},{display:"block",width:"auto"},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Patient ID",width:150,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.Textbox,"patientId",{id:"patientIdID",width:270,newline:true},{},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Patient name",width:150,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.Textbox,"patientName",{id:"patientNameID",width:270,newline:true},{},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Patient DOB",width:150,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.Container,"",{id:"PatientDOBContainer",width:200,newline:true},{display:"inline-flex"},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{text:"Study description",width:150,colon:true},{display:"inline-block"},[]));r.AddField(new i.Field(i.EFieldType.Textbox,"studyDescription",{id:"studyDescriptionID",width:270,newline:true},{},[]));r.AddField(new i.Field(i.EFieldType.Button,"BtnPick",{id:"IdBtnPick",text:"Pick Patient...",newline:true},{},["blue","inline","DTButton"],t[0].actionPickPatient));r.AddField(new i.Field(i.EFieldType.Label,"attachMessage",{id:"uploadMp4Message",text:"",newline:true,width:150,colon:true},{},["desktopToolsMessages"]));r.AddField(new i.Field(i.EFieldType.Container,"",{id:"idProgressbarContainer",newline:true},{display:"inline-block"},["progressbarContainer"]));r.AddField(new i.Field(i.EFieldType.Button,"BtnUpload",{id:"IdButtonUpload",text:"Upload"},{},["green","inline","DTButton"],t[0].actionBtnUploadMp4));r.AddField(new i.Field(i.EFieldType.Button,"BtnUploadClear",{id:"IdButtonUploadClear",text:"Clear"},{"margin-left":"10px"},["red","inline","DTButton"],t[0].actionBtnClearMp4Info));r.AddField(new i.Field(i.EFieldType.Button,"BtnUploadCancel",{id:"IdButtonUploadCancel",text:"Cancel"},{"margin-left":"10px"},["red","inline","DTButton"],t[0].actionBtnCancelMp4));r.Render();a.appendChild(l);e.appendChild(a);o.push(a);return o}}t.StudyToolsUploadMp4=StudyToolsUploadMp4})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var s=e.Frontend.WebClient.DOMUtils;class StudyToolsUploadProgress{Create(e,t,n){var o=new Array;var a=document.createElement("div");s.AddClass(a,"section");var l=document.createElement("div");s.AddClass(l,"block");a["section1"]=l;var r=new i.Form(l,t[0],n);r.AddField(new i.Field(i.EFieldType.Group,"",{text:"Upload progress"},{},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{id:"idLabelNumberFilesProgress",text:"Files",newline:true},{display:"inline-block"},["breadCrumbText"]));r.AddField(new i.Field(i.EFieldType.Container,"",{id:"idContainerListProgress",newline:true},{width:"calc(100% - 10px - 1em)",height:"calc(100vh - 360px)"},["containerListFiles","containerListProgress","dottedBorder"]));r.AddField(new i.Field(i.EFieldType.Container,"",{id:"idProgressbarUploadContainer",newline:true},{display:"inline-block"},["progressbarContainer"]));r.AddField(new i.Field(i.EFieldType.Button,"BtnCancelUpload",{id:"IdBtnCancelUpload",text:"Cancel"},{},["red","inline","DTButton"],t[0].actionBtnCancelUpload));r.Render();a.appendChild(l);e.appendChild(a);o.push(a);return o}}t.StudyToolsUploadProgress=StudyToolsUploadProgress})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var s=e.Frontend.WebClient.DOMUtils;class StudyToolsUploadSelectFolder{Create(e,t,n){var o=new Array;var a=document.createElement("div");s.AddClass(a,"section");var l=document.createElement("div");s.AddClass(l,"block");a["section1"]=l;var r=new i.Form(l,t[0],n);r.AddField(new i.Field(i.EFieldType.Group,"",{text:"Upload files"},{},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{id:"instructions",text:"Click the explore button and select a folder with dicom files.",newline:true},{display:"block"},[]));r.AddField(new i.Field(i.EFieldType.File,"",{id:"dicomUpload",width:150},{display:"none"},[]));r.AddField(new i.Field(i.EFieldType.Label,"",{id:"idLabelNumberFiles",text:"Files",newline:true},{display:"inline-block"},["breadCrumbText"]));r.Render();a.appendChild(l);var l=document.createElement("div");s.AddClass(l,"block");a["section2"]=l;var r=new i.Form(l,t[0],n);r.AddField(new i.Field(i.EFieldType.Container,"",{id:"idContainerListFolders",newline:true},{width:"calc(100% - 10px)"},["containerListFiles","dottedBorder"]));r.AddField(new i.Field(i.EFieldType.Container,"",{id:"idProgressbarContainer",newline:true},{display:"inline-block"},["progressbarContainer"]));r.AddField(new i.Field(i.EFieldType.Button,"BtnNextEditDemographicsForm",{id:"IdBtnNext",text:"Next"},{},["green","inline","DTButton"],t[0].actionBtnNextSelectFolder));r.AddField(new i.Field(i.EFieldType.Button,"BtnCancelUpload",{id:"IdBtnCancelUpload",text:"Next"},{display:"none","margin-left":"10px"},["red","inline","DTButton"],t[0].actionBtnCancelUpload));r.Render();a.appendChild(l);e.appendChild(a);o.push(a);return o}}t.StudyToolsUploadSelectFolder=StudyToolsUploadSelectFolder})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){let t;(function(e){e[e["None"]=0]="None";e[e["Uploading"]=1]="Uploading";e[e["Uploaded"]=2]="Uploaded";e[e["Cancel"]=3]="Cancel";e[e["Pause"]=4]="Pause"})(t=e.EStatusOperation||(e.EStatusOperation={}));let i;(function(e){e[e["Folder"]=0]="Folder";e[e["File"]=1]="File"})(i=e.UploadType||(e.UploadType={}));let s;(function(e){e[e["Uploaded"]=0]="Uploaded";e[e["Progress"]=1]="Progress";e[e["Error"]=2]="Error";e[e["None"]=3]="None"})(s=e.EStatusFile||(e.EStatusFile={}));let n;(function(e){e[e["FileSelector"]=0]="FileSelector";e[e["DicomEdit"]=1]="DicomEdit";e[e["UploadProgress"]=2]="UploadProgress"})(n=e.EUploadDicomSection||(e.EUploadDicomSection={}));e.DICOM_TAG_PATIENT_ID="0010_0020";e.DICOM_TAG_PATIENT_DOB="0010_0030";e.DICOM_TAG_PATIENT_NAME="0010_0010";e.DICOM_TAG_STUDY_ID="0020_000D";e.DICOM_TAG_STUDY_DESCRIPTION="0008_1030";e.DICOM_TAG_STUDY_DATE="0008_0020";e.DICOM_TAG_MODALITY="0008_0060";e.DICOM_TAG_SOP_CLASS_UID="0002_0002";e.DICOM_TAG_DIRECTORY_RECORD_SEQUENCE="0004_1220";e.DICOM_TAG_DIRECTORY_RECORD_TYPE="0004_1430";e.DICOM_TAG_REFERENCED_FILE_ID="0004_1500";e.UPLOAD_VIEW_DICOM="dicom";e.UPLOAD_VIEW_MP4="mp4";e.UPLOAD_VIEW_ATTACH="attach";e.UPLOAD_VIEW_FILE="file"})(t=e.UploadView||(e.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class ResourceBag{}ResourceBag.UploadViewCss=`.UploadPane{overflow:auto}.UploadPane .dicomFieldInput{display:none}.UploadPane .progressbarContainer{height:20px;width:500px;border:2px solid #fff;border-radius:3px;box-shadow:1px 1px 0px rgba(0,0,0,.25)}.UploadPane .progressbar{height:20px;width:0px;background:linear-gradient(270deg, #2ECC71, #b9ffc5, #2ECC71, #b9ffc5, #2ECC71);background-size:1000px 100%;animation:greenLoading 1.5s linear infinite}.UploadPane .progressbar.stop{background:#2ecc71;animation:none}@keyframes greenLoading{0%{background-position:0% 50%}100%{background-position:-100% 50%}}.UploadPane .containerListFiles{margin-top:10px;overflow:auto;border:1px dotted var(--color-border-dotted);min-height:100px}.UploadPane .containerListProgress{padding-left:1em;list-style:none}.UploadPane .containerListProgress li{margin-bottom:10px;display:flex;align-items:center}.UploadPane .containerListProgress li span{margin-right:4px}.UploadPane .containerListProgress li img{width:24px}.UploadPane .loadingFileBarContainer{height:15px;border:2px solid #fff;border-radius:3px;display:inline-block;width:150px;top:5px;position:relative;transform:translateY(-2px)}.UploadPane .progressUpload{height:100%;width:0px;background:linear-gradient(270deg, #2ECC71, #b9ffc5, #2ECC71, #b9ffc5, #2ECC71);background-size:1000px 100%;animation:greenLoading 1.5s linear infinite}@keyframes greenLoading{0%{background-position:0% 50%}100%{background-position:-100% 50%}}.invisibleInputFile{width:.1px;height:.1px;opacity:0;overflow:hidden;position:absolute;z-index:-1}.rotate{animation:loading 3s linear infinite}@keyframes loading{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}`;ResourceBag.Icons8Cancel64Png="data:image/png;base64,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";ResourceBag.Icons8Clock64Png="data:image/png;base64,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";ResourceBag.Icons8Delete32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAOdJREFUWAntldEJwzAMRO3SMTpioWt0gK5bXKskIBtZ9ukK/XEgJJbu3tn6SFLa155AN4FSyrPe965ML4Up7CnoEL5/uQmYCRucY4VZYaPaDM1gAIxXnSGlCCjiaUL7BQJEtH2Ou14Br2jckFnTC/B6My7Ut4KsGgRFxTpQv6McSq+Cqa/mhdrFv8zq9PKDkZuaAnQOK9CqQdBVsRfk9Vb5rm4lYEXjhoyaCBjRjvKaegQY8TSh54IBMd5vPg2olDAjbDxHp54wCzaosNGrx7waplutPXLOL6MXKgmrbkK8wt7XnkAzgQ+2xtFqX+VZZgAAAABJRU5ErkJggg==";ResourceBag.Icons8Ok64Png="data:image/png;base64,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";ResourceBag.Icons8OpenedFolder32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAABuklEQVRYheXWPWtUQRSH8eesa/AFX4poE1SUFCLorqSxsRRMo0UstQqIH8JG8Av4IQTBxk5bwSJNYDcxIaCkSCEGlESIghHzWOzeeHdZ18jmnsbTzTDc/2/ODMOF/71CHQPuAGeGrJuLiNdVAZ4D08D6kHXngLsR8WzfBep3deYvax6rG+rEfueHKjAdEa+GAA4Cb4BJYHPEzE3gYUS8BKjvSRnxQ70B3AKOjAi4DjxVT0XET+zUzRE/uudSp7qZ4/CHDqgngFpFhmPlQQ9AvQq8AM5WFF6u9+qD/g48ApaB2QTAbeBJzx1Q19V7CeGo99W1WmliAjgNtDMAQANo1fomtoGVREC7H7AUEdtVJ6sBXB4EyGr/BeA4fUfQTAQ0gS1gtQAcpvPOt5IADWAhInYKwBXgALCYCGjD7+e2AaxFxOckwO5xlwEp56+epPP31SoDzmcB6GxW4G0ZEORdwCbwLiK+lgGQ/AQXgwKwBawmAnY3WwDaEbFTdbJaBy4NBFQd3q2LwCEGHMFCEqABfIqID8VEHdgAJtWpBMAMMN8zo86q38ypj+q1cn50EWPA0YQOfMm47P9UvwAPixkbBUomPAAAAABJRU5ErkJggg==";ResourceBag.Icons8Pause32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACuSURBVFhH7Y4xCsJAEEX3BjaWktojWFinsbYW7DyJZ7DSJo0X8DpaCyLY7/pmHWEJ2wSbIP/BJ8zMz/KCEKMmxrglj0quXskwL3r3MjOvDYefd+SeUlp/w7zn+/RKhnlJEreNdSz2r+2g8dpwXODmY4Z5xaNVAZj4ynbNZyUBCUhAAhKQgAQk8AcCL3IocuHRqgC3Y9HrbAc/CbQ8cK7k5JUM87x3LzP1mhBjJIQ3mLBMg7WH4VgAAAAASUVORK5CYII=";ResourceBag.Icons8Plan32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAArFJREFUWAm1l79rFUEQx99TEZUUGlCCIJJS0EIUO0VECRJJETCFotgpCNpZpNc/QYw2QkRCAilsQrBLCjEgdtEqEm1SpAzxB8bn53vuXvbu9t7uvpwDw/zamfnu7Lu9e61WJHU6nQU4lhYiy7badiGV96Dfgq/Du6zfkefQ5+GXjs+n3sE5BC95gn/wzcCT7Xb7t+JqamkM5Sn8At6yTkeeRF8hUSBqiY1cILgJf/Is2o1PPX7CrxV3ARzB/kKDBxQ5gH5cCxw67+ghdY0Fz0uLVqm9Se3L+NUrIxeA9UmegX3n2HX3TgHlLzu2VE1mseQrTKAck30C/m4C08j77OCmsevEQQI6/zGzYD/SdxxZuG4CJrf1VWOTQePHiAEbCMg18la1xhxn7fIQgDyRgm9yo0ElGkBdT3aos33oiT8D9FuPv+BKAkCz02QPUnjWqaJHat2xrfrDKt1kEgAKXYVH4RwAYN5ji3uiKABm52p+ER7AHkfqUppC1wU1ApdpjvjHsrNsRwEgaRDWzvUUHDL6O+QUfMzYiAJ9xmoGgDnzWbPzUeyzthX6HLq4J4qdgC2+gqKd5wSooxincse2sgy4b9umX0sCQEGNXOzSJYxJ12H0u8jy+6CyLAlAJRsHoF4hxD1RFADGvI/qfYkdNgAXvAuiAND4NjyRCKDRI9DF8yERQPYyCuVETYBR6qr1Xbeh+sF4FAB+Azeo9CRYrbhgHODZZ1fRXbSiAJCiGy0VQPAWFJQoAOxEXzS1XzUq1CtFAeAIrtDgXmKTRr8H9Dyn/giDd4A2FDUBjkBfs5UvWhXYKYUAPGL8v3bYZG+3/DoAGyTp4rnWLTkhplqqWSEvAEauRyh/51eyGnS4AKQfZuTDyOyPY4N9bKmsB4bb91+Mxv3wBLwF/y9SbfXot4j+AnduMjnJzAGnAAAAAElFTkSuQmCC";ResourceBag.Icons8Undo32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGBSURBVFhH7Za9SsNgFIbj4F9RB0FQKQ5VoUbdnRwcumkRJ0G8AEcdvAGvwMFBvAknMRcg4lCQrh1EBRUcBH/AJfH54K04FMyXlBMEH3hovtO+3zlN2qbBnyFJkh4d2kPzShzHN7iqkh00ncZbPGeQkso2/GgeFdX8rqjmM0U2ny26+T1e4wIDVH5xnNf1K54fNmuwqTfk3rGJx7iFg9rSD4Lz+IRX7FvFTu/6W163iMu4hvt4Sv2Fx2c84HhAW6eHYHsIt1mfyqkhM0R2Bx+wybqqp9JDMNcQDrJjGKH7QJdVTg+hEHMNQa5E/hIvOPa/l2iIx5xDuM/KJ66r5Ec3hiB7gmda+kN4TkNsquQFuTp+YLavp8OFM11HIDtB1v1ehCrZQu9eDbCikj00d9S0tIXGwzoDSyrZQuPQDQBTKtnCABv4xgDF/LGl+RFGWtpD8xbuaWkLjdvX3/+u2A0Y4BAbWtpC41F8xW2VbKHxLrY4/ZluYrmh+QhOavlPB4LgC+v3IICml9ZoAAAAAElFTkSuQmCC";ResourceBag.Icons8UploadToCloud32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAJmSURBVFhH7ZZNSFRRFMcn+iBbDGgKIkGLFiNR0ULMFi4EBYNAcDNU7ooWLqKRNkOhqxIJDUJBEEGiVbZwIZIbW7SpZqFW4xcTNCC6CQ0kIqeZ6XeuZ5xm/Hj3TU9wMX/48e457/zvPe/NfW+erygvlEql/FCVTqePa+rgxYLn4DnEWdiIsWgWuqBMS70V6xxh8hD8ho9wD+rgAjRAJ8RgHW6ozTsxaR9swE1N7RBNnuB8GBJwX9PuhbkMzsuEGt+Cn3DFFDiIujZI4G/UlJ0wnYFxSGKW31Zu9wCsQruWWYn6QYgyzVFN7S+K5arjEIFmOAvX4TPEmOiYllqJ+kp8mxzt7gLFPbAAJZoykisg59fQlfC9hV4N9xeFUQhp6ImYrx/GNNxdFATgNSThqqY9EfN1wycIaCpXsiC3+Ae8YnxR056JOYOwBH/gPWSfIhYtJbEGTzVlLTynZW9o6CjqK0Denr/gWib5GBaZqJDdPSd3za0X3yNYw1cqgbw2w3rOSv8snpGrJqQW/zfokAY2oVXPOQqzLD4P0/AF3pAz+8dNE/iGYFQG32HP93q+qJVNNM1i5RzfgezwGmmC4xMtcxS18p8yIYMJzCOadxS1jXjMXy1H04DmqxlfkrGNqJ2CZzJoAfkZrM0Z4dluwI3w1IJo631D9/L8r0CdSViKetcNsNZlPMvwQlMmeRJGSIom4SHx3XzIB9ViRJzTAGP5NLuzh/cByJtWvhFGyZ1SW1acqAfZnR/g6y5EMG5/9xHnNMA5ubpFrc1nBl5Ck5b/v5isoD3gmYoNHIYGhuG2hkUVVYB8vr+s9h3EDxEplwAAAABJRU5ErkJggg==";ResourceBag.UploadLanguageJson={en:{cancel:"Cancel",open:"Open",upload:"Upload",pause:"Pause",localBack:"Back"},es:{cancel:"Cancelar",open:"Abrir",upload:"Subir",pause:"Pausar",localBack:"Atrás"}};e.ResourceBag=ResourceBag})(t=e.UploadView||(e.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class UploadController{constructor(t,i,s){this.parent=t;this.viewMode=s["mode"];this.specView=i;this.parameters=s;this.setSpecParameters(s);this.fileExtensions=decodeURIComponent(s["fileExtensions"]).split("|")||[];this.accept=decodeURIComponent(s["accept"]);this.statusOperation=e.EStatusOperation.None;this.IsUploading=false}SetBackButtonState(e){let t;t=Array.from(document.querySelectorAll(".mainToolbar .toolbarButton")).filter((e=>{var t;return e.dataset.plugin==="workstation"&&((t=e.innerText)===null||t===void 0?void 0:t.trim())==="Back"}));if(t.length===1)t[0].style.display=e?"inline-block":"none"}GetExtensionName(e){try{const t=e.substring(e.lastIndexOf(".")+1);if(t)return t.toLocaleLowerCase();return""}catch(e){return""}}GetFileSize(e){let t;if(e.size>1024*1024)t=(Math.round(e.size*100/(1024*1024))/100).toString()+" MB";else t=(Math.round(e.size*100/1024)/100).toString()+" KB";return t}setSpecParameters(e){if(e){for(const t in e){if(Object.prototype.hasOwnProperty.call(e,t)){const i=e[t];if(this.specView[t]){switch(t){case"Extensions":case"Mimes":this.specView[t]=JSON.parse(decodeURIComponent(i));break;default:this.specView[t]=decodeURIComponent(i)}}}}}}}e.UploadController=UploadController})(t=e.UploadView||(e.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var s=i.Utils;var n=i.DOMUtils;var o=e.ClientViews.ImagingStudyView.DicomParser;var a=e.Frontend.WebClient.CalendarUtils;const{div:l}=n;class UploadAttachmentController extends t.UploadController{constructor(e,n,o){super(e,n,o);this.loadedFiles=[];this.uploadProgress=e=>{if(e.lengthComputable){const i=Math.round(e.loaded*100/e.total);this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.Progress;this.anyFiles[this.indexFileUpload].Percent=i;let s=0;for(let e=0;e<this.anyFiles.length;e++){s+=this.anyFiles[e].Percent}this.updateProgressBar(s/this.anyFiles.length)}else{s.DebugConsoleLog("unable to compute")}};this.uploadComplete=e=>{if(this.abortUpload)return;let s=true;if(e.target.status===200){this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.Uploaded;this.indexFileUpload+=1}else{this.anyFiles[this.indexFileUpload].Tries+=1;if(this.anyFiles[this.indexFileUpload].Tries>=2){this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.Error;this.anyFiles[this.indexFileUpload].Percent=100;this.indexFileUpload+=1;const i=e.target.getResponseHeader("X-Error");if(i){this.listFilesOnContainer(i)}else{this.listFilesOnContainer("Could not upload")}}else{this.anyFiles[this.indexFileUpload].Percent=0;this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.Error}}if(this.indexFileUpload===this.anyFiles.length){if(!this.anyFiles.some((e=>e.Status===t.EStatusFile.Error)))this.statusOperation=t.EStatusOperation.Uploaded;else i.Toaster.ShowToast("Error attaching some files.",i.Colors.Orange,3.5)}else{s=false}let n=0;for(let e=0;e<this.anyFiles.length;e++){n+=this.anyFiles[e].Percent}this.updateProgressBar(n/this.anyFiles.length);this.listFilesOnContainer();if(s){this.resetStatusFiles();this.statusOperation=t.EStatusOperation.None;this.indexFileUpload=0;this.Selecting=true;this.IsUploading=false;this.buttonUpload.disabled=false;this.buttonCancel.disabled=true;this.progressBarUpload.classList.add("stop");i.Toaster.ShowToast("Operation completed.",i.Colors.Emerald,3)}else{this.uploadFiles()}};this.uploadFailed=e=>{this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.None;this.listFilesOnContainer();i.Toaster.ShowToast("There was an error attempting to upload the file.",i.Colors.Pomegranate,3)};this.uploadAborted=e=>{this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.None;this.listFilesOnContainer();this.statusOperation=t.EStatusOperation.Cancel;i.Toaster.ShowToast("The upload has been canceled by the user or the browser dropped the connection.",i.Colors.BelizeHole,3)};this.indexFileUpload=0;this.anyFiles=[];this.abortUpload=false;this.resourceData=this.createResourceData(this.parameters);this.BuildUI()}BuildUI(){const e=setTimeout((()=>{this.SetBackButtonState(false);clearTimeout(e)}),250);const doUpload=()=>{const e=Math.floor(Math.random()*1e3)+1;this.seriesRandomNumber=e;this.abortUpload=false;this.progressBarUpload.classList.remove("stop");this.buttonUpload.disabled=true;this.buttonCancel.disabled=false;this.uploadFiles()};const doCancelUplaod=()=>{this.IsUploading=false;this.Selecting=true;if(this.xhr)this.xhr.abort();this.abortUpload=true;this.progressBarUpload.style.width="0%";this.buttonUpload.disabled=false;this.buttonCancel.disabled=true};this.sectionFilesForm=l({});const i={actionBtnNextSelectFolder:()=>doUpload(),actionBtnCancelUpload:()=>doCancelUplaod()};const s=(new t.StudyToolsUploadSelectFolder).Create(this.sectionFilesForm,[i]);this.progressBarScan=l({className:"progressbar"});const n=this.sectionFilesForm.querySelector("#idProgressbarContainer");n.appendChild(this.progressBarScan);this.parent.appendChild(this.sectionFilesForm);this.inputFile=this.sectionFilesForm.querySelector("#dicomUpload");this.inputFile.type="file";this.inputFile.name="select";this.inputFile.accept=this.accept;this.inputFile.multiple=true;this.Selecting=true;this.inputFile.addEventListener("change",this.inputFileHandler.bind(this));this.buttonUpload=this.sectionFilesForm.querySelector("button#IdBtnNext");this.buttonCancel=this.sectionFilesForm.querySelector("button#IdBtnCancelUpload");this.buttonUpload.disabled=true;this.buttonCancel.disabled=true;this.buttonCancel.style.display="inline-block";this.labelNumberFiles=this.sectionFilesForm.querySelector("#idLabelNumberFiles");this.BuildUIAttachment()}BuildUIAttachment(){this.buttonUpload.innerText="Upload";this.buttonCancel.innerText="Cancel";this.sectionAttachUploadForm=l({});const e=this.sectionFilesForm.querySelector("h2");const i=(new t.StudyToolsAttachForm).Create(this.sectionAttachUploadForm,[{}]);this.sectionFilesForm.appendChild(this.sectionAttachUploadForm);n.InsertAfter(this.sectionAttachUploadForm,e);this.progressBarUpload=l({className:"progressbar"});const s=this.sectionAttachUploadForm.querySelector("#idProgressbarContainer");s.appendChild(this.progressBarUpload);const o=this.sectionAttachUploadForm.querySelector("#patientName");const r=this.sectionAttachUploadForm.querySelector("#studyDate");const d=this.sectionAttachUploadForm.querySelector("#studyDescription");const h=this.resourceData["studyDate"];const c=a.GetFormattedDateTimeFromDB(h,"YYYY-MM-DD");const u=c.split(" ");const p=u.length>1?u[0]:"";const F=this.resourceData["patientName"]||"";const f=this.resourceData["studyDescription"]||"";r.value=p;o.value=F;d.value=f}GetContainerListFileHtml(){return this.parent.querySelector("#idContainerListFolders")}CleanAction(){if(this.xhr)this.xhr.abort();this.resetStatusFiles();this.statusOperation=t.EStatusOperation.None;this.inputFile.value="";this.indexFileUpload=0;this.anyFiles=[];this.listFilesOnContainer();this.progressBarScan.style.width="0px"}OpenAction(){if(this.IsUploading)return;this.CleanAction();this.inputFile.click()}OnWindowResize(){}GoToFormSelectFolder(){}inputFileHandler(e){[this.progressBarUpload,this.progressBarScan].forEach((e=>{e.classList.remove("stop");e.style.width="0%"}));this.fillFilesList(e);this.processFilesList((()=>{this.listFilesOnContainer();const e=setTimeout((()=>{window.dispatchEvent(new Event("resize"));clearTimeout(e)}),200)}))}createResourceData(e){const t={};["studyDescription","patientName","studyDate","studyUid","patientId"].forEach((i=>{const s=e[i];const n=s&&s!=="undefined"?decodeURIComponent(s):"";t[i]=n}));return t}fillFilesList(e){const i=e.target.files;for(let e=0;e<i.length;e++){const s=this.fileExtensions.some((t=>t.match(this.GetExtensionName(i[e].name))!==null));if(s){this.anyFiles.push({Name:i[e].name,File:i[e],Status:t.EStatusFile.None,Percent:0,Tries:0,Skip:false})}}}getStudyId(e){const t=e.substring(8,e.length);return t}getMimeByExtension(e){let t="";const i=this.specView["Mimes"];for(let s=0;s<this.fileExtensions.length;s++){const n=this.GetExtensionName(e);if(n===this.fileExtensions[s]){t=i[s];break}}return t}listFilesOnContainer(e){const i=document.createElement("ul");const s=this.GetContainerListFileHtml();if(this.anyFiles.length>0){for(let e=0;e<this.anyFiles.length;e++){const s=document.createElement("li");s.style.marginBottom="10px";s.innerHTML=(this.anyFiles[e].File["webkitRelativePath"]||this.anyFiles[e].File["name"])+"  -  "+this.GetFileSize(this.anyFiles[e].File);if(this.anyFiles[e].Status===t.EStatusFile.Uploaded){s.innerHTML+=" <span style='color:green'>✓</span>"}else if(this.anyFiles[e].Status===t.EStatusFile.Error){s.innerHTML+=" <span style='color:red'>X</span>"}i.appendChild(s)}this.labelNumberFiles.innerHTML="Files: "+this.anyFiles.length;s.innerHTML="";s.appendChild(i)}else{this.labelNumberFiles.innerHTML="Files: 0";s.innerHTML=""}}resetStatusFiles(){for(var e=0;e<this.anyFiles.length;e++){this.anyFiles[e].Status=t.EStatusFile.None;this.anyFiles[e].Tries=0;this.anyFiles[e].Percent=0}}updateProgressBar(e){this.progressBarUpload.style.width=e<100?`${e-10}%`:"100%"}uploadFiles(){this.xhr=new XMLHttpRequest;this.xhr.upload.addEventListener("progress",this.uploadProgress,false);this.xhr.addEventListener("load",this.uploadComplete,false);this.xhr.addEventListener("error",this.uploadFailed,false);this.xhr.addEventListener("abort",this.uploadAborted,false);let e;let n=false;if(this.anyFiles[this.indexFileUpload]){const t=this.resourceData["studyUid"];const s=this.getStudyId(t);const n=this.resourceData["patientId"];const o=this.seriesRandomNumber;const a=this.anyFiles[this.indexFileUpload].Name;e=`${i.PlatformContext.PlatformUri}/studytools/uploader?op=attachFile&filename=${a}&studyUid=${s}&seriesUid=${o}&patientId=${n}`}this.xhr.open("POST",e);this.xhr.setRequestHeader("Authorization","Bearer "+sessionStorage["token"]);if(!n){try{if(this.anyFiles.length>0&&this.indexFileUpload<this.anyFiles.length){if(this.statusOperation!==t.EStatusOperation.Pause){const e=this.getMimeByExtension(this.anyFiles[this.indexFileUpload].File.name);this.anyFiles[this.indexFileUpload].File["Content-Type"]=e;const i=new Blob([this.anyFiles[this.indexFileUpload].File],{type:e});if(this.anyFiles[this.indexFileUpload].Status===t.EStatusFile.None||this.anyFiles[this.indexFileUpload].Status===t.EStatusFile.Error){this.xhr.send(this.anyFiles[this.indexFileUpload].File);this.IsUploading=true;this.Selecting=false}}}}catch(e){s.DebugConsoleLog("Error send data");s.DebugConsoleLog(e)}}else{i.Toaster.ShowToast("Custom field empty.",i.Colors.Orange,3)}}processFilesList(e){let i=0;this.loadedFiles=[];this.progressBarScan.classList.remove("stop");if(this.anyFiles.length>0){for(let s=0;s<this.anyFiles.length;s++){const n=new FileReader;n.onload=s=>{this.loadedFiles.push(n.result);const a=new Uint8Array(n.result);const l=new o(a);let r=s.currentTarget.indexFile;const d=l.DicomTags[t.DICOM_TAG_STUDY_ID];this.anyFiles[r].studyUid=d;i++;if(i===this.anyFiles.length){this.getDicomInfo(e)}};let a;a=this.anyFiles[s].File.slice(0,5e3);n["indexFile"]=s;n.readAsArrayBuffer(a)}}}getDicomInfo(e){this.studyInfo={studyUid:[],modality:[],patientID:[],patientName:[],patientDob:[]};let i=0;const process=n=>{const o=n.DicomTags[t.DICOM_TAG_STUDY_ID];const a=n.DicomTags[t.DICOM_TAG_MODALITY];const l=n.DicomTags[t.DICOM_TAG_PATIENT_ID];const r=s.FormatValue(n.DicomTags[t.DICOM_TAG_PATIENT_NAME]);const d=n.DicomTags[t.DICOM_TAG_PATIENT_DOB];if(o&&this.studyInfo["studyUid"].indexOf(o)===-1)this.studyInfo["studyUid"].push(o);if(a&&this.studyInfo["modality"].indexOf(a)===-1)this.studyInfo["modality"].push(a);if(l&&this.studyInfo["patientID"].indexOf(l)===-1)this.studyInfo["patientID"].push(l);if(r&&this.studyInfo["patientName"].indexOf(r)===-1)this.studyInfo["patientName"].push(r);if(d&&this.studyInfo["patientDob"].indexOf(s.FormatDateFromDicomTag(d))===-1)this.studyInfo["patientDob"].push(s.FormatDateFromDicomTag(d));i++;if(i===this.loadedFiles.length){if(e)e();this.buttonUpload.disabled=false;this.buttonCancel.disabled=true;this.progressBarScan.classList.add("stop");this.progressBarScan.style.width="100%";this.studyInfo["patientID"].push("Custom");this.studyInfo["patientName"].push("Custom");this.studyInfo["patientDob"].push("Custom");this.studyInfo["patientDob"].push("Empty");this.studyInfo["patientID"].push("Empty");this.studyInfo["patientName"].push("Empty")}};let n=new Array(this.anyFiles.length);const a=this.anyFiles.map((e=>e.File.size)).reduce(((e,t)=>e+t),0);for(let e=0;e<this.loadedFiles.length;e++){const i=new Uint8Array(this.loadedFiles[e]);const s=new o(i);if(s.reachedPixelData){process(s)}else{const i=new FileReader;i.onload=e=>{const s=new Uint8Array(i.result);const n=new o(s);const a=e.currentTarget.indexFile;const l=n.DicomTags[t.DICOM_TAG_STUDY_ID];this.anyFiles[a].studyUid=l;process(n)};i.addEventListener("progress",(t=>{n[e]=t.loaded;const i=n.reduce(((e,t)=>e+t),0);this.progressBarScan.style.width=i/a*100+"%"}));i["indexFile"]=e;i.readAsArrayBuffer(this.anyFiles[e].File)}}}}t.UploadAttachmentController=UploadAttachmentController})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(i){var s=e.Frontend.WebClient;var n=s.Utils;var o=s.DOMUtils;var a=e.ClientViews.ImagingStudyView.DicomParser;const{div:l,span:r,option:d,input:h,table:c,tbody:u,thead:p,tr:F,td:f,th:m,ul:g,li:y,textNode:A,img:C}=o;class UploadDicomController extends i.UploadController{constructor(e,t,o,a){super(e,t,o);this.loadedFiles=[];this.uploadProgress=e=>{if(e.lengthComputable){const t=Math.round(e.loaded*100/e.total);this.anyFiles[this.indexFileUpload].Status=i.EStatusFile.Progress;this.anyFiles[this.indexFileUpload].Percent=t;let s=0;this.selectedStudies.forEach((e=>{s+=this.studiesMetadata[e].length}));let n=0;for(let e=0;e<this.anyFiles.length;e++){if(this.selectedStudies.length>0){if(this.selectedStudies.includes(this.anyFiles[e].studyUid))n+=this.anyFiles[e].Percent}else{n+=this.anyFiles[e].Percent}}if(this.selectedStudies.length>0){this.updateProgressBar(n/s)}else{let e=0;this.anyFiles.forEach((t=>{if(!t.Skip)e++}));this.updateProgressBar(n/e)}}else{n.DebugConsoleLog("unable to compute")}};this.uploadComplete=e=>{if(this.abortUpload)return;let t=true;if(e.target.status===200){this.changeFileStatusOnList(this.indexFileUpload,i.EStatusFile.Uploaded);this.anyFiles[this.indexFileUpload].Status=i.EStatusFile.Uploaded;this.indexFileUpload+=1}else{this.anyFiles[this.indexFileUpload].Tries+=1;if(this.anyFiles[this.indexFileUpload].Tries>=2){const t=e.target.getResponseHeader("X-Error");this.anyFiles[this.indexFileUpload].Status=i.EStatusFile.Uploaded;this.changeFileStatusOnList(this.indexFileUpload,i.EStatusFile.Uploaded,t);this.indexFileUpload+=1;if(t){this.anyFiles[this.indexFileUpload-1].Status=i.EStatusFile.Error;this.changeFileStatusOnList(this.indexFileUpload-1,i.EStatusFile.Error,t);this.listFilesOnContainer(t)}else this.listFilesOnContainer("Could not upload")}else{this.anyFiles[this.indexFileUpload].Percent=0;this.anyFiles[this.indexFileUpload].Status=i.EStatusFile.Error;this.changeFileStatusOnList(this.indexFileUpload,i.EStatusFile.Error)}}for(let e=0;e<this.anyFiles.length;e++){if(this.selectedStudies.length>0){if(this.selectedStudies.includes(this.anyFiles[e].studyUid)&&this.anyFiles[e].Status!==i.EStatusFile.Uploaded)t=false}else{if(this.anyFiles[e].Status!==i.EStatusFile.Uploaded)t=false}}if(t){this.operationCompleted()}else{this.uploadFiles()}};this.uploadFailed=e=>{this.anyFiles[this.indexFileUpload].Status=i.EStatusFile.None;this.changeFileStatusOnList(this.indexFileUpload,i.EStatusFile.Error);this.listFilesOnContainer();this.uploadFiles()};this.uploadAborted=e=>{this.anyFiles[this.indexFileUpload].Status=i.EStatusFile.None;this.listFilesOnContainer();this.statusOperation=i.EStatusOperation.Cancel;s.Toaster.ShowToast("The upload has been canceled by the user or the browser dropped the connection.",s.Colors.BelizeHole,3)};this.indexFileUpload=0;this.anyFiles=[];this.selectedPatients=[];this.selectedStudies=[];this.abortUpload=false;this.IsUploading=false;this.additionalFiles=[];this.view=a;this.BuildUI()}BuildUI(){const e=setTimeout((()=>{this.SetBackButtonState(false);clearTimeout(e)}),250);const doSelectFolder=()=>{this.abortUpload=false;if(this.isValidDicomUpload()){this.BuildUIDicomDemographics();this.BuildUIUploadProcess();this.GoToDicomEditForm();this.toggleUploadDicomInputs();this.nextButton.disabled=true;this.Selecting=false;this.SetBackButtonState(true)}};const t={actionBtnNextSelectFolder:()=>doSelectFolder()};this.sectionFilesForm=l({});const s=(new i.StudyToolsUploadSelectFolder).Create(this.sectionFilesForm,[t]);this.progressBarScan=l({className:"progressbar"});const n=this.sectionFilesForm.querySelector("#idProgressbarContainer");n.appendChild(this.progressBarScan);this.parent.appendChild(this.sectionFilesForm);this.inputFile=this.sectionFilesForm.querySelector("#dicomUpload");this.inputFile.type="file";this.inputFile.name="select";this.inputFile.accept=this.accept;this.inputFile["webkitdirectory"]=true;this.Selecting=true;this.inputFile.addEventListener("change",this.inputFileHandler.bind(this));this.nextButton=this.sectionFilesForm.querySelector("button");this.nextButton.disabled=true;this.labelNumberFiles=this.sectionFilesForm.querySelector("#idLabelNumberFiles");this.currentSection=i.EUploadDicomSection.FileSelector}BuildUIDicomDemographics(){var e;if(this.sectionDicomEditForm)this.sectionDicomEditForm.parentElement.removeChild(this.sectionDicomEditForm);if(((e=this.selectedPatients)===null||e===void 0?void 0:e.length)>0){this.studyInfo={patientDob:[],patientID:[],patientName:[]};Object.keys(this.studiesMetadata).forEach((e=>{const t=this.studiesMetadata[e][0];if(this.selectedPatients.includes(t.patientID)){const e=t.patientDob;const i=e?n.FormatDateFromDicomTag(e):"";if(!this.studyInfo["patientDob"].includes(i))this.studyInfo["patientDob"].push(i);if(!this.studyInfo["patientID"].includes(t.patientID))this.studyInfo["patientID"].push(t.patientID);if(!this.studyInfo["patientName"].includes(t.patientName))this.studyInfo["patientName"].push(t.patientName)}}));this.studyInfo["patientDob"].push("Custom");this.studyInfo["patientID"].push("Custom");this.studyInfo["patientName"].push("Custom");this.studyInfo["patientDob"].push("Empty");this.studyInfo["patientID"].push("Empty");this.studyInfo["patientName"].push("Empty")}this.sectionDicomEditForm=l({style:{display:"none"}});const isValidForm=()=>{const e=this.sectionDicomEditForm.querySelector("#selectPatientID");const t=this.sectionDicomEditForm.querySelector("#selectPatientName");const i=this.sectionDicomEditForm.querySelector("#selectDOB");const n=this.sectionDicomEditForm.querySelector("#PatientIDTextbox");const o=this.sectionDicomEditForm.querySelector("#PatientNameTextbox");const a=this.sectionDicomEditForm.querySelector("#patientDobContainer");const l=this.getDateFromDatePickerContainer(a);if((e===null||e===void 0?void 0:e.value)==="Custom"&&(n===null||n===void 0?void 0:n.value.trim())===""){s.Toaster.ShowToast("Please enter a valid patient ID",s.Colors.Orange,3);return false}if((t===null||t===void 0?void 0:t.value)==="Custom"&&(o===null||o===void 0?void 0:o.value.trim())===""){s.Toaster.ShowToast("Please enter a valid patient name",s.Colors.Orange,3);return false}if(window.getComputedStyle(a).display!=="none"){if((i===null||i===void 0?void 0:i.value)==="Custom"&&l.length!==10){s.Toaster.ShowToast("Please enter a valid patient date of birth",s.Colors.Orange,3);return false}}return true};const doUpload=()=>{if(isValidForm()){const e=this.sectionDicomProgress.querySelector("#IdBtnCancelUpload");e.disabled=false;this.setBlockedDicomEditControls(true);this.IsUploading=true;this.abortUpload=false;this.labelNumberFilesProgress.innerHTML=`Files: ${this.anyFiles.length}`;this.GoToUploadProgressForm();this.uploadFiles()}};const a={actionBtnUpload:()=>doUpload(),actionBtnSelectUploadDirectory:()=>{},actionCheckboxChange:e=>this.onAnonymizeCheckChanged(e),onchangeSelect:()=>this.toggleUploadDicomInputs(),actionPickPatient:()=>this.pickPatient(),patientIdOptions:this.studyInfo["patientID"],patientNameOptions:this.studyInfo["patientName"],patientDobOptions:this.studyInfo["patientDob"]};const r=(new i.StudyToolsUploadEditDemographics).Create(this.sectionDicomEditForm,[a]);const d=r[0]["children"];this.ContainerDiv=d[0];this.ContainerDiv.classList.add("UploadViewContent");this.ResourcePicker=new t.CommonView.ResourcePickerController(this.view);this.ContainerDiv.parentNode.insertBefore(this.ResourcePicker.ResourceListBox,this.ContainerDiv);this.parent.appendChild(this.sectionDicomEditForm);this.patientDOBContainer=this.sectionDicomEditForm.querySelector("#patientDobContainer");this.dicomFormDobDatePicker=new s.DateRangePicker(this.patientDOBContainer,{date:new Date,from:new Date,to:new Date,type:s.EDateRangeType.Single},{allowEmpty:true,onlySingle:true});const h=["patientID","patientName","patientDob"];const c=["selectPatientID","selectPatientName","selectDOB"];["selectPatientID","selectPatientName"].forEach((e=>{var t;const i=(t=this.sectionDicomEditForm.querySelector(`#${e}`))===null||t===void 0?void 0:t.nextElementSibling;o.ForceNoSpecialCharacters(i)}));h.forEach(((e,t)=>{var i;if(((i=this.studyInfo[e])===null||i===void 0?void 0:i.length)===1&&this.studyInfo[e].includes("Custom")){const e=this.sectionDicomEditForm.querySelector(`#${c[t]}`);const i=e===null||e===void 0?void 0:e.nextElementSibling;if(i)i.style.display="inline-flex"}}));this.OnWindowResize()}BuildUIUploadProcess(){if(this.sectionDicomProgress)this.sectionDicomProgress.parentElement.removeChild(this.sectionDicomProgress);this.sectionDicomProgress=l({style:{display:"none"}});const doCancelUpload=()=>{this.resetStatusFiles();this.unckeckAllStudies();this.abortUpload=true;this.IsUploading=false;this.changeFileStatusOnList(this.indexFileUpload,i.EStatusFile.Error);this.indexFileUpload=0;if(this.xhr)this.xhr.abort();this.progressBarUpload.style.width="0px";this.setBlockedDicomEditControls(false);const e=this.sectionDicomProgress.querySelector("#IdBtnCancelUpload");e.disabled=true};const e={actionBtnCancelUpload:()=>doCancelUpload()};const t=(new i.StudyToolsUploadProgress).Create(this.sectionDicomProgress,[e]);const s=t[0]["children"];this.ContainerDiv=s[0];this.ContainerDiv.classList.add("UploadViewContent");this.containerListProgress=this.sectionDicomProgress.querySelector("#idContainerListProgress");this.containerListProgress.appendChild(g({className:"",style:{padding:"0px"}}));this.progressBarUpload=l({className:"progressbar"});const n=this.sectionDicomProgress.querySelector("#idProgressbarUploadContainer");n.appendChild(this.progressBarUpload);this.labelNumberFilesProgress=this.sectionDicomProgress.querySelector("#idLabelNumberFilesProgress");this.parent.appendChild(this.sectionDicomProgress);this.OnWindowResize()}CleanAction(){if(this.xhr)this.xhr.abort();this.resetStatusFiles();this.statusOperation=i.EStatusOperation.None;this.inputFile.value="";this.indexFileUpload=0;this.anyFiles=[];this.listFilesOnContainer();this.progressBarScan.style.width="0%";this.unckeckAllStudies()}OpenAction(){if(this.IsUploading)return;this.CleanAction();this.inputFile.click()}OnWindowResize(){const e=this.GetContainerListFileHtml();if(e){const t=e.parentElement;const i=t.parentElement.previousSibling;const s=t.querySelector(".instructions");const n=t.querySelector(".study-table");const o=s?parseFloat(window.getComputedStyle(s).height):0;const a=n?parseFloat(window.getComputedStyle(i).height)+135:0;const l=parseFloat(window.getComputedStyle(i).height);e.style.height=document.documentElement.clientHeight-o-a-l-230+"px"}if(this.ResourcePicker){const e=document.documentElement.clientHeight-this.view.Platform.ToolbarSectionHeight()-this.view.Platform.GetActiveMessageHeight();const t=e-50;this.ResourcePicker.Resize(t)}}GoToFormSelectFolder(){if(this.IsUploading)return;if(this.currentSection===i.EUploadDicomSection.DicomEdit){this.sectionFilesForm.style.display="block";this.nextButton.disabled=false;this.Selecting=true;this.unckeckAllStudies();this.sectionDicomEditForm.style.display="none";this.setExploreButtonState(true);this.SetBackButtonState(false);this.currentSection=i.EUploadDicomSection.FileSelector}else if(this.currentSection===i.EUploadDicomSection.UploadProgress){this.sectionDicomEditForm.style.display="block";this.sectionDicomProgress.style.display="none";this.currentSection=i.EUploadDicomSection.DicomEdit}}UploadAction(){s.Toaster.ShowToast("File upload has started",s.Colors.BelizeHole,5);this.statusOperation=i.EStatusOperation.Uploading;this.uploadFiles()}GetContainerListFileHtml(){return this.parent.querySelector("#idContainerListFolders")}PauseResume(){if(this.statusOperation===i.EStatusOperation.Uploading){this.statusOperation=i.EStatusOperation.Pause}else if(this.statusOperation===i.EStatusOperation.Pause){this.statusOperation=i.EStatusOperation.Uploading;this.uploadFiles()}}getStatusUpload(){return this.statusOperation}GoToDicomEditForm(){this.sectionFilesForm.style.display="none";this.sectionDicomEditForm.style.display="block";this.setExploreButtonState(false);this.SetBackButtonState(true);this.currentSection=i.EUploadDicomSection.DicomEdit}GoToUploadProgressForm(){this.sectionDicomProgress.querySelector("#idContainerListProgress ul").innerHTML="";this.sectionDicomEditForm.style.display="none";this.sectionDicomProgress.style.display="block";this.currentSection=i.EUploadDicomSection.UploadProgress}pickPatient(){const e={DisableCreate:true};const t={thisView:this};const i=this.sectionDicomEditForm.querySelector(".UploadViewContent");i.style.display="none";this.ResourcePicker.OpenResourceListBox("Patient","Upload Dicom",e,this.selectAction.bind(this),(()=>{this.view.ShowPanes(true);i.style.display=""}),(()=>{}),t)}setBlockedDicomEditControls(e){const t=this.sectionDicomEditForm.querySelectorAll("select");const i=this.sectionDicomEditForm.querySelectorAll("input[type=text]");const s=this.sectionDicomEditForm.querySelector("#anonymizeCheck");const n=this.sectionDicomEditForm.querySelector("#IdBtnUpload");const o=this.sectionDicomEditForm.querySelector("#IdBtnPick");if(!s.checked){t.forEach((t=>{t.disabled=e}));i.forEach((t=>{t.disabled=e}))}s.disabled=e;n.disabled=e;o.disabled=e;this.dicomFormDobDatePicker.SetReadonlyInputs(e)}resetStatusFiles(){for(var e=0;e<this.anyFiles.length;e++){this.anyFiles[e].Status=i.EStatusFile.None;this.anyFiles[e].Tries=0;this.anyFiles[e].Percent=0}}unckeckAllStudies(){var e;const t=(e=this.sectionFilesForm)===null||e===void 0?void 0:e.querySelectorAll(".study-table input[type='checkbox']");if((t===null||t===void 0?void 0:t.length)>0)t.forEach((e=>{e.checked=false}));this.selectedPatients=[];this.selectedStudies=[]}getDateFromDatePickerContainer(e){let t="";if(e.dataset.range){const i=e.dataset.range.split(",");if(i.length===2)t=i[0]}return t}onAnonymizeCheckChanged(e){const t=this.sectionDicomEditForm.querySelector("#selectPatientID");const i=this.sectionDicomEditForm.querySelector("#selectPatientName");const s=this.sectionDicomEditForm.querySelector("#selectDOB");const n=d({innerHTML:"",value:""});const o=d({innerHTML:"",value:""});const a=d({innerHTML:"",value:""});const l=["patientID","patientName","patientDob"];const r=[t,i,s];const h=[n,o,a];if(e.target.checked){l.forEach(((e,t)=>{var i;r[t].prepend(h[t]);r[t].setAttribute("disabled","true");r[t].value="";const s=(i=r[t])===null||i===void 0?void 0:i.nextElementSibling;if(s)s.style.display="none"}))}else{l.forEach(((e,t)=>{var i,s;r[t].removeChild(r[t].children[0]);r[t].removeAttribute("disabled");const n=((i=this.studyInfo[e])===null||i===void 0?void 0:i.length)===1&&this.studyInfo[e].includes("Custom");const o=(s=r[t])===null||s===void 0?void 0:s.nextElementSibling;if(o)o.style.display=n?"inline-flex":"none"}))}}verifySamePatientIds(e){var t;if(!e)return;const i=e.querySelector("span");if(((t=this.selectedPatients)===null||t===void 0?void 0:t.length)>0){const t=this.selectedPatients[0];const n=this.selectedPatients.every((e=>e===t));if(!n){if(!i){const t="<br/>You are selecting studies with different Patient ID";const i=r({style:{color:s.Colors.Alizarin},innerHTML:t});e.appendChild(i)}}else if(i){e.removeChild(i)}}else if(i){e.removeChild(i)}window.dispatchEvent(new Event("resize"))}isValidDicomUpload(){var e;const t=Object.keys(this.studiesMetadata);if(t.length>1){if(((e=this.selectedPatients)===null||e===void 0?void 0:e.length)>0)return true;s.Toaster.ShowToast("Please select at least one study.",s.Colors.BelizeHole,3);return false}return true}getStudyId(e){return e.substring(8,e.length)}setExploreButtonState(e){let t=Array.from(document.querySelectorAll(".mainToolbar .toolbarButton")).filter((e=>{var t;return((t=e.innerText)===null||t===void 0?void 0:t.trim())==="Explore"}));if(t.length===1)t[0].style.display=e?"inline-block":"none"}inputFileHandler(e){[this.progressBarUpload,this.progressBarScan].forEach((e=>{if(e){e.classList.remove("stop");e.style.width="0px"}}));this.additionalFiles=[];this.fillFilesList(e,(()=>{this.processFilesList((()=>{this.listFilesOnContainer();this.buildStudiesTable();this.progressBarScan.classList.add("stop")}))}))}processDicomDir(e,t){let n=0;for(let o=0;o<e.length;o++){const l=new FileReader;l.addEventListener("load",(o=>{n++;const r=new Uint8Array(l.result);const d=new a(r);try{const e=d["DicomTags"][i.DICOM_TAG_DIRECTORY_RECORD_SEQUENCE];for(let t=0;t<e.length;t++){const s=e[t]["value"];let n=false;for(let e=0;e<s.length;e++){if(s[e]["tag"]===i.DICOM_TAG_DIRECTORY_RECORD_TYPE&&s[e]["value"].toUpperCase()==="IMAGE"){n=true}if(n&&s[e]["tag"]===i.DICOM_TAG_REFERENCED_FILE_ID){const t=s[e]["value"].split("\\");this.additionalFiles.push(t[t.length-1].toUpperCase())}}}if(this.additionalFiles.length>0){for(let e=0;e<this.filesInFolder.length;e++){if(this.additionalFiles.indexOf(this.filesInFolder[e].name.toUpperCase())>-1){const t=this.anyFiles.map((e=>e.Name.toUpperCase()));if(t.indexOf(this.filesInFolder[e].name.toUpperCase())===-1){this.anyFiles.push({Name:this.filesInFolder[e].name,File:this.filesInFolder[e],Status:i.EStatusFile.None,Percent:0,Tries:0,Skip:false})}}}}}catch(e){console.log("No sequence")}if(n===e.length){if(this.anyFiles.length){t()}else{s.Toaster.ShowToast("No images were found in the scanned medium.",s.Colors.Orange,3)}}}));l.readAsArrayBuffer(e[o])}}fillFilesList(e,t){let n=true;this.filesInFolder=e.target.files;let o=[];for(let e=0;e<this.filesInFolder.length;e++){let t=false;let s=false;const a=this.filesInFolder[e].name.split(".");if(this.filesInFolder[e].name.toUpperCase()==="DICOMDIR"){n=false;t=true;o.push(this.filesInFolder[e])}else if(this.filesInFolder[e].name.indexOf(".")===-1||a[a.length-1].toUpperCase()==="DCM"||a[a.length-1].toUpperCase()==="DICOM"){s=true}if(!t&&s){this.anyFiles.push({Name:this.filesInFolder[e].name,File:this.filesInFolder[e],Status:i.EStatusFile.None,Percent:0,Tries:0,Skip:false})}}if(n){if(this.anyFiles.length>0){t()}else{s.Toaster.ShowToast("No images were found in the scanned medium.",s.Colors.Orange,3)}}else{this.processDicomDir(o,t)}}getMimeByExtension(e){let t="";const i=this.specView["Mimes"];for(let t=0;t<this.fileExtensions.length;t++){const s=this.GetExtensionName(e);if(s===this.fileExtensions[t])return i[t]}return t}getDicomInfo(e){this.studyInfo={studyUid:[],modality:[],patientID:[],patientName:[],patientDob:[]};this.studiesMetadata={};let t=0;const process=s=>{if(Object.keys(s.DicomTags).length>0&&s.DicomTags[i.DICOM_TAG_SOP_CLASS_UID]!=="1.2.840.10008.1.3.10"){const e=s.DicomTags[i.DICOM_TAG_STUDY_ID];const t=s.DicomTags[i.DICOM_TAG_MODALITY];const o=s.DicomTags[i.DICOM_TAG_PATIENT_ID];const a=n.FormatValue(s.DicomTags[i.DICOM_TAG_PATIENT_NAME]);const l=s.DicomTags[i.DICOM_TAG_PATIENT_DOB];const r=s.DicomTags[i.DICOM_TAG_STUDY_DATE];const d=s.DicomTags[i.DICOM_TAG_STUDY_DESCRIPTION];const h=((l===null||l===void 0?void 0:l.match(/-/g))||[]).length===2;const c=((l===null||l===void 0?void 0:l.match(/\//g))||[]).length===2;let u;if(h)u=l.replaceAll("-","/");if(c)u=l;if(!h&&!c)u=n.FormatDateFromDicomTag(l);if(!this.studiesMetadata[e])this.studiesMetadata[e]=[];this.studiesMetadata[e].push({studyUid:e,modality:t,patientID:o,patientName:a,patientDob:l,studyDate:r,studyDescription:d});if(e&&this.studyInfo["studyUid"].indexOf(e)===-1)this.studyInfo["studyUid"].push(e);if(t&&this.studyInfo["modality"].indexOf(t)===-1)this.studyInfo["modality"].push(t);if(o&&this.studyInfo["patientID"].indexOf(o)===-1)this.studyInfo["patientID"].push(o);if(a&&this.studyInfo["patientName"].indexOf(a)===-1)this.studyInfo["patientName"].push(a);if(l&&this.studyInfo["patientDob"].indexOf(u)===-1)this.studyInfo["patientDob"].push(u)}t++;if(t===this.loadedFiles.length){if(e)e();this.nextButton.disabled=false;this.progressBarScan.style.width="100%";this.studyInfo["patientID"].push("Custom");this.studyInfo["patientName"].push("Custom");this.studyInfo["patientDob"].push("Custom");this.studyInfo["patientDob"].push("Empty");this.studyInfo["patientID"].push("Empty");this.studyInfo["patientName"].push("Empty")}};let s=new Array(this.anyFiles.length);let o=this.anyFiles.map((e=>e.File.size)).reduce(((e,t)=>e+t),0);for(let e=0;e<this.loadedFiles.length;e++){const t=new Uint8Array(this.loadedFiles[e]);const n=new a(t);if(n.reachedPixelData){process(n)}else{const t=new FileReader;t.addEventListener("load",(e=>{const s=new Uint8Array(t.result);const n=new a(s);const o=e.currentTarget.indexFile;const l=Object.keys(n.DicomTags).length>0&&n.DicomTags[i.DICOM_TAG_SOP_CLASS_UID]!=="1.2.840.10008.1.3.10";if(l){const e=n.DicomTags[i.DICOM_TAG_STUDY_ID];this.anyFiles[o].studyUid=e}else this.anyFiles[o].Skip=true;process(n)}));t.addEventListener("progress",(t=>{s[e]=t.loaded;const i=s.reduce(((e,t)=>e+t),0);this.progressBarScan.style.width=`${i/o*100}%`}));t["indexFile"]=e;t.readAsArrayBuffer(this.anyFiles[e].File)}}}processFilesList(e){let t=0;this.loadedFiles=[];if(this.anyFiles.length>0){for(let s=0;s<this.anyFiles.length;s++){const n=new FileReader;n.addEventListener("load",(s=>{let o=s.currentTarget.indexFile;const l=new Uint8Array(n.result);let r;try{r=new a(l);if(!this.anyFiles[o].hasOwnProperty("studyUid"))this.loadedFiles.push(n.result);const e=r.DicomTags[i.DICOM_TAG_STUDY_ID];this.anyFiles[o].studyUid=e}catch(e){console.log(e)}t++;if(t===this.anyFiles.length)this.getDicomInfo(e)}));let o;o=this.anyFiles[s].File.slice(0,5e3);n["indexFile"]=s;n.readAsArrayBuffer(o)}}}listFilesOnContainer(e){const t=this.GetContainerListFileHtml();if(this.anyFiles.length>0){const e=g({children:this.anyFiles.map((e=>{const t=e.File["webkitRelativePath"]||e.File["name"];const i=this.GetFileSize(e.File);return y({style:{marginBottom:"10px"},innerHTML:`${t} - ${i}`})}))});this.labelNumberFiles.innerHTML=`Files: ${this.anyFiles.length}`;t.innerHTML="";t.appendChild(e)}else{this.labelNumberFiles.innerHTML="Files: 0";t.innerHTML=""}}addFileOnList(e){const t=this.anyFiles[e];const s=this.sectionDicomProgress.querySelector("ul");const n=`list-item-${e}`;const o=s.querySelector(`#${n}`);if(o){s.removeChild(o)}const a=`${t.Name} - ${this.GetFileSize(t.File)}`;const l=y({id:n,className:"list-item",children:[r({children:[C({className:"rotate",src:i.ResourceBag.Icons8Clock64Png})]}),A(a)]});s.appendChild(l);s.parentElement.scrollTop=s.scrollHeight}changeFileStatusOnList(e,t,s){const n=this.anyFiles[e];const a=this.sectionDicomProgress.querySelector("ul");const l=a.querySelector(`#list-item-${e}`);let d=`${n.Name} - ${this.GetFileSize(n.File)}`;if((s===null||s===void 0?void 0:s.length)>0){d+=` (${s})`}if(!l)return;l.innerHTML="";let h;switch(t){case i.EStatusFile.Uploaded:h=i.ResourceBag.Icons8Ok64Png;break;case i.EStatusFile.Error:h=i.ResourceBag.Icons8Cancel64Png;break;default:h=i.ResourceBag.Icons8Clock64Png}o.SetOptions(l,{children:[r({children:[C({src:h})]}),A(d)]})}buildStudiesTable(){const e=this.sectionFilesForm.querySelector("#IdBtnNext");const t=e.parentElement.querySelector("table");const i=e.parentElement.querySelector(".instructions");if(t){e.parentElement.removeChild(t);e.parentElement.removeChild(i)}const s=Object.keys(this.studiesMetadata);if(s.length>1){const t=[];let i;const o=["Patient ID","Patient Name","Study Description","Study Date","Patient DOB","Images"];const a=["patientID","patientName","studyDescription","studyDate","patientDob"];const onSelectAllRows=e=>{if(i.checked){t.forEach((e=>{e.checked=true;if(!this.selectedPatients.includes(e.value))this.selectedPatients.push(e.value);this.selectedStudies.push(e.dataset.studyid)}))}else{t.forEach((e=>{e.checked=false}));this.selectedPatients=[];this.selectedStudies=[]}const s=this.sectionFilesForm.querySelector(".instructions");this.verifySamePatientIds(s)};const onSelectRow=e=>{const t=e.target;if(t.checked){if(!this.selectedPatients.includes(t.value))this.selectedPatients.push(t.value);this.selectedStudies.push(t.dataset.studyid)}else{if(i)i.checked=false;const e=t.dataset.patientid;if(r.querySelectorAll(`tbody input[data-patientid="${e}"]:checked`).length===0){const e=this.selectedPatients.findIndex((e=>e===t.value));const i=this.selectedStudies.findIndex((e=>e===t.dataset.studyid));this.selectedPatients.splice(e,1);this.selectedStudies.splice(i,1)}}const s=this.sectionFilesForm.querySelector(".instructions");this.verifySamePatientIds(s)};const r=c({className:"study-table simple-table",style:{textAlign:"center",width:"100%"},children:[p({children:[F({children:[m({className:"no-border",children:[i=h({type:"checkbox",onchange:onSelectAllRows,style:{display:"block"}})]}),...o.map((e=>m({innerText:e})))]})]}),u({children:s.map((e=>{const i=this.studiesMetadata[e][0];const s=h({type:"checkbox",onchange:onSelectRow,style:{display:"block"},value:i["patientID"],attr:{"data-studyId":e,"data-patientId":i.patientID}});t.push(s);return F({children:[f({className:"no-border",children:[s]}),...a.map((e=>{let t=i[e]||"";if(e==="patientDob"&&t)t=n.FormatDateFromDicomTag(t);return f({innerText:t})})),f({innerText:`${this.studiesMetadata[e].length}`})]})}))})]});const d=l({className:"instructions",innerHTML:"Multiple records detected. Select to upload:",style:{marginBottom:"8px"}});e.parentElement.appendChild(d);e.parentElement.appendChild(r);e.parentElement.insertBefore(d,e);e.parentElement.insertBefore(r,e);const g=setTimeout((()=>{window.dispatchEvent(new Event("resize"));clearTimeout(g)}),200)}}toggleUploadDicomInputs(){const e=this.sectionDicomEditForm.querySelectorAll(".dicomFieldSelect");e.forEach((e=>{e.nextElementSibling.style.display=e.value==="Custom"?"inline-flex":"none"}))}updateProgressBar(e){if(e<100){if(this.progressBarUpload)this.progressBarUpload.style.width=500/(100/e)+"px"}else{if(this.progressBarUpload)this.progressBarUpload.style.width=500/(100/100)+"px"}}selectAction(e,t,i,n){const o=n.thisView.sectionDicomEditForm.querySelector("#PatientIDTextbox");const a=n.thisView.sectionDicomEditForm.querySelector("#PatientNameTextbox");const l=n.thisView.sectionDicomEditForm.querySelector("#selectPatientID");const r=n.thisView.sectionDicomEditForm.querySelector("#selectPatientName");const d=n.thisView.sectionDicomEditForm.querySelector("#selectDOB");l.value="Custom";r.value="Custom";d.value="Custom";n.thisView.toggleUploadDicomInputs();try{o.value=e.identifier[0].value}catch(e){o.value=""}try{a.value=e.name[0].text}catch(e){a.value=""}if(e.hasOwnProperty("birthDate")){n.thisView.patientDOBContainer.innerHTML="";const t=e.birthDate.split("-");const i=new Date(parseInt(t[0]),parseInt(t[1])-1,parseInt(t[2]));n.thisView.dicomFormDobDatePicker=new s.DateRangePicker(n.thisView.patientDOBContainer,{date:i,from:new Date,to:new Date,type:s.EDateRangeType.Single},{allowEmpty:true,onlySingle:true},true)}const h=this.sectionDicomEditForm.querySelector(".UploadViewContent");h.style.display="";n.thisView.view.ShowPanes(true)}operationCompleted(){this.setBlockedDicomEditControls(false);this.resetStatusFiles();this.statusOperation=i.EStatusOperation.None;this.indexFileUpload=0;this.IsUploading=false;const e=this.sectionDicomEditForm.querySelector("#IdBtnUpload");const t=this.sectionDicomProgress.querySelector("#IdBtnCancelUpload");const n=this.sectionDicomProgress.querySelectorAll(".progressbar");if(e)e.disabled=false;if(t)t.disabled=true;if(n){n.forEach((e=>{e.classList.add("stop")}))}s.Toaster.ShowToast("Operation completed.",s.Colors.Emerald,3)}uploadFiles(){if(this.abortUpload){this.abortUpload=false;return}this.xhr=new XMLHttpRequest;this.xhr.upload.addEventListener("progress",this.uploadProgress,false);this.xhr.addEventListener("load",this.uploadComplete,false);this.xhr.addEventListener("error",this.uploadFailed,false);this.xhr.addEventListener("abort",this.uploadAborted,false);let e;let t=false;let o="";const a=this.sectionDicomEditForm.querySelector("#anonymizeCheck");if(a.checked){o+="&anonymize=true"}else{const e=this.sectionDicomEditForm.querySelector("#PatientIDTextbox");const i=this.sectionDicomEditForm.querySelector("#PatientNameTextbox");const s=this.sectionDicomEditForm.querySelector("#patientDobContainer");const n=this.sectionDicomEditForm.querySelector("#selectPatientID");const a=this.sectionDicomEditForm.querySelector("#selectPatientName");const l=this.sectionDicomEditForm.querySelector("#selectDOB");if(window.getComputedStyle(e).display!=="none"){const i=e.value;if(i)o+=`&patientId=${i}&`;else t=true}else if(n.value!=="Empty"&&n.value!=="Custom"){const e=n.value;o+=`&patientId=${e}&`}if(n.value==="Empty")o+="&patientId=&";if(window.getComputedStyle(i).display!=="none"){const e=i.value;if(e)o+=(o.length===0?"&":"")+"patientName="+encodeURIComponent(e)+"&";else t=true}else if(a.value!=="Empty"&&a.value!=="Custom"){const e=a.value;o+=(o.length===0?"&":"")+"patientName="+encodeURIComponent(e)+"&"}if(a.value==="Empty")o+=(o.length===0?"?":"")+"patientName=&";if(window.getComputedStyle(s).display!=="none"){const e=this.getDateFromDatePickerContainer(s);const i=e.split("-").join("");if(i)o+=`${o.length===0?"&":""}patientDob=${i}`;else t=true}else if(l.value!=="Empty"&&l.value!=="Custom"){const e=l.value;const t=e.split("/").join("");o+=`${o.length===0?"&":""}patientDob=${t}`}if(l.value==="Empty")o+=`${o.length===0?"&":""}patientDob=`;if(o.slice(-1)==="&")o=o.slice(0,-1)}e=`${s.PlatformContext.PlatformUri}/studytools/uploader?op=uploadDcm${o}`;this.xhr.open("POST",e);this.xhr.setRequestHeader("Authorization","Bearer "+sessionStorage["token"]);if(!t){try{const e=Object.keys(this.studiesMetadata);let t=this.anyFiles[this.indexFileUpload]&&!this.selectedStudies.some((e=>this.anyFiles[this.indexFileUpload].studyUid===e));let s=e.length<=1&&this.selectedStudies.length===0;let n=this.anyFiles[this.indexFileUpload]&&this.anyFiles[this.indexFileUpload].Skip;if(t&&!s||n){this.anyFiles[this.indexFileUpload].Status=i.EStatusFile.Uploaded;this.anyFiles[this.indexFileUpload].Percent=100;this.indexFileUpload+=1;this.uploadFiles()}else{if(this.anyFiles.length>0&&this.indexFileUpload<this.anyFiles.length){if(this.statusOperation!==i.EStatusOperation.Pause){const e=this.getMimeByExtension(this.anyFiles[this.indexFileUpload].File.name);this.anyFiles[this.indexFileUpload].File["Content-Type"]=e;if(this.anyFiles[this.indexFileUpload].Status===i.EStatusFile.None||this.anyFiles[this.indexFileUpload].Status===i.EStatusFile.Error){this.xhr.send(this.anyFiles[this.indexFileUpload].File);this.addFileOnList(this.indexFileUpload)}}}else{this.operationCompleted()}}}catch(e){n.DebugConsoleLog("Error send data");n.DebugConsoleLog(e)}}else{s.Toaster.ShowToast("Custom field empty.",s.Colors.Orange,3);this.setBlockedDicomEditControls(false)}}}i.UploadDicomController=UploadDicomController})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;var s=i.Utils;var n=i.DOMUtils;const{div:o}=n;class UploadFileController extends t.UploadController{constructor(e,n,o){super(e,n,o);this.uploadProgress=e=>{if(e.lengthComputable){const i=Math.round(e.loaded*100/e.total);this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.Progress;this.anyFiles[this.indexFileUpload].Percent=i;let s=0;for(let e=0;e<this.anyFiles.length;e++){s+=this.anyFiles[e].Percent}this.updateProgressBar(s/this.anyFiles.length)}else{s.DebugConsoleLog("unable to compute")}};this.uploadComplete=e=>{if(this.abortUpload)return;let s=true;if(e.target.status===200){this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.Uploaded;this.indexFileUpload+=1}else{this.anyFiles[this.indexFileUpload].Tries+=1;if(this.anyFiles[this.indexFileUpload].Tries>=2){this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.Error;this.anyFiles[this.indexFileUpload].Percent=100;this.indexFileUpload+=1;const i=e.target.getResponseHeader("X-Error");if(i){this.listFilesOnContainer(i)}else{this.listFilesOnContainer("Could not upload")}}else{this.anyFiles[this.indexFileUpload].Percent=0;this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.Error}}if(this.indexFileUpload===this.anyFiles.length){if(!this.anyFiles.some((e=>e.Status===t.EStatusFile.Error)))this.statusOperation=t.EStatusOperation.Uploaded;else i.Toaster.ShowToast("Error uploading some files.",i.Colors.Orange,3.5)}else{s=false}let n=0;for(let e=0;e<this.anyFiles.length;e++){n+=this.anyFiles[e].Percent}this.updateProgressBar(n/this.anyFiles.length);this.listFilesOnContainer();if(s){this.resetStatusFiles();this.statusOperation=t.EStatusOperation.None;this.indexFileUpload=0;this.Selecting=true;this.IsUploading=false;this.buttonUpload.disabled=false;this.progressBarUpload.classList.add("stop");i.Toaster.ShowToast("Operation completed.",i.Colors.Emerald,3)}else{this.uploadFiles()}};this.uploadFailed=e=>{this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.None;this.listFilesOnContainer();i.Toaster.ShowToast("There was an error attempting to upload the file.",i.Colors.Pomegranate,3)};this.uploadAborted=e=>{this.anyFiles[this.indexFileUpload].Status=t.EStatusFile.None;this.listFilesOnContainer();this.statusOperation=t.EStatusOperation.Cancel;i.Toaster.ShowToast("The upload has been canceled by the user or the browser dropped the connection.",i.Colors.BelizeHole,3)};this.indexFileUpload=0;this.anyFiles=[];this.abortUpload=false;this.BuildUI()}BuildUI(){const e=setTimeout((()=>{this.SetBackButtonState(false);clearTimeout(e)}),250);const doUpload=()=>{this.abortUpload=false;this.progressBarUpload.classList.remove("stop");this.buttonUpload.disabled=true;this.uploadFiles()};this.sectionFilesForm=o({});const i={actionBtnNextSelectFolder:()=>doUpload()};const s=(new t.StudyToolsUploadSelectFolder).Create(this.sectionFilesForm,[i]);this.progressBarScan=o({className:"progressbar"});const n=this.sectionFilesForm.querySelector("#idProgressbarContainer");n.appendChild(this.progressBarScan);this.parent.appendChild(this.sectionFilesForm);this.inputFile=this.sectionFilesForm.querySelector("#dicomUpload");this.inputFile.type="file";this.inputFile.name="select";this.inputFile.accept=this.accept;this.inputFile.multiple=true;this.Selecting=true;this.inputFile.addEventListener("change",this.inputFileHandler.bind(this));this.buttonUpload=this.sectionFilesForm.querySelector("button#IdBtnNext");this.buttonUpload.disabled=true;this.labelNumberFiles=this.sectionFilesForm.querySelector("#idLabelNumberFiles");this.BuildUIUpload()}BuildUIUpload(){this.buttonUpload.innerText="Upload";this.sectionUploadForm=o({});const e=this.sectionFilesForm.querySelector("h2");const i=(new t.StudyToolsUploadAnyForm).Create(this.sectionUploadForm,[{}]);this.sectionFilesForm.appendChild(this.sectionUploadForm);n.InsertAfter(this.sectionUploadForm,e);this.progressBarUpload=o({className:"progressbar"});const s=this.sectionUploadForm.querySelector("#idProgressbarContainer");s.appendChild(this.progressBarUpload)}GetContainerListFileHtml(){return this.parent.querySelector("#idContainerListFolders")}CleanAction(){if(this.xhr)this.xhr.abort();this.resetStatusFiles();this.statusOperation=t.EStatusOperation.None;this.inputFile.value="";this.indexFileUpload=0;this.anyFiles=[];this.listFilesOnContainer();this.progressBarScan.style.width="0px"}OpenAction(){if(this.IsUploading)return;this.CleanAction();this.inputFile.click()}OnWindowResize(){}GoToFormSelectFolder(){}inputFileHandler(e){[this.progressBarUpload,this.progressBarScan].forEach((e=>{e.classList.remove("stop");e.style.width="0%"}));this.fillFilesList(e);this.processFilesList((()=>{this.listFilesOnContainer();const e=setTimeout((()=>{window.dispatchEvent(new Event("resize"));clearTimeout(e)}),200)}))}fillFilesList(e){const i=e.target.files;for(let e=0;e<i.length;e++){const s=this.fileExtensions.some((t=>t.match(this.GetExtensionName(i[e].name))!==null));if(s){this.anyFiles.push({Name:i[e].name,File:i[e],Status:t.EStatusFile.None,Percent:0,Tries:0,Skip:false})}}}getMimeByExtension(e){let t="";const i=this.specView["Mimes"];for(let s=0;s<this.fileExtensions.length;s++){const n=this.GetExtensionName(e);if(n===this.fileExtensions[s]){t=i[s];break}}return t}listFilesOnContainer(e){const i=document.createElement("ul");const s=this.GetContainerListFileHtml();if(this.anyFiles.length>0){for(let e=0;e<this.anyFiles.length;e++){const s=document.createElement("li");s.style.marginBottom="10px";s.innerHTML=(this.anyFiles[e].File["webkitRelativePath"]||this.anyFiles[e].File["name"])+"  -  "+this.GetFileSize(this.anyFiles[e].File);if(this.anyFiles[e].Status===t.EStatusFile.Uploaded){s.innerHTML+=" <span style='color:green'>✓</span>"}else if(this.anyFiles[e].Status===t.EStatusFile.Error){s.innerHTML+=" <span style='color:red'>X</span>"}i.appendChild(s)}this.labelNumberFiles.innerHTML="Files: "+this.anyFiles.length;s.innerHTML="";s.appendChild(i)}else{this.labelNumberFiles.innerHTML="Files: 0";s.innerHTML=""}}resetStatusFiles(){for(var e=0;e<this.anyFiles.length;e++){this.anyFiles[e].Status=t.EStatusFile.None;this.anyFiles[e].Tries=0;this.anyFiles[e].Percent=0}}updateProgressBar(e){this.progressBarUpload.style.width=e<100?`${e-10}%`:"100%"}uploadFiles(){this.xhr=new XMLHttpRequest;this.xhr.upload.addEventListener("progress",this.uploadProgress,false);this.xhr.addEventListener("load",this.uploadComplete,false);this.xhr.addEventListener("error",this.uploadFailed,false);this.xhr.addEventListener("abort",this.uploadAborted,false);let e;if(this.anyFiles[this.indexFileUpload]){e=i.PlatformContext.PlatformUri+decodeURIComponent(this.parameters["endpoint"])}this.xhr.open("POST",e);this.xhr.setRequestHeader("Authorization","Bearer "+sessionStorage["token"]);try{if(this.anyFiles.length>0&&this.indexFileUpload<this.anyFiles.length){if(this.statusOperation!==t.EStatusOperation.Pause){const e=this.getMimeByExtension(this.anyFiles[this.indexFileUpload].File.name);this.anyFiles[this.indexFileUpload].File["Content-Type"]=e;const i=new Blob([this.anyFiles[this.indexFileUpload].File],{type:e});if(this.anyFiles[this.indexFileUpload].Status===t.EStatusFile.None||this.anyFiles[this.indexFileUpload].Status===t.EStatusFile.Error){this.xhr.send(this.anyFiles[this.indexFileUpload].File);this.IsUploading=true;this.Selecting=false}}}}catch(e){s.DebugConsoleLog("Error send data");s.DebugConsoleLog(e)}}processFilesList(e){let t=0;let i=new Array(this.anyFiles.length);const s=this.anyFiles.map((e=>e.File.size)).reduce(((e,t)=>e+t),0);for(let n=0;n<this.anyFiles.length;n++){const o=new FileReader;o.onload=i=>{t++;if(t===this.anyFiles.length){if(e)e();this.buttonUpload.disabled=false;this.progressBarScan.classList.add("stop");this.progressBarScan.style.width="100%"}};o.addEventListener("progress",(e=>{i[n]=e.loaded;const t=i.reduce(((e,t)=>e+t),0);this.progressBarScan.style.width=t/s*100+"%"}));o["indexFile"]=n;o.readAsArrayBuffer(this.anyFiles[n].File)}}}t.UploadFileController=UploadFileController})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(i){var s=e.Frontend.WebClient;var n=s.Utils;var o=s.DOMUtils;const{div:a,input:l}=o;class UploadMp4Controller extends i.UploadController{constructor(e,t,o,a){super(e,t,o);this.uploadProgress=e=>{if(e.lengthComputable){const t=Math.round(e.loaded*100/e.total);console.log(t);this.anyFiles[0].Status=i.EStatusFile.Progress;this.anyFiles[0].Percent=t;this.updateProgressBar(this.anyFiles[0].Percent)}else{n.DebugConsoleLog("unable to compute")}};this.uploadComplete=e=>{if(this.abortUpload)return;this.Selecting=true;this.IsUploading=false;this.buttonUpload.disabled=false;this.buttonCancel.disabled=true;this.buttonClear.disabled=false;this.setBlockedControls(false);this.progressBar.style.width="100%";if(e.target.status===200){this.anyFiles[0].Status=i.EStatusFile.Uploaded;this.resetStatusFile();this.progressBar.classList.add("stop");s.Toaster.ShowToast("Operation completed.",s.Colors.Emerald,3)}else{this.anyFiles[0].Percent=0;this.resetStatusFile();this.anyFiles[0].Status=i.EStatusFile.Error;s.Toaster.ShowToast("Error with some files not uploaded, try again please",s.Colors.Pomegranate,3.5)}};this.uploadFailed=e=>{this.anyFiles[0].Status=i.EStatusFile.None;this.IsUploading=false;this.Selecting=true;this.buttonUpload.disabled=true;this.buttonCancel.disabled=true;this.buttonClear.disabled=false;this.progressBar.classList.add("stop");s.Toaster.ShowToast("There was an error attempting to upload the file.",s.Colors.Pomegranate,3)};this.uploadAborted=e=>{this.anyFiles[0].Status=i.EStatusFile.None;this.IsUploading=false;this.Selecting=true;this.abortUpload=true;this.buttonUpload.disabled=false;this.buttonCancel.disabled=true;this.buttonClear.disabled=false;this.progressBar.classList.add("stop");s.Toaster.ShowToast("The upload has been canceled by the user or the browser dropped the connection.",s.Colors.BelizeHole,3)};this.view=a;this.BuildUI();this.anyFiles=null;this.abortUpload=false;this.IsUploading=false;this.Selecting=true}BuildUI(){const e=setTimeout((()=>{this.SetBackButtonState(false);clearTimeout(e)}),250);const n=this;this.sectionMp4UploadForm=a({});const doUploadMp4=()=>{this.abortUpload=false;this.progressBar.classList.remove("stop");const e=this.inputPatientId.value;const t=this.inputPatientName.value;const i=this.inputStudyDescription.value;const s=this.getDateFromDatePickerContainer(this.patientDOBContainer);const o={patientId:e,patientName:t,studyDescription:i,patientDOB:s};const a=Object.keys(o).some((e=>o[e]===""));if(a){const e=this.createConfirmDialog(o);e.Show()}else{this.buttonUpload.disabled=true;this.buttonClear.disabled=true;this.buttonCancel.disabled=false;this.setBlockedControls(true);n.uploadMp4(o)}};const doClearMp4Info=()=>{this.buttonUpload.disabled=true;this.buttonClear.disabled=true;this.buttonCancel.disabled=true;this.inputPatientId.value="";this.inputPatientName.value="";this.inputStudyDescription.value="";this.divVideoInfo.innerHTML="";this.dobDatePicker.Clear();this.anyFiles=null;this.inputFile.value="";this.setBlockedControls(true);this.progressBar.style.width="0px"};const doCancelMP4=()=>{this.IsUploading=false;this.Selecting=true;this.abortUpload=true;if(this.xhr)this.xhr.abort();this.progressBar.style.width="0px";this.setBlockedControls(false)};const r={actionBtnClearMp4Info:()=>doClearMp4Info(),actionBtnUploadMp4:()=>doUploadMp4(),actionBtnCancelMp4:()=>doCancelMP4(),actionPickPatient:()=>this.pickPatient()};const d=(new i.StudyToolsUploadMp4).Create(this.sectionMp4UploadForm,[r]);this.parent.appendChild(this.sectionMp4UploadForm);const h=d[0]["children"];this.ContainerDiv=h[0];this.ContainerDiv.classList.add("UploadViewContent");this.ResourcePicker=new t.CommonView.ResourcePickerController(this.view);this.ContainerDiv.parentNode.insertBefore(this.ResourcePicker.ResourceListBox,this.ContainerDiv);this.buttonUpload=this.sectionMp4UploadForm.querySelector("button#IdButtonUpload");this.buttonClear=this.sectionMp4UploadForm.querySelector("button#IdButtonUploadClear");this.buttonCancel=this.sectionMp4UploadForm.querySelector("button#IdButtonUploadCancel");this.inputPatientId=this.sectionMp4UploadForm.querySelector("#patientIdID");this.inputPatientName=this.sectionMp4UploadForm.querySelector("#patientNameID");this.inputStudyDescription=this.sectionMp4UploadForm.querySelector("#studyDescriptionID");this.divVideoInfo=this.sectionMp4UploadForm.querySelector("#VideoInfo");[this.inputPatientId,this.inputPatientName,this.inputStudyDescription].forEach((e=>{o.ForceNoSpecialCharacters(e)}));this.patientDOBContainer=this.sectionMp4UploadForm.querySelector("#PatientDOBContainer");this.dobDatePicker=new s.DateRangePicker(this.patientDOBContainer,{date:new Date,from:new Date,to:new Date,type:s.EDateRangeType.Single},{allowEmpty:true,onlySingle:true});this.buildProgressBar(this.sectionMp4UploadForm);this.inputFile=l({type:"file",name:"select",className:"invisibleInputFile"});this.inputFile.accept=this.accept;this.Selecting=true;this.inputFile.addEventListener("change",(e=>{this.buttonUpload.disabled=false;this.buttonCancel.disabled=true;this.buttonClear.disabled=false;this.setBlockedControls(false);this.progressBar.classList.remove("stop");this.progressBar.style.width="0px";this.fillFilesList(e);this.fillVideoInfo()}));this.parent.appendChild(this.inputFile);this.buttonUpload.disabled=true;this.buttonCancel.disabled=true;this.buttonClear.disabled=true;this.OnWindowResize()}CleanAction(){if(this.xhr)this.xhr.abort();this.resetStatusFile();this.inputFile.value="";this.anyFiles=null}OpenAction(){if(this.IsUploading)return;this.CleanAction();this.inputFile.click()}OnWindowResize(){if(this.ResourcePicker){const e=document.documentElement.clientHeight-this.view.Platform.ToolbarSectionHeight()-this.view.Platform.GetActiveMessageHeight();const t=e-50;this.ResourcePicker.Resize(t)}}GoToFormSelectFolder(){}buildProgressBar(e){const t=e.querySelector("#idProgressbarContainer");t.innerHTML="";this.progressBar=a({className:"progressbar"});t.appendChild(this.progressBar)}getDateFromDatePickerContainer(e){let t="";if(e.dataset.range){const i=e.dataset.range.split(",");if(i.length===2)t=i[0]}return t}fillVideoInfo(){if(this.anyFiles){let e=this.anyFiles[0].File["webkitRelativePath"]||this.anyFiles[0].File["name"];let t=this.GetFileSize(this.anyFiles[0].File);let i=`<strong>Video:${e}  - ${t}</strong>`;this.divVideoInfo.innerHTML=i}}setBlockedControls(e){[this.inputPatientId,this.inputPatientName,this.inputStudyDescription].forEach((t=>{t.disabled=e}));this.dobDatePicker.SetReadonlyInputs(e)}updateProgressBar(e){this.progressBar.style.width=e<90?`${e}%`:"90%"}uploadMp4(e){this.xhr=null;this.xhr=new XMLHttpRequest;this.xhr.upload.addEventListener("progress",this.uploadProgress,false);this.xhr.addEventListener("load",this.uploadComplete,false);this.xhr.addEventListener("error",this.uploadFailed,false);this.xhr.addEventListener("abort",this.uploadAborted,false);const t=encodeURIComponent(e.patientId);const i=encodeURIComponent(e.patientName);const n=encodeURIComponent(e.studyDescription);const o=e.patientDOB.split("-").join("");const a=`${s.PlatformContext.PlatformUri}/studytools/uploader?op=uploadMP4&patientId=${t}&patientName=${i}&patientDob=${o}&studyDescription=${n}`;this.xhr.open("POST",a);this.xhr.setRequestHeader("Authorization","Bearer "+sessionStorage["token"]);this.xhr.send(this.anyFiles[0].File);this.IsUploading=true;this.Selecting=false}pickPatient(){const e={DisableCreate:true};const t={thisView:this};this.ResourcePicker.OpenResourceListBox("Patient","Upload MP4",e,this.selectAction,(()=>{this.view.ShowPanes(true)}),(()=>{}),t)}selectAction(e,t,i,n){try{n.thisView.inputPatientId.value=e.identifier[0].value}catch(e){n.thisView.inputPatientId.value=""}try{n.thisView.inputPatientName.value=e.name[0].text}catch(e){n.thisView.inputPatientName.value=""}if(e.hasOwnProperty("birthDate")){n.thisView.patientDOBContainer.innerHTML="";const t=e.birthDate.split("-");const i=new Date(parseInt(t[0]),parseInt(t[1])-1,parseInt(t[2]));n.thisView.dicomFormDobDatePicker=new s.DateRangePicker(n.thisView.patientDOBContainer,{date:i,from:new Date,to:new Date,type:s.EDateRangeType.Single},{allowEmpty:true,onlySingle:true},true)}n.thisView.view.ShowPanes(true)}resetStatusFile(){if(this.anyFiles){this.anyFiles[0].Status=i.EStatusFile.None;this.anyFiles[0].Tries=0;this.anyFiles[0].Percent=0}}fillFilesList(e){const t=e.target.files;for(let e=0;e<t.length;e++){const s=this.fileExtensions.some((i=>i.match(this.GetExtensionName(t[e].name))!==null));if(s){this.anyFiles=[{Name:t[e].name,File:t[e],Status:i.EStatusFile.None,Percent:0,Tries:0,Skip:false}]}}}createConfirmDialog(e){const t={Action:()=>{this.buttonUpload.disabled=true;this.buttonClear.disabled=true;this.buttonCancel.disabled=false;this.setBlockedControls(true);this.uploadMp4(e)},Name:"Ok",Text:"Yes",Id:"btnOkUploadMp4"};const i={Action:()=>{this.setBlockedControls(false)},Name:"Cancel",Text:"No",Id:"btnCancelUploadMp4"};t.ClassNames=["green"];i.ClassNames=["red"];return new s.MessageBox("Are you sure you want to upload mp4 with empty fields?",[t,i])}}i.UploadMp4Controller=UploadMp4Controller})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var i;(function(t){var i=e.Frontend.WebClient;class UploadView{constructor(s,n,o,a,l){this.ViewName="UploadView";this.Platform=n;this.parent=s;this.parameters=a;this.SpecView=o;this.ResourceBag=t.ResourceBag;this.Platform.LanguageManager.AddDictionary("{Efferent.ClientViews.ImageSplitView.ResourceBag.UploadLanguageJson}","UploadLanguage",e.ClientViews.UploadView.ResourceBag.UploadLanguageJson[this.Platform.LanguageManager.CurrentLanguage]);this.buildPane();this.Platform.SwitchTheme(this);setTimeout((()=>{var e;const t=l?l[0]:null;if((e=t===null||t===void 0?void 0:t.meta)===null||e===void 0?void 0:e.tag){t.meta.tag.forEach((e=>{if(e["code"]==="CASE"){i.Toaster.ShowToast("Select a non CASE study from general worklist",i.Colors.BelizeHole,3);n.SwitchView(n.BrowsingHistory[n.BrowsingHistory.length-1],"back")}}))}}),260)}Dispose(){this.uploadController.CleanAction();this.Platform.Toolbar.ShowButton(null,"back");this.Platform.Toolbar.ShowButton(null,"home")}OnPopState(e){}OnBeforeUnload(e){}OnUnload(e){}OnFullScreenChange(e){}CloseActionsConfig(){}OpenActionsConfig(){}GetFhirEntities(){return null}SetInitialStatus(){}SwitchTheme(){this.Platform.SwitchTheme(this)}ShowPanes(e){this.uploadController.ContainerDiv.style.display=e?"block":"none";this.uploadController.ResourcePicker.Show(!e)}LoadData(){}Refresh(){}UpdateUI(){}GetLanguageDictionary(){return""}OnTagChanged(e){}OnWindowResize(e,t){var i=document.documentElement.clientHeight-this.Platform.ToolbarSectionHeight()-this.Platform.GetActiveMessageHeight()-30;this.outContainer.style.height=i+"px";this.uploadController.OnWindowResize()}buildPane(){this.outContainer=document.createElement("div");i.DOMUtils.AddClass(this.outContainer,"UploadPane");this.outContainer.style.width="100%";this.parent.appendChild(this.outContainer);const e=this.parameters["mode"];switch(e){case t.UPLOAD_VIEW_DICOM:this.uploadController=new t.UploadDicomController(this.outContainer,this.SpecView,this.parameters,this);break;case t.UPLOAD_VIEW_MP4:this.uploadController=new t.UploadMp4Controller(this.outContainer,this.SpecView,this.parameters,this);break;case t.UPLOAD_VIEW_ATTACH:this.uploadController=new t.UploadAttachmentController(this.outContainer,this.SpecView,this.parameters);const e=this.outContainer.querySelector("#instructions");if(e)e.innerText="Click the explore button and select a file to attach to the study.";break;case t.UPLOAD_VIEW_FILE:this.uploadController=new t.UploadFileController(this.outContainer,this.SpecView,this.parameters);const i=this.outContainer.querySelector("#instructions");if(i)i.innerText="Click the explore button and select a file to upload.";break}var s=[["explore",t.ResourceBag.Icons8OpenedFolder32Png,e=>{if(this.uploadController.Selecting)this.uploadController.OpenAction()}]];var n=[["localBack",t.ResourceBag.Icons8Undo32Png,e=>{this.uploadController.GoToFormSelectFolder()}]];var o=[["close",t.ResourceBag.Icons8Delete32Png,e=>{if(!this.uploadController.IsUploading)this.Platform.SwitchView(this.Platform.BrowsingHistory[this.Platform.BrowsingHistory.length-1],"back")}]];this.Platform.Toolbar.AppendControlsToGroup([n,s,o],"UploadLanguage","main.1","workstation");this.Platform.Toolbar.HideButton(null,"back");this.Platform.Toolbar.HideButton(null,"home");this.OnWindowResize(0,0);this.Platform.ResizeListeners.push(new i.ResizeStructure(this.constructor.name.toLowerCase(),this,this.ViewName))}}t.UploadView=UploadView})(i=t.UploadView||(t.UploadView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));