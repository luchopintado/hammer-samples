var Efferent;(function(Efferent){var ClientViews;(function(ClientViews){var ImplantTemplateView;(function(ImplantTemplateView_1){var HttpUtils=Efferent.Frontend.WebClient.HttpUtils;var WebClient=Efferent.Frontend.WebClient;var DOMUtils=Efferent.Frontend.WebClient.DOMUtils;class ImplantTemplateView{constructor(e,t,a,i){this.selectedManufacturer="";this.selectedGroup="";this.selectedSizeIndex=0;this.groupsNamesOrder=["manufacturersBtn","groupsBtn","previousSizeBtn","nextSizeBtn"];this.landmarksButtons=[];this.templateControllers=[];this.selectedButton=null;this.componentsTypeName=["Stem","Cup","Femoral_Stem","Tibial_Stem","Femoral_Component","Tibial_Component"];this.landmarksButtonsNames={};this.ViewName="ImplantTemplateView";WebClient.Loader.Show();t.LanguageManager.AddDictionary("{Efferent.ClientViews.ImplantTemplateView.ResourceBag.ImplantTemplatesLanguageJson}","ImplantTemplatesLanguage",Efferent.ClientViews.ImplantTemplateView.ResourceBag.ImplantTemplatesLanguageJson[t.LanguageManager.CurrentLanguage]);this.metadataPathsTemplate={Size:"size",Manufacturer:"manufacturer",Product_group:"productGroup",Product_line:"productLine",Type:"type",Device_name:"deviceName",Patient_side:"patientSide",Model_number:"modelNumber",Product_status:"status",Version:"version",UDI_Device_Identifier:"udiDeviceIdentifier[0].version",Identifier:"identifier[0].value",Contact:"contact",Online_information:"onlineInformation"};this.levels=[{RootExpression:".ProductLines",DisplayExpression:".Name"},{RootExpression:".ProductFamilies",DisplayExpression:".Name"}];this.Platform=t;this.parent=e;this.ResourceBag=ImplantTemplateView_1.ResourceBag;this.SpecView=a;this.outContainer=document.createElement("div");this.outContainer.classList.add("implantTemplateViewOutContainer");this.parent.appendChild(this.outContainer);this.sideBarContainer=document.createElement("div");DOMUtils.AddClass(this.sideBarContainer,"implantTemplateViewSideBarContainer");this.outContainer.appendChild(this.sideBarContainer);this.mainContainer=document.createElement("div");this.mainContainer.classList.add("implantTemplateViewCenterContainer");this.outContainer.appendChild(this.mainContainer);this.Platform.SwitchTheme(this);this.OnWindowResize(0,0);this.loadManufacturers();this.showInstructions(0);this.Platform.ResizeListeners.push(new WebClient.ResizeStructure(this.constructor.name.toLowerCase(),this,this.ViewName));this.loadLandmarksTypes()}ShowPanes(e){}LoadData(){}Refresh(){}UpdateUI(){}GetManufacturer(){return this.selectedManufacturer}GetGroupName(){return this.selectedGroup}OnWindowResize(e,t){var a=document.documentElement.clientHeight-this.Platform.ToolbarSectionHeight()-this.Platform.GetActiveMessageHeight();var i=a-30;this.outContainer.style.height=i+"px";if(this.implantView!==undefined)this.buildMainContainer()}SwitchTheme(){this.Platform.SwitchTheme(this)}GetFhirEntities(){return null}GetLanguageDictionary(){return""}OnTagChanged(e){}SetInitialStatus(){}OpenActionsConfig(){}CloseActionsConfig(){}OnFullScreenChange(e){}Dispose(){}OnPopState(e){}OnBeforeUnload(e){}OnUnload(e){}loadManufacturers(){HttpUtils.AjaxCall(WebClient.PlatformContext.PlatformUri+"/implants/manufacturers","GET",null,null,(e=>{var t=JSON.parse(e.response);var a=0;var i=[[this.groupsNamesOrder[a],ImplantTemplateView_1.ResourceBag.Icons8Hierarchy32Png,e=>{}]];for(var n=0;n<t.length;n++){this.buildManufacturersButton(t[n].replace(/[\[\]/]/g,""),i)}this.rebuildDynamicButtons(a);this.Platform.Toolbar.AppendControlsToGroup([i],"ImplantTemplatesLanguage","main.1","workstation");WebClient.Loader.Hide()}),(()=>{WebClient.Toaster.ShowToast("Could not get the manufacturers list",WebClient.Colors.Orange,3);WebClient.Loader.Hide()}))}loadLandmarksTypes(){ImplantTemplateView_1.LandmarksManager.GetTemplateLandmarks((e=>{this.landmarksTemplate=e}))}buildManufacturersButton(e,t){var a=[e,"noIcon",t=>{this.selectedManufacturer=e;this.buildGroupsButton();WebClient.Toolbar.HideAllMenus()}];t.push(a)}buildGroupsButton(){WebClient.Loader.Show();HttpUtils.AjaxCall(WebClient.PlatformContext.PlatformUri+"/implants/manufacturers/"+this.selectedManufacturer+"/groups","GET",null,null,(e=>{var t=JSON.parse(e.response);var a=1;var i=[[this.groupsNamesOrder[a],ImplantTemplateView_1.ResourceBag.Icons8Hierarchy32Png,e=>{}]];for(var n=0;n<t.length;n++){this.buildGroupsSubButton(t[n].replace(/[\[\]/]/g,""),i)}this.rebuildDynamicButtons(a);this.Platform.Toolbar.AppendControlsToGroup([i],"ImplantTemplatesLanguage","main.1","workstation");WebClient.Loader.Hide()}),(()=>{WebClient.Toaster.ShowToast("Could not get the template group list",WebClient.Colors.Orange,3);WebClient.Loader.Hide()}))}buildGroupsSubButton(e,t){var a=[e,"noIcon",t=>{WebClient.Loader.Show();this.selectedGroup=e;HttpUtils.AjaxCall(WebClient.PlatformContext.PlatformUri+"/implants/manufacturers/"+this.selectedManufacturer+"/groups/"+e+"/files/index.json","GET",null,null,(e=>{this.currentIndexJson=JSON.parse(e.response);var t=this.currentIndexJson["ProductLines"];t.sort(this.compareByName);this.rebuildDynamicButtons(2);this.buildSideBarContainer(true);WebClient.Loader.Hide()}),(()=>{WebClient.Toaster.ShowToast("Could not get products.",WebClient.Colors.Orange,3);WebClient.Loader.Hide()}));WebClient.Toolbar.HideAllMenus()}];t.push(a)}rebuildDynamicButtons(e){for(var t=e;t<this.groupsNamesOrder.length;t++){var a=this.groupsNamesOrder[t];var i=this.Platform.Toolbar.GetButton(a);if(i!==null)i.Element.remove();for(var n=0;n<this.Platform.Toolbar.Groups.length;n++){var s=this.Platform.Toolbar.Groups[n];for(var r=0;r<s["Buttons"].length;r++){if(s["Buttons"][r]["Name"]===a)this.Platform.Toolbar.Groups[n]["Buttons"].splice(r,1)}}}if(e<this.groupsNamesOrder.length-1)this.showInstructions(e)}compareByName(e,t){var a=e.Name.toUpperCase();var i=t.Name.toUpperCase();if(a>i)return 1;else if(a<i)return-1;else return 0}generateSidebarTabs(e=false){this.sideBarContainer.innerHTML="";this.sideBarContainer.style.display="block";var t=document.createElement("div");DOMUtils.AddClass(t,"tabsContainer");var a=document.createElement("div");a.classList.add("implantTemplateTab");a.innerText="Tree";var i=document.createElement("div");i.classList.add("implantTemplateTab");i.innerText="Properties";var n=document.createElement("div");n.classList.add("implantTemplateTab");n.innerText="Landmarks";t.appendChild(a);t.appendChild(i);t.appendChild(n);this.sideBarContainer.appendChild(t);var s=document.createElement("div");var r=document.createElement("div");this.sideBarLandmarksContainer=document.createElement("div");this.sideBarContainer.appendChild(s);this.sideBarContainer.appendChild(r);this.sideBarContainer.appendChild(this.sideBarLandmarksContainer);if(e){DOMUtils.AddClass(a,"activeSideBarTab");DOMUtils.AddClass(i,"disabledSideBarTab");DOMUtils.AddClass(n,"disabledSideBarTab");r.style.display="none";this.sideBarLandmarksContainer.style.display="none"}else{DOMUtils.AddClass(i,"activeSideBarTab");s.style.display="none";this.sideBarLandmarksContainer.style.display="none";for(var l in this.metadataPathsTemplate){if(this.metadataPathsTemplate.hasOwnProperty(l)){try{this.createMetadataRow(l,this.metadataPathsTemplate[l],r)}catch(e){}}}a.addEventListener("click",(()=>{s.style.display="block";DOMUtils.AddClass(a,"activeSideBarTab");r.style.display="none";DOMUtils.RemoveClass(i,"activeSideBarTab");this.sideBarLandmarksContainer.style.display="none";DOMUtils.RemoveClass(n,"activeSideBarTab")}));i.addEventListener("click",(()=>{s.style.display="none";DOMUtils.RemoveClass(a,"activeSideBarTab");r.style.display="block";DOMUtils.AddClass(i,"activeSideBarTab");this.sideBarLandmarksContainer.style.display="none";DOMUtils.RemoveClass(n,"activeSideBarTab")}));n.addEventListener("click",(()=>{s.style.display="none";DOMUtils.RemoveClass(a,"activeSideBarTab");r.style.display="none";DOMUtils.RemoveClass(i,"activeSideBarTab");this.sideBarLandmarksContainer.style.display="block";DOMUtils.AddClass(n,"activeSideBarTab")}))}return s}sortAndSetSizes(e){var t=new Array;var a={};var i=Object.keys(e["Sizes"]);i.forEach((a=>{var i={id:a,size:e["Sizes"][a]};t.push(i)}));t=t.sort(((e,t)=>e.size.localeCompare(t.size,undefined,{numeric:true,sensitivity:"base"})));t.forEach((e=>{a[e.id]=e.size}));e["Sizes"]=a}buildSideBarContainer(e=false){var t=this.generateSidebarTabs(e);this.selectedButton=null;var a=document.createElement("h2");a.style.marginLeft="15px";a.innerText="Product Lines";t.appendChild(a);var i=document.createElement("div");DOMUtils.AddClass(i,"treeListContainer");t.appendChild(i);var n=new Efferent.Frontend.WebClient.TreeList(this.currentIndexJson,this.levels,i,(e=>{WebClient.Loader.Show();this.selectedSizeIndex=0;this.sizesNames=new Array;this.sortAndSetSizes(e);var t=Object.keys(e["Sizes"]);this.sizesNames=Object.values(e["Sizes"]);this.availableSizes=t.length;var a=WebClient.PlatformContext.PlatformUri+`/implants/manufacturers/${this.selectedManufacturer}/groups/${this.selectedGroup}/products/${t[0]}.json`;HttpUtils.AjaxCall(a,"GET",null,null,(e=>{if(e.response!==""){this.templateObject=JSON.parse(e.response);this.buildSideBarContainer();this.buildMainContainer();var a=2;var i=this.Platform.Toolbar.GetButton(this.groupsNamesOrder[2]);var n=this.Platform.Toolbar.GetButton(this.groupsNamesOrder[3]);if(i!==null){var s=this.Platform.Toolbar.Groups[0].Buttons;var r=s.indexOf(i);s.splice(r,1);var l=s.indexOf(n);s.splice(l,1);i.Element.remove();n.Element.remove()}var o=[[this.groupsNamesOrder[a],ImplantTemplateView_1.ResourceBag.Icons8Back32Png,e=>{if(this.selectedSizeIndex>0){WebClient.Loader.Show();this.selectedSizeIndex--;var a=WebClient.PlatformContext.PlatformUri+"/implants/manufacturers/"+this.selectedManufacturer+"/groups/"+this.selectedGroup+"/products/"+t[this.selectedSizeIndex]+".json";HttpUtils.AjaxCall(a,"GET",null,null,(e=>{this.templateObject=JSON.parse(e.response);this.buildSideBarContainer();this.buildMainContainer();WebClient.Loader.Hide();document.querySelector("#selectSizes").value=this.selectedSizeIndex.toString()}),(()=>{this.selectedSizeIndex++;WebClient.Toaster.ShowToast("Could not get the implant template",WebClient.Colors.Orange,3);WebClient.Loader.Hide();document.querySelector("#selectSizes").value=this.selectedSizeIndex.toString()}))}}]];var d=[[this.groupsNamesOrder[3],ImplantTemplateView_1.ResourceBag.Icons8Forward32Png,e=>{if(this.selectedSizeIndex<this.availableSizes-1){WebClient.Loader.Show();this.selectedSizeIndex++;var a=WebClient.PlatformContext.PlatformUri+"/implants/manufacturers/"+this.selectedManufacturer+"/groups/"+this.selectedGroup+"/products/"+t[this.selectedSizeIndex]+".json";HttpUtils.AjaxCall(a,"GET",null,null,(e=>{this.templateObject=JSON.parse(e.response);this.buildSideBarContainer();this.buildMainContainer();WebClient.Loader.Hide();document.querySelector("#selectSizes").value=this.selectedSizeIndex.toString()}),(()=>{this.selectedSizeIndex++;WebClient.Toaster.ShowToast("Could not get the implant template",WebClient.Colors.Orange,3);WebClient.Loader.Hide();document.querySelector("#selectSizes").value=this.selectedSizeIndex.toString()}))}}]];this.Platform.Toolbar.AppendControlsToGroup([o,d],"ImplantTemplatesLanguage","main.1","workstation");WebClient.Loader.Hide()}else{WebClient.Toaster.ShowToast("Could not get the implant template",WebClient.Colors.Orange,3);WebClient.Loader.Hide()}}),(()=>{WebClient.Toaster.ShowToast("Could not get the implant template",WebClient.Colors.Orange,3);WebClient.Loader.Hide()}))}))}createLandmarksMenu(e){this.landmarksButtons.push([]);var t=this.templateObject["type"].replace(" ","_");var a=this.templateObject["attachment"][e].title;var i=document.createElement("div");if(a.toUpperCase()==="AP")this.sideBarLandmarksContainer.prepend(i);else if(a.toUpperCase()==="ML")this.sideBarLandmarksContainer.appendChild(i);var n=document.createElement("h2");n.style.textAlign="center";n.innerText=this.templateObject["attachment"][e].title;i.appendChild(n);var s=this.landmarksTemplate.filter((e=>e.GroupName===this.selectedGroup&&e.ViewName===a.toUpperCase()&&e.TypeName===t));s.forEach((t=>{this.createLandmarkButton(i,t.LandmarkName,e)}));var r=document.createElement("button");r.classList.add("green");r.classList.add("landmarkButton");r.innerText="Done";i.appendChild(r);r.addEventListener("click",(()=>{WebClient.Toaster.ShowToast("Implant updated.",WebClient.Colors.Emerald,3);this.templateControllers[e].RenderTemplate()}))}createLandmarkButton(e,t,a){var i=document.createElement("button");var a=a;i.classList.add("landmarkButton");i.setAttribute("thisButtonName",t);i.setAttribute("viewIndex",a.toString());var n=t.replace(/_/g," ");i.innerText=n.charAt(0).toUpperCase()+n.slice(1);i.setAttribute("property",t);e.appendChild(i);var s=this.templateObject["attachment"][a].title;var r=this.templateObject["type"].replace(" ","_");if(this.templateControllers[a].SvgManager.Origin["NotSet"]){if(t!=="ORIGIN")i.disabled=true}if(this.templateControllers[a].SvgManager.Landmarks.hasOwnProperty(t)){i.disabled=false;i.classList.add("blue")}else{if(this.landmarksTemplate.some((e=>e.GroupName===this.selectedGroup&&e.ViewName===s.toUpperCase()&&e.LandmarkName===t&&e.TypeName===r&&e.Required))){i.style.backgroundColor=WebClient.Colors.SunFlower;i.style.color=WebClient.Colors.FullBlack}}i.addEventListener("click",(e=>{var n=e.currentTarget.getAttribute("thisButtonName");var s=document.getElementsByClassName("red");for(var r=0;r<s.length;r++){s[r].classList.remove("red")}if(i.classList.contains("blue")){this.selectedButton=null;i.classList.remove("blue");this.templateControllers[a].SvgManager.DeleteLandmark(t,(()=>{this.templateControllers[a].RenderTemplate()}))}i.style.removeProperty("background-color");i.style.removeProperty("color");if(this.selectedButton!==null&&this.selectedButton===i){this.selectedButton=null}else{this.selectedButton=i;i.classList.add("red")}for(var r=0;r<this.templateControllers.length;r++){this.templateControllers[r]["IsMarking"]=false;this.templateControllers[r].RenderTemplate()}this.templateControllers[a].IsMarking=this.selectedButton!=null}));this.landmarksButtons[a].push(i)}createMetadataRow(label,path,sideBarPropsContainer){var value=eval("this.templateObject."+path);if(value!=null){var row=document.createElement("div");var labelCapitalized=label.charAt(0).toUpperCase()+label.slice(1);row.classList.add("metadataRow");sideBarPropsContainer.appendChild(row);if(label==="Size"){DOMUtils.AddClass(row,"metadataRowSizes");row.innerHTML="<div><b>"+labelCapitalized.replace(/_/g," ").replace(/-/g," ")+" ("+(this.selectedSizeIndex+1)+"/"+this.availableSizes+"): <div id='previousSizeMiniButton'  class='sizeButton blue'>-</div><div id='nextSizeMiniButton' class='sizeButton'>+</div></b><br>"+value+"</div>";var previousSizeMiniButton=document.getElementById("previousSizeMiniButton");var nextSizeMiniButton=document.getElementById("nextSizeMiniButton");previousSizeMiniButton.addEventListener("click",(()=>{var e=this.Platform.Toolbar.GetButton("previousSizeBtn");e.Action()}));nextSizeMiniButton.addEventListener("click",(()=>{var e=this.Platform.Toolbar.GetButton("nextSizeBtn");e.Action()}));var containerList=document.createElement("div");var labelElementSizes=document.createElement("label");labelElementSizes.innerHTML="<b>Sizes:</b> ";var selectSizes=document.createElement("select");selectSizes.id="selectSizes";this.sizesNames.forEach(((e,t)=>{var a=document.createElement("option");a.value=t.toString();a.innerHTML=e;if(t===this.selectedSizeIndex)a.selected=true;selectSizes.appendChild(a)}));selectSizes.onchange=e=>{var t=parseInt(e.currentTarget.value);var a=t-1;this.selectedSizeIndex=a;var i=this.Platform.Toolbar.GetButton("nextSizeBtn");i.Action()};containerList.appendChild(labelElementSizes);containerList.appendChild(selectSizes);row.appendChild(containerList)}else{row.innerHTML="<div><b>"+labelCapitalized.replace(/_/g," ").replace(/-/g," ")+":</b><br>"+value+"</div>"}}}updateLandmarkPosition(){if(this.selectedButton===null)return;var e=this.selectedButton.getAttribute("thisButtonName");var t=parseInt(this.selectedButton.getAttribute("viewIndex"));this.templateControllers[t].SvgManager.UpdateLandmark(e,this.templateControllers[t].LandmarkPointTracker,(a=>{if(a){if(e==="ORIGIN"){for(var i=0;i<this.landmarksButtons[t].length;i++){this.landmarksButtons[t][i].disabled=false}}this.selectedButton.classList.remove("red");this.selectedButton.classList.add("blue");this.templateControllers[t].RenderTemplate();for(var i=0;i<this.templateControllers.length;i++){this.templateControllers[i]["IsMarking"]=false}this.selectedButton=null}}))}injectSvg(e,t,a,i){var n=document.createElement("canvas");n.addEventListener("click",(()=>{this.updateLandmarkPosition()}));n.width=this.mainContainer.clientWidth/this.templateObject["attachment"].length;n.height=this.mainContainer.clientHeight;t.appendChild(n);var s=new ImplantTemplateView_1.TemplateController(n,this);this.templateControllers.push(s);if(!s.ImplantReadyForDraw){s.LoadImplantFromSVG(e,(()=>{this.createLandmarksMenu(a);i(++a)}))}else{s.RenderTemplate()}}buildMainContainer(e=0){this.mainContainer.innerHTML="";this.mainContainer.style.flexDirection="row";if(this.templateObject!==undefined&&this.templateObject.hasOwnProperty("attachment")&&this.templateObject["attachment"]!==null){var t=WebClient.PlatformContext.PlatformUri+"/implants/manufacturers/"+this.selectedManufacturer+"/groups/"+this.selectedGroup+"/files/";this.templateControllers=[];var a=[];if(this.templateObject["attachment"].length===2){var i=this.templateObject["attachment"];var n=i[0];var s=i[1];if(n["title"]<s["title"])a.push(...[n,s]);else a.push(...[s,n]);this.templateObject["attachment"]=a}var LoadSvg=e=>{var a=document.createElement("div");a.classList.add("subView");this.mainContainer.appendChild(a);var i=t+this.templateObject["attachment"][e]["url"];this.injectSvg(i,a,e,(e=>{if(e<this.templateObject["attachment"].length)LoadSvg(e)}));var n=document.createElement("div");n.innerText=this.templateObject["attachment"][e]["title"];n.classList.add("subViewName");a.appendChild(n)};LoadSvg(0)}else{this.showNoImageMessage("This implant has no preview image to show.")}}showNoImageMessage(e){var t=document.createElement("div");t.classList.add("noImageMessage");t.innerText=e;this.mainContainer.appendChild(t);this.mainContainer.style.flexDirection="column"}showInstructions(e){this.sideBarContainer.style.display="none";this.mainContainer.innerHTML="";var t=document.createElement("div");t.classList.add("instructionsBox");var a="<h1>Select options for the implant.</h1>";var i=this.checkedOption(e,0,this.selectedManufacturer);var n="<div>MANUFACTURER: "+i[1]+" "+i[0]+"</div>";var s=this.checkedOption(e,1,this.selectedGroup);var r="<div>GROUP: "+s[1]+" "+s[0]+"</label><br>";var l="<div>PRODUCT FAMILY: </div>";t.innerHTML+=a;t.innerHTML+=n;t.innerHTML+=r;t.innerHTML+=l;this.mainContainer.appendChild(t)}checkedOption(e,t,a){if(e>t)return["✔",a.charAt(0).toUpperCase()+a.slice(1)];else return["",""]}}ImplantTemplateView_1.ImplantTemplateView=ImplantTemplateView})(ImplantTemplateView=ClientViews.ImplantTemplateView||(ClientViews.ImplantTemplateView={}))})(ClientViews=Efferent.ClientViews||(Efferent.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var a;(function(t){var a=e.Frontend.WebClient.HttpUtils;var i=e.Frontend.WebClient;class Landmark{constructor(e,t,a,i,n){this.ManufacturerName=e;this.TemplateUrl=t;this.LandmarkName=a;this.X=i;this.Y=n}}t.Landmark=Landmark;class TemplateLandmark{}t.TemplateLandmark=TemplateLandmark;class LandmarksManager{static GetTemplateLandmarks(e){var t=new Array;var n=i.PlatformContext.PlatformUri+"/implants/landmarkProjections";a.AjaxCall(n,"GET","min",null,((a,i)=>{t=JSON.parse(i);e(t)}),(a=>{e(t)}))}static LandmarksAreComplete(e,t,a,i,n){var s=true;var r=i.filter((i=>i.GroupName===e&&i.ViewName===a.toUpperCase()&&i.TypeName===t));r.forEach((e=>{if(e.Required&&!n.some((t=>t.LandmarkName.toUpperCase()===e.LandmarkName.toUpperCase())))s=false}));return s}static GetLandmarks(e,t,n,s){var r=new Array;var l=i.PlatformContext.PlatformUri+"/implants/manufacturers/"+e+"/groups/"+t+"/files/"+n+"/landmarks";a.AjaxCall(l,"GET","min",null,((e,t)=>{r=JSON.parse(t);s(r)}),(e=>{s(r)}))}static SaveLandmark(e,t,n,s,r){var l=i.PlatformContext.PlatformUri+"/implants/manufacturers/"+e+"/groups/"+t+"/files/"+n+"/landmarks";a.AjaxCall(l,"POST","min",s,((e,t)=>{r(true)}),(e=>{r(false)}))}static GetLandMark(e,t,n,s,r){var l;var o=i.PlatformContext.PlatformUri+"/implants/manufacturers/"+e+"/groups/"+t+"/files/"+n+"/landmarks/"+i.Utils.EncodeBase64(s);a.AjaxCall(o,"GET","min",null,((e,t)=>{l=JSON.parse(t);r(l)}),(e=>{r(l)}))}static DeleteLandMark(e,t,n,s,r){var l=i.PlatformContext.PlatformUri+"/implants/manufacturers/"+e+"/groups/"+t+"/files/"+n+"/landmarks/"+i.Utils.EncodeBase64(s);a.AjaxCall(l,"DELETE","min",null,((e,t)=>{r(true)}),(e=>{r(false)}))}}t.LandmarksManager=LandmarksManager})(a=t.ImplantTemplateView||(t.ImplantTemplateView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(e){var t;(function(e){class ResourceBag{}ResourceBag.ImplantTemplateViewCss=`.implantTemplateViewOutContainer{display:flex;overflow:auto;width:100%}.implantTemplateViewOutContainer .implantTemplateViewSideBarContainer{overflow:auto;min-width:200px;width:350px;margin-right:10px}.implantTemplateViewOutContainer .implantTemplateViewSideBarContainer .disabledSideBarTab{color:gray}.implantTemplateViewOutContainer .implantTemplateViewSideBarContainer .tabsContainer{margin-bottom:15px}.implantTemplateViewOutContainer .implantTemplateViewSideBarContainer .tabsContainer .implantTemplateTab{font-size:11px;cursor:pointer;display:inline-block;width:33%;text-align:center;height:35px;line-height:35px;border-bottom:0px;border-radius:5px 5px 0px 0px}.implantTemplateViewOutContainer .implantTemplateViewSideBarContainer .landmarkButton{display:block;margin:auto;margin-bottom:15px;font-size:12px;padding:0px 5px;line-height:12px}.implantTemplateViewOutContainer .implantTemplateViewCenterContainer{width:100%;background-repeat:no-repeat;background-position:center;background-size:contain;display:flex}.implantTemplateViewOutContainer .implantTemplateViewCenterContainer .subView{position:relative;width:50%;border-right:1px solid #2ecc71}.implantTemplateViewOutContainer .implantTemplateViewCenterContainer .subViewName{left:10px;top:10px;font-size:25px;font-weight:bold;position:absolute}.implantTemplateViewOutContainer .implantTemplateViewCenterContainer .instructionsBox{margin:auto;line-height:30px}.implantTemplateViewOutContainer .implantTemplateViewCenterContainer .instructionsBox h1{margin:0px 0px 10px 0px;font-size:20px}.implantTemplateViewOutContainer .implantTemplateViewCenterContainer .instructionsBox input[type=checkbox]{display:inline-block;margin-right:10px;width:17px;height:17px;margin:0px 10px 0px 0px}.implantTemplateViewOutContainer .metadataRow{margin:0px 15px 15px}.implantTemplateViewOutContainer .metadataRowSizes{padding:10px}.implantTemplateViewOutContainer .metadataRowSizes .sizeButton{background-color:#2980b9;display:inline-block;color:#fff;border-radius:3px;width:17px;text-align:center;cursor:pointer;margin-left:5px}.implantTemplateViewOutContainer .noImageMessage{padding:10px;background-color:#e67e22;text-align:center}`;ResourceBag.Icons8Back32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACCSURBVFhH7ZUxCoAwFEPrIIJXEMHN23hTV10VPYdOXqM1hf/Byc3gkAehNssLLg3iC2KMLTLYlUtKqYP8REareDzkK75rqzlILrnVHCTHuUhOA+IKOZCdLs9AWkA+IRfSW80F4vwXZo3QCEcjHI1wNML524jNKj54wEoMaOwqXgjhBju8anLOJF14AAAAAElFTkSuQmCC";ResourceBag.Icons8Forward32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAB6SURBVFhH7Y6xCYBQDAU/NhaCO9joQNauYekwLuFCWjiCFolPSMDORvIt3sFBSHMvkTdUtRCRAZb2igXhCq5wyTmigxtHcITDEQ7CLUfccITzpxE7nO0VC8I9POForzge8clecTDOeCiMMx4KojU8ssQdxBs7ycekdAEzfUZuiLGv7AAAAABJRU5ErkJggg==";ResourceBag.Icons8Hierarchy32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAACD0lEQVRYhe2Wv2sUURSFvxtXkxixESwURTurQPyBsRDETrFIoSjbqbWNQtL4B2ghFvZGCHZipabULkZ2UcSAlkEtLRKRrEb9LGYWNpvZnX1qSJGcZnjv3nfmMHPuuxc2sdERqQfUE8AZYFtb6AcwHREzayZAPQbMADXga1t4J3AEGI2IWq+clRQBwGngfUSMdhA4l+f0LKAvUUAFaHSJLwFbUwhTBfx3pApYBga6xAfznJ6RasKjwEugDiy2hZsmPB4R9TURkIsYBc6SleG5fPsJWRk+jYjZVM6/hjqlTv0Lx7qbcNUvULcAN4AqsL/k/FD+/FaSNw88BO5GxK/WQNFFdBu4CtwBPpQQX8uf90ryDgE3gd3AeMcstV/9rl4sIWzm9+wB9ZLaUFf0kHYPHCBz96teSBMxC/QDB7sJaK5/r4GAJueKd657FVTUHcAVYA+wK9+fUBeBj8D9iFhqHmibB0byvVsUzAPqduAysI/spgS4rn4BPgOToU4Dh4G3BQJHgBcRcT4nTJoH1MfASeBNAfcwUEddVseKPo9aVRda1hPqu6LcPD6njresF9Rqh9wxdbmP7j2+wcq7InUeKOVedxP2AT/p3OMH8ngTqfNAKXeoz8jM08mEzyPiAqTPA+oj4BTwuoB7GKiFOkRWhnsLkuaBB21l2DoPtGLVPKAOkpVhUVP7BEwW7G9ig+EP7Urkh2H0HpUAAAAASUVORK5CYII=";ResourceBag.Icons8Playlist32Png="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAACTwAAAk8B95E4kAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAGVSURBVFiF5ZbPKwRhHIefrzZEKAc3FzkoJ+wRJX+FpByUQv4AJwdX4eAgiXJwdldKigNHP5IfuTg4KIrYtv04vENau/tOmteufE5v8870PM18PzMD/z32sZDUAowAqcDMLLBpZvfkwYaAOeAksEBnJLGUL1AF3JhZOiRd0mnE+oSWNZUtIGlA0rWkM0ndIQR8E78CHAKNuKHpk9QMrAN1MRkXZjb5U4EMUB/BMtGxLHAL1MQUuCu16RMYBRaBV2AKwMyegOmYcG9KCpjZEdCbFKxQKrsFZReQ1C/pWNKBpK4QAr4hXAXOgQZcDfslNUXruDW8NLOZnwoYICDHly8n8AK8xRQoeZ5PYAxYwL0DJgDM7PFjnUR8NdwDepKCFUplt6DsApLSkvYl7UjqCCHgG8IN4ApXw2VgUFIjMA80xWScmtlssU3fI6gGnnG1q46OpYDamHBwX9Oi8d2BcWAN1+VhADN7wP09JxJfDXeBtqRghVLZLfiNfH0EOaBd0lVgZmvE+iawhZt2y78i4QjYDsz4Q3kHGktxpGeh0hwAAAAASUVORK5CYII=";ResourceBag.ImplantTemplatesLanguageJson={en:{nextSizeBtn:"Next size",previousSizeBtn:"Previous size",manufacturersBtn:"Manuf.",groupsBtn:"Groups",productLinesBtn:"Product lines",productTypesBtn:"Product types",productFamiliesBtn:"Product families"},es:{nextSizeBtn:"Siguiente tamaño",previousSizeBtn:"Anterior tamaño",manufacturersBtn:"Fabricante",groupsBtn:"Grupos",productLinesBtn:"Lineas",productTypesBtn:"Tipos",productFamiliesBtn:"Familias"}};e.ResourceBag=ResourceBag})(t=e.ImplantTemplateView||(e.ImplantTemplateView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var a;(function(t){var a=e.Frontend.WebClient;class SvgTemplateManager{constructor(e,t,i,n,s){this.xmlDoc=e;this.manufacturer=t;this.groupName=i;this.svgName=n;var r=this.xmlDoc.getElementsByTagName("svg")[0].getElementById("contour");if(r)r.setAttribute("stroke",a.Colors.SunFlower);var l=this.xmlDoc.getElementsByTagName("svg")[0].getElementById("reference");if(l)l.setAttribute("stroke",a.Colors.Asbestos);this.IsValid=false;this.Landmarks=s;this.Origin=new a.Point(0,0);this.ReadMetadataSvg()}ReadMetadataSvg(){try{if(this.Landmarks){var e=this.Landmarks["ORIGIN"];if(e){this.Origin.X=parseFloat(e.X.toString()||"0");this.Origin.Y=parseFloat(e.Y.toString()||"0")}else{this.Origin.X=0;this.Origin.Y=0;this.Origin["NotSet"]=true}}else{this.Origin.X=0;this.Origin.Y=0;this.Origin["NotSet"]=true}var t=this.xmlDoc.getElementsByTagName("svg")[0].getAttribute("viewBox").split(" ");this.ViewBox={X:parseFloat(t[0]),Y:parseFloat(t[1]),Width:parseFloat(t[2]),Height:parseFloat(t[3])};this.IsValid=true}catch(e){a.Utils.DebugConsoleLog(e)}}UpdateLandmark(e,i,n){if(e!=="ORIGIN"){i.X=i.X-this.Origin.X;i.Y=i.Y-this.Origin.Y}var s=new t.Landmark(this.manufacturer,this.svgName,e,i.X.toString(),i.Y.toString());a.Loader.Show();t.LandmarksManager.SaveLandmark(this.manufacturer,this.groupName,this.svgName,JSON.stringify(s),(t=>{a.Loader.Hide();if(t){this.Landmarks[e]=i;if(e==="ORIGIN"){this.Origin=i;delete this.Origin["NotSet"]}a.Toaster.ShowToast("Implant landmarks updated.",a.Colors.Emerald,3);n(true)}else{a.Toaster.ShowToast("Could not update implant landmarks.",a.Colors.Orange,3);n(false)}}))}DeleteLandmark(e,i){if(e==="ORIGIN"){i();return}a.Loader.Show();t.LandmarksManager.DeleteLandMark(this.manufacturer,this.groupName,this.svgName,e,(t=>{a.Loader.Hide();if(t){if(this.Landmarks.hasOwnProperty(e))delete this.Landmarks[e];a.Toaster.ShowToast("Implant landmark deleted.",a.Colors.Emerald,3);i()}else{a.Toaster.ShowToast("Could not delete implant landmarks.",a.Colors.Orange,3);i()}}))}AsString(){var e=(new XMLSerializer).serializeToString(this.xmlDoc);return e}AsURL(){var e=(new XMLSerializer).serializeToString(this.xmlDoc);return"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)}}t.SvgTemplateManager=SvgTemplateManager})(a=t.ImplantTemplateView||(t.ImplantTemplateView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));var Efferent;(function(e){var t;(function(t){var a;(function(t){var a=e.Frontend.WebClient.HttpUtils;var i=e.Frontend.WebClient;var n=e.Frontend.WebClient.Utils;class TemplateController{constructor(e,t){this.ImplantReadyForDraw=false;this.Element=e;this.templateView=t;this.IsMarking=false;this.offsetX=0;this.offsetY=0;this.scale=1;this.implantImage=null;this.offsetX=e.width/2;this.offsetY=e.height/2;this.Element.addEventListener("mousemove",(e=>{var t=i.DOMUtils.GetOffset(e,"x");var a=i.DOMUtils.GetOffset(e,"y");this.cursorPosition=new i.Point(t,a);this.LandmarkPointTracker=new i.Point((t-this.offsetX)/this.scale,(a-this.offsetY)/this.scale);if(this.IsMarking){this.Element.style.cursor="none";this.drawCrossHair(t,a)}else{this.Element.style.cursor="auto";this.RenderTemplate()}}));this.Element.addEventListener("mouseout",(e=>{this.cursorPosition=null}));this.Element.addEventListener("wheel",(e=>{this.ZoomToCenter(this.cursorPosition,e.deltaX,e.deltaY)}));this.Context=this.Element.getContext("2d")}ZoomToCenter(e,t,a,i){var n=this.getZoomFactor(t,a,i);if(n===-1)return;var s={x:e.X/this.scale-this.offsetX/this.scale,y:e.Y/this.scale-this.offsetY/this.scale};this.scale*=n;var r={x:-(s.x-e.X/this.scale)*this.scale,y:-(s.y-e.Y/this.scale)*this.scale};this.offsetX=r.x;this.offsetY=r.y;this.RenderTemplate()}RenderTemplate(){if(this.implantImage!==null&&this.implantImage!==undefined){var e=this.SvgManager.Origin;this.clear();this.Context.save();this.Context.translate(this.offsetX,this.offsetY);this.Context.scale(this.scale,this.scale);this.Context.drawImage(this.implantImage,this.SvgManager.ViewBox.X,this.SvgManager.ViewBox.Y,this.SvgManager.ViewBox.Width,this.SvgManager.ViewBox.Height);this.Context.beginPath();this.Context.lineWidth=1;this.Context.moveTo(e.X-2.5,e.Y-2.5);this.Context.lineTo(e.X+2.5,e.Y+2.5);this.Context.moveTo(e.X+2.5,e.Y-2.5);this.Context.lineTo(e.X-2.5,e.Y+2.5);this.Context.strokeStyle=i.Colors.Alizarin;this.Context.stroke();this.Context.closePath();this.Context.beginPath();this.Context.arc(e.X,e.Y,.8,0,2*Math.PI,false);this.Context.fillStyle=i.Colors.Alizarin;this.Context.fill();this.Context.closePath();if(Object.keys(this.SvgManager.Landmarks).length>0){for(const t in this.SvgManager.Landmarks){if(this.SvgManager.Landmarks.hasOwnProperty(t)){const a=this.SvgManager.Landmarks[t];this.Context.beginPath();this.Context.lineWidth=1;this.Context.arc(a.X+e.X,a.Y+e.Y,.8,0,2*Math.PI,false);this.Context.fillStyle="dodgerblue";this.Context.fill();this.Context.closePath()}}}this.Context.restore()}}LoadImplantFromSVG(e,s){i.Loader.Show();a.AjaxCall(e,"GET","min",null,((a,r)=>{if(r!==""){try{var l=e.split("/").pop();i.Loader.Show("Loading landmarks");t.LandmarksManager.GetLandmarks(this.templateView.GetManufacturer(),this.templateView.GetGroupName(),l,(e=>{var a={};e.forEach((e=>{a[e.LandmarkName]=new i.Point(parseFloat(e.X),parseFloat(e.Y))}));this.SvgManager=new t.SvgTemplateManager(r,this.templateView.GetManufacturer(),this.templateView.GetGroupName(),l,a);if(!this.SvgManager.IsValid){i.Loader.Hide();i.Toaster.ShowToast("Error the implant is invalid",i.Colors.Orange,3);return}this.createImage(s);i.Loader.Hide()}));i.Loader.Hide()}catch(e){i.Loader.Hide();i.Toaster.ShowToast("Error showing implant",i.Colors.Orange,3);n.DebugConsoleLog(e)}}else{i.Toaster.ShowToast("Error parsing svg implant",i.Colors.Orange,3);i.Loader.Hide()}}),(e=>{i.Loader.Hide();if(e===404)i.Toaster.ShowToast("Implant not found",i.Colors.Orange,3)}),"document")}createImage(e){try{var t=this.SvgManager.AsURL();this.implantImage=new Image;this.implantImage.onload=()=>{this.ImplantReadyForDraw=true;this.loadedImageWidth=this.implantImage.width;this.loadedImageHeight=this.implantImage.height;var t=this.SvgManager.Origin;var a=this.Context.canvas.width/this.SvgManager.ViewBox.Width;var i=this.Context.canvas.height/this.SvgManager.ViewBox.Height;this.scale=a<i?a:i;this.offsetX=(this.Context.canvas.width-this.SvgManager.ViewBox.Width*this.scale)/2-this.SvgManager.ViewBox.X*this.scale;this.offsetY=(this.Context.canvas.height-this.SvgManager.ViewBox.Height*this.scale)/2-this.SvgManager.ViewBox.Y*this.scale;this.RenderTemplate();e()};this.implantImage.src=t}catch(e){i.Toaster.ShowToast("svg implant not available.",i.Colors.Orange,3)}}clear(){this.Context.fillStyle=e.Frontend.WebClient.Colors.BgDarker;this.Context.fillRect(0,0,this.Context.canvas.width,this.Context.canvas.height)}drawCrossHair(e,t){this.RenderTemplate();this.Context.save();this.Context.beginPath();this.Context.lineWidth=1;this.Context.strokeStyle=i.Colors.Clouds;this.Context.moveTo(e-this.Context.canvas.width,t);this.Context.lineTo(e+this.Context.canvas.width,t);this.Context.moveTo(e,t-this.Context.canvas.height);this.Context.lineTo(e,t+this.Context.canvas.height);this.Context.stroke();this.Context.closePath();this.Context.restore()}getZoomFactor(e,t,a){var i=1;if(a!==null&&a!==undefined){if(a.deltaX!==undefined&&a.deltaY!==undefined){if(a.deltaX<0&&a.deltaY<0){var n=Math.abs(a.angle)-90;if(25<=n&&n<=65)return-1}if(a.deltaX>0&&a.deltaY>0){if(25<=a.angle&&a.angle<=65)return-1}}if(a.additionalEvent!==undefined){switch(a.additionalEvent){case"panup":case"panright":i=1.02;break;case"panleft":case"pandown":i=1/1.02;break;default:return}}}else{if(t<0||e>0)i=1.02;else if(t>0||e<0)i=1/1.02;else return-1}return i}}t.TemplateController=TemplateController})(a=t.ImplantTemplateView||(t.ImplantTemplateView={}))})(t=e.ClientViews||(e.ClientViews={}))})(Efferent||(Efferent={}));